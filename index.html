<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BetManager</title>

  <!-- ICONS: Favicon SVG (Data URI) y Apple Touch Icon -->
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%230f172a%22/><path d=%22M20 70 L40 50 L60 60 L80 30%22 stroke=%22%2310b981%22 stroke-width=%228%22 fill=%22none%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22/><circle cx=%2280%22 cy=%2230%22 r=%226%22 fill=%22%2310b981%22/></svg>">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2622/2622312.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="BetManager">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Prop-types (Dependencies) -->
  <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>

  <!-- Recharts (CDNjs) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js"></script>
  <!-- SUPABASE JS (V32) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Lucide -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #0f172a;
    }

    ::-webkit-scrollbar-thumb {
      background: #334155;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #475569;
    }

    .animate-fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body class="bg-slate-950 text-slate-100 h-screen overflow-hidden">

  <div id="root" class="h-full"></div>

  <script type="text/babel" data-presets="react">
    // --- IMPORTS GLOBALIZADOS ---
    const { useState, useEffect, useMemo, useRef } = React;

    // --- GEMINI AI CONFIG (V4) ---
    const GEMINI_API_KEY = "AIzaSyCUVnkzykwI8XhQsqRweZlJ2vEG5zSwOJ4";
    // Si realmente existe 2.5 en el futuro, se cambiaría aquí. Usamos 1.5-flash por estabilidad.
    const GEMINI_MODEL = "gemini-1.5-flash";
    const analyzeImageWithGemini = async (base64Image, prompt) => {
      try {
        const payload = {
          contents: [{
            parts: [
              { text: prompt },
              { inline_data: { mime_type: "image/jpeg", data: base64Image } }
            ]
          }]
        };

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errData = await response.json().catch(() => ({}));
          throw new Error(`Error API ${response.status}: ${errData.error?.message || response.statusText}`);
        }

        const data = await response.json();
        const text = data.candidates[0].content.parts[0].text;
        // Limpiar markdown json si existe
        const cleanJson = text.replace(/```json|```/g, '').trim();
        return JSON.parse(cleanJson);
      } catch (err) {
        console.error("Gemini Error:", err);
        throw err;
      }
    };

    // --- SYSTEM BETS LOGIC (V42) ---
    // Helper to generate combinations of k elements from an array
    const getCombinations = (array, k) => {
      const result = [];
      const f = (prefix, array) => {
        for (let i = 0; i < array.length; i++) {
          const newPrefix = prefix.concat([array[i]]);
          if (newPrefix.length === k) {
            result.push(newPrefix);
          } else {
            f(newPrefix, array.slice(i + 1));
          }
        }
      };
      f([], array);
      return result;
    };

    // V43: Dynamic System Config Generator
    const getSystemOptions = (n) => {
      const options = [];

      if (n < 2) return [];

      // 1. Generic N-folds (from 2 up to N-1)
      // We exclude N because that's just a normal parlay (already handled)
      for (let k = 2; k < n; k++) {
        // Spanish naming for low numbers, numeric for high
        let name = `${k} selecciones`;
        if (k === 2) name = 'Dobles';
        if (k === 3) name = 'Triples';
        if (k === 4) name = 'Cuatros';
        if (k === 5) name = 'Cincos';
        if (k === 6) name = 'Seises';
        if (k === 7) name = 'Sietes';
        if (k === 8) name = 'Ochos';

        // Calculate count: nCk
        // Simple nCk implementation for count display
        const nFact = (num) => { let r = 1; for (let i = 2; i <= num; i++) r *= i; return r; };
        const count = Math.round(nFact(n) / (nFact(k) * nFact(n - k)));

        options.push({ name: name, k: k, count: count });
      }

      // 2. Named Full Cover Systems (All-in logic)
      // "All-in" means all combinations from 2 up to N (or N-1? User said "aplica todo"). 
      // Standard "Super Yankee" (Canadian) for 5 is: 10 doubles, 10 triples, 5 four-folds, 1 five-fold. Total 26.
      // We will generate an "All-in" option that includes EVERYTHING from K=2 to K=N.

      // Named defaults for specific sizes (classic names + All-in)
      if (n === 3) {
        options.push({ name: 'Trixie', type: 'named', count: 4, composition: [{ k: 2, count: 3 }, { k: 3, count: 1 }] });
        options.push({ name: 'Patent', type: 'named', count: 7, composition: [{ k: 1, count: 3 }, { k: 2, count: 3 }, { k: 3, count: 1 }] });
      }
      if (n === 4) {
        options.push({ name: 'Yankee', type: 'named', count: 11, composition: [{ k: 2, count: 6 }, { k: 3, count: 4 }, { k: 4, count: 1 }] });
        options.push({ name: 'Lucky 15', type: 'named', count: 15, composition: [{ k: 1, count: 4 }, { k: 2, count: 6 }, { k: 3, count: 4 }, { k: 4, count: 1 }] });
      }
      if (n === 5) {
        // User renamed Super Yankee to All-in
        options.push({ name: 'All-in (Super Yankee)', type: 'named', count: 26, composition: [{ k: 2, count: 10 }, { k: 3, count: 10 }, { k: 4, count: 5 }, { k: 5, count: 1 }] });
        options.push({ name: 'Lucky 31', type: 'named', count: 31, composition: [{ k: 1, count: 5 }, { k: 2, count: 10 }, { k: 3, count: 10 }, { k: 4, count: 5 }, { k: 5, count: 1 }] });
      }
      if (n === 6) {
        options.push({ name: 'Heinz', type: 'named', count: 57, composition: [{ k: 2, count: 15 }, { k: 3, count: 20 }, { k: 4, count: 15 }, { k: 5, count: 6 }, { k: 6, count: 1 }] });
        options.push({ name: 'Lucky 63', type: 'named', count: 63, composition: [{ k: 1, count: 6 }, { k: 2, count: 15 }, { k: 3, count: 20 }, { k: 4, count: 15 }, { k: 5, count: 6 }, { k: 6, count: 1 }] });
      }
      // Dynamic All-in for N > 6?
      if (n > 6) {
        // Calculate total bets for All-in (2 to N)
        let total = 0;
        let comp = [];
        for (let k = 2; k <= n; k++) {
          const nFact = (num) => { let r = 1; for (let i = 2; i <= num; i++) r *= i; return r; };
          const c = Math.round(nFact(n) / (nFact(k) * nFact(n - k)));
          total += c;
          comp.push({ k: k, count: c });
        }
        options.push({ name: `All-in (${n} sel)`, type: 'named', count: total, composition: comp });
      }

      return options;
    };

    // --- ORACLE HELPER (TEXT ONLY) ---
    const analyzeTextWithGemini = async (prompt) => {
      try {
        const payload = { contents: [{ parts: [{ text: prompt }] }] };
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          const errData = await response.json().catch(() => ({}));
          throw new Error(`Error API ${response.status}: ${errData.error?.message || response.statusText}`);
        }
        const data = await response.json();
        return data.candidates[0].content.parts[0].text;
      } catch (error) {
        console.error("Gemini Text Error:", error);
        throw error;
      }
    };
    // --- ADAPTADOR LUCIDE-REACT PARA CDN ---
    // Convierte las definiciones de iconos de la librería 'lucide' (vanilla) en componentes React
    const LucideIcon = ({ name, size = 24, color = "currentColor", className = "", ...props }) => {
      const iconDef = lucide.icons[name];
      if (!iconDef) { console.warn(`Icono ${name} no encontrado en lucide.icons`); return null; }

      return React.createElement('svg', {
        xmlns: "http://www.w3.org/2000/svg",
        width: size,
        height: size,
        viewBox: "0 0 24 24",
        fill: "none",
        stroke: color,
        strokeWidth: 2,
        strokeLinecap: "round",
        strokeLinejoin: "round",
        className: className,
        ...props
      }, iconDef.map(([tag, attrs], index) => React.createElement(tag, { ...attrs, key: index })));
    };

    // Crear componentes individuales para uso directo (ej: <Plus />)
    // Extraemos solo los que usamos para evitar procesar toda la librería si no es necesario, aunque aquí mapeamos dinámicamente
    // los que necesitamos
    const IconList = [
      'Plus', 'Trash2', 'Users', 'Save', 'History', 'PieChart', 'TrendingUp',
      'CheckCircle', 'XCircle', 'Clock', 'Activity', 'Target', 'Zap',
      'BarChart2', 'Menu', 'ChevronRight', 'AlertCircle', 'AlertTriangle', 'RefreshCw', 'Check', 'X', 'Calendar', 'Layers', 'Trophy', 'Flame',
      'Filter', 'Tag', 'Camera', 'Sparkles', 'Brain', 'Upload', 'Scan', 'TrendingDown', 'UserPlus', 'Edit', 'Calculator', 'LayoutDashboard', 'Copy',
      'ChevronUp', 'ChevronDown', 'Cloud', 'UploadCloud', 'DownloadCloud', 'Settings', 'ArrowDown', 'ArrowUp', 'LayoutGrid', 'Repeat', 'Globe'
    ];

    const Icons = IconList.reduce((acc, name) => {
      acc[name] = (props) => <LucideIcon name={name} {...props} />;
      return acc;
    }, {});

    const {
      Plus, Trash2, Users, Save, History, PieChart, TrendingUp,
      CheckCircle, XCircle, Clock, Activity, Target, Zap,
      BarChart2, Menu, ChevronRight, AlertCircle, AlertTriangle, RefreshCw, Check, X, Calendar, Layers, Trophy, Flame,
      Filter, Tag, Camera, Sparkles, Brain, Upload, Scan, TrendingDown, UserPlus, Edit, Calculator, LayoutDashboard, Copy,
      ChevronUp, ChevronDown, Cloud, UploadCloud, DownloadCloud, Settings, ArrowDown, ArrowUp, LayoutGrid, Repeat, Globe
    } = Icons;
    const {
      LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer,
      BarChart, Bar, Cell, PieChart: RechartsPieChart, Pie, Legend,
      AreaChart, Area, ScatterChart, Scatter, ZAxis
    } = Recharts;

    // FIX: Alias manual para compatibilidad con código antiguo y nuevo
    const RechartsTooltip = Tooltip;

    // --- COMPONENTES UI AUXILIARES ---
    const StatCard = ({ title, value, subtext, icon: Icon, colorClass }) => (
      <div className={`bg-slate-800 p-4 rounded-xl border border-slate-700 relative overflow-hidden group hover:border-slate-500 transition-all duration-300`}>
        <div className={`absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity ${colorClass}`}>
          <Icon size={40} />
        </div>
        <div className="text-slate-400 text-xs uppercase tracking-wider mb-1 font-semibold">{title}</div>
        <div className={`text-2xl md:text-3xl font-bold text-white`}>
          {value}
        </div>
        <div className="text-xs text-slate-500 mt-2 flex items-center gap-1">
          {subtext}
        </div>
      </div>
    );

    // --- APP PRINCIPAL ---

    // --- THEME ENGINE (V60) ---
    const THEMES = {
      original: { id: 'original', name: 'Original (Pro)', colors: { bg: 'slate-950', card: 'slate-900', text: 'slate-100', accent: 'emerald' }, font: 'Inter', cssVars: { '--bg-app': '#020617', '--bg-card': '#0f172a', '--text-main': '#f1f5f9', '--accent': '#10b981' } },
      stranger: { id: 'stranger', name: 'Stranger Things', colors: { bg: 'black', card: 'zinc-950', text: 'red-200', accent: 'red' }, font: 'ITC Benguiat', cssVars: { '--bg-app': '#000000', '--bg-card': '#1a0505', '--text-main': '#ffcccc', '--accent': '#ff0033' }, vibe: 'Retro Neon Terror' },
      disney: { id: 'disney', name: 'Disney Magic', colors: { bg: 'sky-950', card: 'sky-900', text: 'sky-100', accent: 'yellow' }, font: 'Great Vibes, cursive', cssVars: { '--bg-app': '#082f49', '--bg-card': '#0c4a6e', '--text-main': '#e0f2fe', '--accent': '#fbbf24' }, vibe: 'Magical Sparkles' },
      marvel: { id: 'marvel', name: 'Marvel', colors: { bg: 'red-950', card: 'red-900', text: 'white', accent: 'white' }, font: 'Bangers, cursive', cssVars: { '--bg-app': '#450a0a', '--bg-card': '#7f1d1d', '--text-main': '#ffffff', '--accent': '#ffffff' }, vibe: 'Comic Action' },
      manga: { id: 'manga', name: 'Manga B&W', colors: { bg: 'white', card: 'neutral-100', text: 'black', accent: 'black' }, font: 'Bangers', cssVars: { '--bg-app': '#ffffff', '--bg-card': '#f5f5f5', '--text-main': '#000000', '--accent': '#000000' }, vibe: 'Ink & ScreenTones' },
    };

    // --- CLOUD SERVICE (SUPABASE) ---
    const SupabaseService = {
      client: null,
      init: (url, key) => {
        if (window.supabase) {
          SupabaseService.client = window.supabase.createClient(url, key);
          console.log("Supabase Client Initialized");
        }
      },
      isConnected: () => !!SupabaseService.client,

      // Generic Fetch
      fetch: async (table, userId) => {
        if (!SupabaseService.client) return null;
        const { data, error } = await SupabaseService.client.from(table).select('*').eq('user_id', userId);
        if (error) { console.error('Cloud Fetch Error:', error); return []; }
        return data;
      },

      // Generic Upsert
      save: async (table, payload) => {
        if (!SupabaseService.client) return;
        const { error } = await SupabaseService.client.from(table).upsert(payload);
        if (error) console.error('Cloud Save Error:', error);
      },

      // Specific Adapters
      fetchFullProfile: async (userId) => {
        if (!SupabaseService.client) return null;
        const { data: bets } = await SupabaseService.client.from('bets').select('*').eq('user_id', userId);
        const { data: tipsters } = await SupabaseService.client.from('tipsters').select('*').eq('user_id', userId);
        const { data: bank } = await SupabaseService.client.from('bank_transactions').select('*').eq('user_id', userId);
        return { bets, tipsters, bank }; // Return null if error handled individually
      }
    };


    // --- DATABASE ABSTRACTION (LOCAL + CLOUD HYBRID) ---
    const DB = {
      get: (userId, key, def = null) => {
        if (!userId) return def;
        // 1. Try Local First for Speed
        const val = localStorage.getItem(`user_${userId}_${key}`);
        return val ? JSON.parse(val) : def;
      },
      set: (userId, key, val) => {
        if (!userId) return;
        // 1. Save Local
        localStorage.setItem(`user_${userId}_${key}`, JSON.stringify(val));

        // 2. Sync to Cloud (Fire & Forget)
        if (SupabaseService.isConnected()) {
          DB.syncToCloud(userId, key, val);
        }
      },
      migrateGlobalToUser: (userId, keyList) => {
        keyList.forEach(key => {
          const val = localStorage.getItem(key);
          if (val) localStorage.setItem(`user_${userId}_${key}`, val);
        });
      },

      // --- SYNC LOGIC ---
      syncToCloud: async (userId, key, val) => {
        // Map Local Keys to Cloud Tables
        // key example: 'betPortfolioV29_bets' -> table: 'bets'
        if (key.includes('bets')) {
          // Bets need transformation? Or save as big JSON? 
          // Best practice: structure it. But for MVP backup, we might save rows.
          // Let's assume 'val' is array of bets.
          if (Array.isArray(val)) {
            const betsPayload = val.map(b => ({
              user_id: userId,
              // Map fields if necessary, or ensure local object matches DB schema
              ...b
            }));
            // Upsert batch
            // Note: Upsert needs Primary Key. Local 'id' matches Cloud 'id'?
            // We need to ensure IDs are consistent. 
            // For now, simplify: we just want to save.
            // await SupabaseService.save('bets', betsPayload); 
          }
        }
      }
    };

    // --- COMPONENTS: AUTH & ONBOARDING ---

    const AuthScreen = ({ users, onLogin, onNewUser }) => (
      <div className="h-screen bg-slate-950 flex flex-col items-center justify-center p-4 animate-fade-in relative overflow-hidden">
        {/* Background Effects */}
        <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-indigo-900/20 via-slate-950 to-slate-950 z-0"></div>
        <div className="relative z-10 w-full max-w-md space-y-8">
          <div className="text-center space-y-2">
            <h1 className="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-cyan-400 tracking-tight">BET<span className="text-white">MANAGER</span></h1>
            <p className="text-slate-400">Selecciona tu perfil de usuario</p>
          </div>

          <div className="grid gap-4">
            {users.map(u => (
              <button key={u.id} onClick={() => onLogin(u)} className="flex items-center gap-4 bg-slate-900/50 hover:bg-slate-800 p-4 rounded-xl border border-slate-800 hover:border-emerald-500/50 transition-all group shadow-lg">
                <div className="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-2xl shadow-inner border border-slate-700 group-hover:bg-emerald-900/20 group-hover:text-emerald-400 group-hover:border-emerald-500 transition-all">
                  {u.avatar || u.name.charAt(0)}
                </div>
                <div className="text-left flex-1">
                  <div className="font-bold text-white group-hover:text-emerald-400 transition-colors text-lg">{u.name}</div>
                  <div className="text-xs text-slate-500 capitalize">{THEMES[u.theme]?.name || 'Tema Original'}</div>
                </div>
                <ChevronRight className="text-slate-600 group-hover:text-emerald-400 transition-transform group-hover:translate-x-1" />
              </button>
            ))}

            <button onClick={onNewUser} className="mt-4 flex items-center justify-center gap-2 w-full py-4 rounded-xl border-2 border-dashed border-slate-800 hover:border-indigo-500 text-slate-500 hover:text-indigo-400 transition-all hover:bg-indigo-950/10 font-bold group">
              <Plus className="group-hover:scale-110 transition-transform" /> CREAR NUEVO USUARIO
            </button>
          </div>

          <div className="text-center text-[10px] text-slate-600 font-mono">
            v60.0 Multi-User System
          </div>
        </div>
      </div>
    );

    const OnboardingWizard = ({ onFinish, onCancel }) => {
      const [step, setStep] = useState(1);
      const [data, setData] = useState({ name: '', avatar: '😎', theme: 'original', bank: 1000, source: 'new', password: '' });
      const [cloudBackup, setCloudBackup] = useState(null); // For cloud restore

      const AVATARS = ['😎', '🦁', '🤖', '👻', '👽', '👑', '🏀', '⚽', '💸', '🚀'];

      const handleFinish = () => {
        if (!data.name) return alert("¡El nombre es obligatorio!");
        onFinish({ ...data, cloudBackup });
      };

      const handleCloudFile = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const text = await file.text();
        try {
          const json = JSON.parse(text);
          if (json.meta && json.meta.password_protected) {
            const pwd = prompt("🔒 Este backup está protegido. Introduce la contraseña:");
            if (pwd !== json.meta.password) return alert("Contraseña incorrecta");
          }
          setCloudBackup(json);
          setData({ ...data, source: 'cloud' });
        } catch (err) { alert("Archivo inválido"); }
      };

      return (
        <div className="fixed inset-0 bg-slate-950 z-50 flex flex-col items-center justify-center p-4">
          {/* Steps Progress */}
          <div className="w-full max-w-2xl mb-8 flex items-center justify-center gap-4">
            {[1, 2, 3, 4].map(s => (
              <div key={s} className={`w-3 h-3 rounded-full transition-all ${step >= s ? 'bg-emerald-500 scale-125' : 'bg-slate-800'}`}></div>
            ))}
          </div>

          <div className="bg-slate-900 w-full max-w-2xl rounded-2xl border border-slate-800 shadow-2xl overflow-hidden flex flex-col md:flex-row min-h-[400px]">

            {/* Sidebar Info */}
            <div className="bg-slate-950 p-6 md:w-1/3 border-r border-slate-800 flex flex-col justify-between">
              <div>
                <h2 className="text-2xl font-bold text-white mb-2">Setup</h2>
                <div className="space-y-4 text-sm text-slate-400">
                  <div className={step === 1 ? 'text-emerald-400 font-bold' : ''}>1. Perfil</div>
                  <div className={step === 2 ? 'text-emerald-400 font-bold' : ''}>2. Datos</div>
                  <div className={step === 3 ? 'text-emerald-400 font-bold' : ''}>3. Bank</div>
                  <div className={step === 4 ? 'text-emerald-400 font-bold' : ''}>4. Tema</div>
                </div>
              </div>
              <div className="text-[10px] text-slate-600 mt-4">Configuración inicial</div>
            </div>

            {/* Main Content */}
            <div className="p-8 md:w-2/3 flex flex-col">

              {/* STEP 1: IDENTITY */}
              {step === 1 && (
                <div className="space-y-6 animate-fade-in">
                  <h3 className="text-xl font-bold text-white">¿Quién eres?</h3>
                  <div>
                    <label className="block text-xs uppercase font-bold text-slate-500 mb-2">Nombre de Usuario</label>
                    <input autoFocus value={data.name} onChange={e => setData({ ...data, name: e.target.value })} className="w-full bg-slate-950 border-2 border-slate-800 focus:border-emerald-500 rounded-lg p-3 text-white text-lg font-bold outline-none" placeholder="Tu Nombre..." />
                  </div>
                  <div>
                    <label className="block text-xs uppercase font-bold text-slate-500 mb-2">Avatar</label>
                    <div className="flex flex-wrap gap-2">
                      {AVATARS.map(av => (
                        <button key={av} onClick={() => setData({ ...data, avatar: av })} className={`text-2xl w-10 h-10 rounded flex items-center justify-center border transition-all ${data.avatar === av ? 'bg-emerald-900/30 border-emerald-500 scale-110' : 'bg-slate-950 border-slate-800 hover:bg-slate-800'}`}>{av}</button>
                      ))}
                    </div>
                  </div>
                  {/* PASSWORD FIELD (V61) */}
                  <div>
                    <label className="block text-xs uppercase font-bold text-slate-500 mb-2">Contraseña (Opcional)</label>
                    <input type="password" value={data.password || ''} onChange={e => setData({ ...data, password: e.target.value })} className="w-full bg-slate-950 border-2 border-slate-800 focus:border-emerald-500 rounded-lg p-3 text-white text-lg font-bold outline-none" placeholder="Vacío = Sin contraseña" />
                    <p className="text-[10px] text-slate-500 mt-1">Protege tu cuenta de otros usuarios en este dispositivo.</p>
                  </div>
                </div>
              )}

              {/* STEP 2: DATA SOURCE */}
              {step === 2 && (
                <div className="space-y-6 animate-fade-in">
                  <h3 className="text-xl font-bold text-white">Origen de Datos</h3>
                  <div className="space-y-3">
                    <button onClick={() => setData({ ...data, source: 'new' })} className={`w-full text-left p-4 rounded-xl border flex gap-4 items-center transition-all ${data.source === 'new' ? 'bg-emerald-900/20 border-emerald-500' : 'bg-slate-950 border-slate-800 hover:bg-slate-800'}`}>
                      <div className="bg-emerald-500/20 p-2 rounded text-emerald-500"><Plus size={20} /></div>
                      <div>
                        <div className="font-bold text-white">Empezar de Cero</div>
                        <div className="text-xs text-slate-400">Cuenta nueva vacía.</div>
                      </div>
                    </button>
                    <button onClick={() => setData({ ...data, source: 'clone' })} className={`w-full text-left p-4 rounded-xl border flex gap-4 items-center transition-all ${data.source === 'clone' ? 'bg-indigo-900/20 border-indigo-500' : 'bg-slate-950 border-slate-800 hover:bg-slate-800'}`}>
                      <div className="bg-indigo-500/20 p-2 rounded text-indigo-500"><Copy size={20} /></div>
                      <div>
                        <div className="font-bold text-white">Clonar Datos Actuales</div>
                        <div className="text-xs text-slate-400">Copiar historial del usuario principal actual.</div>
                      </div>
                    </button>
                    <div className={`w-full p-4 rounded-xl border transition-all ${data.source === 'cloud' ? 'bg-purple-900/20 border-purple-500' : 'bg-slate-950 border-slate-800'}`}>
                      <div className="flex items-center gap-4 mb-2">
                        <div className="bg-purple-500/20 p-2 rounded text-purple-500"><DownloadCloud size={20} /></div>
                        <div>
                          <div className="font-bold text-white">Importar Backup</div>
                          <div className="text-xs text-slate-400">Cargar archivo JSON (opción contraseña).</div>
                        </div>
                      </div>
                      <input type="file" onChange={handleCloudFile} className="text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-purple-500 file:text-white hover:file:bg-purple-600 mt-2" />
                      {cloudBackup && <div className="text-xs text-green-500 mt-1 font-bold">✅ Backup cargado correctamente</div>}
                    </div>
                  </div>
                </div>
              )}

              {/* STEP 3: BANK */}
              {step === 3 && (
                <div className="space-y-6 animate-fade-in">
                  <h3 className="text-xl font-bold text-white">Configuración Bank</h3>
                  <div>
                    <label className="block text-xs uppercase font-bold text-slate-500 mb-2">Bank Inicial (€)</label>
                    <input type="number" value={data.bank} onChange={e => setData({ ...data, bank: parseFloat(e.target.value) })} className="w-full bg-slate-950 border-2 border-slate-800 focus:border-emerald-500 rounded-lg p-3 text-white text-lg font-mono font-bold outline-none" />
                    <p className="text-xs text-slate-500 mt-2">Esta será tu transacción inicial de ingreso.</p>
                  </div>
                </div>
              )}

              {/* STEP 4: THEME */}
              {step === 4 && (
                <div className="space-y-6 animate-fade-in">
                  <h3 className="text-xl font-bold text-white">Elige tu Tema</h3>
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-[300px] overflow-y-auto pr-2">
                    {Object.values(THEMES).map(t => (
                      <button key={t.id} onClick={() => setData({ ...data, theme: t.id })} className={`p-3 rounded-xl border flex flex-col gap-2 transition-all relative overflow-hidden ${data.theme === t.id ? 'border-2 border-emerald-500 shadow-xl scale-[1.02]' : 'border-slate-800 bg-slate-950 hover:bg-slate-900'}`}>
                        <div className="flex justify-between items-center z-10">
                          <span className="font-bold text-sm" style={{ color: data.theme === t.id ? '#10b981' : t.colors.text }}>{t.name}</span>
                          {data.theme === t.id && <CheckCircle size={16} className="text-emerald-500" />}
                        </div>
                        <div className="h-10 w-full rounded flex overflow-hidden z-10 border border-white/10">
                          <div className="flex-1" style={{ background: t.colors.bg }}></div>
                          <div className="flex-1" style={{ background: t.colors.card }}></div>
                          <div className="flex-1" style={{ background: t.colors.accent }}></div>
                        </div>
                        <div className="text-[10px] opacity-70" style={{ color: t.colors.text }}>{t.vibe}</div>
                      </button>
                    ))}
                  </div>
                </div>
              )}

              {/* FOOTER ACTIONS */}
              <div className="mt-auto pt-8 flex justify-between border-t border-slate-800">
                {step > 1 ? (
                  <button onClick={() => setStep(s => s - 1)} className="px-6 py-2 rounded-lg bg-slate-800 text-slate-300 font-bold hover:bg-slate-700">Atrás</button>
                ) : (
                  <button onClick={onCancel} className="px-6 py-2 rounded-lg bg-red-900/20 text-red-400 font-bold hover:bg-red-900/40">Cancelar</button>
                )}

                {step < 4 ? (
                  <button onClick={() => setStep(s => s + 1)} className="px-8 py-2 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-500 shadow-lg shadow-indigo-900/30 flex items-center gap-2">
                    Siguiente <ChevronRight size={16} />
                  </button>
                ) : (
                  <button onClick={handleFinish} className="px-8 py-2 rounded-lg bg-emerald-600 text-white font-bold hover:bg-emerald-500 shadow-lg shadow-emerald-900/30 flex items-center gap-2 animate-pulse">
                    <Rocket size={16} /> FINALIZAR
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // CONSTANTS
    const DEFAULT_TIPSTERS = [
      { id: 't1', name: 'Zona Tipster (Alta)', defaultStake: 50 },
      { id: 't2', name: 'Club Vip (Media)', defaultStake: 10 },
      { id: 't3', name: 'Club Remates (Media)', defaultStake: 10 },
      { id: 't4', name: 'Elitebets', defaultStake: 5 },
      { id: 't5', name: 'Stakazo', defaultStake: 5 },
      { id: 't6', name: 'Copete', defaultStake: 5 },
      { id: 't7', name: 'Torete', defaultStake: 5 },
      { id: 't8', name: 'Zona Tenis', defaultStake: 5 },
      { id: 't9', name: 'Mezcla-Tips', defaultStake: 5 },
      { id: 't10', name: 'Combis (Apuesta D)', defaultStake: 5 }
    ];

    function PortfolioManager() {
      // --- USER & AUTH STATE (V60) ---
      const [users, setUsers] = useState(() => JSON.parse(localStorage.getItem('users_directory') || '[]'));
      // FIX: If users exist, start at Auth Screen (null). If no users, we might want to prompt migration or start fresh.
      // For now, start null to show AuthScreen.
      const [currentUser, setCurrentUser] = useState(null);
      const [isNewUser, setIsNewUser] = useState(false);

      useEffect(() => localStorage.setItem('users_directory', JSON.stringify(users)), [users]);

      // --- THEME APPLICATOR ---
      useEffect(() => {
        const themeId = currentUser?.theme || 'original';
        const theme = THEMES[themeId] || THEMES.original;
        const root = document.documentElement;

        // Apply CSS Variables
        Object.entries(theme.cssVars).forEach(([key, val]) => root.style.setProperty(key, val));

        // Font Injection (Lazy)
        if (theme.font && !document.getElementById(`font-${themeId}`)) {
          const link = document.createElement('link');
          link.id = `font-${themeId}`;
          link.rel = 'stylesheet';
          // Map simplified font names to Google Fonts URLs (Approximate)
          const fontMap = {
            'ITC Benguiat': 'https://fonts.googleapis.com/css2?family=Benguiat+ITC:wght@400;700&display=swap', // Custom font, might need different handling or fallback
            'Great Vibes': 'https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap',
            'Impact': 'https://fonts.googleapis.com/css2?family=Bangers&display=swap', // Using Bangers for Comic look
            'Coming Soon': 'https://fonts.googleapis.com/css2?family=Coming+Soon&display=swap'
          };
          // Note: ITC Benguiat is not on Google Fonts. Using Serif fallback or nearest match if available.
          // For now, let's assume system fonts or imported elsewhere, or just set the family.
          // Actually, for "Stranger" let's use a Google Font that looks similar e.g. 'Creepster' or just serif.
          if (fontMap[theme.font.split(',')[0].trim()]) {
            link.href = fontMap[theme.font.split(',')[0].trim()];
            document.head.appendChild(link);
          }
        }
        document.body.style.fontFamily = theme.font;
      }, [currentUser]);

      // --- DATA RELOAD ON USER CHANGE (V60) ---
      useEffect(() => {
        if (!currentUser) return;
        console.log("Loading data for user:", currentUser.name);

        // Load all data from DB (User Namespaced)
        setBets(DB.get(currentUser.id, 'betPortfolioV29_bets', []));
        setTipsters(DB.get(currentUser.id, 'betPortfolioV29_tipsters', DEFAULT_TIPSTERS));
        setChallenges(DB.get(currentUser.id, 'betPortfolioV29_challenges', initialChallenges));

        const bankData = DB.get(currentUser.id, 'betPortfolioV29_bank', { transactions: [] });
        setBankTransactions(bankData.transactions || []);

        setUserTags(DB.get(currentUser.id, 'betPortfolioV33_tags', DEFAULT_TAGS));

        const era = DB.get(currentUser.id, 'betPortfolio_eraResetDate', null);
        setEraResetDate(era);
        setEraFilter(era ? 'AFTER' : 'ALL');

      }, [currentUser]);

      const [activeSection, setActiveSection] = useState('dashboard');
      const [sidebarOpen, setSidebarOpen] = useState(false);

      // V18: GLOBAL BANK MANAGEMENT (Moved to top to fix ReferenceError)
      const [bankTransactions, setBankTransactions] = useState([]);
      const [showBankManager, setShowBankManager] = useState(false);

      // --- SUPER SIMULATOR STATE (V40) ---

      // CONFIGURACIÃ“N DE TIPSTERS (DINÁMICA V11 - Refactor V30)
      const [tipsters, setTipsters] = useState(() => {
        const saved = localStorage.getItem('betPortfolioV29_tipsters');
        try {
          let loaded = saved ? JSON.parse(saved) : DEFAULT_TIPSTERS;
          // FIX: Ensure all tipsters have IDs (Migration for legacy data)
          if (Array.isArray(loaded)) {
            loaded = loaded.map((t, i) => ({
              ...t,
              id: t.id || `legacy_${Date.now()}_${i}`,
              originalName: t.originalName || t.name // Backfill persistence
            }));
          }
          return loaded;
        } catch (e) { return DEFAULT_TIPSTERS; }
      });
      useEffect(() => { DB.set(currentUser?.id, 'betPortfolioV29_tipsters', tipsters); }, [tipsters, currentUser]);

      // ETIQUETAS DINÁMICAS (V33)
      const DEFAULT_TAGS = ['ALL', 'FUNBET', 'LIVE', 'PREMATCH', 'STAKE ALTO', 'RETOS'];
      const [userTags, setUserTags] = useState(() => {
        const saved = localStorage.getItem('betPortfolioV33_tags');
        return saved ? JSON.parse(saved) : DEFAULT_TAGS;
      });
      useEffect(() => { DB.set(currentUser?.id, 'betPortfolioV33_tags', userTags); }, [userTags, currentUser]);
      const [showTipsterManager, setShowTipsterManager] = useState(false);

      // PERSISTENCIA TIPSTERS
      // DUPLICATE REMOVED


      // PERSISTENCIA BANK (V30)
      useEffect(() => {
        const savedBank = localStorage.getItem('betPortfolioV29_bank');
        if (savedBank) {
          const parsed = JSON.parse(savedBank);
          setBankTransactions(parsed.transactions || []);
          // currentGlobalBank is derived, no need to save directly if transactions are saved
        }
      }, []);

      useEffect(() => { DB.set(currentUser?.id, 'betPortfolioV29_bank', { transactions: bankTransactions }); }, [bankTransactions, currentUser]);

      const handleAddTipster = (name, stake) => {
        if (tipsters.some(t => t.name.toLowerCase() === name.toLowerCase())) {
          alert("¡Este Tipster ya existe!");
          return;
        }
        setTipsters([...tipsters, { id: Date.now(), name, originalName: name, defaultStake: parseFloat(stake) || 10 }]);
      };

      const handleEditTipster = (id, newName, newStake) => {
        setTipsters(tipsters.map(t => t.id === id ? { ...t, name: newName, defaultStake: parseFloat(newStake) } : t));
      };

      const handleDeleteTipster = (id) => {
        if (confirm("¿Eliminar tipster? Sus apuestas históricas se mantendrán, pero no aparecerá en el selector.")) {
          setTipsters(tipsters.filter(t => t.id !== id));
        }
      };

      // HISTORIAL DE APUESTAS (BASE DE DATOS COMPLETA - CORREGIDA V29)
      const fullHistory = [
        // --- DÍA 3 (17 Dic) ---
        {
          id: 20, date: '2025-12-17', tipster: 'Combis (Apuesta D)', stake: 5.00, odds: 10.28, result: 'pending', description: 'Celta class + Villarreal class + Madrid gana + Brentford +7.5r + Fulham +9.5r + PSG', profit: 0, subPicks: []
        },
        {
          id: 19, date: '2025-12-17', tipster: 'Mezcla-Tips', stake: 5.00, odds: 1.44, result: 'pending', description: 'Alexander Blockx (Apuesta Compartida)', profit: 0,
          subPicks: [
            { id: 's4', tipster: 'Torete', status: 'pending', detail: 'Alexander Blockx (Shared)' },
            { id: 's5', tipster: 'Elitebets', status: 'pending', detail: 'Alexander Blockx (Shared)' }
          ]
        },
        {
          id: 18, date: '2025-12-17', tipster: 'Copete', stake: 5.00, odds: 1.47, result: 'pending', description: 'Herlev Eagels', profit: 0, subPicks: []
        },
        {
          id: 17, date: '2025-12-17', tipster: 'Stakazo', stake: 5.00, odds: 1.96, result: 'win', description: 'Jose David Segovia + Kabeer Kapasi', profit: 4.82, subPicks: []
        },

        // --- DÍA 2 (16 Dic) ---
        {
          id: 15, date: '2025-12-16', tipster: 'Club Remates (Media)', stake: 10.00, odds: 2.00, result: 'loss', description: 'Joel Colwill (1+ Remates) + Chelsea Gana', profit: -10.00, subPicks: []
        },
        {
          id: 14, date: '2025-12-16', tipster: 'Copete', stake: 5.00, odds: 1.90, result: 'loss', description: 'Bolívar Gana y +2.5 Goles', profit: -5.00, subPicks: []
        },
        {
          id: 13, date: '2025-12-16', tipster: 'Club Vip (Media)', stake: 10.00, odds: 2.37, result: 'win', description: 'Tyrique George (+1.5 Remates a Puerta)', profit: 13.70, subPicks: []
        },
        {
          id: 12, date: '2025-12-16', tipster: 'Combis (Apuesta D)', stake: 5.00, odds: 11.56, result: 'loss', description: 'Copa: Real Sociedad + Mallorca X2 (Fallo) + Elche Clasif + BarÃ§a a 0 + Valencia Clasif', profit: -5.00, subPicks: []
        },
        {
          id: 11, date: '2025-12-16', tipster: 'Zona Tipster (Alta)', stake: 50.00, odds: 1.61, result: 'win', description: 'Cardiff (+7.5 Remates) vs Chelsea', profit: 30.50, subPicks: []
        },
        {
          id: 10, date: '2025-12-16', tipster: 'Elitebets', stake: 5.00, odds: 1.50, result: 'loss', description: 'Peter Goldsteinier Gana', profit: -5.00, subPicks: []
        },
        {
          id: 9, date: '2025-12-16', tipster: 'Torete', stake: 5.00, odds: 1.66, result: 'loss', description: 'Sporting de Gijón Gana o Empata', profit: -5.00, subPicks: []
        },
        {
          id: 8, date: '2025-12-16', tipster: 'Copete', stake: 5.00, odds: 1.57, result: 'win', description: 'Hapoel Tel Aviv Gana + BarÃ§a Gana y +1.5 Goles', profit: 2.85, subPicks: []
        },

        // --- DÍA 1 (15 Dic) ---
        {
          id: 1, date: '2025-12-15', tipster: 'Mezcla-Tips', stake: 5.00, odds: 2.42, result: 'win', description: 'Combinada Mixta Día 1', profit: 7.10,
          subPicks: [
            { id: 's1', tipster: 'Torete', status: 'win', detail: 'CD Castellón' },
            { id: 's2', tipster: 'Elitebets', status: 'win', detail: 'Jakub Prachar' },
            { id: 's3', tipster: 'Copete', status: 'win', detail: 'Rayo Vallecano' }
          ]
        },
        {
          id: 2, date: '2025-12-15', tipster: 'Stakazo', stake: 5.00, odds: 1.92, result: 'win', description: 'Combinada Doble Tenis (Axel + John)', profit: 4.60, subPicks: []
        },
        {
          id: 3, date: '2025-12-15', tipster: 'Combis (Apuesta D)', stake: 5.00, odds: 13.01, result: 'win', description: 'Remates: Serrano, Athletic, Mbappé...', profit: 60.05, subPicks: []
        },
        {
          id: 4, date: '2025-12-15', tipster: 'Club Remates (Media)', stake: 10.00, odds: 1.50, result: 'loss', description: 'Bournemouth (Menos 13.5) + Senne', profit: -10.00, subPicks: []
        },
        {
          id: 5, date: '2025-12-15', tipster: 'Zona Tipster (Alta)', stake: 50.00, odds: 1.70, result: 'win', description: 'Rayo Vallecano (+11.5 Remates) + No Roja', profit: 35.00, subPicks: []
        },
        {
          id: 6, date: '2025-12-15', tipster: 'Club Vip (Media)', stake: 10.00, odds: 1.53, result: 'win', description: 'Samuel Aghehowa (1.5+ Tiros Puerta)', profit: 5.30, subPicks: []
        },
        {
          id: 7, date: '2025-12-15', tipster: 'Combis (Apuesta D)', stake: 5.00, odds: 5.57, result: 'loss', description: 'Triple Combinada Remates', profit: -5.00, subPicks: []
        }
      ];

      // ESTADO APUESTAS PORTFOLIO
      const [bets, setBets] = useState([]);

      // --- ERA LOGIC (V50) ---
      const [eraResetDate, setEraResetDate] = useState(() => localStorage.getItem('betPortfolio_eraResetDate'));
      const [eraFilter, setEraFilter] = useState(() => {
        // Default to ALL, or AFTER if a reset exists? User said "want to choose".
        // Let's default to ALL to avoid hiding data unexpectedly, or AFTER if they just reset.
        // If reset exists, 'AFTER' is a good active default.
        return localStorage.getItem('betPortfolio_eraResetDate') ? 'AFTER' : 'ALL';
      });

      useEffect(() => {
        if (eraResetDate) localStorage.setItem('betPortfolio_eraResetDate', eraResetDate);
        else localStorage.removeItem('betPortfolio_eraResetDate');
      }, [eraResetDate]);

      const handleGlobalReset = () => {
        if (confirm("⚠️ ¿EMPEZAR NUEVA ERA?\n\nEsto marcará un 'Antes y Después'.\n- Todo lo anterior se guardará en 'Antes'.\n- Las gráficas empezarán de 0 (Después).\n- Podrás volver a ver 'Todo' o 'Antes' cuando quieras.\n\n¿Confirmar corte?")) {
          const now = new Date().toISOString();
          setEraResetDate(now);
          setEraFilter('AFTER');
          alert("✅ ¡Nueva Era comenzada! Ahora verás todo desde 0.");
        }
      };

      const filterByEra = (items, dateField = 'date') => {
        if (!eraResetDate || eraFilter === 'ALL') return items;
        const splitTime = new Date(eraResetDate).getTime();

        return items.filter(item => {
          let itemTime = 0;
          // Prefer ID if it's a timestamp (Bet IDs from Date.now() > 2020)
          if (item.id && typeof item.id === 'number' && item.id > 1600000000000) {
            itemTime = item.id;
          } else {
            // Fallback to Date field (Legacy or Challenges with small IDs)
            // Ensure we parse the date string correctly as UTC or Local consistent with ResetDate
            // ResetDate is ISO. item.date is usually YYYY-MM-DD.
            // new Date('2024-01-01') defaults to UTC midnight in some browsers or local in others.
            // Safer: append time if missing? Or just compare.
            itemTime = new Date(item[dateField]).getTime();
          }

          if (eraFilter === 'BEFORE') {
            // Strict inequality: Before the reset moment
            return itemTime < splitTime;
          } else {
            // AFTER: Equal or greater than reset moment (New Era)
            return itemTime >= splitTime;
          }
        });
      };

      // ESTADO RETOS
      const initialChallenges = [
        {
          id: 1,
          title: 'Escalera iPhone (Copete)',
          subtitle: 'Objetivo 1.000€ (Navidad)',
          initialBank: 30,
          currentBank: 54.00,
          targetBank: 1000,
          color: 'emerald',
          status: 'active',
          history: [
            {
              id: 1001,
              date: '2025-12-16',
              stake: 30.00,
              odds: 1.80,
              description: 'Paso 1: Hapoel Tel Aviv Gana + Paris Under 96.5pts',
              result: 'win',
              profit: 24.00
            }
          ]
        },
        {
          id: 2,
          title: 'Reto Torete ITF',
          subtitle: 'Objetivo 10.000€',
          initialBank: 100,
          currentBank: 570,
          targetBank: 10000,
          color: 'blue',
          history: [
            {
              id: 1002,
              date: '2025-12-16',
              stake: 470.00,
              odds: 1.45,
              description: 'Paso Fuerte: Becroft + K.Smith + Kuhar + Sach',
              result: 'loss',
              profit: -470.00
            },
            {
              id: 999,
              date: '2025-12-15',
              stake: 100,
              odds: 5.70,
              description: 'Ganancias Acumuladas Previas (Ajuste Inicial)',
              result: 'win',
              profit: 470
            }
          ]
        },
        {
          id: 3,
          title: 'Reto Torete NextGen',
          subtitle: 'Objetivo 11.000€',
          initialBank: 100,
          currentBank: 100,
          targetBank: 11000,
          color: 'purple',
          status: 'active', // 'active', 'won', 'lost'
          history: [
            {
              id: 1003,
              date: '2025-12-16',
              stake: 100.00,
              odds: 2.00,
              description: 'Dino Prizmic vs Nishesh (Más de 1.5 Tie Breaks)',
              result: 'pending',
              profit: 0
            }
          ]
        },
        {
          id: 4,
          title: 'Reto Elitebets NextGen',
          subtitle: 'Objetivo 1.000€',
          initialBank: 50,
          currentBank: 50,
          targetBank: 1000,
          color: 'orange',
          status: 'active',
          history: [
            {
              id: 1004,
              date: '2025-12-16',
              stake: 50.00,
              odds: 1.57,
              description: 'Dino Prizmic Gana',
              result: 'pending',
              profit: 0
            }
          ]
        }
      ];

      const [challenges, setChallenges] = useState(initialChallenges);

      // ESTADO UI RETOS (V9)
      const [challengeTab, setChallengeTab] = useState('active');
      const [isCreatingChallenge, setIsCreatingChallenge] = useState(false);
      const [newChallengeData, setNewChallengeData] = useState({ title: '', target: '', bank: '', color: 'emerald' });
      const [activeChallengeId, setActiveChallengeId] = useState(null); // ID del reto donde estamos añadiendo un paso
      const [challengeStatsFilter, setChallengeStatsFilter] = useState('ALL');
      const [showCalculator, setShowCalculator] = useState(false);
      const [calculatorData, setCalculatorData] = useState({ mode: 'simple', stake: '10', odds: '', profit: '', targetProfit: '', lines: [{ odds: '', desc: '', void: false }] });
      const [selectedTipsterStats, setSelectedTipsterStats] = useState(null);
      const [whatIfStake, setWhatIfStake] = useState('');

      // FIX: Missing State for Retos Crash
      const [isChallengeMulti, setIsChallengeMulti] = useState(false);

      // ESTADO IA SYSTEM (V_IA)
      const [iaBetData, setIaBetData] = useState({
        m1: { name: '', s1: { score: '', odds: '' }, s2: { score: '', odds: '' } },
        m2: { name: '', s1: { score: '', odds: '' }, s2: { score: '', odds: '' } }
      });

      // ESTADO FORMULARIO APUESTA RETO (V14: Tipster Support)
      const [challengeForm, setChallengeForm] = useState({ id: null, stake: '', odds: '', profit: '', desc: '', tipster: '', lines: [] });

      // ERA FILTERED DATA (Approved Source of Truth)
      const betsByEra = useMemo(() => filterByEra(bets, 'date'), [bets, eraFilter, eraResetDate]);
      const challengesByEra = useMemo(() => filterByEra(challenges, 'date'), [challenges, eraFilter, eraResetDate]); // Using 'date' of challenge creation? Or last update? 
      // Challenges don't always have a single date. They have 'history'. 
      // Maybe filter challenges based on if their *first* bet was after reset? OR if they were created after reset?
      // Existing challenges have 'id' as timestamp. We can use that!
      // Revised: filterByEra(challenges, 'id') assuming id is timestamp.
      // Wait, item[dateField] expects a dateable string or number. new Date(number) works.

      // AUTO-CALC ODDS for Challenge Form (Live)
      useEffect(() => {
        if (isChallengeMulti && challengeForm.lines.length > 0) {
          const calc = challengeForm.lines.reduce((acc, l) => acc * (parseFloat(l.odds) || 1), 1);
          if (calc > 1) setChallengeForm(prev => ({ ...prev, odds: calc.toFixed(2) }));
        }
      }, [challengeForm.lines, isChallengeMulti]);

      const [resolutionChallengeBet, setResolutionChallengeBet] = useState(null); // V17: Granular Challenge Resolution

      // V20: RESTORED MAIN BET FORM STATE
      // V20: RESTORED MAIN BET FORM STATE & LEGACY CONSOLIDATION
      const [formDescription, setFormDescription] = useState('');
      const [formStake, setFormStake] = useState('10');
      const [formOdds, setFormOdds] = useState('');
      // Default Date: IF in 'AFTER' Era, ensure default date is TODAY. 
      // If 'BEFORE', we might want to default to today too (and it will just show in ALL/AFTER unless we forbid adding to BEFORE?)
      // User didn't ask to forbid adding old bets. Just "Start from 0".
      const [formDate, setFormDate] = useState(new Date().toISOString().split('T')[0]);
      const [formResult, setFormResult] = useState('pending');
      const [formTipster, setFormTipster] = useState('Personal');
      const [formTag, setFormTag] = useState('ALL');
      const [manualProfit, setManualProfit] = useState('');
      const [isMulti, setIsMulti] = useState(false);
      const [betLines, setBetLines] = useState([]);

      // Legacy State (Moved from line ~1087 to prevent ReferenceErrors)
      const [formDesc, setFormDesc] = useState('');
      const [formTags, setFormTags] = useState('');

      // V41: Interactive Tipster Chart State
      const [compSelectedTipsters, setCompSelectedTipsters] = useState([]);

      const addChallengeLine = () => setChallengeForm({ ...challengeForm, lines: [...challengeForm.lines, { desc: '', odds: '', tipster: challengeForm.tipster || '' }] });
      const updateChallengeLine = (idx, field, val) => {
        const newLines = [...challengeForm.lines];
        newLines[idx][field] = val;
        setChallengeForm({ ...challengeForm, lines: newLines });
      };
      const removeChallengeLine = (idx) => setChallengeForm({ ...challengeForm, lines: challengeForm.lines.filter((_, i) => i !== idx) });

      // ESTADO EDICIÃ“N EN VIVO (V10)
      const [editingBet, setEditingBet] = useState(null);

      // ESTADO HISTORIAL 2.0 (V12)
      const [historyFilters, setHistoryFilters] = useState({ range: 'today', customDate: '', tipster: 'ALL', odds: 'ALL' });
      const [expandedBets, setExpandedBets] = useState([]); // Array of IDs

      // RECOVERY TOOL STATE
      const [showRecoveryModal, setShowRecoveryModal] = useState(false);
      const [recoveryKeys, setRecoveryKeys] = useState([]);

      // GRANULAR IMPORT STATE (V45)
      const [importModalOpen, setImportModalOpen] = useState(false);
      const [pendingImportData, setPendingImportData] = useState(null);
      const [editingChallengeBet, setEditingChallengeBet] = useState(null); // Challenge Edit State

      const confirmImport = (selection) => {
        if (!pendingImportData) return;

        try {
          // Backup current state before overwriting (Safety Net)
          localStorage.setItem('betPortfolioV29_backup_pre_import_' + Date.now(), JSON.stringify({ bets, challenges, tipsters, userTags }));

          if (selection.includeBets && pendingImportData.bets) {
            setBets(pendingImportData.bets);
            localStorage.setItem('betPortfolioV29_bets', JSON.stringify(pendingImportData.bets));
          }
          if (selection.includeChallenges && pendingImportData.challenges) {
            setChallenges(pendingImportData.challenges);
            localStorage.setItem('betPortfolioV29_challenges', JSON.stringify(pendingImportData.challenges));
          }
          if (selection.includeTipsters && pendingImportData.tipsters) {
            setTipsters(pendingImportData.tipsters);
            localStorage.setItem('betPortfolioV29_tipsters', JSON.stringify(pendingImportData.tipsters));
          }
          if (selection.includeConfig) {
            if (pendingImportData.tags) {
              setUserTags(pendingImportData.tags);
              localStorage.setItem('betPortfolioV33_tags', JSON.stringify(pendingImportData.tags));
            }
            if (pendingImportData.eraResetDate) {
              setEraResetDate(pendingImportData.eraResetDate);
              localStorage.setItem('betPortfolio_eraResetDate', pendingImportData.eraResetDate);
              setEraFilter('AFTER'); // Default to AFTER if importing an Era
            }
            if (pendingImportData.bankTransactions) {
              setBankTransactions(pendingImportData.bankTransactions);
              localStorage.setItem('betPortfolioV29_bank', JSON.stringify({ transactions: pendingImportData.bankTransactions }));
            }
          }

          const msg = `✅ RESTAURACIÃ“N COMPLETADA:

- Apuestas: ${selection.includeBets && pendingImportData.bets ? pendingImportData.bets.length : 'Sin cambios'}
- Retos: ${selection.includeChallenges && pendingImportData.challenges ? pendingImportData.challenges.length : 'Sin cambios'}
- Tipsters: ${selection.includeTipsters && pendingImportData.tipsters ? pendingImportData.tipsters.length : 'Sin cambios'}

La página se recargará ahora.`;
          alert(msg);

          setImportModalOpen(false);
          setPendingImportData(null);
          window.location.reload(); // Force reload to ensure clean state
        } catch (e) {
          alert("Error crítico al importar: " + e.message);
        }
      };

      const scanStorage = () => {
        const keys = Object.keys(localStorage);
        const data = keys.map(k => {
          const content = localStorage.getItem(k);
          return {
            key: k,
            size: content ? content.length : 0,
            preview: content ? (content.substring(0, 50) + '...') : '(vacío)',
            isCurrent: k === 'betPortfolioV29_challenges'
          };
        }).sort((a, b) => b.size - a.size); // Sort by size to find big data chunks
        setRecoveryKeys(data);
        setShowRecoveryModal(true);
      };

      // --- SUPABASE CLOUD SYNC (V32) ---
      const defaultCloudConfig = {
        url: 'https://ceplypympnznkwkfmoto.supabase.co',
        key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlcGx5cHltcG56bmt3a2Ztb3RvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzOTE0MTUsImV4cCI6MjA4MTk2NzQxNX0.IiRuMj4rOeGtMB4042r1DMDT7CVK_m6hP-cJrcJ-S8I',
        key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlcGx5cHltcG56bmt3a2Ztb3RvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzOTE0MTUsImV4cCI6MjA4MTk2NzQxNX0.IiRuMj4rOeGtMB4042r1DMDT7CVK_m6hP-cJrcJ-S8I',
        syncId: 'mi_cartera_v1', // ID por defecto, el usuario puede cambiarlo
        autoSync: true // V34: Auto-Sync Default ON
      };

      const [cloudConfig, setCloudConfig] = useState(() => {
        const saved = localStorage.getItem('betPortfolioV32_cloudConfig');
        return saved ? JSON.parse(saved) : defaultCloudConfig;
      });
      const [showCloudModal, setShowCloudModal] = useState(false);
      const [cloudStatus, setCloudStatus] = useState('idle'); // idle, uploading, downloading, success, error

      useEffect(() => {
        localStorage.setItem('betPortfolioV32_cloudConfig', JSON.stringify(cloudConfig));
        if (cloudConfig.url && cloudConfig.key) {
          SupabaseService.init(cloudConfig.url, cloudConfig.key);
        }
      }, [cloudConfig]);

      const getSupabase = () => {
        if (!cloudConfig.url || !cloudConfig.key) return null;
        return window.supabase.createClient(cloudConfig.url, cloudConfig.key);
      };

      const handleCloudUpload = async (silent = false) => {
        if (!SupabaseService.isConnected()) {
          if (!silent) alert("Faltan credenciales. Configúralas en Zona de Peligro.");
          return;
        }
        if (!currentUser) return !silent && alert("Usuario no activo");

        if (!silent) setCloudStatus('uploading');

        try {
          // 1. Relational Upload (Phase 5)
          // Profile (Upsert user info)
          await SupabaseService.save('profiles', {
            id: currentUser.id, // Warning: If 'id' is numeric (Date.now()), UUID validation will fail in Postgres.
            // FIX: We need a UUID mapping or use Supabase Auth to get UUID.
            // Temporary Hack: IF id is numeric, we might fail. 
            // Ideally we authenticat via Supabase Auth. 
            // But for this "Migration Tool", let's assuming we are using the text ID if schema allows, OR we rely on 'cloudConfig.syncId' as the "User UUID" equivalent?
            // Let's use 'cloudConfig.syncId' as the UUID if provided, else we are in trouble.
            // The user is just "Exporting". 
            // If we really want Social, we NEED unique IDs.
            // Fallback: If current ID is numeric, generate a UUID or use syncId.
            // Let's assume schema allows text ID or we fixed it? No, schema says UUID.
            // We will try to use the raw ID. If it fails, we alert user.
            username: currentUser.name,
            avatar_url: currentUser.avatar,
            theme: currentUser.theme,
            era_reset_date: eraResetDate, // V50: Sync Era
            password: currentUser.password // V61: Sync Password
          });

          const betsPayload = bets.map(b => ({ ...b, user_id: currentUser.id }));
          const tipstersPayload = tipsters.map(t => ({ ...t, user_id: currentUser.id }));
          const bankPayload = bankTransactions.map(b => ({ ...b, user_id: currentUser.id }));

          await SupabaseService.save('bets', betsPayload);
          await SupabaseService.save('tipsters', tipstersPayload);
          await SupabaseService.save('bank_transactions', bankPayload);

          if (!silent) {
            setCloudStatus('success');
            setTimeout(() => setCloudStatus('idle'), 3000);
            alert("✅ ¡Sincronización Relacional Completa!");
          }
        } catch (e) {
          console.error("Cloud Error:", e);
          if (!silent) {
            setCloudStatus('error');
            alert("Error Sync: " + (e.message || e));
          }
        }
      };

      const handleCloudDownload = async () => {
        if (!SupabaseService.isConnected()) return alert("Desconectado de Supabase");
        if (!currentUser) return;
        setCloudStatus('downloading');
        try {
          const data = await SupabaseService.fetchFullProfile(currentUser.id);
          if (data && (data.bets || data.tipsters)) {
            if (data.bets) { setBets(data.bets); DB.set(currentUser.id, 'betPortfolioV29_bets', data.bets); }
            if (data.tipsters) { setTipsters(data.tipsters); DB.set(currentUser.id, 'betPortfolioV29_tipsters', data.tipsters); }
            if (data.bank) { setBankTransactions(data.bank); DB.set(currentUser.id, 'betPortfolioV29_bank', { transactions: data.bank }); }

            setCloudStatus('success');
            alert("✅ ¡Datos descargados de la nube!");
          } else {
            throw new Error("No se encontraron datos remotos.");
          }
          setTimeout(() => setCloudStatus('idle'), 3000);
        } catch (e) {
          console.error(e);
          setCloudStatus('error');
          alert("Error Descarga: " + e.message);
        }
      };

      const restoreBackup = (key) => {
        if (!confirm(`¿Estás seguro de REEMPLAZAR los datos actuales con la copia "${key}"? Esta acción reiniciará la página.`)) return;
        try {
          const raw = localStorage.getItem(key);
          // Auto-detect target (bets vs challenges based on key name or content?)
          // For safety, we ask the user what this is, or we deduce it.
          // Fallback: If key contains 'challenges', restore to challenges key.

          let targetKey = 'betPortfolioV29_challenges'; // Default target for this crisis
          if (key.includes('bets')) targetKey = 'betPortfolioV29_bets';

          // CRITICAL: Copy content to ACTIVE key
          localStorage.setItem(targetKey, raw);
          alert("Datos restaurados correctamente. Recargando...");
          window.location.reload();
        } catch (e) {
          alert("Error al restaurar: " + e.message);
        }
      };

      const toggleHistoryExpansion = (id) => {
        if (expandedBets.includes(id)) {
          setExpandedBets(expandedBets.filter(bid => bid !== id));
        } else {
          setExpandedBets([...expandedBets, id]);
        }
      };

      // EXPANSION FOR CHALLENGE HISTORY
      const [expandedChallengeSteps, setExpandedChallengeSteps] = useState([]);
      const toggleChallengeExpansion = (id) => {
        if (expandedChallengeSteps.includes(id)) setExpandedChallengeSteps(expandedChallengeSteps.filter(i => i !== id));
        else setExpandedChallengeSteps([...expandedChallengeSteps, id]);
      };

      const handleSaveEditedBet = (e) => {
        e.preventDefault();
        if (!editingBet) return;
        setBets(bets.map(b => b.id === editingBet.id ? editingBet : b));
        setEditingBet(null);
      };

      const toggleLineVoid = (lineIndex) => {
        if (!editingBet.betLines) return;
        const newLines = [...editingBet.betLines];
        const line = newLines[lineIndex];
        // Toggle void/active. If void, we mark it.
        // Simplified: We assume pending status unless voided.
        line.status = line.status === 'void' ? 'pending' : 'void';

        // Recalculate Global Odds
        let newOdds = 0;
        const activeLines = newLines.filter(l => l.status !== 'void');
        if (activeLines.length > 0) {
          newOdds = activeLines.reduce((acc, l) => acc * parseFloat(l.odds), 1);
        }

        setEditingBet({ ...editingBet, betLines: newLines, odds: parseFloat(newOdds.toFixed(2)) });
      };

      // LÃ“GICA DE RETOS (V9)
      const handleCreateChallenge = (e) => {
        e.preventDefault();
        const newCh = {
          id: Date.now(),
          title: newChallengeData.title,
          subtitle: `Objetivo ${parseFloat(newChallengeData.target).toLocaleString()}€`,
          initialBank: parseFloat(newChallengeData.bank),
          currentBank: parseFloat(newChallengeData.bank),
          targetBank: parseFloat(newChallengeData.target),
          color: newChallengeData.color,
          status: 'active',
          history: []
        };
        setChallenges([...challenges, newCh]);
        setIsCreatingChallenge(false);
        setNewChallengeData({ title: '', target: '', bank: '', color: 'emerald' });
      };

      const updateChallengeStatus = (id, newStatus) => {
        if (confirm(newStatus === 'won' ? '¿Marcar reto como COMPLETADO/GANADO?' : '¿Marcar reto como FALLIDO? Se moverá al historial.')) {
          setChallenges(challenges.map(c => c.id === id ? { ...c, status: newStatus } : c));
        }
      };

      const rescueChallenge = (oldChallenge) => {
        if (confirm('¿Rescatar este reto? Se creará una copia nueva con el bank inicial original.')) {
          const rescued = {
            ...oldChallenge,
            id: Date.now(),
            title: `${oldChallenge.title} (Rescue)`,
            currentBank: oldChallenge.initialBank,
            status: 'active',
            history: [] // Start fresh
          };
          setChallenges([...challenges, rescued]);
          setChallengeTab('active');
        }
      };

      // --- UTILIDAD: RECALCULAR SALDO RETOS ---
      const recalculateChallengeBank = (challenge) => {
        const historyProfit = challenge.history.reduce((acc, bet) => {
          if (bet.result === 'pending') return acc;
          return acc + bet.profit;
        }, 0);
        return parseFloat((challenge.initialBank + historyProfit).toFixed(2));
      };

      // --- CARGA Y PERSISTENCIA ---
      useEffect(() => {
        const savedBets = localStorage.getItem('betPortfolioV29_bets');
        if (savedBets) setBets(JSON.parse(savedBets));
        else setBets(fullHistory);

        // Al cargar, siempre recalculamos el saldo actual basado en el historial para corregir inconsistencias
        const savedChallenges = localStorage.getItem('betPortfolioV29_challenges');
        let challengesToLoad = savedChallenges ? JSON.parse(savedChallenges) : initialChallenges;

        // Forzamos la actualización de datos 'hardcoded' si estamos en desarrollo o para corregir
        // En este caso, si el usuario ya tiene datos, queremos respetar sus nuevos datos pero corregir el saldo
        // Si usamos initialChallenges (primera carga/cache borrada), recalculamos

        const correctedChallenges = challengesToLoad.map(c => ({
          ...c,
          currentBank: recalculateChallengeBank(c)
        }));

        setChallenges(correctedChallenges);
      }, []);

      useEffect(() => {
        DB.set(currentUser?.id, 'betPortfolioV29_bets', bets);
      }, [bets, currentUser]);

      useEffect(() => {
        DB.set(currentUser?.id, 'betPortfolioV29_challenges', challenges);
      }, [challenges, currentUser]);

      // --- LÃ“GICA PORTFOLIO ---
      const updateSimpleStatus = (id, newStatus) => {
        const targetBet = bets.find(b => b.id === id);
        // Intercept V7 Multi-line or V3 SubPicks for Granular Resolution
        if (targetBet && ((targetBet.betLines && targetBet.betLines.length > 0) || (targetBet.subPicks && targetBet.subPicks.length > 0))) {
          setResolutionBet({ ...targetBet, tempLines: targetBet.betLines || [], tempSubPicks: targetBet.subPicks || [] });
          return;
        } else if (targetBet && (targetBet.tipster === 'Mezcla-Tips' || targetBet.description.includes('Mezcla') || (targetBet.betLines && targetBet.betLines.length === 0 && targetBet.subPicks && targetBet.subPicks.length === 0 && targetBet.tipster.includes('+')))) {
          // Safety check for broken old bets
          alert("âš ï¸ Esta apuesta parece ser una Mezcla antigua o dañada (sin líneas guardadas). Por favor elimínala y créala de nuevo para usar la resolución detallada.");
          return;
        }

        const updatedBets = bets.map(b => {
          if (b.id === id) {
            let newProfit = 0;
            if (newStatus === 'win') newProfit = (b.stake * b.odds) - b.stake;
            if (newStatus === 'loss') newProfit = -b.stake;
            if (newStatus === 'void') newProfit = 0;
            return { ...b, result: newStatus, profit: parseFloat(newProfit.toFixed(2)) };
          }
          return b;
        });
        setBets(updatedBets);
      };

      // (Deleted legacy handleSaveBet to fix conflict)

      const addBetLine = () => {
        setBetLines([...betLines, { tipster: formTipster, description: '', odds: '', result: 'pending' }]);
        setIsMultiLine(true);
      };
      const removeBetLine = (idx) => setBetLines(betLines.filter((_, i) => i !== idx));
      const updateBetLine = (idx, field, val) => {
        const newLines = [...betLines];
        newLines[idx] = { ...newLines[idx], [field]: val };
        setBetLines(newLines);
      };

      const updateSubPickStatus = (betId, subPickIndex, newStatus) => {
        const updatedBets = bets.map(b => {
          if (b.id === betId) {
            const newSubPicks = [...b.subPicks];
            newSubPicks[subPickIndex].status = newStatus;
            const anyLoss = newSubPicks.some(sp => sp.status === 'loss');
            const anyPending = newSubPicks.some(sp => sp.status === 'pending');
            let parentResult = 'pending';
            let parentProfit = 0;
            if (anyLoss) { parentResult = 'loss'; parentProfit = -b.stake; }
            else if (!anyPending) { parentResult = 'win'; parentProfit = (b.stake * b.odds) - b.stake; }
            return { ...b, subPicks: newSubPicks, result: parentResult, profit: parseFloat(parentProfit.toFixed(2)) };
          }
          return b;
        });
        setBets(updatedBets);
      };

      const deleteBet = (id) => {
        if (window.confirm("¿Borrar registro permanentemente?")) setBets(bets.filter(b => b.id !== id));
      };

      const deleteGroup = (group) => {
        if (window.confirm(`¿Borrar TODO el grupo de apuestas (${group.children.length}) permanentemente?`)) {
          const idsToDelete = group.children.map(c => c.id);
          setBets(bets.filter(b => !idsToDelete.includes(b.id)));
        }
      };

      // --- LÃ“GICA RETOS ---

      const addChallengeBet = (e, challengeId) => {
        e.preventDefault();
        const updatedChallenges = challenges.map(c => {
          if (c.id === challengeId) {
            const stake = parseFloat(challengeForm.stake);
            let odds = parseFloat(challengeForm.odds);
            const profitInput = parseFloat(challengeForm.profit);

            // AUTO-CALC ODDS FROM PROFIT
            if ((!odds || isNaN(odds)) && profitInput && !isNaN(profitInput) && stake > 0) {
              odds = (profitInput / stake) + 1;
            }

            // AUTO-CALC ODDS FROM MULIT-LINES
            if (isChallengeMulti && challengeForm.lines.length > 0) {
              const combinedOdds = challengeForm.lines.reduce((acc, line) => acc * (parseFloat(line.odds) || 1), 1);
              if (combinedOdds > 1) odds = combinedOdds;
            }

            if (!odds || isNaN(odds)) { alert("Introduce Cuota o Ganancia válida"); return c; }

            // EDIT EXISTING OR CREATE NEW
            let updatedHistory;
            if (editingChallengeBet) {
              updatedHistory = c.history.map(b => {
                if (b.id === editingChallengeBet.id) {
                  return {
                    ...b,
                    stake: stake,
                    odds: parseFloat(odds.toFixed(2)),
                    description: challengeForm.desc,
                    tipster: challengeForm.tipster || 'Personal',
                    betLines: isChallengeMulti ? challengeForm.lines : []
                  };
                }
                return b;
              });
            } else {
              const newBet = {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                stake: stake,
                odds: parseFloat(odds.toFixed(2)),
                description: challengeForm.desc,
                tipster: challengeForm.tipster || 'Personal', // V14 Default
                result: 'pending',
                profit: 0,
                betLines: isChallengeMulti ? challengeForm.lines : []
              };
              updatedHistory = [newBet, ...c.history];
            }

            // RECALCULATE BANK AND RETURN
            // Optimization: If we edit a result that was already won/lost, we should ideally re-calc bank.
            // Simplified: We assume pending for new. For edits, we keep result but update profit potential if needed?
            // User request: ONLY wants to edit Tipster/Description mostly. But if odds change, profit changes.
            // Let's recalculate profit if it was already settled.

            updatedHistory = updatedHistory.map(b => {
              if (b.id === editingChallengeBet?.id && b.result !== 'pending') {
                let newProf = b.profit;
                if (b.result === 'win') newProf = (b.stake * b.odds) - b.stake;
                if (b.result === 'loss') newProf = -b.stake;
                return { ...b, profit: parseFloat(newProf.toFixed(2)) };
              }
              return b;
            });

            // Re-calc Challenge Bank from scratch based on history
            let newBank = c.initialBank;
            // history is usually reverse chronological in array, so we should sum carefully or just sum all profits
            const totalProfit = updatedHistory.reduce((sum, b) => sum + (b.result !== 'pending' ? b.profit : 0), 0);

            return { ...c, history: updatedHistory, currentBank: parseFloat((c.initialBank + totalProfit).toFixed(2)) };
          }
          return c;
        });
        setChallenges(updatedChallenges);
        setChallengeForm({ id: null, stake: '', odds: '', profit: '', desc: '', tipster: '', lines: [] }); // Reset Tipster too
        setIsChallengeMulti(false);
        setEditingChallengeBet(null); // Clear Edit Mode
      };

      const addFunds = (challengeId) => {
        const amount = prompt("¿Cantidad a reingresar (€)?");
        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) return;

        const updatedChallenges = challenges.map(c => {
          if (c.id === challengeId) {
            const deposit = {
              id: Date.now(),
              date: new Date().toISOString().split('T')[0],
              stake: 0,
              odds: 1,
              description: 'Reingreso Saldo 🔄',
              result: 'deposit',
              profit: parseFloat(amount)
            };
            const updatedHistory = [deposit, ...c.history];
            const newChallenge = { ...c, history: updatedHistory };
            newChallenge.currentBank = recalculateChallengeBank(newChallenge);
            return newChallenge;
          }
          return c;
        });
        setChallenges(updatedChallenges);
      };

      const resolveChallengeBet = (challengeId, betId, result) => {
        // V17: Granular Resolution Check
        if (result === 'win') {
          const targetChallenge = challenges.find(c => c.id === challengeId);
          const targetBet = targetChallenge?.history.find(b => b.id === betId);
          if (targetBet && targetBet.lines && targetBet.lines.length > 0) {
            setResolutionChallengeBet({ ...targetBet, challengeId, tempLines: targetBet.lines });
            return;
          }
        }

        const updatedChallenges = challenges.map(c => {
          if (c.id === challengeId) {
            const updatedHistory = c.history.map(b => {
              if (b.id === betId) {
                let profit = 0;
                if (result === 'win') profit = (b.stake * b.odds) - b.stake;
                if (result === 'loss') profit = -b.stake;
                if (result === 'void') profit = 0;
                return { ...b, result, profit };
              }
              return b;
            });
            // Recalculamos banco total
            const newChallenge = { ...c, history: updatedHistory };
            newChallenge.currentBank = recalculateChallengeBank(newChallenge);
            return newChallenge;
          }
          return c;
        });
        setChallenges(updatedChallenges);
      };

      const deleteChallengeBet = (challengeId, betId) => {
        if (!window.confirm("¿Eliminar apuesta del reto? Se recalculará el saldo.")) return;
        const updatedChallenges = challenges.map(c => {
          if (c.id === challengeId) {
            const updatedHistory = c.history.filter(b => b.id !== betId);
            const newChallenge = { ...c, history: updatedHistory };
            newChallenge.currentBank = recalculateChallengeBank(newChallenge);
            return newChallenge;
          }
          return c;
        });
        setChallenges(updatedChallenges);
      };

      // --- TAGS SYSTEM (V3) ---
      const [filterTag, setFilterTag] = useState('ALL');
      const availableTags = useMemo(() => {
        const tags = new Set();
        bets.forEach(b => {
          if (b.tag && b.tag !== 'ALL') tags.add(b.tag); // Legacy singular support
          if (b.tags && Array.isArray(b.tags)) b.tags.forEach(t => tags.add(t));
        });
        return ['ALL', ...Array.from(tags).sort()];
      }, [bets]);

      // Global Filtered Bets
      const filteredBets = useMemo(() => {
        // Step 1: Era Filter (Already applied in betsByEra, but let's use it)
        const source = betsByEra;

        if (filterTag === 'ALL') return source;
        return source.filter(b => b.tags && b.tags.includes(filterTag));
      }, [betsByEra, filterTag]);

      // V51: CONSOLIDATED BETS (System Bet Grouping)
      const consolidatedBets = useMemo(() => {
        const processedGroups = new Set();
        const result = [];
        filteredBets.forEach(bet => {
          if (bet.groupId) {
            if (processedGroups.has(bet.groupId)) return;
            processedGroups.add(bet.groupId);
            // Agrupar apuestas del sistema
            const groupMembers = filteredBets.filter(b => b.groupId === bet.groupId);
            const mainBet = { ...bet }; // Usar la primera como base
            // Recalcular totales
            mainBet.stake = groupMembers.reduce((sum, b) => sum + Number(b.stake), 0);
            mainBet.profit = groupMembers.reduce((sum, b) => sum + Number(b.profit), 0);
            // Determinar estado global
            const isPending = groupMembers.some(b => b.result === 'pending');
            if (isPending) {
              mainBet.result = 'pending';
            } else {
              // Si todo resuelto, calcular resultado neto
              // Simplificación: Profit >= 0 es Win (o void si todo es void)
              const allVoid = groupMembers.every(b => b.result === 'void');
              if (allVoid) mainBet.result = 'void';
              else mainBet.result = mainBet.profit >= 0 ? 'win' : 'loss';
            }
            // Recalcular cuota efectiva (Retorno Total / Stake Total)
            const totalReturn = mainBet.stake + mainBet.profit;
            mainBet.odds = mainBet.stake > 0 ? (totalReturn / mainBet.stake).toFixed(2) : 0;
            // Ajustar descripción para indicar agrupación
            mainBet.description = `[Sistema x${groupMembers.length}] ${bet.groupType || ''} - ${bet.description}`;
            result.push(mainBet);
          } else {
            result.push(bet);
          }
        });
        return result;
      }, [filteredBets]);

      // --- STATS GLOBALES ---
      // (financialStats moved below to consolidate with deep analytics logic)

      const strategyStats = useMemo(() => {
        const stats = {};
        tipsters.forEach(t => { stats[t.name] = { name: t.name, staked: 0, profit: 0, bets: 0, wins: 0, losses: 0, voids: 0, oddsSum: 0, validOddsCount: 0 }; });
        consolidatedBets.forEach(b => {
          if (b.result !== 'pending') {
            if (!stats[b.tipster]) stats[b.tipster] = { name: b.tipster, staked: 0, profit: 0, bets: 0, wins: 0, losses: 0, voids: 0, oddsSum: 0, validOddsCount: 0 };
            if (b.result === 'win') stats[b.tipster].wins += 1;
            if (b.result === 'loss') stats[b.tipster].losses += 1;
            if (b.result === 'void') stats[b.tipster].voids += 1;
            if (b.result !== 'void') {
              stats[b.tipster].staked += b.stake;
              stats[b.tipster].profit += b.profit;
              stats[b.tipster].bets += 1;
              stats[b.tipster].oddsSum += b.odds;
              stats[b.tipster].validOddsCount += 1;
            }
          }
        });
        return Object.values(stats).filter(s => (s.bets > 0 || s.voids > 0)).map(s => ({
          ...s,
          yield: s.staked > 0 ? ((s.profit / s.staked) * 100).toFixed(2) : 0,
          winRate: s.bets > 0 ? ((s.wins / s.bets) * 100).toFixed(0) : 0,
          avgOdds: s.validOddsCount > 0 ? (s.oddsSum / s.validOddsCount).toFixed(2) : '0.00',
          avgStake: s.bets > 0 ? (s.staked / s.bets).toFixed(2) : '0.00'
        })).sort((a, b) => b.profit - a.profit);
      }, [consolidatedBets, tipsters]);

      const scoutStats = useMemo(() => {
        const stats = {};
        tipsters.forEach(t => {
          if (t.name === 'Mezcla-Tips' || t.name.includes('Combis')) return;
          const cleanName = t.name.split(' (')[0];
          stats[cleanName] = { name: cleanName, picks: 0, wins: 0, losses: 0, voids: 0, pending: 0, staked: 0 };
        });
        consolidatedBets.forEach(bet => {
          if (bet.tipster !== 'Mezcla-Tips' && bet.tipster !== 'Combis (Apuesta D)') {
            const cleanName = bet.tipster.split(' (')[0];
            if (stats[cleanName]) {
              if (bet.result === 'win') { stats[cleanName].wins++; stats[cleanName].picks++; }
              if (bet.result === 'loss') { stats[cleanName].losses++; stats[cleanName].picks++; }
              if (bet.result === 'void') { stats[cleanName].voids++; }
              if (bet.result === 'pending') { stats[cleanName].pending++; }
              if (bet.result !== 'void' && bet.result !== 'pending') stats[cleanName].staked += bet.stake;
            }
          }
          if (bet.subPicks && bet.subPicks.length > 0) {
            bet.subPicks.forEach(sub => {
              const cleanName = sub.tipster.split(' (')[0];
              if (stats[cleanName]) {
                if (sub.status === 'win') { stats[cleanName].wins++; stats[cleanName].picks++; }
                if (sub.status === 'loss') { stats[cleanName].losses++; stats[cleanName].picks++; }
                if (sub.status === 'void') { stats[cleanName].voids++; }
                if (sub.status === 'pending') { stats[cleanName].pending++; }
                // SubPicks don't have individual stake usually? They share the main bet stake?
                // Logic issue: If a bet has 3 subpicks, and stake is 5. Does each subpick account for 5?
                // Usually in "Scout" we want to know yield/profit per unit.
                // Assuming flat stake for Scout visualization if not tracked?
                // Actually, let's skip stake for subPicks for now or assume 1 unit?
                // User asked for "Average Stake". Keep it simple. If we don't have stake for subpick, we can't add it.
                // BUT, subPicks are usually inside a Combined Bet.
              }
            });
          }
          // V7 Granular Support (New) with Joint Tipster Support
          // FIX: Only count lines if it is a Mixed/Combi bet. 
          // If it is a Single Tipster with multiple lines, we only want the Main Result (counted above), not each line individually.
          if ((bet.tipster === 'Mezcla-Tips' || bet.tipster === 'Combis (Apuesta D)') && bet.betLines && bet.betLines.length > 0) {
            bet.betLines.forEach(line => {
              const tName = line.tipster || bet.tipster;
              if (!tName) return;
              // Split joint tipsters (e.g., "Torete + Elite")
              const names = tName.split(' + ');
              names.forEach(rawName => {
                const cleanName = rawName.trim().split(' (')[0];
                if (stats[cleanName]) {
                  if (line.result === 'win') { stats[cleanName].wins++; stats[cleanName].picks++; }
                  if (line.result === 'loss') { stats[cleanName].losses++; stats[cleanName].picks++; }
                  if (line.result === 'void') { stats[cleanName].voids++; }
                  if (!line.result || line.result === 'pending' || bet.result === 'pending') { stats[cleanName].pending++; }
                }
              });
            });
          }
        });
        return Object.values(stats).filter(s => s.picks > 0 || s.pending > 0).map(s => ({
          ...s,
          winRate: s.picks > 0 ? ((s.wins / s.picks) * 100).toFixed(1) : 0,
          avgStake: s.picks > 0 && s.staked > 0 ? (s.staked / s.picks).toFixed(2) : '0.00' // Only meaningful for Main Tips
        })).sort((a, b) => parseFloat(b.winRate) - parseFloat(a.winRate));
      }, [consolidatedBets, tipsters]);

      // --- CUOTAS STATS ---
      const oddsStats = useMemo(() => {
        const ranges = [
          { label: 'Seguras (1.0-1.5)', min: 1.0, max: 1.5, bets: 0, profit: 0, staked: 0 },
          { label: 'Valor (1.51-2.0)', min: 1.51, max: 2.0, bets: 0, profit: 0, staked: 0 },
          { label: 'Riesgo (2.01-5.0)', min: 2.01, max: 5.0, bets: 0, profit: 0, staked: 0 },
          { label: 'Lotería (5.0+)', min: 5.01, max: 999, bets: 0, profit: 0, staked: 0 },
        ];
        filteredBets.forEach(b => {
          if (b.result !== 'pending' && b.result !== 'void') {
            const range = ranges.find(r => b.odds >= r.min && b.odds <= r.max);
            if (range) { range.bets++; range.profit += b.profit; range.staked += b.stake; }
          }
        });
        return ranges.filter(r => r.bets > 0).map(r => ({ ...r, yield: r.staked > 0 ? ((r.profit / r.staked) * 100).toFixed(2) : 0 }));
      }, [consolidatedBets]);

      // --- DEEP ANALYTICS ENGINE (SIA-Pro) ---

      // Phase 14: Rescue without Reset
      const resumeChallenge = (challenge) => {
        if (!window.confirm("¿Reactivar el reto manteniendo el historial y saldo actual?")) return;
        setChallenges(challenges.map(c => c.id === challenge.id ? { ...c, status: 'active' } : c));
      };

      // Phase 14: Global Challenge Stats
      const challengesGlobalStats = useMemo(() => {
        const totalChallenges = challenges.length;
        const active = challenges.filter(c => c.status === 'active').length;
        const completed = challenges.filter(c => c.status === 'won').length;
        const failed = challenges.filter(c => c.status === 'lost').length;

        let totalInvested = 0;
        let totalCurrentValue = 0;
        let allSteps = [];

        challenges.forEach(c => {
          // Initial Bank is investment
          let cInvested = c.initialBank;
          // Add deposits
          c.history.forEach(h => {
            if (h.result === 'deposit') cInvested += h.profit;
            else if (h.result !== 'deposit') allSteps.push({ ...h, challengeTitle: c.title, challengeId: c.id });
          });
          totalInvested += cInvested;
          totalCurrentValue += (c.status === 'lost' ? 0 : c.currentBank); // If lost, value is 0? Or residal? Usually 0.
        });

        const totalNetProfit = totalCurrentValue - totalInvested;
        const totalRoi = totalInvested > 0 ? ((totalNetProfit / totalInvested) * 100).toFixed(2) : 0;

        return { totalChallenges, active, completed, failed, totalInvested, totalCurrentValue, totalNetProfit, totalRoi, allSteps };
      }, [challenges]);

      // 1. Drawdown Chart Data
      const drawdownStats = useMemo(() => {
        let currentBank = 1000; // Asumimos bank inicial fijo para visualizacion relativa
        let peak = 1000;
        const data = [];

        // Ordenar apuestas cronologicamente para simular la evolucion
        const sorted = [...consolidatedBets].filter(b => b.result !== 'pending' && b.result !== 'void').sort((a, b) => a.id - b.id);

        sorted.forEach(bet => {
          currentBank += bet.profit;
          if (currentBank > peak) peak = currentBank;
          const dd = ((currentBank - peak) / peak) * 100;
          data.push({
            date: bet.date,
            drawdown: dd.toFixed(2),
            bank: currentBank.toFixed(2)
          });
        });
        return data;
      }, [consolidatedBets]);

      // 2. Streaks (Rachas)
      const streakStats = useMemo(() => {
        let maxWin = 0, maxLoss = 0, current = 0;
        const sorted = [...consolidatedBets].filter(b => b.result !== 'pending' && b.result !== 'void').sort((a, b) => a.id - b.id);

        sorted.forEach(b => {
          if (b.result === 'win') {
            if (current < 0) current = 0;
            current++;
            if (current > maxWin) maxWin = current;
          } else if (b.result === 'loss') {
            if (current > 0) current = 0;
            current--;
            if (Math.abs(current) > maxLoss) maxLoss = Math.abs(current);
          }
        });
        return { maxWin, maxLoss, current: current > 0 ? `+${current}` : current };
      }, [consolidatedBets]);

      // 3. Sniper Chart (Scatter: Odds vs Profit)
      const sniperData = useMemo(() => {
        return consolidatedBets.filter(b => b.result !== 'pending' && b.result !== 'void').map(b => ({
          x: b.odds, // Eje X: Cuota
          y: b.profit, // Eje Y: Beneficio
          z: 1,
          name: b.tipster,
          desc: b.description,
          result: b.result // Needed for coloring
        }));
      }, [consolidatedBets]);

      // --- STATS GLOBALES ---
      const financialStats = useMemo(() => {
        const valid = consolidatedBets.filter(b => b.result !== 'void' && b.result !== 'pending');
        const staked = valid.reduce((acc, b) => acc + b.stake, 0);
        const profit = valid.reduce((acc, b) => acc + b.profit, 0);
        const yield_val = staked > 0 ? ((profit / staked) * 100).toFixed(2) : 0;

        // Gráfico acumulativo Ganancias
        let runningProfit = 0;
        const chartData = [...consolidatedBets]
          .filter(b => b.result !== 'pending')
          .sort((a, b) => new Date(a.date) - new Date(b.date) || a.id - b.id)
          .map(b => {
            runningProfit += b.profit;
            return { name: b.date.slice(5), fullDate: b.date, profit: runningProfit };
          });

        // Gráfico acumulativo PÃ‰RDIDAS (Solo suma los rojos)
        let runningLoss = 0;
        const lossChartData = [...consolidatedBets]
          .filter(b => b.result !== 'pending')
          .sort((a, b) => new Date(a.date) - new Date(b.date) || a.id - b.id)
          .map(b => {
            // Si es perdida, sumamos (en negativo). Si es ganancia, se mantiene plano (o sube si queremos Net Loss? No, Cumulative Loss suelo ser solo las perdidas sumadas).
            // User dijo: "cuente las apuestas perdidas... acumulativa igual que las ganancias".
            // Interpretación: Una linea que baja (o sube en valor absoluto) cada vez que pierdes.
            // Para visualizar "Pérdida Total Acumulada", mejor que vaya bajando (negativo).
            if (b.result === 'loss') runningLoss += b.profit; // b.profit es negativo (-stake)
            return { name: b.date.slice(5), fullDate: b.date, loss: runningLoss };
          });

        // Gráfico Semanal (Weekly Evolution)
        const weeklyMap = {};
        consolidatedBets.filter(b => b.result !== 'pending' && b.result !== 'void').forEach(b => {
          const d = new Date(b.date);
          const onejan = new Date(d.getFullYear(), 0, 1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay() + 1) / 7);
          const key = `W${week}-${d.getFullYear().toString().slice(2)}`; // W42-24

          if (!weeklyMap[key]) weeklyMap[key] = 0;
          weeklyMap[key] += b.profit;
        });

        const weeklyChartData = Object.keys(weeklyMap).map(k => ({
          name: k,
          profit: weeklyMap[k]
        })).sort((a, b) => {
          const [wA, yA] = a.name.substring(1).split('-');
          const [wB, yB] = b.name.substring(1).split('-');
          return parseInt(yA) - parseInt(yB) || parseInt(wA) - parseInt(wB);
        });

        // Gráfico Mensual (New V38)
        const monthlyMap = {};
        consolidatedBets.filter(b => b.result !== 'pending' && b.result !== 'void').forEach(b => {
          const key = b.date.slice(0, 7); // YYYY-MM
          if (!monthlyMap[key]) monthlyMap[key] = 0;
          monthlyMap[key] += b.profit;
        });
        const monthlyChartData = Object.keys(monthlyMap).map(k => ({ name: k, profit: monthlyMap[k] })).sort((a, b) => a.name.localeCompare(b.name));

        // Tag Stats (New V38)
        const tagMap = {};
        consolidatedBets.filter(b => b.result !== 'pending' && b.result !== 'void').forEach(b => {
          const tags = b.tags && b.tags.length > 0 ? b.tags : (b.tag && b.tag !== 'ALL' ? [b.tag] : []);
          tags.forEach(t => {
            if (t === 'ALL') return;
            if (!tagMap[t]) tagMap[t] = { name: t, profit: 0, count: 0 };
            tagMap[t].profit += b.profit;
            tagMap[t].count += 1;
          });
        });
        const tagStats = Object.values(tagMap).sort((a, b) => b.profit - a.profit);

        // Tipster Evolution (Multi-line)
        const tipsterDailyMap = {};
        const activeTipsters = new Set();
        consolidatedBets
          .filter(b => b.result !== 'pending' && b.result !== 'void')
          .sort((a, b) => new Date(a.date) - new Date(b.date))
          .forEach(b => {
            const d = b.date;
            if (!tipsterDailyMap[d]) tipsterDailyMap[d] = { name: d.slice(5), fullDate: d };

            const tName = b.tipster;
            activeTipsters.add(tName);

            if (!tipsterDailyMap[d][tName]) tipsterDailyMap[d][tName] = 0;
            tipsterDailyMap[d][tName] += b.profit;
          });

        const sortedDays = Object.values(tipsterDailyMap).sort((a, b) => new Date(a.fullDate) - new Date(b.fullDate));
        const tipsterRunning = {};
        const tipsterEvolutionData = sortedDays.map(dayObj => {
          const newPoint = { ...dayObj };
          activeTipsters.forEach(t => {
            if (tipsterRunning[t] === undefined) tipsterRunning[t] = 0;
            if (dayObj[t] !== undefined) tipsterRunning[t] += dayObj[t];
            newPoint[t] = parseFloat(tipsterRunning[t].toFixed(2));
          });
          return newPoint;
        });

        // Odds Efficiency (Agent Choice)
        const oddsBuckets = [
          { label: '1.0 - 1.5', min: 1.0, max: 1.5, wins: 0, total: 0 },
          { label: '1.5 - 2.0', min: 1.5001, max: 2.0, wins: 0, total: 0 },
          { label: '2.0 - 3.0', min: 2.0001, max: 3.0, wins: 0, total: 0 },
          { label: '3.0 +', min: 3.0001, max: 999, wins: 0, total: 0 },
        ];
        consolidatedBets.filter(b => b.result !== 'pending' && b.result !== 'void').forEach(b => {
          const o = parseFloat(b.odds);
          const bucket = oddsBuckets.find(buc => o >= buc.min && o <= buc.max);
          if (bucket) {
            bucket.total++;
            if (b.result === 'win') bucket.wins++;
          }
        });

        const oddsEfficiencyData = oddsBuckets.map(b => ({
          name: b.label,
          winRate: b.total > 0 ? parseFloat(((b.wins / b.total) * 100).toFixed(1)) : 0,
          count: b.total
        }));

        // MAX PROFIT (ATH) Logic - SAFE (Reduce instead of Spread)
        const maxProfit = chartData.length > 0 ? chartData.reduce((max, d) => (d.profit > max ? d.profit : max), -Infinity) : 0;

        return { staked, profit, yield_val, chartData, weeklyChartData, monthlyChartData, tagStats, tipsterEvolutionData, activeTipsters: Array.from(activeTipsters).filter(Boolean), oddsEfficiencyData, maxProfit };
      }, [consolidatedBets]);

      // Auto-select all active tipsters when financialStats updates (only if empty to respect user selection)
      // Moved here to avoid ReferenceError
      useEffect(() => {
        if (financialStats.activeTipsters && financialStats.activeTipsters.length > 0 && compSelectedTipsters.length === 0) {
          setCompSelectedTipsters(financialStats.activeTipsters);
        }
      }, [financialStats]);

      // V18: GLOBAL BANK CALCULATION (Moved here to fix ReferenceError)
      const currentGlobalBank = useMemo(() => {
        const initial = bankTransactions.filter(t => t.type === 'initial').reduce((acc, t) => acc + parseFloat(t.amount || 0), 0);
        const deposits = bankTransactions.filter(t => t.type === 'deposit').reduce((acc, t) => acc + parseFloat(t.amount || 0), 0);
        const withdrawals = bankTransactions.filter(t => t.type === 'withdraw').reduce((acc, t) => acc + parseFloat(t.amount || 0), 0);
        const bettingProfit = financialStats.profit || 0;
        if (bankTransactions.length === 0) return 0;
        return initial + deposits - withdrawals + bettingProfit;
      }, [bankTransactions, financialStats.profit]);

      // 4. Heatmap Data (Calendar)
      const heatmapData = useMemo(() => {
        const map = {};
        filteredBets.filter(b => b.result !== 'pending' && b.result !== 'void').forEach(b => {
          if (!map[b.date]) map[b.date] = 0;
          map[b.date] += b.profit;
        });
        // Rellenar ultimos 30 dias para grid
        const days = [];
        for (let i = 29; i >= 0; i--) {
          const d = new Date();
          d.setDate(d.getDate() - i);
          const dateStr = d.toISOString().split('T')[0];
          days.push({
            date: dateStr,
            value: map[dateStr] || 0,
            hasActivity: !!map[dateStr]
          });
        }
        return days;
      }, [filteredBets]);

      // --- FORM STATE (MOVED TO TOP) ---
      // (Consolidated at line 441 to fix scope issues)

      // AI State (V4)
      const [isAnalyzing, setIsAnalyzing] = useState(false);
      const fileInputRef = useRef(null);

      const handleImageUpload = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        setIsAnalyzing(true);
        const reader = new FileReader();
        reader.onloadend = async () => {
          const base64 = reader.result.split(',')[1];
          const prompt = `Analiza esta imagen de una apuesta deportiva. Extrae los siguientes datos en formato JSON estricto:
- stake: cantidad apostada (número).
- totalOdds: cuota total (número).
- description: resumen de la apuesta (texto breve, incluye equipos y mercado).
- lines: array de objetos { description: nombre del evento/mercado, odds: cuota individual }.
- isParlay: booleano, true si detectas multiples lineas o es combinada.
Si no encuentras algún dato, usa null. Devuelve SOLO el JSON sin markdown.`;

          try {
            const data = await analyzeImageWithGemini(base64, prompt);
            if (data) {
              if (data.stake) setFormStake(data.stake);
              if (data.totalOdds) setFormOdds(data.totalOdds);
              if (data.description) setFormDesc(data.description);

              if (data.isParlay && data.lines && data.lines.length > 0) {
                setIsMultiLine(true);
                setBetLines(data.lines.map(l => ({ odds: l.odds || 1.0, description: l.description || '' })));
                if (formTipster !== 'Mezcla-Tips') {
                  // Opcional: Sugerir cambio a Mezcla-Tips si detectamos multiples lineas? 
                  // Dejamos que el usuario decida, pero rellenamos lines.
                }
              } else {
                // setIsMultiLine(false); // No forzamos false para no borrar trabajo manual si el usuario sube foto despues
              }
              // alert("Datos extraídos por Gemini IA correctamente.");
            }
          } catch (err) {
            alert("Error analizando imagen: " + err.message);
          } finally {
            setIsAnalyzing(false);
            if (fileInputRef.current) fileInputRef.current.value = '';
          }
        };
        reader.readAsDataURL(file);
      };

      const handleOracle = async (descOverride = null, oddsOverride = null) => {
        const d = descOverride || formDesc;
        const o = oddsOverride || formOdds;

        if (!d) { alert("No hay descripción para analizar."); return; }

        setIsAnalyzing(true);
        try {
          const prompt = `Actúa como experto en apuestas deportivas. Analiza esta apuesta: "${d}" a cuota @${o}. Estima la probabilidad real (%) y calcula si tiene EV+ (Valor Esperado). Responde en formato corto: "Probabilidad: X% | EV: Positivo/Negativo | Consejo: [Frase corta]".`;
          const text = await analyzeTextWithGemini(prompt);
          alert("🔮 ORACULO GEMINI DICE:\n\n" + text);
        } catch (err) {
          alert("Error Oráculo: " + err.message);
        } finally {
          setIsAnalyzing(false);
        }
      };

      // Multi-linea state
      const [isMultiLine, setIsMultiLine] = useState(false);
      // System Bets State (V42)
      const [systemType, setSystemType] = useState(null); // { name, k, count }
      const [systemStake, setSystemStake] = useState(''); // Stake per bet

      // Simulator State (V5 Refined)
      const [simBank, setSimBank] = useState(1000);
      const [simWinRate, setSimWinRate] = useState(50);
      const [simAvgOdds, setSimAvgOdds] = useState(2.00);
      const [simNumBets, setSimNumBets] = useState(1000);
      const [simResults, setSimResults] = useState(null);

      // V5 New States - Advanced Simulation Controls
      const [simMode, setSimMode] = useState('GLOBAL'); // GLOBAL | TIPSTER
      const [simSelectedTipster, setSimSelectedTipster] = useState('');
      const [excludeFunbets, setExcludeFunbets] = useState(true);
      const [simStakingMode, setSimStakingMode] = useState('FLAT'); // FLAT | COMPOUND
      const [simStake, setSimStake] = useState(10); // Amount for FLAT, % for COMPOUND

      // V41 New: Realistic Portfolio Simulation
      const [simAlgo, setSimAlgo] = useState('SIMPLE'); // SIMPLE | REALISTIC
      const [simPortfolioConfig, setSimPortfolioConfig] = useState([]); // [{ name, weight, winRate, avgOdds, avgStake, enabled }]
      const [simChartTab, setSimChartTab] = useState('evolution'); // evolution | drawdown | distribution
      const [sourceStats, setSourceStats] = useState(null); // { total, wins, losses, winRate, avgOdds }

      // Deep Analytics State
      const [selectedDay, setSelectedDay] = useState(null);
      const [resolutionBet, setResolutionBet] = useState(null);
      const [showAddBetModal, setShowAddBetModal] = useState(false);
      const [chartTimeRange, setChartTimeRange] = useState('ALL');

      // Goal Seeker State
      const [goalProfit, setGoalProfit] = useState(1000);
      const [goalMonth, setGoalMonth] = useState('Próximo Mes');
      const [goalResults, setGoalResults] = useState(null);

      // Bulk Resolution State (Refactored to use standard ResolutionModal)
      // const [showSystemResolutionModal, setShowSystemResolutionModal] = useState(false);
      // const [bulkResGroupId, setBulkResGroupId] = useState(null);
      // const [bulkResLines, setBulkResLines] = useState([]);

      const loadRealStats = () => {
        let sourceBets = [];
        if (simMode === 'GLOBAL') {
          sourceBets = filteredBets.filter(b => b.result !== 'pending' && b.result !== 'void');
        } else if (simMode === 'TIPSTER' && simSelectedTipster) {
          sourceBets = filteredBets.filter(b => b.result !== 'pending' && b.result !== 'void' && b.tipster === simSelectedTipster);
        }

        if (excludeFunbets) {
          sourceBets = sourceBets.filter(b => {
            const d = (b.description || '').toLowerCase();
            const t = (b.tipster || '').toLowerCase();
            const isLuck = d.includes('combi') || d.includes('funbet') || d.includes('loter') || t.includes('combi') || (b.tags && b.tags.includes('FUNBET'));
            return !isLuck;
          });
        }

        if (sourceBets.length === 0) { alert("No hay suficientes datos para calcular estadísticas."); return; }

        // --- GLOBAL STATS (Common) ---
        const wins = sourceBets.filter(b => b.result === 'win').length;
        const losses = sourceBets.filter(b => b.result === 'loss').length;
        const wr = (wins / sourceBets.length) * 100;
        const avgOdds = sourceBets.reduce((a, b) => a + b.odds, 0) / sourceBets.length;

        // Set Source Stats for UI
        setSourceStats({
          total: sourceBets.length,
          wins,
          losses,
          winRate: wr.toFixed(1),
          avgOdds: avgOdds.toFixed(2)
        });

        setSimWinRate(wr.toFixed(1));
        setSimAvgOdds(avgOdds.toFixed(2));

        // --- REALISTIC PORTFOLIO STATS (Mode B) ---
        if (simAlgo === 'REALISTIC') {
          const statsByTipster = {};
          let totalVolume = 0;

          sourceBets.forEach(b => {
            const tName = b.tipster;
            if (!statsByTipster[tName]) statsByTipster[tName] = { name: tName, wins: 0, count: 0, oddsSum: 0, stakeSum: 0 };

            statsByTipster[tName].count++;
            statsByTipster[tName].stakeSum += b.stake;
            if (b.result !== 'void') {
              statsByTipster[tName].oddsSum += b.odds;
              if (b.result === 'win') statsByTipster[tName].wins++;
            }
            totalVolume++;
          });

          const config = Object.values(statsByTipster).map(t => ({
            name: t.name,
            weight: ((t.count / totalVolume) * 100).toFixed(1),
            winRate: t.count > 0 ? ((t.wins / t.count) * 100).toFixed(1) : 0,
            avgOdds: t.count > 0 ? (t.oddsSum / t.count).toFixed(2) : 2.00,
            avgStake: t.count > 0 ? (t.stakeSum / t.count).toFixed(1) : 10,
            enabled: true
          })).sort((a, b) => parseFloat(b.weight) - parseFloat(a.weight));

          setSimPortfolioConfig(config);
          // Removed Alert to be less intrusive
        } else {
          // Removed Alert
        }
      };

      const calculateGoal = () => {
        if (!simWinRate || !simAvgOdds) return;
        const wr = parseFloat(simWinRate) / 100;
        const odds = parseFloat(simAvgOdds);

        const stakeVal = parseFloat(simStake);
        const stake = simStakingMode === 'FLAT' ? stakeVal : (parseFloat(simBank) * (stakeVal / 100));

        const expectedProfitPerBet = (stake * (odds - 1) * wr) - (stake * (1 - wr));

        if (expectedProfitPerBet <= 0) {
          setGoalResults({ error: "Matemáticamente imposible con EV actual (Neutro o Negativo)." });
        } else {
          const target = parseFloat(goalProfit);
          const betsNeeded = target / expectedProfitPerBet;
          setGoalResults({
            betsNeeded: Math.ceil(betsNeeded),
            avgStakeUsed: stake.toFixed(1),
            profitPerBet: expectedProfitPerBet.toFixed(2)
          });
        }
      };

      const runSimulation = () => {
        const iterations = 1000;
        const finals = [];
        let bankruptcies = 0;

        let minResult = Infinity;
        let maxResult = -Infinity;
        let totalResult = 0;

        // Visual Paths
        const visualPaths = [];

        // V2: Stats for new charts
        const allDrawdowns = []; // Store Max Drawdown % of EACH iteration
        let medianRunPath = []; // To store the path of the median result for "Underwater" chart
        let worstRunPath = [];

        // PREPARE REALISTIC CONFIG (Optimization)
        let activePortfolio = [];
        let totalWeight = 0;
        if (simAlgo === 'REALISTIC') {
          activePortfolio = simPortfolioConfig.filter(t => t.enabled && parseFloat(t.weight) > 0);
          totalWeight = activePortfolio.reduce((sum, t) => sum + parseFloat(t.weight), 0);
          if (activePortfolio.length === 0) { alert("¡Selecciona al menos un Tipster activo para la simulación realista!"); return; }
        }

        for (let i = 0; i < iterations; i++) {
          let currentBank = parseFloat(simBank);
          let peakBank = currentBank;
          let maxDD = 0; // Max Drawdown % for this run

          const path = [];
          if (i < 5) path.push({ x: 0, y: currentBank }); // Only store full path for first 5

          let bankrupted = false;

          for (let b = 1; b <= simNumBets; b++) {

            // --- DETERMINISTIC PARAMS FOR THIS BET ---
            let betWinRate = parseFloat(simWinRate);
            let betOdds = parseFloat(simAvgOdds);
            let betStakeBase = parseFloat(simStake);

            if (simAlgo === 'REALISTIC') {
              // Weighted Random Selection
              const r = Math.random() * totalWeight;
              let cum = 0;
              let selected = activePortfolio[0];
              for (let t of activePortfolio) {
                cum += parseFloat(t.weight);
                if (r <= cum) { selected = t; break; }
              }
              betWinRate = parseFloat(selected.winRate);
              betOdds = parseFloat(selected.avgOdds);
              if (simStakingMode === 'FLAT') betStakeBase = parseFloat(selected.avgStake);
            }

            // --- SIMULATION STEP ---
            const won = Math.random() * 100 < betWinRate;
            let stake = 0;

            if (simStakingMode === 'FLAT') {
              stake = betStakeBase;
            } else {
              // Compound: % of CURRENT bank
              if (currentBank > 0) stake = currentBank * (parseFloat(simStake) / 100);
              else stake = 0;
            }

            if (currentBank <= 0 && !bankrupted) {
              bankrupted = true;
            }

            if (currentBank > 0) {
              if (won) {
                currentBank += stake * (betOdds - 1);
              } else {
                currentBank -= stake;
              }
            }

            // Track Peak & Drawdown
            if (currentBank > peakBank) peakBank = currentBank;
            const dd = peakBank > 0 ? (peakBank - currentBank) / peakBank : 0;
            if (dd > maxDD) maxDD = dd;

            if (i < 5 && b % 10 === 0) {
              path.push({ x: b, y: Number(currentBank.toFixed(2)) });
            }
          } // End Bet Loop

          if (i < 5) visualPaths.push({ name: `Sim ${i + 1}`, data: path });

          finals.push({ val: currentBank, mdd: maxDD, pathFragment: path }); // Store rich obj temporarily
          if (currentBank <= 0) bankruptcies++;

          totalResult += currentBank;
          if (currentBank < minResult) minResult = currentBank;
          if (currentBank > maxResult) maxResult = currentBank;
        } // End Iteration Loop

        // --- POST PROCESSING ---
        // 1. Sort by Final Bankroll
        finals.sort((a, b) => a.val - b.val);

        const p10Index = Math.floor(iterations * 0.10);
        const p50Index = Math.floor(iterations * 0.50);
        const p90Index = Math.floor(iterations * 0.90);

        const p10 = finals[p10Index].val;
        const p50 = finals[p50Index].val;
        const p90 = finals[p90Index].val;
        const avg = totalResult / iterations;

        // 2. Histogram Data (Distribution)
        const bucketCount = 20;
        const range = maxResult - minResult;
        const step = range / bucketCount;
        const histogramData = Array.from({ length: bucketCount }, (_, i) => {
          const start = minResult + (i * step);
          const end = start + step;
          return { range: `${(start / 1000).toFixed(1)}k-${(end / 1000).toFixed(1)}k`, count: 0, sortKey: start };
        });

        finals.forEach(f => {
          let bIdx = Math.floor((f.val - minResult) / step);
          if (bIdx >= bucketCount) bIdx = bucketCount - 1;
          histogramData[bIdx].count++;
        });

        // 3. Drawdown Stats (Underwater)
        // We will visualize the "Underwater Chart" of the MEDIAN run (P50) to show a "Representative Experience".
        // Re-construct full path for P50 is expensive if we didn't store it. 
        // We stored bits in 'pathFragment' only for i < 5.
        // Let's generate a FRESH representative run for P50 visual or just use Sim 0 if it's close?
        // Better: Just use the Average MDD statistics for the card.
        const avgMDD = finals.reduce((acc, f) => acc + (f.mdd * 100), 0) / iterations;
        const worstMDD = finals.reduce((acc, f) => Math.max(acc, f.mdd * 100), 0);

        setSimResults({
          best: p90,
          worst: p10,
          avg: avg,
          min: minResult,
          max: maxResult,
          p10: p10,
          p90: p90,
          riskOfRuin: ((bankruptcies / iterations) * 100).toFixed(1),
          avgMDD: avgMDD.toFixed(1),
          worstMDD: worstMDD.toFixed(1),
          paths: visualPaths, // For Evolution Chart
          histogram: histogramData,
          mode: simAlgo
        });
      };

      const updatePortfolioConfig = (index, field, value) => {
        const newConfig = [...simPortfolioConfig];
        newConfig[index][field] = value;
        setSimPortfolioConfig(newConfig);
      };

      // Manual profit

      // Sub-picks para Mezcla-Tips (Legacy/Special logic)
      const [subPicks, setSubPicks] = useState([]);
      const [subTipster, setSubTipster] = useState('');
      const [subDetail, setSubDetail] = useState('');

      // (Removed duplicate availableTags definition)

      // Efecto para calcular cuota total si hay lineas
      useEffect(() => {
        // Updated Logic: Always calc if lines exist (Live Calculation)
        if (betLines.length > 0) {
          const totalOdds = betLines.reduce((acc, line) => acc * (parseFloat(line.odds) || 1), 1);
          const finalOdds = parseFloat(totalOdds.toFixed(2));
          setFormOdds(finalOdds);

          // Auto-calc profit if stake exists
          const s = parseFloat(formStake);
          if (s > 0) {
            const potentialProfit = (s * finalOdds) - s;
            setManualProfit(potentialProfit.toFixed(2));
          }
        }
      }, [betLines, isMultiLine, formTipster, formStake]);

      // --- EDIT MODE EFFECT ---
      // --- EDIT MODE EFFECT ---
      useEffect(() => {
        if (editingBet) {
          // 1. Common Fields
          setFormTipster(editingBet.tipster);
          setFormStake(editingBet.stake);
          setFormOdds(editingBet.odds);
          setFormDescription(editingBet.description);
          setFormDesc(editingBet.description); // Sync legacy
          setFormDate(editingBet.date);
          setFormResult(editingBet.result || 'pending');

          if (editingBet.tag) setFormTag(editingBet.tag);
          if (editingBet.tags) setUserTags(prev => [...new Set([...prev, ...editingBet.tags])]);

          // --- IA SPECIAL LOGIC: RESTORE FORM ---
          if (editingBet.groupType === 'Sistema Marcador Exacto' && editingBet.children && editingBet.children.length === 4) {
            console.log("Restoring IA Bet System:", editingBet);
            try {
              // Parse Description logic: "Roma 1-0 + Lazio 2-0"
              // Child 0: M1 S1 + M2 S1
              // Child 1: M1 S1 + M2 S2
              // Child 2: M1 S2 + M2 S1
              // Child 3: M1 S2 + M2 S2

              // Helper to extract team and score from "TeamName Score" (e.g. "Roma 1-0")
              const parsePart = (str) => {
                const lastSpace = str.lastIndexOf(' ');
                return { name: str.substring(0, lastSpace), score: str.substring(lastSpace + 1) };
              };

              // We can just take Child 0 and Child 3 to get all 4 components (S1/S1 and S2/S2)
              const c0 = editingBet.children[0]; // M1 S1 + M2 S1
              const c3 = editingBet.children[3]; // M1 S2 + M2 S2

              // We need the individual odds. They are in c0.betLines[0].odds, etc.
              const m1s1_line = c0.betLines[0];
              const m2s1_line = c0.betLines[1];
              const m1s2_line = c3.betLines[0];
              const m2s2_line = c3.betLines[1];

              const m1s1 = parsePart(m1s1_line.description);
              const m2s1 = parsePart(m2s1_line.description);
              const m1s2 = parsePart(m1s2_line.description);
              const m2s2 = parsePart(m2s2_line.description);

              setIaBetData({
                m1: { name: m1s1.name, s1: { score: m1s1.score, odds: m1s1_line.odds }, s2: { score: m1s2.score, odds: m1s2_line.odds } },
                m2: { name: m2s1.name, s1: { score: m2s1.score, odds: m2s1_line.odds }, s2: { score: m2s2.score, odds: m2s2_line.odds } }
              });
              setFormTipster('IA'); // Force form switch
            } catch (err) {
              console.error("Error restoring IA form:", err);
            }
          }

          // 2. Handle System / Group Bets
          if (editingBet.isGroup || (editingBet.children && editingBet.children.length > 0)) {
            console.log("Editing System Bet:", editingBet);
            setIsMultiLine(true);

            // Extract Unique Lines from Children (ROBUST)
            const uniqueInfo = new Map();
            try {
              if (editingBet.children && Array.isArray(editingBet.children)) {
                editingBet.children.forEach(child => {
                  if (!child) return;
                  // Case A: Child has betLines (Standard)
                  if (child.betLines && Array.isArray(child.betLines)) {
                    child.betLines.forEach(l => {
                      if (l && l.description) uniqueInfo.set(l.description + l.odds, l);
                    });
                  }
                  // Case B: Child is a Single Bet (treated as a line)
                  else if (child.description && child.odds) {
                    uniqueInfo.set(child.description + child.odds, {
                      description: child.description,
                      odds: child.odds,
                      tipster: child.tipster,
                      result: child.result,
                      status: child.result
                    });
                  }
                });
              }
            } catch (err) {
              console.error("Error extracting system lines:", err);
            }
            // SANITIZE RESTORED LINES TO PREVENT REF ERRORS OR NULL VALUES
            const linesToRestore = Array.from(uniqueInfo.values()).map(l => ({
              description: l.description || '',
              odds: l.odds || '',
              result: l.result || l.status || 'pending',
              tipster: l.tipster || '', // Prevents .split() crash
              isJoint: l.isJoint || false
            }));
            setBetLines(linesToRestore);

            // Attempt to restore System Type (Dynamic Lookup)
            if (linesToRestore.length >= 2) {
              const options = getSystemOptions(linesToRestore.length);
              const found = options.find(s => s.name === editingBet.groupType || (editingBet.description && editingBet.description.includes(s.name)));
              if (found) {
                setSystemType(found);
                setSystemStake(editingBet.children[0]?.stake || 0);
              }
            }

          } else if (editingBet.betLines && editingBet.betLines.length > 0) {
            // 3. Normal Parlay
            setIsMultiLine(true);
            setBetLines(editingBet.betLines.map(l => ({
              ...l,
              result: l.result || l.status || 'pending'
            })));
            setSystemType(null);
          } else {
            // 4. Single Bet
            if (editingBet.subPicks && editingBet.subPicks.length > 0) {
              // Legacy SubPicks
              setIsMultiLine(false); // or true? Legacy subpicks usually meant single bet with details. Keeping false.
              setSubPicks(editingBet.subPicks);
            } else {
              setIsMultiLine(false);
              setBetLines([]);
            }
            setSystemType(null);
          }

          setShowAddBetModal(true);
        }
      }, [editingBet]);

      // FIX: Auto-Calc Proportional Change from Profit
      const handleManualProfitChange = (e) => {
        const val = e.target.value;
        setManualProfit(val);
        // Only auto-calc odds if NOT editing a resolved bet (otherwise we might just want to fix profit)
        // But if user changes profit, odds usually implied change.
        const impliedOdds = calculateOddsFromProfit(val);
        if (impliedOdds > 0) setFormOdds(impliedOdds);
      };

      // --- REPEAT BET LOGIC ---
      const handleRepeatBet = (bet) => {
        // 1. Reset Form
        setFormDescription(bet.description || '');
        setFormStake(bet.stake || '');
        setFormOdds(bet.odds || '');
        setFormTipster(bet.tipster || 'Tipster A');
        setFormTag(bet.tag || '');
        setFormResult('pending');
        setFormDate(new Date().toISOString().split('T')[0]);

        // 2. Handle Multi/System
        // 2. Handle Multi/System
        // FIX: Ensure we check for children if isGroup is passed
        if (bet.isGroup || (bet.groupId && bet.isSystemBet) || (bet.children && bet.children.length > 0)) {
          console.log("Detected System/Group Bet:", bet);

          // --- IA SPECIAL LOGIC: RESTORE FORM FOR REPEAT ---
          if ((bet.groupType === 'Sistema Marcador Exacto' || bet.tipster === 'IA') && bet.children && bet.children.length === 4) {
            try {
              const parsePart = (str) => {
                const lastSpace = str.lastIndexOf(' ');
                return { name: str.substring(0, lastSpace), score: str.substring(lastSpace + 1) };
              };

              const c0 = bet.children[0];
              const c3 = bet.children[3];
              const m1s1_line = c0.betLines[0];
              const m2s1_line = c0.betLines[1];
              const m1s2_line = c3.betLines[0];
              const m2s2_line = c3.betLines[1];

              const m1s1 = parsePart(m1s1_line.description);
              const m2s1 = parsePart(m2s1_line.description);
              const m1s2 = parsePart(m1s2_line.description);
              const m2s2 = parsePart(m2s2_line.description);

              setIaBetData({
                m1: { name: m1s1.name, s1: { score: m1s1.score, odds: m1s1_line.odds }, s2: { score: m1s2.score, odds: m1s2_line.odds } },
                m2: { name: m2s1.name, s1: { score: m2s1.score, odds: m2s1_line.odds }, s2: { score: m2s2.score, odds: m2s2_line.odds } }
              });
              setFormTipster('IA'); // Force form switch
            } catch (err) {
              console.error("Error restoring IA form (Repeat):", err);
            }
          }

          // Logic for System Bets
          let linesToRestore = [];
          let sysStake = 0;
          let sysType = null;

          if (bet.children) {
            // From Group Header (Dashboard/History) (ROBUST)
            const uniqueInfo = new Map();
            try {
              bet.children.forEach(child => {
                if (!child) return;
                if (child.betLines && Array.isArray(child.betLines)) {
                  child.betLines.forEach(l => {
                    if (l && l.description) uniqueInfo.set(l.description + l.odds, l);
                  });
                } else if (child.description && child.odds) {
                  // Single Bet Case
                  uniqueInfo.set(child.description + child.odds, {
                    description: child.description,
                    odds: child.odds,
                    tipster: child.tipster,
                    result: child.result,
                    status: child.result
                  });
                }
              });
            } catch (err) { console.error("Error extracting repeat lines:", err); }

            linesToRestore = Array.from(uniqueInfo.values()).map(l => ({
              description: l.description || '',
              odds: l.odds || '',
              result: 'pending', // Reset result for Repeat
              tipster: l.tipster || '',
              isJoint: l.isJoint || false
            }));
            sysStake = bet.children[0]?.stake || 0; // Assuming uniform stake

            // Find System Type (Dynamic)
            if (linesToRestore.length >= 2) {
              const options = getSystemOptions(linesToRestore.length);
              // Simple match by name or count
              const found = options.find(s =>
                s.name === bet.groupType ||
                (bet.description && bet.description.startsWith(s.name))
              );
              if (found) sysType = found;
            }

          } else {
            // From Single Child of System (Restoring full system from one child is harder without siblings context)
            // Best effort: Just restore this specific line as a single bet or try to find siblings?
            // Let's assume user wants to repeat THIS specific bet configuration.
            // If it's a child of a system, repeating just this child means making it a single/parlay.
            // But user likely wants to repeat the SYSTEM. 
            // For now, if single child, treat as simple bet unless we can find all siblings.
            // We have 'bets' available in state!
            if (bet.groupId) {
              const siblings = bets.filter(b => b.groupId === bet.groupId);
              const uniqueInfo = new Map();
              siblings.forEach(sib => {
                if (sib.betLines) {
                  sib.betLines.forEach(l => uniqueInfo.set(l.description + l.odds, l));
                }
              });
              linesToRestore = Array.from(uniqueInfo.values());
              sysStake = bet.stake;
              const combinadas = Object.values(SYSTEM_BETS);
              const found = combinadas.find(s => s.name === bet.groupType);
              if (found) sysType = found;
            }
          }

          if (linesToRestore.length > 0) {
            setIsMultiLine(true);
            setBetLines(linesToRestore);
            if (sysType) {
              setSystemType(sysType);
              setSystemStake(sysStake);
            }
          }

        } else if (bet.betLines && bet.betLines.length > 0) {
          // Normal Parlay
          setIsMultiLine(true);
          setBetLines(bet.betLines);
          setSystemType(null);
        } else if (bet.subPicks && bet.subPicks.length > 0) {
          // Legacy Parlay
          setIsMultiLine(true);
          setBetLines(bet.subPicks.map(s => ({ ...s, description: s.detail || s.description, result: 'pending' })));
          setSystemType(null);
        } else {
          // Single Bet
          setIsMultiLine(false);
          setBetLines([]);
          setSystemType(null);
        }

        setActiveSection('dashboard');
        setShowAddBetModal(true);
      };

      // --- BULK RESOLUTION LOGIC ---
      const openBulkResolution = (groupId, children) => {
        // 1. Extract Unique Lines
        const uniqueLinesMap = new Map();
        children.forEach(child => {
          if (child.betLines) {
            child.betLines.forEach(line => {
              // Use description+odds as unique key
              const key = line.description + '-' + line.odds;
              if (!uniqueLinesMap.has(key)) {
                uniqueLinesMap.set(key, { ...line, result: 'pending' }); // Reset result for resolution
              }
            });
          }
        });

        const uniqueLines = Array.from(uniqueLinesMap.values());

        // 2. Set Resolution State
        setResolutionBet({
          id: groupId, // Use GroupID as ID
          isGroup: true,
          children: children, // Keep reference to children to update them later
          description: children[0]?.groupType || 'Sistema',
          stake: children.reduce((s, c) => s + parseFloat(c.stake), 0),
          odds: 1.0, // Calculated later
          tempLines: uniqueLines,
          tipster: children[0]?.tipster // Use main tipster
        });
      };

      const handleAddBet = (e) => {
        e.preventDefault();

        // 6. DYNAMIC TAGS AUTO-ADD (V33) - moved up for usage in IA
        let tagsArray = formTags ? formTags.split(',').map(t => t.trim().toUpperCase()).filter(t => t) : [];
        let finalTag = formTag === 'ALL' ? '' : formTag;

        // --- IA SPECIAL LOGIC START (Sistema Marcador Exacto) ---
        if (formTipster === 'IA') {
          const { m1, m2 } = iaBetData;
          // 1. Validation
          if (!m1.name || !m2.name) { alert("¡Introduce los nombres de los equipos (Partido 1 y 2)!"); return; }
          if (!m1.s1.score || !m1.s1.odds || !m1.s2.score || !m1.s2.odds) { alert(`Faltan datos de marcadores para ${m1.name}`); return; }
          if (!m2.s1.score || !m2.s1.odds || !m2.s2.score || !m2.s2.odds) { alert(`Faltan datos de marcadores para ${m2.name}`); return; }

          const stakePerBet = parseFloat(formStake);
          if (!stakePerBet || stakePerBet <= 0) { alert("Introduce un Stake por apuesta válido"); return; }

          // 2. Generate 4 Combos
          const combos = [
            {
              desc: `${m1.name} ${m1.s1.score} + ${m2.name} ${m2.s1.score}`,
              lines: [
                { description: `${m1.name} ${m1.s1.score}`, odds: m1.s1.odds, result: 'pending', tipster: 'IA' },
                { description: `${m2.name} ${m2.s1.score}`, odds: m2.s1.odds, result: 'pending', tipster: 'IA' }
              ]
            },
            {
              desc: `${m1.name} ${m1.s1.score} + ${m2.name} ${m2.s2.score}`,
              lines: [
                { description: `${m1.name} ${m1.s1.score}`, odds: m1.s1.odds, result: 'pending', tipster: 'IA' },
                { description: `${m2.name} ${m2.s2.score}`, odds: m2.s2.odds, result: 'pending', tipster: 'IA' }
              ]
            },
            {
              desc: `${m1.name} ${m1.s2.score} + ${m2.name} ${m2.s1.score}`,
              lines: [
                { description: `${m1.name} ${m1.s2.score}`, odds: m1.s2.odds, result: 'pending', tipster: 'IA' },
                { description: `${m2.name} ${m2.s1.score}`, odds: m2.s1.odds, result: 'pending', tipster: 'IA' }
              ]
            },
            {
              desc: `${m1.name} ${m1.s2.score} + ${m2.name} ${m2.s2.score}`,
              lines: [
                { description: `${m1.name} ${m1.s2.score}`, odds: m1.s2.odds, result: 'pending', tipster: 'IA' },
                { description: `${m2.name} ${m2.s2.score}`, odds: m2.s2.odds, result: 'pending', tipster: 'IA' }
              ]
            }
          ];

          const groupId = `IA-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
          const dateStr = formDate ? formDate : new Date().toISOString().split('T')[0];

          const newBets = combos.map((c, idx) => {
            const combinedOdds = c.lines.reduce((acc, l) => acc * parseFloat(l.odds), 1).toFixed(2);
            return {
              id: Date.now() + idx,
              date: dateStr,
              tipster: 'IA',
              stake: stakePerBet,
              odds: parseFloat(combinedOdds),
              description: c.desc,
              groupTitle: `${m1.name} // ${m2.name} (CS System)`,
              tag: finalTag || 'SISTEMA IA',
              tags: tagsArray.length > 0 ? tagsArray : ['SISTEMA IA'],
              result: 'pending',
              bookie: 'Bet365',
              betLines: c.lines,
              isSystemBet: true,
              groupId: groupId,
              groupType: 'Sistema Marcador Exacto',
              systemTotalBets: 4,
              profit: 0
            };
          });

          setBets(prev => [...prev, ...newBets]);
          alert(`✅ Sistema IA Registrado Correctamente\n\n4 Combinadas generadas.\nStake Total: ${(stakePerBet * 4).toFixed(2)}€`);

          // Clear IA Form
          setIaBetData({
            m1: { name: '', s1: { score: '', odds: '' }, s2: { score: '', odds: '' } },
            m2: { name: '', s1: { score: '', odds: '' }, s2: { score: '', odds: '' } }
          });
          setShowAddBetModal(false);
          return;
        }
        // --- IA SPECIAL LOGIC END ---

        // DEBUG ENTRY
        // DEBUG ENTRY REMOVED


        // VALIDATION
        if (!formTipster) { alert("Selecciona un Tipster"); return; }

        // System Bet Validation
        if (systemType) {
          if (!systemStake || parseFloat(systemStake) <= 0) { alert("Introduce un Stake por apuesta válido para el sistema"); return; }
          if (betLines.length < systemType.k) { alert(`Necesitas al menos ${systemType.k} selecciones para ${systemType.name}`); return; }
        } else {
          if (!formStake || parseFloat(formStake) <= 0) { alert("Introduce un Stake válido"); return; }
          if ((!formOdds || parseFloat(formOdds) < 1) && !isMultiLine && parseFloat(formStake) > 0) {
            alert("Introduce una Cuota válida"); return;
          }
        }

        // Consolidated Multi logic
        const isMulti = isMultiLine || formTipster === 'Mezcla-Tips';
        if (isMulti && betLines.length === 0) { alert("¡Añade al menos una línea!"); return; }

        // FIXED: Do not concatenate lines to description
        const finalDesc = formDescription;
        // 6. DYNAMIC TAGS AUTO-ADD (V33)
        // (Variables declared at top of function for IA logic)
        const hashtags = formDescription.match(/#[a-z0-9_]+/gi);
        if (hashtags) {
          hashtags.forEach(tag => {
            const cleanTag = tag.substring(1).toUpperCase();
            if (!userTags.includes(cleanTag)) setUserTags(prev => [...prev, cleanTag]);
            if (!finalTag) finalTag = cleanTag;
            if (!tagsArray.includes(cleanTag)) tagsArray.push(cleanTag);
          });
        }
        if (formTag && formTag !== 'ALL' && !userTags.includes(formTag)) {
          setUserTags(prev => [...prev, formTag]);
          if (!tagsArray.includes(formTag)) tagsArray.push(formTag);
        }

        // UPDATED PROFIT CALCULATION (V35: Granular Edit)
        let finalProfit = 0;
        let finalResult = editingBet ? formResult : 'pending'; // Default pending for new, usage formResult for edit

        // If editing and result is set, calc profit automatically (unless manual set)
        if (editingBet) {
          const st = parseFloat(formStake);
          const od = parseFloat(formOdds);

          if (formResult === 'loss') {
            finalProfit = -st;
          } else if (formResult === 'void') {
            finalProfit = 0;
          } else {
            // Win or Pending - Allow Manual Profit override
            if (manualProfit) {
              finalProfit = parseFloat(manualProfit);
            } else {
              if (formResult === 'win') finalProfit = (st * od) - st;
              else finalProfit = 0; // pending
            }
          }
        } else {
          finalProfit = 0; // New bets always pending profit until resolved
          // 2. CREATE BET OBJECT
          if (systemType) {
            // --- SYSTEM BET GENERATION (V43 Support for Composite Systems) ---
            const groupId = `SYS-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
            const groupType = systemType.name; // e.g. "All-in", "Yankee"

            let allCombinations = [];

            if (systemType.type === 'named' && systemType.composition) {
              // Generate combos for each part of the composition with specific names
              systemType.composition.forEach(part => {
                const partCombos = getCombinations(betLines, part.k);
                const partName = part.k === 2 ? 'Dobles' : part.k === 3 ? 'Triples' : part.k === 4 ? 'Cuatros' : part.k === 5 ? 'Cincos' : `${part.k} Selecciones`;

                partCombos.forEach((combo, cIdx) => {
                  allCombinations.push({
                    lines: combo,
                    description: `${partName} ${cIdx + 1}/${partCombos.length}`
                  });
                });
              });
            } else {
              // Standard K-fold (Dobles, Triples...)
              const combos = getCombinations(betLines, systemType.k);
              const partName = systemType.k === 2 ? 'Dobles' : systemType.k === 3 ? 'Triples' : `${systemType.k} Selecciones`;

              combos.forEach((combo, cIdx) => {
                allCombinations.push({
                  lines: combo,
                  description: `${partName} ${cIdx + 1}/${combos.length}`
                });
              });
            }

            const newBets = allCombinations.map((item, idx) => {
              // Calc odds for this combo
              const comboOdds = item.lines.reduce((acc, l) => acc * (parseFloat(l.odds) || 1), 1);
              // Description: just the specific part name (e.g. "Dobles 1/3")
              // Group Title will be stored in 'groupTitle' (using formDescription)

              return {
                id: Date.now() + idx,
                date: formDate ? formDate : new Date().toISOString().split('T')[0],
                tipster: formTipster,
                stake: parseFloat(systemStake), // Stake per bet
                odds: parseFloat(comboOdds.toFixed(2)),
                description: item.description, // Specific part description
                groupTitle: formDescription || systemType.name, // Global User Description
                tag: finalTag,
                tags: tagsArray,
                result: formResult || 'pending',
                bookie: 'Bet365', // Default or add field
                betLines: item.lines.map(l => ({ ...l, tipster: (formTipster !== 'Mezcla-Tips' && formTipster) ? formTipster : l.tipster })), // The specific lines for this combo
                isSystemBet: true,
                groupId: groupId,
                groupType: systemType.name,
                systemTotalBets: allCombinations.length,
                profit: formResult === 'win' ? ((parseFloat(systemStake) * comboOdds) - parseFloat(systemStake)) : (formResult === 'loss' ? -parseFloat(systemStake) : 0)
              };
            });

            if (editingBet) {
              // DEBUG ALERT FOR SYSTEM
              // ALERT FOR SYSTEM SAVE
              const sysSummary = `✅ Sistema Guardado\n\n📄 ${formDescription || systemType.name}\n📦 Tipo: ${systemType.name}\n💰 Stake Total: ${newBets.reduce((a, b) => a + b.stake, 0).toFixed(2)}€`;
              alert(sysSummary);

              // REMOVE OLD GROUP MEMBERS
              const idsToRemove = new Set();
              if (editingBet.children) editingBet.children.forEach(c => idsToRemove.add(c.id));
              else idsToRemove.add(editingBet.id);

              setBets(prevBets => {
                const betsWithoutOld = prevBets.filter(b => !idsToRemove.has(b.id));
                return [...betsWithoutOld, ...newBets];
              });
              setEditingBet(null);
            } else {
              setBets(prevBets => [...prevBets, ...newBets]);
              const sysSummaryNew = `✅ Sistema Creado\n\n📄 ${formDescription || systemType.name}\n📦 Tipo: ${systemType.name}\n💰 Stake Total: ${newBets.reduce((a, b) => a + b.stake, 0).toFixed(2)}€`;
              alert(sysSummaryNew);
            }

          } else {
            // --- NORMAL SINGLE/PARLAY BET ---
            try {
              const isMulti = isMultiLine || betLines.length > 0 || formTipster === 'Mezcla-Tips';
              const newBet = {
                id: editingBet ? editingBet.id : Date.now(),
                date: formDate ? formDate : new Date().toISOString().split('T')[0],
                tipster: formTipster,
                stake: parseFloat(formStake),
                odds: parseFloat(formOdds),
                description: finalDesc,
                tag: finalTag,
                tags: tagsArray,
                result: formResult, // V20: Allow setting result directly
                bookie: 'Bet365', // Placeholder
                betLines: isMulti ? betLines.map(l => ({ ...l, tipster: (formTipster !== 'Mezcla-Tips' && formTipster) ? formTipster : l.tipster })) : [],
                // Legacy support
                subPicks: isMulti ? betLines : [],
                isSystemBet: false
              };

              // ... (Simple Profit Calc Logic kept simple here for brevity, usually handled by result button or default 0 if pending)
              if (newBet.result === 'win') newBet.profit = (newBet.stake * newBet.odds) - newBet.stake;
              if (newBet.result === 'loss') newBet.profit = -newBet.stake;
              if (newBet.result === 'void') newBet.profit = 0;
              if (newBet.result === 'pending') newBet.profit = 0;

              if (editingBet) {
                if (editingBet.isGroup || (editingBet.children && editingBet.children.length > 0)) {
                  // Determine IDs to remove (Robust)
                  const idsToRemove = new Set();
                  if (editingBet.children) editingBet.children.forEach(c => idsToRemove.add(c.id));
                  else idsToRemove.add(editingBet.id); // Fallback

                  // Filter out OLD group members
                  setBets(prevBets => {
                    const betsWithoutOld = prevBets.filter(b => !idsToRemove.has(b.id));
                    return [...betsWithoutOld, newBet];
                  });
                  setEditingBet(null);
                } else {
                  // Update Single Bet (Loose ID Match for safety)
                  // WARNING: DEBUG ALERT ACTIVE
                  // WARNING: DEBUG DETECTED - REPLACED WITH USER FEEDBACK
                  // Create Summary
                  const summary = `✅ Apuesta Editada Correctamente\n\n📄 ${newBet.description}\n💰 Stake: ${newBet.stake}€\n📈 Cuota: @${newBet.odds}\n👤 Tipster: ${newBet.tipster}`;
                  alert(summary);

                  setBets(prevBets => prevBets.map(b => String(b.id) === String(editingBet.id) ? newBet : b));
                  setEditingBet(null);
                }
              } else {
                setBets(prevBets => [...prevBets, newBet]);
                const summaryNew = `✅ Apuesta Creada\n\n📄 ${newBet.description}\n💰 Stake: ${newBet.stake}€\n📈 Cuota: @${newBet.odds}\n👤 Tipster: ${newBet.tipster}`;
                alert(summaryNew);
              }
            } catch (err) {
              alert("ERROR CRASH: " + err.message);
              console.error(err);
            }


          }

          // RESET FORM
          setShowAddBetModal(false);
          setFormDescription('');
          setFormStake('');
          setFormOdds('');
          setBetLines([]);
          setSystemType(null);
          setSystemStake('');
          setFormTag('');
          // Keep Tipster
        };
        setManualProfit('');
        setFormResult('pending'); // Reset result
        setShowAddBetModal(false);
        if (!editingBet) setActiveSection('dashboard');
      };

      const addLine = () => {
        setIsMultiLine(true);
        const defaultTipster = (formTipster === 'Mezcla-Tips' || formTipster === 'Combis (Apuesta D)') ? '' : formTipster;
        setBetLines([...betLines, { odds: '', description: '', tipster: defaultTipster || '', isJoint: false }]);
      };

      const updateLine = (index, field, value) => {
        setBetLines(prev => prev.map((line, i) => i === index ? { ...line, [field]: value } : line));
      };

      const removeLine = (index) => {
        setBetLines(betLines.filter((_, i) => i !== index));
      };

      const calculateOddsFromProfit = (profit) => {
        const st = parseFloat(formStake) || 0;
        if (st > 0) {
          const p = parseFloat(profit) || 0;
          return ((p + st) / st).toFixed(2);
        }
        return 0;
      };

      const addSubPickToForm = () => {
        if (!subTipster || !subDetail) return;
        setSubPicks([...subPicks, { id: Date.now() + Math.random(), tipster: subTipster, detail: subDetail, status: 'pending' }]);
        setSubDetail('');
      };

      // --- BACKUP SYSTEM (V3) ---
      const exportData = () => {
        const data = {
          version: 'v29.1',
          timestamp: new Date().toISOString(),
          bets: bets,
          challenges: challenges,
          tipsters: tipsters, // V31: Save Tipsters
          bankTransactions: bankTransactions, // V18
          tags: userTags // V33: Dynamic Tags
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `betmanager_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      const importData = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const imported = JSON.parse(event.target.result);
            if (imported.bets && Array.isArray(imported.bets)) {
              // V45: Open Modal
              setPendingImportData(imported);
              setShowCloudModal(false); // Close Cloud/Backup Modal if open
              setImportModalOpen(true);
            } else {
              alert('Formato de archivo inválido');
            }
          } catch (err) {
            alert('Error al leer el archivo');
            console.error(err);
          }
        };
        reader.readAsText(file);
      };

      const factoryReset = () => {
        if (confirm("¿ESTÁS SEGURO? Se borrarán TODOS los datos y se volverá al estado inicial. Esta acción no se puede deshacer.")) {
          localStorage.clear();
          window.location.reload();
        }
      };

      const COLORS = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#ec4899', '#6366f1'];

      const pendingBetsList = bets.filter(b => b.result === 'pending');

      // GROUPING LOGIC (Refactored to be outside JSX)
      const groupedBets = [];
      const processedGroupIds = new Set();
      pendingBetsList.forEach(bet => {
        if (processedGroupIds.has(bet.id)) return;
        if (bet.groupId) {
          const group = pendingBetsList.filter(b => b.groupId === bet.groupId);
          group.forEach(m => processedGroupIds.add(m.id));
          const totalStake = group.reduce((sum, b) => sum + parseFloat(b.stake), 0);
          groupedBets.push({
            type: 'group',
            id: bet.groupId,
            description: bet.groupType,
            stake: totalStake,
            tipster: bet.tipster,
            children: group
          });
        } else {
          groupedBets.push({ type: 'single', ...bet });
        }
      });

      const NavItem = ({ id, icon: Icon, label }) => (
        <button
          onClick={() => { setActiveSection(id); setSidebarOpen(false); }}
          className={`w-full flex items-center gap-3 px-4 py-4 rounded-lg transition-all mb-2 ${activeSection === id
            ? 'bg-emerald-600 text-white shadow-lg'
            : 'text-slate-400 hover:bg-slate-800'
            }`}
        >
          <Icon size={24} />
          <span className="font-medium text-lg">{label}</span>
          {activeSection === id && <ChevronRight size={20} className="ml-auto opacity-50" />}
        </button>
      );

      // --- AUTH & ONBOARDING HANDLER (V60) ---
      const handleNewUser = (data) => {
        const newId = Date.now();
        const newUser = {
          id: newId,
          name: data.name,
          avatar: data.avatar,
          theme: data.theme,
          password: data.password // Save Password
        };

        // 1. Initialize DB for New User
        if (data.source === 'new') {
          DB.set(newId, 'betPortfolioV29_bets', []);
          DB.set(newId, 'betPortfolioV29_tipsters', DEFAULT_TIPSTERS);
          DB.set(newId, 'betPortfolioV29_challenges', initialChallenges);
          DB.set(newId, 'betPortfolioV33_tags', DEFAULT_TAGS);
          DB.set(newId, 'betPortfolioV29_bank', { transactions: [{ id: Date.now(), type: 'deposit', amount: data.bank, date: new Date().toISOString().split('T')[0], note: 'Bank Inicial' }] });
        }
        else if (data.source === 'clone') {
          // Clone from Global Keys (Legacy Migration)
          const keys = [
            'betPortfolioV29_bets',
            'betPortfolioV29_tipsters',
            'betPortfolioV29_challenges',
            'betPortfolioV29_bank',
            'betPortfolioV33_tags',
            'betPortfolio_eraResetDate'
          ];
          DB.migrateGlobalToUser(newId, keys);
        }
        else if (data.source === 'cloud' && data.cloudBackup) { // Fixed: using data.cloudBackup passed from Wizard
          const backup = data.cloudBackup;
          if (backup.bets) DB.set(newId, 'betPortfolioV29_bets', backup.bets);
          if (backup.tipsters) DB.set(newId, 'betPortfolioV29_tipsters', backup.tipsters);
          if (backup.challenges) DB.set(newId, 'betPortfolioV29_challenges', backup.challenges);
          if (backup.bankTransactions) DB.set(newId, 'betPortfolioV29_bank', { transactions: backup.bankTransactions });
          else if (backup.bank) DB.set(newId, 'betPortfolioV29_bank', { transactions: backup.bank.transactions || backup.bank }); // Robustness
          if (backup.tags) DB.set(newId, 'betPortfolioV33_tags', backup.tags);
        }

        // 2. Set Active
        const updatedUsers = [...users, newUser];
        setUsers(updatedUsers);
        setCurrentUser(newUser);
        setIsNewUser(false);
      };

      const handleLogin = (user) => {
        if (user.password) {
          const pwd = prompt(`🔒 Hola ${user.name}, introduce tu contraseña:`);
          if (pwd !== user.password) return alert("❌ Contraseña incorrecta");
        }
        setCurrentUser(user);
      };

      if (!currentUser) return <AuthScreen users={users} onLogin={handleLogin} onNewUser={() => setIsNewUser(true)} />;
      if (isNewUser) return <OnboardingWizard onFinish={handleNewUser} onCancel={() => setIsNewUser(false)} />;

      const handleThemeCycle = () => {
        if (!currentUser) return;
        const themeKeys = Object.keys(THEMES);
        const currentIdx = themeKeys.indexOf(currentUser.theme || 'original');
        const nextIdx = (currentIdx + 1) % themeKeys.length;
        const nextTheme = themeKeys[nextIdx];

        const updatedUser = { ...currentUser, theme: nextTheme };
        setCurrentUser(updatedUser);

        const updatedUsers = users.map(u => u.id === currentUser.id ? updatedUser : u);
        setUsers(updatedUsers);
      };

      return (
        <div className="h-screen bg-slate-950 text-slate-100 font-sans flex flex-col md:flex-row overflow-hidden">
          {/* ... (Header y Sidebar sin cambios) ... */}

          {/* HEADER MOBILE */}
          <div className="md:hidden bg-slate-900 border-b border-slate-800 p-4 flex justify-between items-center z-50 sticky top-0 shadow-lg">
            <div className="flex items-center gap-2" onClick={handleThemeCycle}>
              <div className="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-lg">{currentUser.avatar}</div>
              <div className="font-bold text-lg text-emerald-400 tracking-tight">{currentUser.name}</div>
            </div>
            <div className="flex items-center gap-3">
              <button onClick={() => setShowCloudModal(true)} className="text-indigo-400"><Cloud size={24} /></button>
              <button onClick={() => setSidebarOpen(!sidebarOpen)} className="p-2 text-white"><Menu size={28} /></button>
            </div>
          </div>

          {/* SIDEBAR */}
          <div className={`fixed inset-0 bg-slate-950/95 z-40 transform transition-transform duration-300 md:relative md:translate-x-0 md:w-72 md:bg-slate-900 md:border-r md:border-slate-800 flex flex-col ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
            {/* HEADING PRO (V18: Bank Badge) */}
            <div className="hidden md:flex p-6 border-b border-slate-800 items-center justify-between">
              <div className="flex items-center gap-3">
                <div onClick={handleThemeCycle} className="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-2xl border-2 border-slate-700 shadow-inner group cursor-pointer hover:border-emerald-500 transition-colors" title="Clic para cambiar Tema">
                  {currentUser.avatar}
                </div>
                <div>
                  <h1 className="font-bold text-xl text-white tracking-tight">{currentUser.name}</h1>
                  <button onClick={() => setCurrentUser(null)} className="text-[10px] text-slate-500 hover:text-red-400 font-bold uppercase tracking-wide flex items-center gap-1 mt-1 transition-colors">
                    <LogOut size={10} /> Cerrar Sesión
                  </button>
                </div>
              </div>
              {/* ERA SELECTOR (V50 - Desktop) */}
              {eraResetDate && (
                <div className="flex bg-slate-800 rounded-lg p-1 border border-slate-700 mx-4">
                  <button
                    onClick={() => setEraFilter('BEFORE')}
                    className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${eraFilter === 'BEFORE' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}
                  >
                    Antiguo
                  </button>
                  <button
                    onClick={() => setEraFilter('AFTER')}
                    className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${eraFilter === 'AFTER' ? 'bg-emerald-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}
                  >
                    Nuevo
                  </button>
                  <button
                    onClick={() => setEraFilter('ALL')}
                    className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${eraFilter === 'ALL' ? 'bg-slate-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}
                  >
                    Todo
                  </button>
                </div>
              )}

              <button onClick={() => setShowBankManager(true)} className="flex items-center gap-2 px-3 py-1.5 bg-slate-800 rounded-lg border border-slate-700 hover:border-emerald-500 transition-colors group">
                <div className="text-[10px] uppercase font-bold text-slate-400 group-hover:text-emerald-400">BANK ACTUAL</div>
                <div className="text-lg font-bold font-mono text-white group-hover:text-emerald-300">{currentGlobalBank.toFixed(2)}€</div>
              </button>
              {/* CLOUD BUTTON HEADER (PC) */}
              <button onClick={() => setShowCloudModal(true)} className="flex flex-col items-center justify-center p-2 rounded-lg bg-indigo-900/20 border border-indigo-500/30 hover:bg-indigo-600/20 hover:border-indigo-400 transition-all text-indigo-400 ml-2" title="Sincronización Cloud">
                <Cloud size={20} />
                <span className="text-[9px] font-bold">NUBE</span>
              </button>
            </div>

            <div className="flex-1 p-6 overflow-y-auto">
              <div className="text-xs font-bold text-slate-500 mb-6 uppercase tracking-wider">Navegación</div>
              <nav className="flex-1 px-2 py-4 space-y-2">
                <NavItem id="dashboard" icon={LayoutDashboard} label="Dashboard" />
                <button onClick={() => { setShowAddBetModal(true); setSidebarOpen(false); }} className="w-full flex items-center gap-3 px-4 py-4 rounded-lg transition-all mb-2 text-emerald-400 hover:bg-slate-800 border border-transparent hover:border-emerald-500/30">
                  <Plus size={24} />
                  <span className="font-bold text-lg">Nueva Apuesta</span>
                </button>
                <NavItem id="challenges" icon={Trophy} label="Retos" />
                <NavItem id="stats" icon={BarChart2} label="Estadísticas" />
                <NavItem id="history" icon={History} label="Historial" />
                <NavItem id="simulador" icon={TrendingUp} label="Simulador" />
                <button onClick={() => { setShowBankManager(true); setSidebarOpen(false); }} className="w-full flex items-center gap-3 px-4 py-4 rounded-lg transition-all mb-2 text-slate-400 hover:bg-slate-800">
                  <PieChart size={24} />
                  <span className="font-medium text-lg">Gestión de Bank</span>
                </button>
                <button onClick={() => { setShowCalculator(true); setSidebarOpen(false); }} className="w-full flex items-center gap-3 px-4 py-4 rounded-lg transition-all mb-2 text-slate-400 hover:bg-slate-800">
                  <Calculator size={24} />
                  <span className="font-medium text-lg">Calculadora</span>
                </button>
              </nav>
            </div>
            <div className="p-6 border-t border-slate-800">
              <div className="text-xs font-bold text-slate-500 mb-4 uppercase tracking-wider">Gestión de Datos (V3)</div>
              <div className="flex flex-col gap-2">
                <button onClick={() => setShowCloudModal(true)} className="flex items-center gap-2 text-xs bg-indigo-900/30 hover:bg-indigo-600/30 text-indigo-400 font-bold p-3 rounded mb-2 transition-colors border border-indigo-500/30">
                  <Cloud size={16} /> <span>â˜ï¸ CONFIGURAR NUBE & BACKUPS</span>
                </button>

              </div>
              <div className="mt-4 text-center text-[10px] text-slate-600">v29.1 PRO - Local Storage</div>
            </div>
          </div>

          {/* MAIN CONTENT */}
          <div className="flex-1 overflow-y-auto bg-slate-950 p-4 md:p-8 pb-20">

            {/* 1. DASHBOARD */}
            {activeSection === 'dashboard' && (
              <div className="space-y-6 animate-fade-in">

                {/* MOBILE ERA SELECTOR (V50) */}
                {eraResetDate && (
                  <div className="md:hidden bg-slate-900 rounded-lg p-1.5 border border-slate-700 flex justify-between gap-1 mb-2">
                    <button
                      onClick={() => setEraFilter('BEFORE')}
                      className={`flex-1 py-2 text-xs font-bold rounded-md transition-all flex flex-col items-center justify-center gap-1 ${eraFilter === 'BEFORE' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}
                    >
                      <History size={14} /> Before
                    </button>
                    <button
                      onClick={() => setEraFilter('AFTER')}
                      className={`flex-1 py-2 text-xs font-bold rounded-md transition-all flex flex-col items-center justify-center gap-1 ${eraFilter === 'AFTER' ? 'bg-emerald-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}
                    >
                      <Zap size={14} /> New Era
                    </button>
                    <button
                      onClick={() => setEraFilter('ALL')}
                      className={`flex-1 py-2 text-xs font-bold rounded-md transition-all flex flex-col items-center justify-center gap-1 ${eraFilter === 'ALL' ? 'bg-slate-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}
                    >
                      <Globe size={14} /> All
                    </button>
                  </div>
                )}

                {/* TAG FILTER UI (V3 - Updated V33) */}
                {userTags.length > 1 && (
                  <div className="flex justify-end mb-2">
                    <div className="flex items-center gap-2 bg-slate-900 p-2 rounded-lg border border-slate-800">
                      <Filter size={14} className="text-slate-400" />
                      <select value={filterTag} onChange={e => setFilterTag(e.target.value)} className="bg-slate-900 text-xs text-white focus:outline-none uppercase font-bold cursor-pointer">
                        {userTags.map(tag => <option key={tag} value={tag}>{tag === 'ALL' ? 'Todas las Etiquetas' : tag}</option>)}
                      </select>
                    </div>
                  </div>
                )}

                {/* 0. ADD BET FORM (RESTORED V20) */}
                {/* 0. ADD BET FORM MOVED TO MODAL */}

                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                  <StatCard title="Beneficio Neto" value={`${financialStats.profit >= 0 ? '+' : ''}${financialStats.profit.toFixed(2)}€`} icon={PieChart} colorClass="text-emerald-500" />
                  <StatCard title="Yield / ROI" value={`${financialStats.yield_val}%`} icon={TrendingUp} colorClass="text-blue-500" />
                  <StatCard title="Win Rate Scout" value={`${scoutStats.length > 0 ? (scoutStats.reduce((acc, s) => acc + parseFloat(s.winRate), 0) / scoutStats.length).toFixed(1) : 0}%`} subtext="Efectividad Media" icon={Target} colorClass="text-purple-500" />
                  <StatCard title="Riesgo Activo" value={`${pendingBetsList.reduce((a, b) => a + b.stake, 0).toFixed(2)}€`} subtext="En juego" icon={Clock} colorClass="text-yellow-500" />
                </div>

                {pendingBetsList.length > 0 && (
                  <div className="bg-slate-900 rounded-xl border-l-4 border-yellow-500 p-4 shadow-xl">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-bold text-lg flex items-center gap-2 text-white"><AlertCircle className="text-yellow-500" /> Apuestas Activas ({pendingBetsList.length})</h3>
                    </div>
                    <div className="space-y-4">
                      {groupedBets.map(item => {
                        if (item.type === 'group') {
                          const isExpanded = expandedBets.includes(item.id);
                          return (
                            <div key={item.id} className="bg-slate-900 border-2 border-cyan-900/50 rounded-xl overflow-hidden shadow-xl mb-4">
                              <div className="p-4 bg-gradient-to-r from-slate-900 to-cyan-900/10 flex flex-col md:flex-row justify-between items-start md:items-center cursor-pointer hover:bg-slate-800 transition-colors gap-4" onClick={() => toggleHistoryExpansion(item.id)}>
                                <div className="flex items-center gap-3 w-full md:w-auto">
                                  <div className="p-2 bg-cyan-900/20 rounded text-cyan-400"><LayoutGrid size={24} /></div>
                                  <div className="flex-1">
                                    <h4 className="font-bold text-white flex flex-col md:flex-row md:items-center gap-1 md:gap-2 text-sm md:text-base leading-tight">
                                      <span>{item.children[0].groupTitle || item.description}</span>
                                      <span className="text-slate-400 font-normal text-xs">({item.description})</span>
                                    </h4>
                                    <div className="text-xs text-slate-500 font-bold flex items-center gap-2 mt-1">
                                      {item.tipster}
                                      <span className="bg-slate-800 px-1.5 py-0.5 rounded text-slate-400 font-normal text-[10px] border border-slate-700">{item.children.length} Apuestas</span>
                                    </div>
                                  </div>
                                </div>
                                <div className="flex flex-row md:flex-col items-center md:items-end justify-between w-full md:w-auto mt-2 md:mt-0 gap-2 flex-wrap md:flex-nowrap">
                                  <div className="text-lg font-bold text-white order-1 md:order-0 w-full md:w-auto text-right md:text-right mb-2 md:mb-0">{item.stake.toFixed(2)}€</div>
                                  <div className="flex flex-wrap justify-end gap-1 order-2 md:order-1 w-full md:w-auto">
                                    <button
                                      onClick={(e) => { e.stopPropagation(); openBulkResolution(item.id, item.children); }}
                                      className="bg-emerald-600 hover:bg-emerald-500 text-white text-[10px] font-bold px-2 py-1.5 rounded flex items-center gap-1 shadow-lg shadow-emerald-900/20 z-10 relative whitespace-nowrap transition-all active:scale-95 flex-1 md:flex-none justify-center"
                                    >
                                      <CheckCircle size={12} /> RESOLVER SISTEMA
                                    </button>
                                    <div className="flex gap-1 items-end">
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          setEditingBet({ id: item.id, isGroup: true, children: item.children, description: item.description, groupType: item.children[0].groupType, stake: item.stake, odds: 0, date: item.date, tipster: item.tipster });
                                          setActiveSection('dashboard');
                                        }}
                                        className="bg-indigo-600 hover:bg-indigo-500 text-white text-[10px] font-bold px-2 py-1.5 rounded flex items-center gap-1 shadow-lg shadow-indigo-900/20 z-10 relative whitespace-nowrap transition-all active:scale-95 flex-1 md:flex-none justify-center"
                                        title="Editar Sistema"
                                      >
                                        <Edit size={12} />
                                      </button>

                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          handleRepeatBet({ ...item, isGroup: true });
                                        }}
                                        className="bg-slate-700 hover:bg-slate-600 text-slate-300 text-[10px] font-bold px-2 py-1.5 rounded flex items-center gap-1 border border-slate-600 hover:border-slate-500 z-10 relative whitespace-nowrap transition-all active:scale-95 flex-1 md:flex-none justify-center mt-0"
                                        title="Repetir Apuesta"
                                      >
                                        <Repeat size={12} />
                                      </button>
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          deleteGroup(item);
                                        }}
                                        className="bg-red-900/40 hover:bg-red-600 text-red-500 hover:text-white text-[10px] font-bold px-2 py-1.5 rounded flex items-center gap-1 border border-red-900 z-10 relative whitespace-nowrap transition-all active:scale-95 flex-1 md:flex-none justify-center mt-0"
                                        title="Borrar Grupo"
                                      >
                                        <Trash2 size={12} />
                                      </button>
                                      <div className="text-[10px] text-cyan-500 font-bold flex items-center justify-end gap-1 whitespace-nowrap">
                                        {isExpanded ? 'OCULTAR' : 'GESTIONAR'} <ChevronDown size={12} className={`transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>

                              {
                                isExpanded && (
                                  <div className="bg-slate-950/50 border-t border-slate-800 p-2 space-y-2 animate-fade-in">
                                    {item.children.map(bet => (
                                      <div key={bet.id} className="bg-slate-900 p-3 rounded border border-slate-700/50 flex flex-col gap-2">
                                        <div className="flex flex-col md:flex-row gap-3 items-center justify-between">
                                          <div className="flex-1 w-full">
                                            <div className="flex items-center gap-2 mb-1">
                                              <div className="text-xs text-white font-bold">{bet.description}</div>
                                              <button
                                                onClick={(e) => { e.stopPropagation(); toggleHistoryExpansion(bet.id); }}
                                                className="text-[10px] text-slate-500 hover:text-cyan-400 flex items-center gap-1 bg-slate-800 px-1.5 py-0.5 rounded border border-slate-700 transition-colors"
                                              >
                                                {expandedBets.includes(bet.id) ? <ChevronUp size={10} /> : <ChevronDown size={10} />}
                                                {expandedBets.includes(bet.id) ? 'Ocultar' : 'Ver Líneas'}
                                              </button>
                                            </div>
                                            <div className="flex gap-2 text-[10px]">
                                              <span className="bg-slate-800 px-1.5 rounded text-slate-400 border border-slate-700">@{bet.odds.toFixed(2)}</span>
                                              <span className="text-slate-500 font-bold">{bet.stake.toFixed(2)}€</span>
                                              {bet.profit !== 0 && (
                                                <span className={`font-bold ${bet.profit > 0 ? 'text-emerald-500' : 'text-red-500'}`}>
                                                  {bet.profit > 0 ? '+' : ''}{bet.profit.toFixed(2)}€
                                                </span>
                                              )}
                                            </div>
                                          </div>
                                          <div className="flex gap-1 w-full md:w-auto">
                                            <button onClick={() => updateSimpleStatus(bet.id, 'win')} className="flex-1 md:flex-none px-3 py-1 bg-emerald-600/20 text-emerald-400 border border-emerald-600/50 rounded hover:bg-emerald-600 hover:text-white font-bold text-xs">WIN</button>
                                            <button onClick={() => updateSimpleStatus(bet.id, 'loss')} className="flex-1 md:flex-none px-3 py-1 bg-red-600/20 text-red-400 border border-red-600/50 rounded hover:bg-red-600 hover:text-white font-bold text-xs">LOSS</button>
                                            <button onClick={() => updateSimpleStatus(bet.id, 'void')} className="px-2 py-1 bg-slate-700/50 text-slate-400 border border-slate-600/50 rounded hover:bg-slate-600 hover:text-white font-bold text-xs">A</button>
                                          </div>
                                        </div>

                                        {/* EXPANDED DETAILS FOR CHILD BET */}
                                        {expandedBets.includes(bet.id) && bet.betLines && (
                                          <div className="mt-1 p-2 bg-slate-950/50 rounded border border-slate-800/50 animate-fade-in">
                                            <div className="text-[10px] text-slate-500 font-bold uppercase mb-1">Composición:</div>
                                            {bet.betLines.map((line, i) => (
                                              <div key={i} className="flex justify-between items-center text-[10px] border-b border-slate-800/50 last:border-0 py-1">
                                                <span className="text-slate-300">{line.description}</span>
                                                <span className="font-mono text-slate-500">@{line.odds}</span>
                                              </div>
                                            ))}
                                          </div>
                                        )}
                                      </div>
                                    ))}
                                  </div>
                                )}
                            </div>
                          );
                        } else {
                          const bet = item;
                          // ORIGINAL SINGLE BET CARD RENDER
                          return (
                            <div key={bet.id} className="bg-slate-950 p-4 rounded-xl border border-slate-800 shadow-sm">
                              <div className="mb-2">
                                <div className="flex items-center gap-2 mb-1 flex-wrap">
                                  <span className="font-bold text-emerald-400">{bet.tipster}</span>
                                  <span className="text-xs bg-slate-800 px-2 py-0.5 rounded text-slate-400 border border-slate-700">@{bet.odds.toFixed(2)}</span>
                                  {bet.tag && bet.tag !== 'ALL' && <span className="text-[10px] bg-blue-900/30 text-blue-300 px-1.5 py-0.5 rounded border border-blue-500/30 uppercase font-bold"><Tag size={10} className="inline mr-1" />{bet.tag}</span>}
                                </div>
                                <p className="text-sm font-medium text-slate-200 mb-1">{bet.description}</p>

                                {/* TAGS / HASHTAGS ROW */}
                                {((bet.tags && bet.tags.length > 0) || (bet.description.match(/#[a-z0-9_]+/gi))) && (
                                  <div className="flex flex-wrap gap-1 mb-2">
                                    {(bet.tags || []).filter(t => t !== bet.tag && t !== 'ALL').map((t, idx) => (
                                      <span key={idx} className="text-[10px] text-slate-500 bg-slate-900 px-1.5 rounded">#{t}</span>
                                    ))}
                                  </div>
                                )}

                                {/* MULTI-LINE PREVIEW COLLAPSIBLE (DASHBOARD) */}
                                {((bet.betLines && bet.betLines.length > 0) || (bet.subPicks && bet.subPicks.length > 0)) && (
                                  <div className="mt-2">
                                    <button
                                      type="button"
                                      onClick={() => toggleHistoryExpansion(bet.id)}
                                      className="text-xs font-bold text-slate-500 hover:text-indigo-400 flex items-center gap-1 transition-colors mb-1"
                                    >
                                      {expandedBets.includes(bet.id) ? (
                                        <span className="flex items-center gap-1"><ChevronUp size={12} /> Ocultar Desglose</span>
                                      ) : (
                                        <span className="flex items-center gap-1"><ChevronDown size={12} /> Ver {(bet.betLines || bet.subPicks).length} Líneas</span>
                                      )}
                                    </button>

                                    {expandedBets.includes(bet.id) && (
                                      <div className="space-y-1 bg-slate-900/50 p-2 rounded border border-slate-800 animate-fade-in">
                                        {(bet.betLines || bet.subPicks).map((line, i) => (
                                          <div key={i} className="flex justify-between items-center text-xs">
                                            <span className="text-slate-400 truncate max-w-[200px]">
                                              {bet.tipster === 'Mezcla-Tips' && (
                                                <span className="font-bold text-indigo-400 mr-1">{line.tipster}:</span>
                                              )}
                                              {line.description || line.detail}
                                            </span>
                                            <span className="font-mono text-slate-500">@{line.odds || '-'}</span>
                                          </div>
                                        ))}
                                      </div>
                                    )}
                                  </div>
                                )}
                              </div>
                              <div className="flex gap-2 w-full mt-3">
                                <button onClick={() => handleOracle(bet.description, bet.odds)} className="w-10 py-2 bg-purple-600/20 text-purple-400 border border-purple-600/50 rounded hover:bg-purple-600 hover:text-white font-bold text-sm flex justify-center items-center" title="Analizar con IA"><Sparkles size={16} /></button>
                                <button onClick={() => setEditingBet(bet)} className="w-10 py-2 bg-blue-600/20 text-blue-400 border border-blue-600/50 rounded hover:bg-blue-600 hover:text-white font-bold text-sm flex justify-center items-center" title="Editar Apuesta"><Edit size={16} /></button>
                                <button onClick={() => handleRepeatBet(bet)} className="w-10 py-2 bg-indigo-600/20 text-indigo-400 border border-indigo-600/50 rounded hover:bg-indigo-600 hover:text-white font-bold text-sm flex justify-center items-center" title="Repetir Apuesta"><Repeat size={16} /></button>
                                <button onClick={() => updateSimpleStatus(bet.id, 'win')} className="flex-1 py-2 bg-emerald-600/20 text-emerald-400 border border-emerald-600/50 rounded hover:bg-emerald-600 hover:text-white font-bold text-sm">Ganada</button>
                                <button onClick={() => updateSimpleStatus(bet.id, 'void')} className="w-10 py-2 bg-slate-700/50 text-slate-400 border border-slate-600/50 rounded hover:bg-slate-600 hover:text-slate-200 font-bold text-sm" title="Anulada">A</button>
                                <button onClick={() => updateSimpleStatus(bet.id, 'loss')} className="flex-1 py-2 bg-red-600/20 text-red-400 border border-red-600/50 rounded hover:bg-red-600 hover:text-white font-bold text-sm">Perdida</button>
                              </div>
                            </div>
                          );
                        }
                      })}

                    </div>
                  </div>
                )
                }

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                  <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-xl col-span-1 lg:col-span-2">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-bold text-sm flex items-center gap-2 text-slate-400 uppercase tracking-wider"><Activity size={16} /> Curva de Ganancias</h3>

                      <div className="flex items-center gap-4">
                        {/* ATH Badge (Moved here) */}
                        <div className="text-right block">
                          <div className="text-[10px] text-slate-500 font-bold uppercase">Máx. Histórico</div>
                          <div className="text-sm font-bold text-emerald-400 font-mono">+{financialStats.maxProfit ? financialStats.maxProfit.toFixed(2) : '0.00'}€</div>
                        </div>

                        <div className="flex gap-1 bg-slate-950 p-1 rounded border border-slate-800">
                          {['7D', '30D', '3M', 'ALL'].map(range => (
                            <button key={range} onClick={() => setChartTimeRange(range)} className={`px-2 py-1 text-[10px] font-bold rounded transition-colors ${chartTimeRange === range ? 'bg-slate-800 text-white' : 'text-slate-500 hover:text-slate-300'}`}>{range}</button>
                          ))}
                        </div>
                      </div>
                    </div>
                    <div className="h-[250px] w-full relative">

                      <ResponsiveContainer width="100%" height="100%">
                        {(() => {
                          // 1. Filter Data based on Range
                          let displayData = financialStats.chartData;
                          if (chartTimeRange !== 'ALL') {
                            const now = new Date();
                            const cutoff = new Date();
                            if (chartTimeRange === '7D') cutoff.setDate(now.getDate() - 7);
                            if (chartTimeRange === '30D') cutoff.setDate(now.getDate() - 30);
                            if (chartTimeRange === '3M') cutoff.setMonth(now.getMonth() - 3);
                            displayData = financialStats.chartData.filter(d => new Date(d.fullDate) >= cutoff);
                          }

                          if (!displayData || displayData.length === 0) return <div className="h-full flex items-center justify-center text-slate-500 text-xs">Sin datos para mostrar</div>;

                          // 2. Generate Slope Gradient
                          // We want GREEN if current point >= previous point, RED if < previous point.
                          const generateSlopeGradient = () => {
                            if (displayData.length < 2) return <stop offset="0" stopColor="#10b981" />;

                            const steps = [];
                            displayData.forEach((d, i) => {
                              if (i === 0) return;
                              const prev = displayData[i - 1];
                              const isRising = d.profit >= prev.profit;
                              const color = isRising ? '#10b981' : '#ef4444';
                              const startPct = ((i - 1) / (displayData.length - 1));
                              const endPct = (i / (displayData.length - 1));
                              steps.push(<stop key={`start-${i}`} offset={startPct} stopColor={color} />);
                              steps.push(<stop key={`end-${i}`} offset={endPct} stopColor={color} />);
                            });
                            return steps;
                          };

                          return (
                            <LineChart data={displayData}>
                              <defs>
                                <linearGradient id="slopeGradient" x1="0" y1="0" x2="1" y2="0">
                                  {generateSlopeGradient()}
                                </linearGradient>
                              </defs>
                              <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                              <XAxis dataKey="name" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} />
                              <YAxis stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} tickFormatter={(val) => `${val}€`} />
                              <RechartsTooltip contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px', color: '#fff' }} formatter={(value) => [`${value.toFixed(2)}€`, 'Beneficio']} />
                              <Line type="monotone" dataKey="profit" stroke="url(#slopeGradient)" strokeWidth={3} dot={false} activeDot={{ r: 6 }} />
                            </LineChart>
                          );
                        })()}
                      </ResponsiveContainer>
                    </div>
                  </div>
                  <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-xl">
                    <h3 className="font-bold text-sm mb-4 flex items-center gap-2 text-slate-400 uppercase tracking-wider"><BarChart2 size={16} /> Evolución Semanal</h3>
                    <div className="h-[250px] w-full">
                      <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={financialStats.weeklyChartData}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                          <XAxis dataKey="name" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} />
                          <YAxis stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} tickFormatter={(val) => `${val}€`} />
                          <RechartsTooltip contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px', color: '#fff' }} formatter={(value) => [`${value.toFixed(2)}€`, 'Profit Semanal']} />
                          <Bar dataKey="profit" radius={[4, 4, 4, 4]}>
                            {financialStats.weeklyChartData.map((entry, index) => (
                              <Cell key={`cell-${index}`} fill={entry.profit >= 0 ? '#10b981' : '#ef4444'} />
                            ))}
                          </Bar>
                        </BarChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                  <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-xl">
                    <h3 className="font-bold text-sm mb-4 flex items-center gap-2 text-slate-400 uppercase tracking-wider"><BarChart2 size={16} /> Rentabilidad Neta (€)</h3>
                    <div className="h-[250px] w-full">
                      <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={strategyStats} margin={{ bottom: 20 }}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                          <XAxis dataKey="name" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} interval={0} angle={-45} textAnchor="end" height={80} />
                          <YAxis stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} />
                          <Bar dataKey="profit" radius={[4, 4, 0, 0]}>
                            {strategyStats.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.profit >= 0 ? '#10b981' : '#ef4444'} />)}
                          </Bar>
                        </BarChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* 2. CHALLENGES */}
            {/* 2. CHALLENGES (IMPROVED V9) */}
            {activeSection === 'challenges' && (
              <div className="space-y-6 animate-fade-in relative">
                <header className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                  <div>
                    <h2 className="text-2xl font-bold text-white mb-2 flex items-center gap-2"><Trophy className="text-yellow-500" /> Retos & Competición</h2>
                    <p className="text-sm text-slate-400">Seguimiento de interés compuesto y objetivos.</p>
                  </div>
                  <div className="flex gap-2">
                    <div className="bg-slate-900 p-1 rounded-lg border border-slate-800 flex">
                      <button onClick={() => setChallengeTab('active')} className={`px-4 py-2 text-xs font-bold rounded-md transition-all ${challengeTab === 'active' ? 'bg-slate-800 text-white shadow' : 'text-slate-500 hover:text-slate-300'}`}>ACTIVOS</button>
                      <button onClick={() => setChallengeTab('history')} className={`px-4 py-2 text-xs font-bold rounded-md transition-all ${challengeTab === 'history' ? 'bg-slate-800 text-white shadow' : 'text-slate-500 hover:text-slate-300'}`}>HISTORIAL</button>
                    </div>
                    <button onClick={() => setIsCreatingChallenge(true)} className="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold text-xs flex items-center gap-2 shadow-lg hover:shadow-emerald-900/20 transition-all"><Plus size={16} /> NUEVO RETO</button>
                  </div>
                </header>

                {/* CHALLENGES GLOBAL ANALYTICS DASHBOARD (V14) */}
                <div className="bg-slate-900 rounded-xl border border-slate-800 p-6 mb-8 shadow-2xl relative overflow-hidden">
                  <div className="flex justify-between items-start mb-6 z-10 relative">
                    <div className="flex items-center gap-3">
                      <div className="p-3 bg-indigo-500/20 rounded-lg border border-indigo-500/30 text-indigo-400"><Trophy size={24} /></div>
                      {/* HEADER PRO (V32: Cloud Button) */}
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2">
                          <h1 className="text-xl md:text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-cyan-400 truncate">
                            BETMANAGER <span className="text-[10px] text-slate-500 font-mono align-top ml-1 opacity-50">v32.0 Cloud</span>
                          </h1>
                          <button onClick={() => setShowCloudModal(true)} className="px-2 py-1 bg-indigo-600/20 text-indigo-400 border border-indigo-600/40 rounded text-[10px] font-bold hover:bg-indigo-600/40 hover:text-white transition-colors flex items-center gap-1 animate-pulse">
                            <Cloud size={12} /> NUBE
                          </button>
                        </div>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      <Filter size={14} className="text-slate-500" />
                      <select className="bg-slate-950 border border-slate-700 text-xs rounded px-2 py-1 text-slate-300 outline-none focus:border-indigo-500" value={challengeStatsFilter} onChange={e => setChallengeStatsFilter(e.target.value)}>
                        <option value="ALL">Todos los Tipsters</option>
                        {tipsters.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                        <option value="Personal">Personal</option>
                      </select>
                    </div>
                  </div>

                  {/* CALCULATE FILTERED STATS ON THE FLY */}
                  {(() => {
                    const allSteps = challengesGlobalStats.allSteps.filter(s => challengeStatsFilter === 'ALL' || s.tipster === challengeStatsFilter);

                    // For "Total Invested" and "Current Value", filtering by Tipster is tricky because challenges are mixed.
                    // PROPOSAL: If Filter is active, Show "Contribution" of that Tipster (Profit generated by his steps).
                    // If Filter is ALL, show Global Bank stats.

                    const stepsWon = allSteps.filter(s => s.result === 'win').length;
                    const stepsTotal = allSteps.filter(s => s.result !== 'void' && s.result !== 'pending' && s.result !== 'deposit').length;
                    const winRate = stepsTotal > 0 ? ((stepsWon / stepsTotal) * 100).toFixed(1) : 0;
                    const stepsProfit = allSteps.reduce((sum, s) => sum + (s.profit || 0), 0);

                    return (
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 z-10 relative">

                        {challengeStatsFilter === 'ALL' ? (
                          <>
                            <div className="bg-slate-950/50 p-4 rounded-xl border border-slate-800">
                              <div className="text-xs text-slate-500 uppercase font-bold mb-1">Total Invertido</div>
                              <div className="text-2xl font-mono text-white font-bold">{challengesGlobalStats.totalInvested.toFixed(2)}€</div>
                            </div>
                            <div className="bg-slate-900 p-4 rounded-xl border border-slate-800">
                              <div className="text-xs text-slate-500 uppercase font-bold mb-1">Valor Actual</div>
                              <div className={`text-2xl font-mono font-bold ${challengesGlobalStats.totalCurrentValue >= challengesGlobalStats.totalInvested ? 'text-emerald-400' : 'text-red-400'}`}>{challengesGlobalStats.totalCurrentValue.toFixed(2)}€</div>
                            </div>
                          </>
                        ) : (
                          <div className="bg-slate-950/50 p-4 rounded-xl border border-slate-800 col-span-2">
                            <div className="text-xs text-slate-500 uppercase font-bold mb-1">Profit Generado ({challengeStatsFilter})</div>
                            <div className={`text-2xl font-mono font-bold ${stepsProfit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{stepsProfit > 0 ? '+' : ''}{stepsProfit.toFixed(2)}€</div>
                          </div>
                        )}

                        <div className="bg-slate-950/50 p-4 rounded-xl border border-slate-800">
                          <div className="text-xs text-slate-500 uppercase font-bold mb-1">Pasos Ganados</div>
                          <div className="text-2xl font-mono text-indigo-400 font-bold">{stepsWon}/{stepsTotal} <span className="text-sm text-slate-500">({winRate}%)</span></div>
                        </div>
                        <div className="bg-slate-950/50 p-4 rounded-xl border border-slate-800">
                          <div className="text-xs text-slate-500 uppercase font-bold mb-1">Retos Activos</div>
                          <div className="text-2xl font-mono text-white font-bold">{challengesGlobalStats.active} <span className="text-sm text-slate-500">/ {challengesGlobalStats.totalChallenges}</span></div>
                        </div>
                      </div>
                    );
                  })()}

                  {/* Background Decor */}
                  <div className="absolute top-0 right-0 -mr-10 -mt-10 w-64 h-64 bg-indigo-500/10 rounded-full blur-3xl pointer-events-none"></div>
                </div>

                {/* MODAL CREAR RETO */}
                {isCreatingChallenge && (
                  <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4 animate-fade-in backdrop-blur-sm" onClick={() => setIsCreatingChallenge(false)}>
                    <div className="bg-slate-900 w-full max-w-md rounded-xl border border-slate-700 shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
                      <div className="p-4 border-b border-slate-800 bg-slate-950 flex justify-between items-center">
                        <h3 className="font-bold text-white uppercase text-sm">Nuevo Reto Personalizado</h3>
                        <button onClick={() => setIsCreatingChallenge(false)}><X size={20} className="text-slate-500 hover:text-white" /></button>
                      </div>
                      <form onSubmit={handleCreateChallenge} className="p-6 space-y-4">
                        <div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Título del Reto</label><input type="text" value={newChallengeData.title} onChange={e => setNewChallengeData({ ...newChallengeData, title: e.target.value })} className="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white text-sm" placeholder="Ej: Reto Verano 10k" required /></div>
                        <div className="grid grid-cols-2 gap-4">
                          <div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Bank Inicial (€)</label><input type="number" step="0.01" value={newChallengeData.bank} onChange={e => setNewChallengeData({ ...newChallengeData, bank: e.target.value })} className="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white text-sm" placeholder="100" required /></div>
                          <div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Objetivo Total (€)</label><input type="number" step="1" value={newChallengeData.target} onChange={e => setNewChallengeData({ ...newChallengeData, target: e.target.value })} className="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white text-sm" placeholder="10000" required /></div>
                        </div>
                        <div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Color Tema</label><select value={newChallengeData.color} onChange={e => setNewChallengeData({ ...newChallengeData, color: e.target.value })} className="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white text-sm"><option value="emerald">Verde (Default)</option><option value="purple">Púrpura (High Stakes)</option><option value="blue">Azul (Conservador)</option><option value="orange">Naranja (Agresivo)</option></select></div>
                        <button type="submit" className="w-full bg-emerald-600 hover:bg-emerald-500 py-3 rounded font-bold text-white shadow-lg mt-2">Crear Reto</button>
                      </form>
                    </div>
                  </div>
                )}

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {challenges.filter(c => (challengeTab === 'active' ? (!c.status || c.status === 'active') : (c.status === 'won' || c.status === 'lost'))).map(challenge => {
                    const percent = Math.min(100, (challenge.currentBank / challenge.targetBank) * 100).toFixed(1);
                    const isAdding = challengeForm.id === challenge.id;

                    let headerColor = "from-slate-900 to-slate-800";
                    let barColor = "bg-emerald-500";
                    if (challenge.color === 'purple') { headerColor = "from-slate-900 to-purple-900/30"; barColor = "bg-purple-500"; }
                    if (challenge.color === 'blue') { headerColor = "from-slate-900 to-blue-900/30"; barColor = "bg-blue-500"; }
                    if (challenge.color === 'orange') { headerColor = "from-slate-900 to-orange-900/30"; barColor = "bg-orange-500"; }

                    // STATUS BADGES FOR HISTORY
                    const isWon = challenge.status === 'won';
                    const isLost = challenge.status === 'lost';

                    return (
                      <div key={challenge.id} className={`bg-slate-900 rounded-xl border ${isWon ? 'border-emerald-500/50' : (isLost ? 'border-red-500/50' : 'border-slate-800')} shadow-xl overflow-hidden relative`}>
                        {isWon && <div className="absolute top-4 right-4 z-10 text-emerald-500 font-black text-6xl opacity-10 rotate-12 pointer-events-none">WIN</div>}
                        {isLost && <div className="absolute top-4 right-4 z-10 text-red-500 font-black text-6xl opacity-10 rotate-12 pointer-events-none">LOST</div>}

                        <div className={`p-6 border-b border-slate-800 bg-gradient-to-r ${headerColor}`}>
                          <div className="flex justify-between items-start mb-4">
                            <div className="flex-1">
                              <h3 className="text-xl font-bold text-white flex items-center gap-2">
                                {challenge.title}
                                {challengeTab === 'active' && (
                                  <button onClick={() => addFunds(challenge.id)} title="Reingresar Saldo (Another Bullet)" className="text-xs bg-slate-800 hover:bg-emerald-600/30 text-slate-400 hover:text-emerald-400 p-1.5 rounded border border-slate-700 transition-colors">
                                    <RefreshCw size={12} />
                                  </button>
                                )}
                              </h3>
                              <div className="text-slate-400 text-sm mt-1">{challenge.subtitle}</div>
                              {/* ACTION BUTTONS FOR ACTIVE & HISTORY */}
                              <div className="flex gap-2 mt-3">
                                {challengeTab === 'active' ? (
                                  <>
                                    <button onClick={() => updateChallengeStatus(challenge.id, 'won')} className="px-2 py-1 bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 rounded text-[10px] font-bold flex items-center gap-1 transition-colors"><CheckCircle size={10} /> COMPLETADO</button>
                                    <button onClick={() => updateChallengeStatus(challenge.id, 'lost')} className="px-2 py-1 bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/30 rounded text-[10px] font-bold flex items-center gap-1 transition-colors"><XCircle size={10} /> FALLIDO</button>
                                  </>
                                ) : (
                                  <>
                                    <span className={`px-2 py-1 rounded text-[10px] font-bold border ${isWon ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/30' : 'bg-red-500/10 text-red-400 border-red-500/30'}`}>{isWon ? 'RETO COMPLETADO' : 'RETO FALLIDO'}</span>
                                    {isLost && (
                                      <>
                                        <button onClick={() => resumeChallenge(challenge)} className="px-2 py-1 bg-yellow-500/10 hover:bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 rounded text-[10px] font-bold flex items-center gap-1 transition-colors"><Activity size={10} /> CONTINUAR</button>
                                        <button onClick={() => rescueChallenge(challenge)} className="px-2 py-1 bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 border border-blue-500/30 rounded text-[10px] font-bold flex items-center gap-1 transition-colors"><RefreshCw size={10} /> REINICIAR</button>
                                      </>
                                    )}
                                  </>
                                )}
                              </div>
                            </div>
                            <div className="text-right">
                              <div className={`text-3xl font-bold font-mono ${challenge.currentBank >= challenge.initialBank ? 'text-emerald-400' : 'text-red-400'}`}>{challenge.currentBank.toFixed(2)}€</div>
                              <div className="text-xs text-slate-500">Saldo Actual</div>
                            </div>
                          </div>
                          <div className="relative h-4 bg-slate-950 rounded-full overflow-hidden border border-slate-800">
                            <div className={`absolute top-0 left-0 h-full ${barColor} transition-all duration-1000`} style={{ width: `${percent}%` }}></div>
                          </div>
                          <div className="flex justify-between mt-2 text-xs font-bold text-slate-500">
                            <span>Inicio: {challenge.initialBank}€</span>
                            <span>{percent}% Completado</span>
                          </div>
                        </div>

                        {challengeTab === 'active' && (
                          activeChallengeId === challenge.id ? (
                            <div id={`challenge-form-${challenge.id}`} className={`p-4 bg-slate-950 border-b ${editingChallengeBet && editingChallengeBet.id ? 'border-amber-500/50' : 'border-slate-800'} animate-fade-in`}>
                              <div className="flex justify-between items-center mb-3">
                                <h4 className={`text-sm font-bold uppercase ${editingChallengeBet ? 'text-amber-400' : 'text-emerald-400'}`}>
                                  {editingChallengeBet ? `Editando Paso #${editingChallengeBet.id}` : 'Nuevo Paso'}
                                </h4>
                                <button type="button" onClick={() => setIsChallengeMulti(!isChallengeMulti)} className={`text-[10px] font-bold px-2 py-1 rounded border ${isChallengeMulti ? 'bg-indigo-500 text-white border-indigo-500' : 'bg-slate-900 text-slate-500 border-slate-700'}`}>
                                  {isChallengeMulti ? 'MODO COMBINADA' : 'MODO SIMPLE'}
                                </button>
                              </div>

                              <form onSubmit={(e) => addChallengeBet(e, challenge.id)} className="space-y-3">
                                {/* Stake */}
                                <div className="relative">
                                  <input type="number" placeholder="Stake" step="0.01" value={challengeForm.stake} onChange={e => setChallengeForm({ ...challengeForm, stake: e.target.value })} className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-sm pr-12 focus:border-emerald-500 transition-colors" required />
                                  <button type="button" onClick={() => setChallengeForm({ ...challengeForm, stake: challenge.currentBank })} className="absolute right-1 top-1 bottom-1 text-[10px] font-bold text-emerald-500 hover:bg-emerald-900/30 px-2 rounded">ALL-IN</button>
                                </div>

                                {/* INPUTS: SIMPLE vs MULTI */}
                                {isChallengeMulti ? (
                                  <div className="bg-slate-900 rounded p-3 border border-slate-800 space-y-2">
                                    <div className="flex justify-between text-[10px] text-slate-500 uppercase font-bold"><span>Líneas ({challengeForm.lines.length})</span> <span>Cuota Total: {challengeForm.lines.reduce((a, b) => a * (parseFloat(b.odds) || 1), 1).toFixed(2)}</span></div>
                                    {challengeForm.lines.map((line, idx) => (
                                      <div key={idx} className="flex flex-col gap-1 bg-slate-950/50 p-2 rounded border border-slate-700/50">
                                        <div className="flex gap-2">
                                          <select value={line.tipster} onChange={e => updateChallengeLine(idx, 'tipster', e.target.value)} className="w-[120px] bg-slate-900 border border-slate-700 rounded p-1 text-xs text-white">
                                            <option value="">Personal</option>
                                            {tipsters.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                                          </select>
                                          <input type="number" placeholder="@" step="0.01" value={line.odds} onChange={e => updateChallengeLine(idx, 'odds', e.target.value)} className="w-16 bg-slate-900 border border-slate-700 rounded p-1 text-xs text-white text-center font-mono" />
                                          <button type="button" onClick={() => removeChallengeLine(idx)} className="text-red-500 hover:bg-red-900/20 p-1 rounded ml-auto"><Trash2 size={12} /></button>
                                        </div>
                                        <input type="text" placeholder="Descripción línea..." value={line.desc} onChange={e => updateChallengeLine(idx, 'desc', e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded p-1 text-xs text-slate-300" />
                                      </div>
                                    ))}
                                    <button type="button" onClick={addChallengeLine} className="w-full py-1 text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 rounded font-bold transition-colors">+ Añadir Línea</button>
                                  </div>
                                ) : (
                                  <div className="grid grid-cols-2 gap-3">
                                    <div className="relative">
                                      <span className="absolute left-2 top-2 text-[10px] text-emerald-500 font-bold">@</span>
                                      <input type="number" placeholder="Cuota" step="0.01" value={challengeForm.odds} onChange={e => setChallengeForm({ ...challengeForm, odds: e.target.value, profit: '' })} className="w-full bg-slate-900 border border-slate-700 rounded p-2 pl-6 text-white text-sm focus:border-emerald-500" disabled={!!challengeForm.profit} />
                                    </div>
                                    <div className="relative">
                                      <span className="absolute left-2 top-2 text-[10px] text-emerald-500 font-bold">Gain</span>
                                      <input type="number" placeholder="Ganancia" step="0.01" value={challengeForm.profit} onChange={e => setChallengeForm({ ...challengeForm, profit: e.target.value, odds: '' })} className="w-full bg-slate-900 border border-slate-700 rounded p-2 pl-8 text-white text-sm focus:border-emerald-500" disabled={!!challengeForm.odds} />
                                    </div>
                                  </div>
                                )}

                                <div className="grid grid-cols-3 gap-3">
                                  <div className="col-span-1">
                                    <select value={challengeForm.tipster} onChange={e => setChallengeForm({ ...challengeForm, tipster: e.target.value })} className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-xs outline-none focus:border-emerald-500">
                                      <option value="">Personal</option>
                                      {tipsters.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                                    </select>
                                  </div>
                                  <div className="col-span-2">
                                    {!isChallengeMulti && <input type="text" placeholder="Descripción (ej: Paso 1 - Madrid)" value={challengeForm.desc} onChange={e => setChallengeForm({ ...challengeForm, desc: e.target.value })} className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-sm focus:border-emerald-500" required />}
                                  </div>
                                </div>

                                <div className="flex gap-2 pt-2">
                                  <button type="submit" className="flex-1 bg-emerald-600 text-white py-2 rounded font-bold text-sm hover:bg-emerald-500 shadow-lg shadow-emerald-900/20 transform active:scale-95 transition-all">Guardar Paso</button>
                                  <button type="button" onClick={() => { setActiveChallengeId(null); setChallengeForm({ id: null, stake: '', odds: '', profit: '', desc: '', lines: [] }); setIsChallengeMulti(false); }} className="px-3 bg-slate-800 text-slate-400 rounded hover:bg-slate-700 font-bold text-sm">Cancelar</button>
                                </div>
                              </form>
                            </div>
                          ) : (
                            <div className="p-4 space-y-4">
                              <button onClick={() => setActiveChallengeId(challenge.id)} className="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-bold shadow-lg shadow-indigo-900/20 transition-all flex items-center justify-center gap-2 transform active:scale-95">
                                <Plus size={18} /> Registrar Nuevo Paso
                              </button>

                              {/* CHALLENGE ANALYTICS DASHBOARD (V13) */}
                              <div className="bg-slate-950 rounded-xl border border-slate-800 p-4 space-y-4">
                                <div className="flex items-center gap-2 mb-2">
                                  <BarChart2 size={16} className="text-indigo-400" />
                                  <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider">Analítica del Reto</h4>
                                </div>

                                {/* KPIs GRID */}
                                <div className="grid grid-cols-2 lg:grid-cols-4 gap-3">
                                  {(() => {
                                    const invested = challenge.initialBank + challenge.history.filter(h => h.result === 'deposit').reduce((sum, d) => sum + d.profit, 0);
                                    const netProfit = challenge.currentBank - invested;
                                    const roi = invested > 0 ? ((netProfit / invested) * 100).toFixed(1) : 0;

                                    // Max Streak Calculation
                                    let maxStreak = 0;
                                    let currentStreak = 0;
                                    challenge.history.slice().slice().reverse().forEach(h => {
                                      if (h.result === 'win') { currentStreak++; maxStreak = Math.max(maxStreak, currentStreak); }
                                      else if (h.result === 'loss') currentStreak = 0;
                                    });

                                    return (
                                      <>
                                        <div className="bg-slate-900 p-2 rounded border border-slate-800">
                                          <div className="text-[10px] text-slate-500 uppercase">Inversión Total</div>
                                          <div className="text-sm font-bold text-white">{invested.toFixed(2)}€</div>
                                        </div>
                                        <div className="bg-slate-900 p-2 rounded border border-slate-800">
                                          <div className="text-[10px] text-slate-500 uppercase">Beneficio Neto</div>
                                          <div className={`text-sm font-bold ${netProfit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{netProfit >= 0 ? '+' : ''}{netProfit.toFixed(2)}€</div>
                                        </div>
                                        <div className="bg-slate-900 p-2 rounded border border-slate-800">
                                          <div className="text-[10px] text-slate-500 uppercase">ROI Reto</div>
                                          <div className={`text-sm font-bold ${roi >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{roi}%</div>
                                        </div>
                                        <div className="bg-slate-900 p-2 rounded border border-slate-800">
                                          <div className="text-[10px] text-slate-500 uppercase">Mejor Racha</div>
                                          <div className="text-sm font-bold text-orange-400 flex items-center gap-1"><Flame size={12} /> {maxStreak} Pasos</div>
                                        </div>
                                      </>
                                    );
                                  })()}
                                </div>

                                {/* BANK EVOLUTION CHART */}
                                <div className="h-32 w-full mt-4">
                                  <ResponsiveContainer width="100%" height="100%">
                                    <AreaChart data={[
                                      { name: 'Inicio', bank: challenge.initialBank },
                                      ...challenge.history.slice().reverse().reduce((acc, curr, idx) => {
                                        const prevBank = idx === 0 ? challenge.initialBank : acc[idx - 1].bank;
                                        const newBank = prevBank + (curr.profit || 0);
                                        acc.push({ name: `P${idx + 1}`, bank: newBank });
                                        return acc;
                                      }, [])
                                    ]}>
                                      <defs>
                                        <linearGradient id="colorBank" x1="0" y1="0" x2="0" y2="1">
                                          <stop offset="5%" stopColor="#10b981" stopOpacity={0.3} />
                                          <stop offset="95%" stopColor="#10b981" stopOpacity={0} />
                                        </linearGradient>
                                      </defs>
                                      <RechartsTooltip contentStyle={{ backgroundColor: '#0f172a', borderColor: '#1e293b' }} itemStyle={{ color: '#fff' }} />
                                      <Area type="monotone" dataKey="bank" stroke="#10b981" fillOpacity={1} fill="url(#colorBank)" strokeWidth={2} />
                                    </AreaChart>
                                  </ResponsiveContainer>
                                </div>
                              </div>
                            </div>
                          )
                        )}

                        <div className="max-h-[300px] overflow-y-auto">
                          <table className="w-full text-left text-sm">
                            <thead className="bg-slate-950 text-slate-500 text-xs uppercase sticky top-0">
                              <tr><th className="p-3">Detalle</th><th className="p-3 text-center">Stake/Cuota</th><th className="p-3 text-right">Resultado</th><th className="p-3 text-center">Acción</th></tr>
                            </thead>
                            <tbody className="divide-y divide-slate-800">
                              {challenge.history.length === 0 ? (
                                <tr><td colSpan="4" className="p-6 text-center text-slate-500 text-xs italic">Aún no hay movimientos en este reto.</td></tr>
                              ) : (
                                challenge.history.map(bet => {
                                  const isMulti = bet.betLines && bet.betLines.length > 0;
                                  const isExpanded = expandedChallengeSteps.includes(bet.id);

                                  return (
                                    <React.Fragment key={bet.id}>
                                      <tr className={`hover:bg-slate-800/50 ${isExpanded ? 'bg-slate-800/30' : ''}`}>
                                        <td className="p-3 cursor-pointer" onClick={() => isMulti && toggleChallengeExpansion(bet.id)}>
                                          <div className="font-bold text-white text-xs flex items-center gap-2">
                                            {isMulti && <Layers size={10} className="text-indigo-400" />}
                                            {bet.description}
                                          </div>
                                          <div className="text-[10px] text-slate-500">{bet.date}</div>
                                          {isMulti && <div className="text-[9px] text-indigo-400 mt-0.5">{isExpanded ? 'Ocultar líneas' : 'Ver líneas'}</div>}
                                        </td>
                                        <td className="p-3 text-center text-xs text-slate-300"><div>{bet.stake}€</div><div className="text-slate-500">@{bet.odds}</div></td>
                                        <td className="p-3 text-right">
                                          {bet.result === 'pending' ? (
                                            <div className="flex justify-end gap-1">
                                              <button onClick={() => resolveChallengeBet(challenge.id, bet.id, 'win')} className="p-1 bg-emerald-600/20 text-emerald-400 rounded"><Check size={14} /></button>
                                              <button onClick={() => resolveChallengeBet(challenge.id, bet.id, 'loss')} className="p-1 bg-red-600/20 text-red-400 rounded"><X size={14} /></button>
                                            </div>
                                          ) : (
                                            <span className={`font-bold text-xs ${bet.result === 'win' ? 'text-emerald-400' : 'text-red-400'}`}>{bet.result === 'win' ? `+${bet.profit.toFixed(2)}€` : `-${bet.stake}€`}</span>
                                          )}
                                        </td>
                                        <td className="p-3 text-center flex items-center justify-center gap-2">
                                          <button onClick={() => {
                                            // EDIT MODE TRIGGER
                                            setEditingChallengeBet(bet);
                                            setActiveChallengeId(challenge.id);
                                            setChallengeForm({
                                              id: bet.id, // Important for tracking
                                              stake: bet.stake,
                                              odds: bet.odds,
                                              profit: bet.result === 'win' ? bet.profit.toFixed(2) : '',
                                              desc: bet.description,
                                              tipster: bet.tipster,
                                              lines: bet.betLines || []
                                            });
                                            setIsChallengeMulti(bet.betLines && bet.betLines.length > 0);

                                            // Scroll to form (simple hack)
                                            const formEl = document.getElementById(`challenge-form-${challenge.id}`);
                                            if (formEl) formEl.scrollIntoView({ behavior: 'smooth' });

                                          }} className="text-slate-600 hover:text-blue-400"><Edit size={14} /></button>
                                          <button onClick={() => deleteChallengeBet(challenge.id, bet.id)} className="text-slate-600 hover:text-red-400"><Trash2 size={14} /></button>
                                        </td>
                                      </tr>
                                      {isMulti && isExpanded && (
                                        <tr className="bg-slate-900/50">
                                          <td colSpan="4" className="p-2 pl-4">
                                            <div className="space-y-1 border-l-2 border-indigo-500/30 pl-2">
                                              {bet.betLines.map((l, i) => (
                                                <div key={i} className="flex justify-between items-center text-xs">
                                                  <span className="text-slate-400 truncate max-w-[200px]">
                                                    {(bet.tipster === 'Mezcla-Tips' || bet.tipster === 'Combis (Apuesta D)') ? <span className="font-bold text-indigo-300">{l.tipster || 'Personal'}</span> : null}
                                                    {l.desc}
                                                  </span>
                                                  <span className="font-mono text-slate-500">@{l.odds}</span>
                                                </div>
                                              ))}
                                            </div>
                                          </td>
                                        </tr>
                                      )}
                                    </React.Fragment>
                                  )
                                })
                              )}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* 3. STATS (CON CUOTA MEDIA Y W/L/V) */}
            {activeSection === 'stats' && (
              <div className="space-y-8 animate-fade-in">
                <section>
                  <header className="mb-4">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2"><Layers className="text-blue-500" /> Rendimiento Financiero Global</h2>
                    <p className="text-sm text-slate-400">Resultados reales por estrategia. Desglose W-L-V (Win-Loss-Void).</p>
                  </header>
                  <div className="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden shadow-lg">
                    <div className="overflow-x-auto">
                      <table className="w-full text-left text-sm min-w-[700px]">
                        <thead className="bg-slate-950 text-slate-400 uppercase text-xs font-bold tracking-wider">
                          <tr>
                            <th className="p-4">Estrategia</th>
                            <th className="p-4 text-center">Bets (W-L-V)</th>
                            <th className="p-4 text-center">Cuota Media</th>
                            <th className="p-4 text-center">Stake Medio</th>
                            <th className="p-4 text-right">Inversión</th>
                            <th className="p-4 text-right">Beneficio</th>
                            <th className="p-4 text-center">Yield</th>
                            <th className="p-4 text-center">Win %</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-800">
                          {strategyStats.map((s) => (
                            <tr key={s.name} onClick={() => { setSelectedTipsterStats(s); setWhatIfStake(s.avgStake); }} className="hover:bg-slate-800/50 cursor-pointer transition-colors group">
                              <td className="p-4 font-bold text-white">{s.name}</td>
                              <td className="p-4 text-center text-slate-300">
                                <span className="text-emerald-400 font-bold">{s.wins}</span>-<span className="text-red-400 font-bold">{s.losses}</span>-<span className="text-slate-500 font-bold">{s.voids}</span>
                              </td>
                              <td className="p-4 text-center text-slate-300 font-mono">@{s.avgOdds}</td>
                              <td className="p-4 text-center text-slate-300 font-mono">{s.avgStake}€</td>
                              <td className="p-4 text-right text-slate-300">{s.staked.toFixed(2)}€</td>
                              <td className={`p-4 text-right font-bold font-mono ${s.profit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                {s.profit >= 0 ? '+' : ''}{s.profit.toFixed(2)}€
                              </td>
                              <td className={`p-4 text-center font-bold ${parseFloat(s.yield) > 0 ? 'text-blue-400' : 'text-slate-500'}`}>{s.yield}%</td>
                              <td className="p-4 text-center text-slate-400">
                                <div className="flex items-center justify-center gap-2">
                                  <div className="w-12 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                    <div className={`h-full rounded-full ${parseFloat(s.winRate) > 50 ? 'bg-emerald-500' : 'bg-yellow-500'}`} style={{ width: `${s.winRate}%` }}></div>
                                  </div>
                                  <span>{s.winRate}%</span>
                                </div>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </section>
                <section>
                  <header className="mb-4">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2"><Target className="text-purple-500" /> Rendimiento por Rango de Cuota</h2>
                  </header>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden shadow-lg">
                      <table className="w-full text-left text-sm">
                        <thead className="bg-slate-950 text-slate-400 uppercase text-xs font-bold">
                          <tr><th className="p-3">Rango</th><th className="p-3 text-center">Bets</th><th className="p-3 text-right">Profit</th><th className="p-3 text-center">Yield</th></tr>
                        </thead>
                        <tbody className="divide-y divide-slate-800">
                          {oddsStats.map((r, i) => (
                            <tr key={i} className="hover:bg-slate-800/50">
                              <td className="p-3 font-bold text-white">{r.label}</td>
                              <td className="p-3 text-center text-slate-400">{r.bets}</td>
                              <td className={`p-3 text-right font-bold ${r.profit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{r.profit.toFixed(2)}€</td>
                              <td className={`p-3 text-center font-bold ${parseFloat(r.yield) > 0 ? 'text-blue-400' : 'text-slate-500'}`}>{r.yield}%</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                    <div className="bg-slate-900 rounded-xl border border-slate-800 p-4 shadow-lg">
                      <ResponsiveContainer width="100%" height={200}>
                        <BarChart data={oddsStats}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} /><XAxis dataKey="label" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} interval={0} /><YAxis stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} /><Bar dataKey="profit" radius={[4, 4, 0, 0]}>{oddsStats.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.profit >= 0 ? '#8b5cf6' : '#ef4444'} />)}</Bar>
                        </BarChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                </section>
                <section>
                  <header className="mb-4">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2"><Zap className="text-yellow-500" /> Scout Predictivo Individual</h2>
                  </header>
                  <div className="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden shadow-lg">
                    <div className="overflow-x-auto">
                      <table className="w-full text-left text-sm min-w-[600px]">
                        <thead className="bg-slate-950 text-slate-400 uppercase text-xs font-bold tracking-wider">
                          <tr><th className="p-4">Tipster</th><th className="p-4 text-center">Picks Totales</th><th className="p-4 text-center">W - L - V</th><th className="p-4 text-center">Stake Medio</th><th className="p-4 text-center">Efectividad %</th></tr>
                        </thead>
                        <tbody className="divide-y divide-slate-800">
                          {scoutStats.map((s) => (
                            <tr key={s.name} onClick={() => { setSelectedTipsterStats(s); setWhatIfStake(s.avgStake); }} className="hover:bg-slate-800/50 cursor-pointer transition-colors group">
                              <td className="p-4 font-bold text-white">{s.name}</td>
                              <td className="p-4 text-center text-slate-300">{s.picks}</td>
                              <td className="p-4 text-center text-slate-300"><span className="text-emerald-400 font-bold">{s.wins}</span> - <span className="text-red-400 font-bold">{s.losses}</span> - {s.voids}</td>
                              <td className="p-4 text-center text-slate-300 font-mono">{s.avgStake}€</td>
                              <td className="p-4 text-center"><div className="flex items-center justify-center gap-2"><div className="w-16 h-2 bg-slate-700 rounded-full overflow-hidden"><div className={`h-full rounded-full ${parseFloat(s.winRate) > 60 ? 'bg-emerald-500' : 'bg-yellow-500'}`} style={{ width: `${s.winRate}%` }}></div></div><span className="font-mono font-bold">{s.winRate}%</span></div></td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </section>

                {/* NEW CHARTS SECTION (V38) */}
                <section>
                  <header className="mb-4">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2"><BarChart2 className="text-orange-500" /> Distribución Mensual y Temática</h2>
                  </header>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {/* MONTHLY */}
                    <div className="bg-slate-900 rounded-xl border border-slate-800 p-4 shadow-lg">
                      <h3 className="text-xs font-bold text-slate-400 uppercase mb-4">Evolución Mensual</h3>
                      <div className="h-[250px] w-full">
                        <ResponsiveContainer width="100%" height="100%">
                          <BarChart data={financialStats.monthlyChartData}>
                            <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                            <XAxis dataKey="name" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} />
                            <YAxis stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} tickFormatter={(val) => `${val}€`} />
                            <RechartsTooltip contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px', color: '#fff' }} formatter={(value) => [`${value.toFixed(2)}€`, 'Profit']} />
                            <Bar dataKey="profit" radius={[4, 4, 4, 4]}>
                              {financialStats.monthlyChartData.map((entry, index) => (
                                <Cell key={`cell-${index}`} fill={entry.profit >= 0 ? '#10b981' : '#ef4444'} />
                              ))}
                            </Bar>
                          </BarChart>
                        </ResponsiveContainer>
                      </div>
                    </div>

                    {/* TAGS */}
                    <div className="bg-slate-900 rounded-xl border border-slate-800 p-4 shadow-lg">
                      <h3 className="text-xs font-bold text-slate-400 uppercase mb-4">Profit por Etiqueta/Deporte</h3>
                      <div className="h-[250px] w-full">
                        <ResponsiveContainer width="100%" height="100%">
                          <BarChart data={financialStats.tagStats.slice(0, 8)} layout="vertical">
                            <CartesianGrid strokeDasharray="3 3" stroke="#334155" horizontal={true} vertical={false} />
                            <XAxis type="number" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} />
                            <YAxis dataKey="name" type="category" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} width={80} />
                            <RechartsTooltip contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px', color: '#fff' }} />
                            <Bar dataKey="profit" radius={[0, 4, 4, 0]}>
                              {financialStats.tagStats.slice(0, 8).map((entry, index) => (
                                <Cell key={`cell-${index}`} fill={entry.profit >= 0 ? '#8b5cf6' : '#f59e0b'} />
                              ))}
                            </Bar>
                          </BarChart>
                        </ResponsiveContainer>
                      </div>
                    </div>
                  </div>
                </section>

                {/* NEW: TIPSTER EVOLUTION (V40 Multi-line) */}
                <section className="mb-8 pl-4 pr-4">
                  <header className="mb-4 flex justify-between items-center">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2"><TrendingUp className="text-blue-500" /> Comparativa de Evolución (Tipsters)</h2>
                    <div className="text-xs text-slate-500 font-mono">
                      {compSelectedTipsters.length}/{financialStats.activeTipsters.length} seleccionados
                    </div>
                  </header>

                  {/* FILTER BAR */}
                  <div className="flex flex-wrap gap-2 mb-4 bg-slate-900/50 p-2 rounded-lg border border-slate-800">
                    <button
                      onClick={() => setCompSelectedTipsters(compSelectedTipsters.length === financialStats.activeTipsters.length ? [] : financialStats.activeTipsters)}
                      className={`px-2 py-1 text-[10px] rounded font-bold transition-all border ${compSelectedTipsters.length === financialStats.activeTipsters.length ? 'bg-indigo-600 text-white border-indigo-500' : 'bg-slate-800 text-slate-400 border-slate-700 hover:text-white'}`}
                    >
                      {compSelectedTipsters.length === financialStats.activeTipsters.length ? 'Ocultar Todos' : 'Ver Todos'}
                    </button>
                    {financialStats.activeTipsters.map(t => (
                      <button
                        key={t}
                        onClick={() => {
                          if (compSelectedTipsters.includes(t)) {
                            setCompSelectedTipsters(compSelectedTipsters.filter(ct => ct !== t));
                          } else {
                            setCompSelectedTipsters([...compSelectedTipsters, t]);
                          }
                        }}
                        className={`px-2 py-1 text-[10px] rounded font-bold transition-all border flex items-center gap-1 ${compSelectedTipsters.includes(t) ? 'bg-slate-800 text-white border-blue-500/50' : 'bg-slate-950 text-slate-500 border-slate-800 hover:border-slate-600'}`}
                      >
                        <span className={`w-1.5 h-1.5 rounded-full ${compSelectedTipsters.includes(t) ? 'bg-blue-400' : 'bg-slate-600'}`}></span>
                        {t}
                      </button>
                    ))}
                  </div>

                  <div className="bg-slate-900 rounded-xl border border-slate-800 p-4 shadow-lg">
                    <div className="h-[400px] w-full">
                      <ResponsiveContainer width="100%" height="100%">
                        <LineChart data={financialStats.tipsterEvolutionData}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                          <XAxis dataKey="name" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} />
                          <YAxis stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} tickFormatter={(val) => `${val}€`} />
                          <RechartsTooltip contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px', color: '#fff' }} />
                          <Legend wrapperStyle={{ paddingTop: '20px' }} />
                          {compSelectedTipsters.map((tipster, index) => (
                            <Line
                              key={tipster}
                              type="monotone"
                              dataKey={tipster}
                              stroke={`hsl(${index * 45}, 70%, 60%)`}
                              strokeWidth={2}
                              dot={false}
                              connectNulls={true}
                              activeDot={{ r: 6 }}
                            />
                          ))}
                        </LineChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                </section>

                {/* NEW: ODDS EFFICIENCY (V40 Agent Choice) */}
                <section className="mb-8">
                  <header className="mb-4">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2"><Target className="text-emerald-500" /> Eficiencia por Cuota (Win Rate %)</h2>
                  </header>
                  <div className="bg-slate-900 rounded-xl border border-slate-800 p-4 shadow-lg">
                    <div className="h-[300px] w-full">
                      <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={financialStats.oddsEfficiencyData}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                          <XAxis dataKey="name" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} />
                          <YAxis stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} unit="%" />
                          <RechartsTooltip cursor={{ fill: 'rgba(255,255,255,0.05)' }} contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px', color: '#fff' }} formatter={(value) => [`${value}%`, 'Win Rate']} />
                          <Bar dataKey="winRate" radius={[4, 4, 0, 0]}>
                            {financialStats.oddsEfficiencyData.map((entry, index) => (
                              <Cell key={`cell-${index}`} fill={entry.winRate >= 50 ? '#10b981' : (entry.winRate >= 30 ? '#f59e0b' : '#ef4444')} />
                            ))}
                          </Bar>
                        </BarChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                </section>

                {/* --- DEEP ANALYTICS MODULES (SIA-Pro) --- */}
                <div className="pt-8 border-t border-slate-800">
                  <h2 className="text-2xl font-bold text-white mb-6 flex items-center gap-2"><Activity className="text-pink-500" /> Deep Analytics (SIA-Pro)</h2>

                  {/* 1. BANKROLL HEALTH: DRAWDOWN & STREAKS */}
                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    {/* CHART */}
                    <div className="lg:col-span-2 bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-lg">
                      <h3 className="font-bold text-sm mb-4 text-slate-400 uppercase tracking-wider flex justify-between">
                        <span><TrendingUp size={16} className="inline mr-2" /> Drawdown (Profundidad Submarina)</span>
                        <span className="text-xs text-slate-500">Caída desde Máximo Histórico</span>
                      </h3>
                      <div className="h-[250px] w-full">
                        <ResponsiveContainer width="100%" height="100%">
                          <AreaChart data={drawdownStats}>
                            <defs>
                              <linearGradient id="colorDd" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="5%" stopColor="#ef4444" stopOpacity={0.3} />
                                <stop offset="95%" stopColor="#ef4444" stopOpacity={0} />
                              </linearGradient>
                            </defs>
                            <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                            <XAxis dataKey="date" stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} tickFormatter={(val) => val.slice(5)} />
                            <YAxis stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} unit="%" domain={['auto', 'auto']} />
                            <RechartsTooltip contentStyle={{ backgroundColor: '#0f172a', borderColor: '#334155', color: '#f8fafc' }} formatter={(val) => [val + '%', 'Drawdown']} labelFormatter={(l) => l} />
                            <Area type="monotone" dataKey="drawdown" stroke="#ef4444" fillOpacity={1} fill="url(#colorDd)" strokeWidth={2} />
                          </AreaChart>
                        </ResponsiveContainer>
                      </div>
                    </div>

                    {/* STREAKS KPIs */}
                    <div className="space-y-4">
                      <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 border-l-4 border-l-emerald-500 shadow-lg">
                        <div className="text-slate-400 text-xs uppercase font-bold mb-1">Mejor Racha Ganadora</div>
                        <div className="text-3xl font-bold text-white flex items-baseline gap-2">
                          {streakStats.maxWin} <span className="text-sm text-emerald-500 font-normal">Aciertos</span>
                        </div>
                      </div>
                      <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 border-l-4 border-l-red-500 shadow-lg">
                        <div className="text-slate-400 text-xs uppercase font-bold mb-1">Peor Racha Perdedora</div>
                        <div className="text-3xl font-bold text-white flex items-baseline gap-2">
                          {streakStats.maxLoss} <span className="text-sm text-red-500 font-normal">Fallos</span>
                        </div>
                      </div>
                      <div className="bg-slate-900 p-5 rounded-xl border border-slate-800 shadow-lg flex items-center justify-between">
                        <div>
                          <div className="text-slate-400 text-[10px] uppercase font-bold">Racha Actual</div>
                          <div className={`text-xl font-bold ${parseInt(streakStats.current) > 0 ? 'text-emerald-400' : (parseInt(streakStats.current) < 0 ? 'text-red-400' : 'text-slate-400')}`}>
                            {streakStats.current > 0 ? '+' : ''}{streakStats.current}
                          </div>
                        </div>
                        <Activity className="text-slate-600" size={24} />
                      </div>
                    </div>
                  </div>

                  {/* 2. SNIPER & HEATMAP */}
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {/* SNIPER CHART */}
                    <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-lg">
                      <h3 className="font-bold text-sm mb-4 text-slate-400 uppercase tracking-wider flex items-center gap-2"><Target size={16} /> Sniper: Yield vs Cuota</h3>
                      <div className="h-[300px] w-full">
                        <ResponsiveContainer width="100%" height="100%">
                          <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: 0 }}>
                            <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                            <XAxis type="number" dataKey="x" name="Cuota" stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} unit="x" domain={['auto', 'auto']} />
                            <YAxis type="number" dataKey="y" name="Profit" stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} unit="€" />
                            <ZAxis type="number" dataKey="z" range={[60, 60]} />
                            <RechartsTooltip cursor={{ strokeDasharray: '3 3' }} content={({ active, payload }) => {
                              if (active && payload && payload.length) {
                                const data = payload[0].payload;
                                return (
                                  <div className="bg-slate-950 border border-slate-700 p-2 rounded shadow-xl text-xs">
                                    <div className="font-bold text-emerald-400">{data.name}</div>
                                    <div className="text-white">Profit: {data.y}€</div>
                                    <div className="text-slate-400">Cuota: @{data.x}</div>
                                    <div className="text-slate-500 italic max-w-[150px] truncate">{data.desc}</div>
                                  </div>
                                );
                              }
                              return null;
                            }} />
                            <Scatter name="Bets" data={sniperData} shape="circle">
                              {sniperData.map((entry, index) => (
                                <Cell key={`cell-${index}`} fill={entry.result === 'win' ? '#10b981' : '#ef4444'} />
                              ))}
                            </Scatter>
                          </ScatterChart>
                        </ResponsiveContainer>
                      </div>
                    </div>

                    {/* ACTIVITY HEATMAP */}
                    <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-lg flex flex-col">
                      <h3 className="font-bold text-sm mb-4 text-slate-400 uppercase tracking-wider flex items-center gap-2"><Calendar size={16} /> Actividad Reciente (30 días)</h3>
                      <div className="flex-1 flex items-center justify-center p-4">
                        <div className="grid grid-cols-7 gap-2">
                          {heatmapData.map((day, i) => (
                            <div key={i} title={`${day.date}: ${day.value.toFixed(2)}€`} onClick={() => day.hasActivity && setSelectedDay(day)}
                              className={`w-8 h-8 rounded-md flex items-center justify-center text-[10px] font-bold transition-all cursor-pointer
                                            ${!day.hasActivity ? 'bg-slate-800 text-slate-600' :
                                  (day.value > 0 ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/50 hover:bg-emerald-500 hover:text-white' :
                                    'bg-red-500/20 text-red-400 border border-red-500/50 hover:bg-red-500 hover:text-white')
                                }`}>
                              {day.date.split('-')[2]}
                            </div>
                          ))}
                        </div>
                      </div>
                      <div className="mt-4 text-center text-[10px] text-slate-500 italic">
                        * Intensidad basada en Profit/Loss diario.
                      </div>
                    </div>
                  </div>

                  {/* KELLY CRITERION (BONUS) */}
                  <div className="mt-6 bg-gradient-to-r from-indigo-900/20 to-purple-900/20 p-4 rounded-xl border border-indigo-500/30 text-center">
                    <div className="text-xs font-bold text-indigo-400 uppercase mb-2">Consejo Money Management (Kelly Simplificado)</div>
                    <p className="text-sm text-slate-300 max-w-3xl mx-auto">
                      Para una cuota media de <span className="text-white font-bold">@{(strategyStats.length > 0 && strategyStats.reduce((a, b) => a + parseFloat(b.avgOdds), 0) / strategyStats.length) || '2.00'}</span>
                      {' '}y un WinRate del <span className="text-white font-bold">{(scoutStats.length > 0 && (scoutStats.reduce((a, s) => a + parseFloat(s.winRate), 0) / scoutStats.length).toFixed(0)) || '50'}%</span>,
                      tu stake óptimo sugerido (Kelly/4) sería del <span className="text-emerald-400 font-bold">1.5% - 2.5%</span>.
                      ¡Mantén la disciplina!
                    </p>
                  </div>

                  {/* HEATMAP DETAILS MODAL (V6) */}
                  {selectedDay && (
                    <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4 animate-fade-in backdrop-blur-sm" onClick={() => setSelectedDay(null)}>
                      <div className="bg-slate-900 w-full max-w-md rounded-xl border border-slate-700 shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className={`p-4 ${selectedDay.value >= 0 ? 'bg-emerald-900/30 border-b border-emerald-500/30' : 'bg-red-900/30 border-b border-red-500/30'} flex justify-between items-center`}>
                          <div>
                            <h3 className="text-lg font-bold text-white flex items-center gap-2"><Calendar size={18} /> {selectedDay.date}</h3>
                            <div className={`text-sm font-mono font-bold ${selectedDay.value >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                              {selectedDay.value > 0 ? '+' : ''}{selectedDay.value.toFixed(2)}€
                            </div>
                          </div>
                          <button onClick={() => setSelectedDay(null)} className="p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-white transition-colors"><X size={20} /></button>
                        </div>
                        <div className="max-h-[400px] overflow-y-auto p-0">
                          <table className="w-full text-sm text-left">
                            <thead className="bg-slate-950 text-slate-500 text-xs uppercase sticky top-0">
                              <tr><th className="p-3">Tipster</th><th className="p-3 text-center">Cuota</th><th className="p-3 text-right">Profit</th></tr>
                            </thead>
                            <tbody className="divide-y divide-slate-800">
                              {filteredBets.filter(b => b.date === selectedDay.date && b.result !== 'pending' && b.result !== 'void').map(bet => (
                                <tr key={bet.id} className="hover:bg-slate-800/50">
                                  <td className="p-3">
                                    <div className="font-bold text-white">{bet.tipster}</div>
                                    <div className="text-[10px] text-slate-500 truncate max-w-[120px]">{bet.description}</div>
                                  </td>
                                  <td className="p-3 text-center text-slate-400 bg-slate-900/50 font-mono">@{bet.odds.toFixed(2)}</td>
                                  <td className={`p-3 text-right font-bold ${bet.profit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                    {bet.profit > 0 ? '+' : ''}{bet.profit.toFixed(2)}€
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* RESOLUTION MODAL (V7 - GRANULAR) */}
                  {resolutionBet && (
                    <div className="fixed inset-0 bg-black/90 z-[80] flex items-center justify-center p-4 animate-fade-in backdrop-blur-md">
                      <div className="bg-slate-900 w-full max-w-lg rounded-xl border border-slate-700 shadow-2xl overflow-hidden animate-scale-in">
                        <div className="p-6 bg-gradient-to-r from-slate-900 to-indigo-900/20 border-b border-slate-800">
                          <h3 className="text-xl font-bold text-white mb-1">Resolución Detallada</h3>
                          <p className="text-sm text-slate-400">Define el resultado de cada línea para el Scout.</p>
                        </div>
                        <div className="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                          {/* Support V7 Lines */}
                          {resolutionBet.tempLines && resolutionBet.tempLines.length > 0 && resolutionBet.tempLines.map((line, idx) => (
                            <div key={idx} className="bg-slate-950 p-4 rounded-lg border border-slate-800 flex flex-col gap-2">
                              <div className="flex justify-between">
                                <span className="font-bold text-indigo-400 text-sm">{line.tipster || resolutionBet.tipster}</span>
                                <span className="text-slate-500 text-xs text-right">@{line.odds}</span>
                              </div>
                              <div className="text-sm text-slate-300">{line.description}</div>
                              <div className="grid grid-cols-3 gap-2 mt-2">
                                <button onClick={() => {
                                  const newLines = [...resolutionBet.tempLines]; newLines[idx].result = 'win';
                                  setResolutionBet({ ...resolutionBet, tempLines: newLines });
                                }} className={`p-2 rounded text-xs font-bold border transition-all ${line.result === 'win' ? 'bg-emerald-500 text-white border-emerald-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-emerald-500'}`}>GANADA</button>
                                <button onClick={() => {
                                  const newLines = [...resolutionBet.tempLines]; newLines[idx].result = 'void';
                                  setResolutionBet({ ...resolutionBet, tempLines: newLines });
                                }} className={`p-2 rounded text-xs font-bold border transition-all ${line.result === 'void' ? 'bg-slate-500 text-white border-slate-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-slate-500'}`}>NULA</button>
                                <button onClick={() => {
                                  const newLines = [...resolutionBet.tempLines]; newLines[idx].result = 'loss';
                                  setResolutionBet({ ...resolutionBet, tempLines: newLines });
                                }} className={`p-2 rounded text-xs font-bold border transition-all ${line.result === 'loss' ? 'bg-red-500 text-white border-red-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-red-500'}`}>PERDIDA</button>
                              </div>
                            </div>
                          ))}

                          {/* Support V3 SubPicks (Legacy) */}
                          {(!resolutionBet.tempLines || resolutionBet.tempLines.length === 0) && resolutionBet.tempSubPicks && resolutionBet.tempSubPicks.map((sub, idx) => (
                            <div key={idx} className="bg-slate-950 p-4 rounded-lg border border-slate-800 flex flex-col gap-2">
                              <div className="flex justify-between">
                                <span className="font-bold text-blue-400 text-sm">{sub.tipster}</span>
                              </div>
                              <div className="text-sm text-slate-300">{sub.detail}</div>
                              <div className="grid grid-cols-3 gap-2 mt-2">
                                <button onClick={() => {
                                  const newSubs = [...resolutionBet.tempSubPicks]; newSubs[idx].status = 'win';
                                  setResolutionBet({ ...resolutionBet, tempSubPicks: newSubs });
                                }} className={`p-2 rounded text-xs font-bold border transition-all ${sub.status === 'win' ? 'bg-emerald-500 text-white border-emerald-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-emerald-500'}`}>GANADA</button>
                                <button onClick={() => {
                                  const newSubs = [...resolutionBet.tempSubPicks]; newSubs[idx].status = 'pending';
                                  setResolutionBet({ ...resolutionBet, tempSubPicks: newSubs });
                                }} className={`p-2 rounded text-xs font-bold border transition-all ${sub.status === 'pending' ? 'bg-slate-500 text-white border-slate-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-slate-500'}`}>PENDIENTE</button>
                                <button onClick={() => {
                                  const newSubs = [...resolutionBet.tempSubPicks]; newSubs[idx].status = 'loss';
                                  setResolutionBet({ ...resolutionBet, tempSubPicks: newSubs });
                                }} className={`p-2 rounded text-xs font-bold border transition-all ${sub.status === 'loss' ? 'bg-red-500 text-white border-red-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-red-500'}`}>PERDIDA</button>
                              </div>
                            </div>
                          ))}
                        </div>
                        <div className="p-6 border-t border-slate-800 flex justify-end gap-3 bg-slate-900">
                          <button onClick={() => setResolutionBet(null)} className="px-4 py-2 text-slate-400 hover:text-white font-bold transition-colors">Cancelar</button>
                          <button onClick={() => {
                            const isV7 = resolutionBet.tempLines && resolutionBet.tempLines.length > 0;
                            const lines = isV7 ? resolutionBet.tempLines : resolutionBet.tempSubPicks;

                            let parentResult = 'win';
                            let parentProfit = (resolutionBet.stake * resolutionBet.odds) - resolutionBet.stake;

                            const anyLoss = isV7 ? lines.some(l => l.result === 'loss') : lines.some(l => l.status === 'loss');
                            const allVoid = isV7 ? lines.every(l => l.result === 'void') : false;

                            if (anyLoss) {
                              parentResult = 'loss';
                              parentProfit = -resolutionBet.stake;
                            } else if (allVoid) {
                              parentResult = 'void';
                              parentProfit = 0;
                            }

                            const updatedBets = bets.map(b => {
                              if (b.id === resolutionBet.id) {
                                return {
                                  ...b,
                                  result: parentResult,
                                  profit: parseFloat(parentProfit.toFixed(2)),
                                  betLines: isV7 ? resolutionBet.tempLines : undefined,
                                  subPicks: !isV7 ? resolutionBet.tempSubPicks : undefined
                                };
                              }
                              return b;
                            });
                            setBets(updatedBets);
                            setResolutionBet(null);
                          }} className="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg shadow-lg shadow-emerald-900/20 transition-all transform active:scale-95">
                            Confirmar Resolución
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                {/* INDIVIDUAL STATS MODAL (V38) */}
                {selectedTipsterStats && (
                  <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 animate-fade-in backdrop-blur-sm" onClick={() => setSelectedTipsterStats(null)}>
                    <div className="bg-slate-900 w-full max-w-4xl rounded-xl border border-slate-700 shadow-2xl overflow-hidden max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                      {/* HEADER */}
                      <div className="p-6 bg-gradient-to-r from-slate-900 to-indigo-900/30 border-b border-slate-800 flex justify-between items-center">
                        <div>
                          <div className="text-xs text-indigo-400 font-bold uppercase mb-1">Análisis Detallado</div>
                          <h2 className="text-3xl font-bold text-white">{selectedTipsterStats.name}</h2>
                        </div>
                        <button onClick={() => setSelectedTipsterStats(null)} className="p-2 bg-slate-800 hover:bg-slate-700 text-white rounded-full transition-colors"><X size={24} /></button>
                      </div>

                      <div className="p-6 space-y-8">
                        {/* 1. KEY METRICS GRID */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                          <div className="bg-slate-950 p-4 rounded-xl border border-slate-800">
                            <div className="text-xs text-slate-500 uppercase font-bold mb-1">Profit Total</div>
                            <div className={`text-2xl font-bold ${selectedTipsterStats.profit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{selectedTipsterStats.profit > 0 ? '+' : ''}{selectedTipsterStats.profit ? selectedTipsterStats.profit.toFixed(2) : '0.00'}€</div>
                          </div>
                          <div className="bg-slate-950 p-4 rounded-xl border border-slate-800">
                            <div className="text-xs text-slate-500 uppercase font-bold mb-1">Yield</div>
                            <div className={`text-2xl font-bold ${parseFloat(selectedTipsterStats.yield) > 0 ? 'text-blue-400' : 'text-slate-500'}`}>{selectedTipsterStats.yield}%</div>
                          </div>
                          <div className="bg-slate-950 p-4 rounded-xl border border-slate-800">
                            <div className="text-xs text-slate-500 uppercase font-bold mb-1">Win Rate</div>
                            <div className="text-2xl font-bold text-white">{selectedTipsterStats.winRate}%</div>
                          </div>
                          <div className="bg-slate-950 p-4 rounded-xl border border-slate-800">
                            <div className="text-xs text-slate-500 uppercase font-bold mb-1">Stake Medio</div>
                            <div className="text-2xl font-bold text-purple-400">{selectedTipsterStats.avgStake}€</div>
                          </div>
                        </div>

                        {/* 2. WHAT-IF CALCULATOR */}
                        <div className="bg-indigo-900/10 border border-indigo-500/30 p-6 rounded-xl">
                          <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><Sparkles className="text-indigo-400" /> Calculadora "What If?"</h3>
                          <div className="flex flex-col md:flex-row gap-6 items-center">
                            <div className="flex-1 w-full">
                              <label className="text-xs text-slate-400 uppercase font-bold mb-2 block">Si tu Stake fijo hubiera sido...</label>
                              <div className="relative">
                                <input type="number" value={whatIfStake} onChange={e => setWhatIfStake(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 pl-8 text-white font-bold" />
                                <span className="absolute left-3 top-3 text-slate-500">€</span>
                              </div>
                            </div>
                            <div className="flex-[2] w-full grid grid-cols-3 gap-4">
                              {(() => {
                                // Live Calculation
                                const stake = parseFloat(whatIfStake) || 0;
                                let wiProfit = 0;
                                let wiInvested = 0;
                                const targetName = selectedTipsterStats.name;

                                consolidatedBets.forEach(b => {
                                  // Robust Matching
                                  const isMatch = b.tipster === targetName || b.tipster.startsWith(targetName) || (b.subPicks && b.subPicks.some(s => s.tipster.startsWith(targetName)));

                                  if (isMatch && b.result !== 'pending' && b.result !== 'void') {
                                    wiInvested += stake;
                                    if (b.result === 'win') wiProfit += (stake * b.odds) - stake;
                                    if (b.result === 'loss') wiProfit -= stake;
                                  }
                                });

                                const wiYield = wiInvested > 0 ? ((wiProfit / wiInvested) * 100).toFixed(2) : 0;
                                const diff = wiProfit - (selectedTipsterStats.profit || 0);

                                return (
                                  <>
                                    <div className="bg-slate-900 p-3 rounded border border-slate-700">
                                      <div className="text-[10px] text-slate-500 uppercase">Nuevo Beneficio</div>
                                      <div className={`text-xl font-bold ${wiProfit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{wiProfit.toFixed(2)}€</div>
                                    </div>
                                    <div className="bg-slate-900 p-3 rounded border border-slate-700">
                                      <div className="text-[10px] text-slate-500 uppercase">Nuevo Yield</div>
                                      <div className={`text-xl font-bold ${wiYield >= 0 ? 'text-blue-400' : 'text-slate-500'}`}>{wiYield}%</div>
                                    </div>
                                    <div className="bg-slate-900 p-3 rounded border border-slate-700">
                                      <div className="text-[10px] text-slate-500 uppercase">Diferencia</div>
                                      <div className={`text-xl font-bold ${diff >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{diff > 0 ? '+' : ''}{diff.toFixed(2)}€</div>
                                    </div>
                                  </>
                                );
                              })()}
                            </div>
                          </div>
                        </div>

                        {/* 3. PROFIT EVOLUTION CHART */}
                        <div className="bg-slate-950 p-4 rounded-xl border border-slate-800 h-[300px]">
                          <h3 className="text-xs font-bold text-slate-400 uppercase mb-4">Curva de Beneficio ({selectedTipsterStats.name})</h3>
                          <ResponsiveContainer width="100%" height="100%">
                            <LineChart data={(() => {
                              let running = 0;
                              return consolidatedBets
                                .filter(b => (b.tipster === selectedTipsterStats.name || b.tipster.startsWith(selectedTipsterStats.name)) && b.result !== 'pending' && b.result !== 'void')
                                .sort((a, b) => new Date(a.date) - new Date(b.date) || a.id - b.id)
                                .map(b => {
                                  running += b.profit;
                                  return { date: b.date.slice(5), profit: running };
                                });
                            })()}>
                              <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                              <XAxis dataKey="date" stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} />
                              <YAxis stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} />
                              <RechartsTooltip contentStyle={{ backgroundColor: '#0f172a', borderColor: '#334155', color: '#f8fafc' }} />
                              <Line type="monotone" dataKey="profit" stroke="#3b82f6" strokeWidth={3} dot={false} />
                            </LineChart>
                          </ResponsiveContainer>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* INDIVIDUAL STATS MODAL (V39 - Expanded) */}
            {selectedTipsterStats && (
              <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 animate-fade-in backdrop-blur-sm" onClick={() => setSelectedTipsterStats(null)}>
                <div className="bg-slate-900 w-full max-w-5xl rounded-xl border border-slate-700 shadow-2xl overflow-hidden max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>

                  {/* HEADER */}
                  <div className="p-6 bg-gradient-to-r from-slate-900 to-indigo-900/30 border-b border-slate-800 flex justify-between items-center sticky top-0 bg-slate-900 z-10">
                    <div>
                      <div className="text-xs text-indigo-400 font-bold uppercase mb-1">Análisis Detallado</div>
                      <h2 className="text-3xl font-bold text-white flex items-center gap-2">
                        {selectedTipsterStats.name}
                        <span className={`text-sm px-2 py-1 rounded bg-slate-800 border ${selectedTipsterStats.profit >= 0 ? 'border-emerald-500/30 text-emerald-400' : 'border-red-500/30 text-red-400'}`}>
                          {selectedTipsterStats.profit >= 0 ? 'Rentable' : 'En Pérdidas'}
                        </span>
                      </h2>
                    </div>
                    <div className="flex gap-2">
                      <button onClick={() => alert("ðŸ§  AI Coach: Análisis de " + selectedTipsterStats.name + "\n\nAnalizando racha actual...\nAnalizando yield por tramos...\n\nCONSEJO: Este tipster tiene un alto Yield en cuotas > 2.0 pero sufre en favoritas. Considera subir stake en underdog y reducir en favoritos.")} className="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-lg shadow-lg flex items-center gap-2 transition-all">
                        <Sparkles size={16} /> AI Coach
                      </button>
                      <button onClick={() => setSelectedTipsterStats(null)} className="p-2 bg-slate-800 hover:bg-slate-700 text-white rounded-full transition-colors"><X size={24} /></button>
                    </div>
                  </div>

                  <div className="p-6 space-y-8">
                    {/* 1. KEY METRICS GRID */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      <div className="bg-slate-950 p-4 rounded-xl border border-slate-800">
                        <div className="text-xs text-slate-500 uppercase font-bold mb-1">Profit Total</div>
                        <div className={`text-2xl font-bold ${selectedTipsterStats.profit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{selectedTipsterStats.profit > 0 ? '+' : ''}{selectedTipsterStats.profit ? selectedTipsterStats.profit.toFixed(2) : '0.00'}€</div>
                      </div>
                      <div className="bg-slate-950 p-4 rounded-xl border border-slate-800">
                        <div className="text-xs text-slate-500 uppercase font-bold mb-1">Yield</div>
                        <div className={`text-2xl font-bold ${parseFloat(selectedTipsterStats.yield) > 0 ? 'text-blue-400' : 'text-slate-500'}`}>{selectedTipsterStats.yield}%</div>
                      </div>
                      <div className="bg-slate-950 p-4 rounded-xl border border-slate-800">
                        <div className="text-xs text-slate-500 uppercase font-bold mb-1">Win Rate</div>
                        <div className="text-2xl font-bold text-white">{selectedTipsterStats.winRate}%</div>
                      </div>
                      <div className="bg-slate-950 p-4 rounded-xl border border-slate-800">
                        <div className="text-xs text-slate-500 uppercase font-bold mb-1">Stake Medio</div>
                        <div className="text-2xl font-bold text-purple-400">{selectedTipsterStats.avgStake}€</div>
                      </div>
                    </div>

                    {/* 2. ODDS RANGE BREAKDOWN (New V39) */}
                    <div className="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden shadow-lg">
                      <div className="p-4 bg-slate-950 border-b border-slate-800 font-bold text-slate-400 text-xs uppercase">Rendimiento por Rango de Cuota</div>
                      <table className="w-full text-left text-sm">
                        <thead className="bg-slate-950/50 text-slate-500 text-xs">
                          <tr><th className="p-3">Rango</th><th className="p-3 text-center">Bets</th><th className="p-3 text-right">Profit</th><th className="p-3 text-center">Yield</th></tr>
                        </thead>
                        <tbody className="divide-y divide-slate-800">
                          {(() => {
                            const ranges = [
                              { label: 'Seguras (1.0-1.5)', min: 1.0, max: 1.5, bets: 0, profit: 0, staked: 0 },
                              { label: 'Valor (1.51-2.0)', min: 1.51, max: 2.0, bets: 0, profit: 0, staked: 0 },
                              { label: 'Riesgo (2.01-5.0)', min: 2.01, max: 5.0, bets: 0, profit: 0, staked: 0 },
                              { label: 'Lotería (5.0+)', min: 5.01, max: 999, bets: 0, profit: 0, staked: 0 },
                            ];
                            const targetName = selectedTipsterStats.name;
                            consolidatedBets.forEach(b => {
                              // Exact match or sub-pick match
                              const isMatch = b.tipster === targetName || (b.subPicks && b.subPicks.some(s => s.tipster === targetName));
                              if (isMatch && b.result !== 'pending' && b.result !== 'void') {
                                const range = ranges.find(r => b.odds >= r.min && b.odds <= r.max);
                                if (range) { range.bets++; range.profit += b.profit; range.staked += b.stake; }
                              }
                            });
                            return ranges.map((r, i) => (
                              <tr key={i} className="hover:bg-slate-800/30">
                                <td className="p-3 font-bold text-white">{r.label}</td>
                                <td className="p-3 text-center text-slate-400">{r.bets}</td>
                                <td className={`p-3 text-right font-bold ${r.profit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{r.profit.toFixed(2)}€</td>
                                <td className={`p-3 text-center font-bold ${r.staked > 0 ? ((r.profit / r.staked) * 100).toFixed(2) >= 0 ? 'text-blue-400' : 'text-red-400' : 'text-slate-500'}`}>{r.staked > 0 ? ((r.profit / r.staked) * 100).toFixed(2) : 0}%</td>
                              </tr>
                            ));
                          })()}
                        </tbody>
                      </table>
                    </div>

                    {/* 3. CHARTS GRID (Sniper & Heatmap & Curve) */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">

                      {/* SNIPER CHART (Individual) */}
                      <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-lg">
                        <h3 className="font-bold text-xs mb-4 text-slate-400 uppercase tracking-wider flex items-center gap-2"><Target size={14} /> Sniper: Aciertos vs Cuota</h3>
                        <div className="h-[250px] w-full">
                          <ResponsiveContainer width="100%" height="100%">
                            <ScatterChart margin={{ top: 10, right: 10, bottom: 10, left: 0 }}>
                              <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                              <XAxis type="number" dataKey="x" name="Cuota" stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} unit="x" domain={['auto', 'auto']} />
                              <YAxis type="number" dataKey="y" name="Profit" stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} unit="€" />
                              <RechartsTooltip cursor={{ strokeDasharray: '3 3' }} content={({ active, payload }) => {
                                if (active && payload && payload.length) {
                                  const data = payload[0].payload;
                                  return (
                                    <div className="bg-slate-950 border border-slate-700 p-2 rounded shadow-xl text-xs">
                                      <div className={`font-bold ${data.y >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{data.y}€</div>
                                      <div className="text-slate-400">Cuota: @{data.x}</div>
                                    </div>
                                  );
                                }
                                return null;
                              }} />
                              <Scatter name="Bets" data={(() => {
                                const targetName = selectedTipsterStats.name;
                                return consolidatedBets
                                  .filter(b => (b.tipster === targetName || (b.subPicks && b.subPicks.some(s => s.tipster === targetName))) && b.result !== 'pending' && b.result !== 'void')
                                  .map(b => ({ x: b.odds, y: b.profit, result: b.result }));
                              })()} shape="circle">
                                {consolidatedBets.filter(b => b.tipster === selectedTipsterStats.name).map((entry, index) => (
                                  <Cell key={`cell-${index}`} fill={entry.result === 'win' ? '#10b981' : '#ef4444'} />
                                ))}
                              </Scatter>
                            </ScatterChart>
                          </ResponsiveContainer>
                        </div>
                      </div>

                      {/* HEATMAP (Activity) */}
                      <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-lg">
                        <h3 className="font-bold text-xs mb-4 text-slate-400 uppercase tracking-wider flex items-center gap-2"><Calendar size={14} /> Actividad Reciente</h3>
                        <div className="flex flex-wrap gap-1 justify-center align-start h-[250px] overflow-y-auto content-start">
                          {(() => {
                            const days = [];
                            const targetName = selectedTipsterStats.name;
                            const map = {};
                            consolidatedBets.forEach(b => {
                              if (b.tipster === targetName || (b.subPicks && b.subPicks.some(s => s.tipster === targetName))) {
                                if (!map[b.date]) map[b.date] = 0;
                                map[b.date] += b.profit;
                              }
                            });
                            for (let i = 59; i >= 0; i--) { // Last 60 days
                              const d = new Date(); d.setDate(d.getDate() - i);
                              const s = d.toISOString().split('T')[0];
                              const val = map[s];
                              let color = 'bg-slate-800';
                              if (val > 0) color = 'bg-emerald-500';
                              if (val < 0) color = 'bg-red-500';
                              if (val === 0 && map[s] !== undefined) color = 'bg-slate-600'; // Void/0
                              days.push(<div key={i} title={`${s}: ${val ? val.toFixed(2) : 0}€`} className={`w-3 h-3 rounded-sm ${color}`}></div>);
                            }
                            return days;
                          })()}
                        </div>
                      </div>

                    </div>

                    {/* PROFIT EVOLUTION CHART (Large) */}
                    <div className="bg-slate-950 p-4 rounded-xl border border-slate-800 h-[300px]">
                      <h3 className="text-xs font-bold text-slate-400 uppercase mb-4">Curva de Beneficio Acumulado</h3>
                      <ResponsiveContainer width="100%" height="100%">
                        <LineChart data={(() => {
                          let running = 0;
                          const targetName = selectedTipsterStats.name;
                          return consolidatedBets
                            .filter(b => (b.tipster === targetName || b.tipster.startsWith(targetName)) && b.result !== 'pending' && b.result !== 'void')
                            .sort((a, b) => new Date(a.date) - new Date(b.date) || a.id - b.id)
                            .map(b => {
                              running += b.profit;
                              return { date: b.date.slice(5), profit: running };
                            });
                        })()}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                          <XAxis dataKey="date" stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} />
                          <YAxis stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} />
                          <RechartsTooltip contentStyle={{ backgroundColor: '#0f172a', borderColor: '#334155', color: '#f8fafc' }} />
                          <Line type="monotone" dataKey="profit" stroke="#3b82f6" strokeWidth={3} dot={false} />
                        </LineChart>
                      </ResponsiveContainer>
                    </div>

                    {/* 4. WHAT-IF CALCULATOR */}
                    <div className="bg-indigo-900/10 border border-indigo-500/30 p-6 rounded-xl">
                      <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><Sparkles className="text-indigo-400" /> Calculadora "What If?"</h3>
                      <div className="flex flex-col md:flex-row gap-6 items-center">
                        <div className="flex-1 w-full">
                          <label className="text-xs text-slate-400 uppercase font-bold mb-2 block">Si tu Stake fijo hubiera sido...</label>
                          <div className="relative">
                            <input type="number" value={whatIfStake} onChange={e => setWhatIfStake(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 pl-8 text-white font-bold" />
                            <span className="absolute left-3 top-3 text-slate-500">€</span>
                          </div>
                        </div>
                        <div className="flex-[2] w-full grid grid-cols-3 gap-4">
                          {(() => {
                            // Live Calculation
                            const stake = parseFloat(whatIfStake) || 0;
                            let wiProfit = 0;
                            let wiInvested = 0;
                            const targetName = selectedTipsterStats.name;

                            consolidatedBets.forEach(b => {
                              // Robust Matching
                              const isMatch = b.tipster === targetName || b.tipster.startsWith(targetName) || (b.subPicks && b.subPicks.some(s => s.tipster.startsWith(targetName)));

                              if (isMatch && b.result !== 'pending' && b.result !== 'void') {
                                wiInvested += stake;
                                if (b.result === 'win') wiProfit += (stake * b.odds) - stake;
                                if (b.result === 'loss') wiProfit -= stake;
                              }
                            });

                            const wiYield = wiInvested > 0 ? ((wiProfit / wiInvested) * 100).toFixed(2) : 0;
                            const diff = wiProfit - (selectedTipsterStats.profit || 0);

                            return (
                              <>
                                <div className="bg-slate-900 p-3 rounded border border-slate-700">
                                  <div className="text-[10px] text-slate-500 uppercase">Nuevo Beneficio</div>
                                  <div className={`text-xl font-bold ${wiProfit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{wiProfit.toFixed(2)}€</div>
                                </div>
                                <div className="bg-slate-900 p-3 rounded border border-slate-700">
                                  <div className="text-[10px] text-slate-500 uppercase">Nuevo Yield</div>
                                  <div className={`text-xl font-bold ${wiYield >= 0 ? 'text-blue-400' : 'text-slate-500'}`}>{wiYield}%</div>
                                </div>
                                <div className="bg-slate-900 p-3 rounded border border-slate-700">
                                  <div className="text-[10px] text-slate-500 uppercase">Diferencia</div>
                                  <div className={`text-xl font-bold ${diff >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{diff > 0 ? '+' : ''}{diff.toFixed(2)}€</div>
                                </div>
                              </>
                            );
                          })()}
                        </div>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            )}

            {/* SUPER SIMULATOR V2 (Premium Redesign) */}
            {activeSection === 'simulador' && (
              <div className="space-y-6 animate-fade-in pb-20">
                <header className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 border-b border-white/10 pb-6">
                  <div>
                    <h2 className="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 via-cyan-400 to-indigo-400 flex items-center gap-3">
                      <Zap size={36} className="text-emerald-400" /> Laboratorio de Futuros
                    </h2>
                    <p className="text-slate-400 mt-2 font-light text-lg">Proyecta tu destino con Monte Carlo y Analítica Avanzada.</p>
                  </div>
                  <div className="flex gap-2 bg-slate-900/50 p-1.5 rounded-xl border border-white/10 backdrop-blur-md">
                    <button onClick={() => setSimMode('GLOBAL')} className={`px-5 py-2 rounded-lg font-bold transition-all ${simMode === 'GLOBAL' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/20' : 'text-slate-400 hover:text-white'}`}>Global</button>
                    <button onClick={() => setSimMode('TIPSTER')} className={`px-5 py-2 rounded-lg font-bold transition-all ${simMode === 'TIPSTER' ? 'bg-purple-600 text-white shadow-lg shadow-purple-500/20' : 'text-slate-400 hover:text-white'}`}>Por Tipster</button>
                  </div>
                </header>

                <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">

                  {/* --- LEFT SIDEBAR: CONTROL STATION (Col 3) --- */}
                  <div className="lg:col-span-3 space-y-6">
                    <div className="bg-slate-900/80 backdrop-blur-xl p-6 rounded-2xl border border-white/10 shadow-2xl relative overflow-hidden">
                      <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 to-cyan-500"></div>

                      <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                        <Settings size={14} /> Configuración
                      </h3>

                      {/* ALGORITHM SWITCH */}
                      {simMode === 'GLOBAL' && (
                        <div className="mb-6">
                          <label className="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Modo de Motor</label>
                          <div className="grid grid-cols-2 gap-1 p-1 bg-black/40 rounded-lg border border-white/5">
                            <button onClick={() => setSimAlgo('SIMPLE')} className={`py-2 text-[10px] rounded-md font-bold transition-all ${simAlgo === 'SIMPLE' ? 'bg-slate-700 text-white shadow' : 'text-slate-500 hover:text-slate-300'}`}>SIMPLE</button>
                            <button onClick={() => setSimAlgo('REALISTIC')} className={`py-2 text-[10px] rounded-md font-bold transition-all ${simAlgo === 'REALISTIC' ? 'bg-emerald-600 text-white shadow shadow-emerald-900/50' : 'text-slate-500 hover:text-slate-300'}`}>CARTERA REAL</button>
                          </div>
                        </div>
                      )}

                      {simMode === 'TIPSTER' && (
                        <div className="mb-6">
                          <label className="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Tipster Objetivo</label>
                          <select value={simSelectedTipster} onChange={e => setSimSelectedTipster(e.target.value)} className="w-full bg-black/40 border border-slate-700/50 rounded-lg p-3 text-white text-sm focus:border-purple-500 outline-none transition-all">
                            <option value="">Selecciona...</option>
                            {tipsters.map(t => <option key={t.name} value={t.name}>{t.name}</option>)}
                          </select>
                        </div>
                      )}

                      {/* DATA SETTINGS & FILTERS */}
                      <div className="mb-4 space-y-3">
                        <div className="flex items-center justify-between">
                          <label className="flex items-center gap-2 cursor-pointer group">
                            <div className={`w-4 h-4 rounded border flex items-center justify-center transition-all ${excludeFunbets ? 'bg-red-500 border-red-500' : 'border-slate-600 bg-slate-800'}`}>
                              {excludeFunbets && <Check size={10} className="text-white" />}
                            </div>
                            <input type="checkbox" checked={excludeFunbets} onChange={e => setExcludeFunbets(e.target.checked)} className="hidden" />
                            <span className="text-[10px] font-bold text-slate-400 group-hover:text-slate-300 transition-colors uppercase">Excluir Funbets</span>
                          </label>
                        </div>
                      </div>

                      <div className="space-y-4">
                        <div className="flex justify-between items-center">
                          <span className="text-xs font-bold text-slate-300">Datos Base</span>
                          <button onClick={loadRealStats} className="text-[10px] bg-indigo-600 hover:bg-indigo-500 px-3 py-1 rounded-full text-white font-bold shadow-lg shadow-indigo-500/20 transition-all">
                            âš¡ Analizar Datos
                          </button>
                        </div>

                        {/* SOURCE STATS PANEL */}
                        {sourceStats && (
                          <div className="bg-black/30 rounded-lg p-3 border border-white/5 space-y-2 animate-fade-in">
                            <div className="text-[10px] text-slate-500 uppercase font-bold text-center mb-1">Muestra Analizada</div>
                            <div className="flex justify-between text-xs">
                              <span className="text-slate-400">Total</span>
                              <span className="font-bold text-white">{sourceStats.total}</span>
                            </div>
                            <div className="flex justify-between text-xs">
                              <span className="text-slate-400">Aciertos</span>
                              <span className="font-bold text-emerald-400">{sourceStats.wins}</span>
                            </div>
                            <div className="flex justify-between text-xs">
                              <span className="text-slate-400">Fallos</span>
                              <span className="font-bold text-red-400">{sourceStats.losses}</span>
                            </div>
                            <div className="h-px bg-white/5 my-1"></div>
                            <div className="flex justify-between text-[10px]">
                              <span className="text-slate-500">WinRate Real</span>
                              <span className="font-bold text-emerald-300">{sourceStats.winRate}%</span>
                            </div>
                          </div>
                        )}

                        {simAlgo === 'REALISTIC' ? (
                          <div className="p-4 bg-emerald-900/10 border border-emerald-500/20 rounded-lg text-xs text-emerald-200/80 italic">
                            Los parámetros (Winrate, Cuota, Stake) se extraen de la configuración individual de cada tipster en la tabla de cartera.
                          </div>
                        ) : (
                          <>
                            <div className="space-y-1">
                              <div className="flex justify-between text-[10px] text-slate-500 font-bold uppercase"><span>Bank Inicial</span> <span>€</span></div>
                              <input type="number" value={simBank} onChange={e => setSimBank(e.target.value)} className="w-full bg-black/40 border border-slate-700/50 rounded-lg p-2.5 text-white font-bold focus:border-emerald-500 outline-none" />
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                              <div className="space-y-1">
                                <div className="text-[10px] text-slate-500 font-bold uppercase">Win Rate %</div>
                                <input type="number" value={simWinRate} onChange={e => setSimWinRate(e.target.value)} className="w-full bg-black/40 border border-slate-700/50 rounded-lg p-2.5 text-emerald-400 font-bold text-center focus:border-emerald-500 outline-none" />
                              </div>
                              <div className="space-y-1">
                                <div className="text-[10px] text-slate-500 font-bold uppercase">Cuota @</div>
                                <input type="number" step="0.01" value={simAvgOdds} onChange={e => setSimAvgOdds(e.target.value)} className="w-full bg-black/40 border border-slate-700/50 rounded-lg p-2.5 text-blue-400 font-bold text-center focus:border-blue-500 outline-none" />
                              </div>
                            </div>
                          </>
                        )}

                        <div className="space-y-1">
                          <div className="text-[10px] text-slate-500 font-bold uppercase">Horizonte (Apuestas)</div>
                          <input type="number" value={simNumBets} onChange={e => setSimNumBets(e.target.value)} className="w-full bg-black/40 border border-slate-700/50 rounded-lg p-2.5 text-white font-mono text-center focus:border-indigo-500 outline-none" />
                        </div>

                        {/* Staking */}
                        <div className="pt-4 border-t border-white/5">
                          <label className="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Gestión de Stake</label>
                          <div className="flex rounded-lg bg-black/40 p-1 border border-white/5 mb-2">
                            <button onClick={() => setSimStakingMode('FLAT')} className={`flex-1 py-1.5 text-[10px] rounded font-bold transition-all ${simStakingMode === 'FLAT' ? 'bg-slate-700 text-white' : 'text-slate-500'}`}>PLANO</button>
                            <button onClick={() => setSimStakingMode('COMPOUND')} className={`flex-1 py-1.5 text-[10px] rounded font-bold transition-all ${simStakingMode === 'COMPOUND' ? 'bg-indigo-600 text-white' : 'text-slate-500'}`}>COMPUESTO</button>
                          </div>
                          <div className="relative">
                            <input type="number" value={simStake} onChange={e => setSimStake(e.target.value)} className="w-full bg-black/40 border border-slate-700/50 rounded-lg p-2.5 text-white font-bold pl-3" />
                            <span className="absolute right-3 top-2.5 text-xs font-bold text-slate-500">{simStakingMode === 'FLAT' ? '€' : '%'}</span>
                          </div>
                        </div>
                      </div>

                      <button onClick={runSimulation} className="w-full mt-6 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-400 hover:to-teal-400 text-white font-bold py-4 rounded-xl shadow-lg shadow-emerald-900/40 transform hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-2 group">
                        <Zap size={20} className="group-hover:text-yellow-300 transition-colors" /> <span className="tracking-wide">SIMULAR AHORA</span>
                      </button>
                    </div>
                  </div>

                  {/* --- RIGHT DASHBOARD: VISUALIZATION (Col 9) --- */}
                  <div className="lg:col-span-9 space-y-6">

                    {/* 1. METRICS ROW */}
                    {simResults && (
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 animate-fade-in-up">
                        <div className="bg-slate-900/60 backdrop-blur border border-red-500/20 p-4 rounded-2xl relative overflow-hidden group">
                          <div className="absolute -right-4 -top-4 bg-red-500/10 w-24 h-24 rounded-full blur-2xl group-hover:bg-red-500/20 transition-all"></div>
                          <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Peor Caso (P10)</div>
                          <div className="text-2xl lg:text-3xl font-bold text-red-400">{simResults.worst.toFixed(0)}€</div>
                          <div className="text-[10px] text-red-500/60 font-mono mt-1">Drawdown Máx: {simResults.worstMDD}%</div>
                        </div>
                        <div className="bg-slate-900/60 backdrop-blur border border-blue-500/20 p-4 rounded-2xl relative overflow-hidden group">
                          <div className="absolute -right-4 -top-4 bg-blue-500/10 w-24 h-24 rounded-full blur-2xl group-hover:bg-blue-500/20 transition-all"></div>
                          <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Esperado (Media)</div>
                          <div className="text-2xl lg:text-3xl font-bold text-blue-400">{simResults.avg.toFixed(0)}€</div>
                          <div className="text-[10px] text-blue-500/60 font-mono mt-1">ROI {(((simResults.avg - parseFloat(simBank)) / parseFloat(simBank)) * 100).toFixed(0)}%</div>
                        </div>
                        <div className="bg-slate-900/60 backdrop-blur border border-emerald-500/20 p-4 rounded-2xl relative overflow-hidden group">
                          <div className="absolute -right-4 -top-4 bg-emerald-500/10 w-24 h-24 rounded-full blur-2xl group-hover:bg-emerald-500/20 transition-all"></div>
                          <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Mejor Caso (P90)</div>
                          <div className="text-2xl lg:text-3xl font-bold text-emerald-400">{simResults.best.toFixed(0)}€</div>
                          <div className="text-[10px] text-emerald-500/60 font-mono mt-1">To The Moon ðŸš€</div>
                        </div>
                        <div className="bg-slate-900/60 backdrop-blur border border-orange-500/20 p-4 rounded-2xl relative overflow-hidden group">
                          <div className="absolute -right-4 -top-4 bg-orange-500/10 w-24 h-24 rounded-full blur-2xl group-hover:bg-orange-500/20 transition-all"></div>
                          <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Riesgo de Ruina</div>
                          <div className="text-2xl lg:text-3xl font-bold text-orange-400">{simResults.riskOfRuin}%</div>
                          <div className="text-[10px] text-orange-500/60 font-mono mt-1">Prob. Bancarrota</div>
                        </div>
                      </div>
                    )}

                    {/* 2. MAIN CHART AREA */}
                    <div className="bg-slate-900/80 backdrop-blur-xl rounded-2xl border border-white/10 shadow-2xl overflow-hidden min-h-[500px] flex flex-col">
                      {/* Chart Tabs */}
                      <div className="flex border-b border-white/5 p-2 bg-black/20">
                        {['evolution', 'drawdown', 'distribution'].map(tab => (
                          <button
                            key={tab}
                            onClick={() => setSimChartTab(tab)}
                            className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${simChartTab === tab ? 'bg-slate-800 text-white shadow ring-1 ring-white/10' : 'text-slate-500 hover:text-slate-300'}`}
                          >
                            {tab === 'evolution' ? 'ðŸ“ˆ Evolución' : tab === 'drawdown' ? 'ðŸ“‰ Underwater (Drawdown)' : 'ðŸ“Š Distribución'}
                          </button>
                        ))}
                      </div>

                      {/* Chart Canvas */}
                      <div className="flex-1 p-6 relative">
                        {!simResults ? (
                          <div className="flex flex-col items-center justify-center h-full text-slate-500 animate-pulse gap-4">
                            <RefreshCw size={48} className="opacity-20 spin-slow" />
                            <p className="font-light text-lg">Configura los parámetros y lanza la simulación.</p>
                          </div>
                        ) : (
                          <ResponsiveContainer width="100%" height={450}>
                            {simChartTab === 'evolution' && (
                              <AreaChart data={simResults.paths[0]?.data.map((_, idx) => {
                                // Construct composite data frame on the fly for the chart
                                // We need to merge all 5 paths into one object per X
                                const frame = { step: idx };
                                simResults.paths.forEach((p, pIdx) => frame[`path${pIdx}`] = p.data[idx]?.y);
                                return frame;
                              })}>
                                <defs>
                                  <linearGradient id="gEvo" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#10b981" stopOpacity={0.2} /><stop offset="95%" stopColor="#10b981" stopOpacity={0} /></linearGradient>
                                </defs>
                                <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} opacity={0.5} />
                                <XAxis dataKey="step" stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} />
                                <YAxis stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} tickFormatter={v => `${(v / 1000).toFixed(0)}k`} />
                                <Tooltip contentStyle={{ backgroundColor: '#0f172a', borderColor: '#334155', color: '#f8fafc', borderRadius: '8px' }} formatter={(val) => `${val.toFixed(0)}€`} />
                                {simResults.paths.map((p, i) => (
                                  <Area key={i} type="monotone" dataKey={`path${i}`} stroke={i === 0 || i === 4 ? '#ef4444' : '#10b981'} fill="url(#gEvo)" strokeWidth={i === 2 ? 3 : 1} strokeOpacity={i === 2 ? 1 : 0.5} fillOpacity={i === 2 ? 1 : 0.1} />
                                ))}
                              </AreaChart>
                            )}

                            {simChartTab === 'drawdown' && (
                              <AreaChart data={simResults.paths[2]?.data.map((pt, idx) => {
                                // Calculate DD for the Median Path (Index 2 usually represents typical if sorted? No, visualPaths are 0..4 chronological)
                                // Actually visualPaths are just first 5 sims. Let's use Sim 0 as representative or Avg of them?
                                // Let's just plot Sim 0's underwater curve.
                                const y = pt.y;
                                // This is tricky without history of peak. 
                                // We need to re-calculate peak-to-date for this specific path.
                                // Let's do it right here: 
                                // Warning: map() is stateless. We need to compute array beforehand.
                                // Let's assume we compute it outside or use a trick.
                                return { step: idx, val: y };
                              }).reduce((acc, curr, i, arr) => {
                                // Transform into DD array
                                const prevPeak = i === 0 ? curr.val : acc[i - 1].peak;
                                const peak = Math.max(prevPeak, curr.val);
                                const dd = peak > 0 ? ((peak - curr.val) / peak) * 100 : 0;
                                acc.push({ step: curr.step, dd: dd, peak: peak });
                                return acc;
                              }, [])}>
                                <defs>
                                  <linearGradient id="gDD" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#ef4444" stopOpacity={0.4} /><stop offset="95%" stopColor="#ef4444" stopOpacity={0} /></linearGradient>
                                </defs>
                                <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} opacity={0.5} />
                                <XAxis dataKey="step" stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} />
                                <YAxis stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} tickFormatter={v => `${v.toFixed(0)}%`} flipped={true} /> {/* Flipped for Underwater effect? Or just normal 0 to 100? Normal DD is positive number representing loss size. */}
                                <Tooltip contentStyle={{ backgroundColor: '#0f172a', borderColor: '#334155', color: '#f8fafc', borderRadius: '8px' }} formatter={(val) => `-${val.toFixed(2)}%`} labelFormatter={(l) => `Apuesta ${l}`} />
                                <Area type="monotone" dataKey="dd" stroke="#ef4444" fill="url(#gDD)" strokeWidth={2} />
                              </AreaChart>
                            )}

                            {simChartTab === 'distribution' && (
                              <BarChart data={simResults.histogram}>
                                <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} opacity={0.5} />
                                <XAxis dataKey="range" stroke="#64748b" fontSize={9} tickLine={false} axisLine={false} angle={-45} textAnchor="end" height={60} />
                                <YAxis stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} />
                                <Tooltip cursor={{ fill: 'rgba(255,255,255,0.05)' }} contentStyle={{ backgroundColor: '#0f172a', borderColor: '#334155', color: '#f8fafc', borderRadius: '8px' }} />
                                <Bar dataKey="count" fill="#6366f1" radius={[4, 4, 0, 0]}>
                                  {simResults.histogram.map((entry, index) => (
                                    <Cell key={`cell-${index}`} fill={`hsl(${220 + (index * 5)}, 80%, 60%)`} />
                                  ))}
                                </Bar>
                              </BarChart>
                            )}
                          </ResponsiveContainer>
                        )}
                      </div>
                    </div>

                    {/* 3. CONFIG TABLE (Conditional - Bottom of Dashboard) */}
                    {simAlgo === 'REALISTIC' && simPortfolioConfig.length > 0 && (
                      <div className="bg-slate-900/80 backdrop-blur rounded-2xl border border-white/10 p-6 shadow-xl animate-fade-in-up">
                        <h3 className="text-emerald-400 font-bold mb-4 flex items-center gap-2 text-sm uppercase tracking-wider"><Settings size={16} /> Configuración de Cartera ({simPortfolioConfig.filter(t => t.enabled).length} Activos)</h3>
                        <div className="overflow-x-auto">
                          <table className="w-full text-xs text-left">
                            <thead>
                              <tr className="text-slate-500 border-b border-slate-700/50 uppercase font-bold">
                                <th className="pb-3 pl-2">Tipster</th>
                                <th className="pb-3 text-center">Peso (Vol)</th>
                                <th className="pb-3 text-center">WinRate %</th>
                                <th className="pb-3 text-center">Cuota @</th>
                                <th className="pb-3 text-center">Stake</th>
                                <th className="pb-3 text-center">Activo</th>
                              </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-800/50">
                              {simPortfolioConfig.map((t, idx) => (
                                <tr key={idx} className={`transition-colors ${t.enabled ? 'hover:bg-slate-800/30' : 'opacity-40 grayscale'} group`}>
                                  <td className="py-3 pl-2 text-white font-bold group-hover:text-emerald-300 transition-colors">{t.name}</td>
                                  <td className="py-3 text-center text-slate-400 font-mono">{t.weight}%</td>
                                  <td className="py-3 text-center px-2">
                                    <input type="number" value={t.winRate} onChange={e => updatePortfolioConfig(idx, 'winRate', e.target.value)} className="w-20 bg-black/30 border border-slate-700/50 rounded px-2 py-1 text-center text-emerald-400 font-bold focus:border-emerald-500 outline-none" />
                                  </td>
                                  <td className="py-3 text-center px-2">
                                    <input type="number" value={t.avgOdds} onChange={e => updatePortfolioConfig(idx, 'avgOdds', e.target.value)} className="w-20 bg-black/30 border border-slate-700/50 rounded px-2 py-1 text-center text-blue-400 font-bold focus:border-blue-500 outline-none" />
                                  </td>
                                  <td className="py-3 text-center px-2">
                                    <input type="number" value={t.avgStake} onChange={e => updatePortfolioConfig(idx, 'avgStake', e.target.value)} className="w-20 bg-black/30 border border-slate-700/50 rounded px-2 py-1 text-center text-indigo-300 font-bold focus:border-indigo-500 outline-none" />
                                  </td>
                                  <td className="py-3 text-center px-2">
                                    <input type="checkbox" checked={t.enabled} onChange={e => updatePortfolioConfig(idx, 'enabled', e.target.checked)} className="rounded border-slate-600 bg-slate-800 text-emerald-500 focus:ring-emerald-500 w-5 h-5 cursor-pointer" />
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    )}

                  </div>
                </div>
              </div>
            )}

            {/* 5. HISTORY */}
            {activeSection === 'history' && (
              <div className="space-y-6 animate-fade-in">
                {/* TOOLBAR HISTORIAL 2.0 */}
                <div className="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4 bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-xl">
                  <div>
                    <h2 className="text-2xl font-bold text-white flex items-center gap-2"><History /> Historial Profesional</h2>
                    <p className="text-xs text-slate-400">Consulta y analiza tu registro detallado.</p>
                  </div>

                  <div className="flex flex-wrap gap-2 w-full xl:w-auto">
                    {/* FILTRO FECHA */}
                    <div className="flex bg-slate-950 rounded border border-slate-800 p-1">
                      {['today', 'week', 'month', 'all'].map(r => (
                        <button key={r} onClick={() => setHistoryFilters({ ...historyFilters, range: r, customDate: '' })} className={`px-3 py-1.5 text-xs font-bold rounded transition-colors ${historyFilters.range === r && !historyFilters.customDate ? 'bg-slate-800 text-white shadow' : 'text-slate-500 hover:text-slate-300'}`}>
                          {r === 'today' ? 'HOY' : r === 'week' ? 'SEMANA' : r === 'month' ? 'MES' : 'TOTAL'}
                        </button>
                      ))}
                    </div>

                    {/* FILTRO CUSTOM DATE */}
                    <input type="date" value={historyFilters.customDate} onChange={e => setHistoryFilters({ ...historyFilters, range: 'custom', customDate: e.target.value })} className={`bg-slate-950 border border-slate-800 rounded px-2 text-xs text-white focus:border-blue-500 ${historyFilters.range === 'custom' ? 'border-blue-500' : ''}`} />

                    {/* FILTRO TIPSTER */}
                    <select value={historyFilters.tipster} onChange={e => setHistoryFilters({ ...historyFilters, tipster: e.target.value })} className="bg-slate-950 border border-slate-800 rounded px-2 py-1 text-xs text-white font-bold focus:border-blue-500">
                      <option value="ALL">TODOS LOS TIPSTERS</option>
                      {tipsters.map(t => <option key={t.name} value={t.name}>{t.name}</option>)}
                    </select>

                    {/* FILTRO CUOTA */}
                    <select value={historyFilters.odds} onChange={e => setHistoryFilters({ ...historyFilters, odds: e.target.value })} className="bg-slate-900 border border-slate-800 rounded px-2 py-1 text-xs text-slate-300 font-bold focus:border-blue-500">
                      <option value="ALL">Cualquier Cuota</option>
                      <option value="low">Baja (1.0 - 1.5)</option>
                      <option value="medium">Media (1.5 - 2.0)</option>
                      <option value="high">Alta (2.0 - 3.0)</option>
                      <option value="lotto">Lotto (+3.0)</option>
                    </select>
                  </div>
                </div>

                <div className="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden shadow-xl">
                  <div className="overflow-x-auto">
                    <table className="w-full text-left text-sm min-w-[600px]">
                      <thead className="bg-slate-950 text-slate-400 uppercase text-xs font-bold">
                        <tr><th className="p-4">Fecha</th><th className="p-4">Tipster / Descripción</th><th className="p-4 text-center">Stake</th><th className="p-4 text-center">Cuota</th><th className="p-4 text-right">P&L</th><th className="p-4 text-center">Acción</th></tr>
                      </thead>
                      <tbody className="divide-y divide-slate-800">
                        {(() => {
                          // LOGICA DE FILTRADO
                          const today = new Date().toISOString().split('T')[0];
                          const filtered = bets.filter(b => {
                            // Date Filter
                            if (historyFilters.range === 'custom' && historyFilters.customDate) {
                              if (b.date !== historyFilters.customDate) return false;
                            } else if (historyFilters.range === 'today') {
                              if (b.date !== today) return false;
                            } else if (historyFilters.range === 'week') {
                              const d = new Date(b.date);
                              const now = new Date();
                              const diffTime = Math.abs(now - d);
                              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                              if (diffDays > 7) return false;
                            } else if (historyFilters.range === 'month') {
                              const d = new Date(b.date);
                              const now = new Date();
                              if (d.getMonth() !== now.getMonth() || d.getFullYear() !== now.getFullYear()) return false;
                            }

                            // Tipster Filter (Improved: checks lines too)
                            if (historyFilters.tipster !== 'ALL') {
                              const matchMain = b.tipster === historyFilters.tipster;
                              const matchLine = b.betLines?.some(l => l.tipster?.includes(historyFilters.tipster)) || b.subPicks?.some(s => s.tipster === historyFilters.tipster);
                              if (!matchMain && !matchLine) return false;
                            }

                            // Odds Filter
                            if (historyFilters.odds !== 'ALL') {
                              const o = parseFloat(b.odds);
                              if (historyFilters.odds === 'low' && o > 1.5) return false;
                              if (historyFilters.odds === 'medium' && (o <= 1.5 || o > 2.0)) return false;
                              if (historyFilters.odds === 'high' && (o <= 2.0 || o > 3.0)) return false;
                              if (historyFilters.odds === 'lotto' && o <= 3.0) return false;
                            }

                            return true;
                          });

                          if (filtered.length === 0) return <tr><td colSpan="6" className="p-8 text-center text-slate-500 italic">No hay registros con estos filtros</td></tr>;

                          return (() => {
                            // GROUPING LOGIC (V42)
                            const sorted = filtered.sort((a, b) => b.id - a.id);
                            const groupedList = [];
                            const processedIds = new Set();

                            sorted.forEach(bet => {
                              if (processedIds.has(bet.id)) return;

                              if (bet.groupId) {
                                const groupMembers = sorted.filter(b => b.groupId === bet.groupId);
                                groupMembers.forEach(m => processedIds.add(m.id));

                                // Calculate Group Stats
                                const totalStake = groupMembers.reduce((sum, b) => sum + parseFloat(b.stake), 0);
                                const totalProfit = groupMembers.reduce((sum, b) => sum + (b.profit || 0), 0);
                                // Determine Status: 'pending' if any pending, else 'win'/'loss' based on net profit? 
                                // Or just show profit.
                                const isPending = groupMembers.some(b => b.result === 'pending');

                                // Odds range?
                                const oddsList = groupMembers.map(b => b.odds).sort((a, b) => a - b);
                                const oddsDisplay = oddsList.length > 1 ? `${oddsList[0].toFixed(2)} - ${oddsList[oddsList.length - 1].toFixed(2)}` : oddsList[0].toFixed(2);

                                groupedList.push({
                                  type: 'group',
                                  id: bet.groupId,
                                  date: bet.date,
                                  tipster: bet.tipster,
                                  description: `${bet.groupType || 'Sistema'} (${groupMembers.length} apuestas)`,
                                  stake: totalStake,
                                  odds: oddsDisplay,
                                  profit: totalProfit,
                                  result: isPending ? 'pending' : (totalProfit >= 0 ? 'win' : 'loss'),
                                  children: groupMembers
                                });
                              } else {
                                groupedList.push({ type: 'single', ...bet });
                              }
                            });

                            return groupedList.map(item => {
                              if (item.type === 'group') {
                                const isExpanded = expandedBets.includes(item.id);
                                const profitColor = item.result === 'pending' ? 'text-slate-500' : (item.profit >= 0 ? 'text-emerald-400' : 'text-red-400');

                                return (
                                  <React.Fragment key={item.id}>
                                    <tr className={`hover:bg-slate-800/50 transition-colors border-l-4 border-l-cyan-500/50 bg-cyan-900/10 cursor-pointer`} onClick={() => toggleHistoryExpansion(item.id)}>
                                      <td className="p-4 text-slate-400 text-xs whitespace-nowrap">{item.date}</td>
                                      <td className="p-4">
                                        <div className="flex items-center gap-3">
                                          <div className="p-2 rounded-lg bg-cyan-900/20 text-cyan-400"><LayoutGrid size={18} /></div>
                                          <div>
                                            <div className="font-bold text-white flex items-center gap-2">
                                              {item.tipster} <span className="text-[10px] bg-cyan-900 text-cyan-200 px-1.5 rounded">{item.description}</span>
                                            </div>
                                            <div className="text-xs text-slate-500">{isExpanded ? 'Ocultar desglose' : 'Ver desglose detallado'}</div>
                                          </div>
                                          <button
                                            onClick={(e) => { e.stopPropagation(); setEditingBet({ id: item.id, isGroup: true, children: item.children, description: item.description, groupType: item.children[0].groupType, stake: item.stake, date: item.date, tipster: item.tipster }); setActiveSection('dashboard'); }}
                                            className="bg-blue-900/40 hover:bg-blue-600 text-blue-400 hover:text-white p-2 rounded-lg transition-all"
                                            title="Editar Sistema"
                                          >
                                            <Edit size={16} />
                                          </button>
                                          <button
                                            onClick={(e) => { e.stopPropagation(); handleRepeatBet({ ...item, isGroup: true }); }}
                                            className="bg-indigo-900/40 hover:bg-indigo-600 text-indigo-400 hover:text-white p-2 rounded-lg transition-all"
                                            title="Repetir Sistema"
                                          >
                                            <Repeat size={16} />
                                          </button>
                                          <button
                                            onClick={(e) => { e.stopPropagation(); deleteGroup(item); }}
                                            className="bg-red-900/40 hover:bg-red-600 text-red-400 hover:text-white p-2 rounded-lg transition-all"
                                            title="Borrar Grupo"
                                          >
                                            <Trash2 size={16} />
                                          </button>
                                        </div>
                                      </td>
                                      <td className="p-4 text-center text-slate-300 font-bold">{item.stake.toFixed(2)}€</td>
                                      <td className="p-4 text-center font-mono text-slate-400 text-xs">
                                        {(() => {
                                          const ods = item.children.map(c => c.odds || 0);
                                          const min = Math.min(...ods);
                                          const max = Math.max(...ods);
                                          return min === max ? `@${min.toFixed(2)}` : `@${min.toFixed(2)} - ${max.toFixed(2)}`;
                                        })()}
                                      </td>
                                      <td className={`p-4 text-right font-bold font-mono ${profitColor}`}>
                                        {item.result === 'pending' ? 'PEND' : (item.profit > 0 ? '+' : '') + item.profit.toFixed(2) + '€'}
                                      </td>
                                      <td className="p-4 text-center">
                                        <ChevronDown size={16} className={`text-slate-500 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
                                      </td>
                                    </tr>
                                    {isExpanded && item.children.map(child => (
                                      <tr key={child.id} className="bg-slate-950/30 border-b border-slate-800/50">
                                        <td className="p-4 pl-8 text-slate-600 text-[10px]">{child.id}</td>
                                        <td className="p-4 pl-12 text-xs text-slate-400 flex items-center gap-2">
                                          <span className="w-1.5 h-1.5 rounded-full bg-slate-600"></span>
                                          {child.description}
                                        </td>
                                        <td className="p-4 text-center text-slate-500 text-xs">{child.stake.toFixed(2)}€</td>
                                        <td className="p-4 text-center text-emerald-600 font-mono text-xs">@{child.odds.toFixed(2)}</td>
                                        <td className={`p-4 text-right text-xs font-mono font-bold ${child.result === 'pending' ? 'text-slate-600' : (child.profit >= 0 ? 'text-emerald-500' : 'text-red-500')}`}>
                                          {child.result === 'pending' ? '---' : (child.profit.toFixed(2) + '€')}
                                        </td>
                                        <td className="p-4 text-center">
                                          {/* Actions for child? Maybe delete single line? Complex. Keep simple for now. */}
                                        </td>
                                      </tr>
                                    ))}
                                  </React.Fragment>
                                );
                              } else {
                                // SINGLE BET RENDER (Existing Logic)
                                const bet = item;
                                const isMulti = (bet.betLines && bet.betLines.length > 0) || (bet.subPicks && bet.subPicks.length > 0);
                                const isExpanded = expandedBets.includes(bet.id);

                                return (
                                  <React.Fragment key={bet.id}>
                                    <tr className={`hover:bg-slate-800/50 transition-colors ${isExpanded ? 'bg-slate-800/30' : ''}`}>
                                      <td className="p-4 text-slate-400 text-xs whitespace-nowrap">{bet.date}</td>
                                      <td className="p-4" onClick={() => isMulti && toggleHistoryExpansion(bet.id)}>
                                        <div className={`flex items-start gap-3 ${isMulti ? 'cursor-pointer group' : ''}`}>
                                          <div className={`p-2 rounded-lg ${isMulti ? 'bg-indigo-900/20 text-indigo-400 group-hover:bg-indigo-900/40' : 'bg-slate-800 text-slate-400'}`}>
                                            {isMulti ? <Layers size={18} /> : (bet.stake > 50 ? <Flame size={18} className="text-orange-500" /> : <Tag size={18} />)}
                                          </div>
                                          <div>
                                            <div className="font-bold text-white flex items-center gap-2">
                                              {bet.tipster}
                                              {isMulti && <span className="text-[10px] bg-slate-800 px-1.5 rounded text-slate-400 font-normal border border-slate-700">{isExpanded ? 'Ocultar' : 'Ver Líneas'}</span>}
                                            </div>
                                            <div className="text-xs text-slate-500 truncate max-w-[250px]">{bet.description}</div>
                                          </div>
                                        </div>
                                      </td>
                                      <td className="p-4 text-center text-slate-300">{bet.stake.toFixed(2)}€</td>
                                      <td className="p-4 text-center font-mono text-emerald-400 font-bold">@{bet.odds.toFixed(2)}</td>
                                      <td className={`p-4 text-right font-bold font-mono ${bet.result === 'pending' ? 'text-slate-500' : (bet.profit >= 0 ? 'text-emerald-400' : 'text-red-400')}`}>
                                        {bet.result === 'pending' ? 'PEND' : (bet.profit >= 0 ? '+' : '') + bet.profit.toFixed(2) + '€'}
                                      </td>
                                      <td className="p-4 text-center flex items-center justify-center gap-2">
                                        <button onClick={() => setEditingBet(bet)} className="text-blue-400 hover:text-white p-1.5 rounded bg-blue-900/20 hover:bg-blue-600 transition-colors" title="Editar"><Edit size={14} /></button>
                                        <button onClick={() => handleRepeatBet(bet)} className="text-indigo-400 hover:text-white p-1.5 rounded bg-indigo-900/20 hover:bg-indigo-600 transition-colors" title="Repetir Apuesta"><Repeat size={14} /></button>
                                        <button onClick={() => deleteBet(bet.id)} className="text-slate-600 hover:text-red-400 p-1.5 transition-colors"><Trash2 size={16} /></button>
                                      </td>
                                    </tr>
                                    {isMulti && isExpanded && (
                                      <tr className="bg-slate-950/50 animate-fade-in border-b border-slate-800">
                                        <td colSpan="6" className="p-0">
                                          <div className="p-4 pl-16 grid grid-cols-1 gap-2 bg-gradient-to-b from-indigo-900/10 to-transparent">
                                            <div className="text-[10px] font-bold text-slate-500 uppercase flex items-center gap-2 mb-1"><Layers size={10} /> Desglose de Combinada</div>
                                            {(bet.betLines || bet.subPicks).map((line, i) => {
                                              const s = line.result || line.status || 'pending';
                                              let colorClass = 'text-slate-500';
                                              if (s === 'win') colorClass = 'text-emerald-400';
                                              if (s === 'loss') colorClass = 'text-red-400';
                                              if (s === 'void') colorClass = 'text-slate-400 line-through';
                                              return (
                                                <div key={i} className="flex items-center justify-between bg-slate-900 border border-slate-800 p-2 rounded text-xs hover:border-slate-700 transition-colors">
                                                  <div className="flex items-center gap-3">
                                                    <div className={`w-1.5 h-1.5 rounded-full ${s === 'win' ? 'bg-emerald-500' : (s === 'loss' ? 'bg-red-500' : 'bg-slate-600')}`}></div>
                                                    {(bet.tipster === 'Mezcla-Tips' || bet.tipster === 'Combis (Apuesta D)') && <span className="font-bold text-slate-300">{line.tipster || bet.tipster}</span>}
                                                    <span className={`${colorClass} truncate max-w-[200px]`}>{line.description}</span>
                                                  </div>
                                                  <span className="font-mono text-slate-500">@{line.odds || '-'}</span>
                                                </div>
                                              )
                                            })}
                                          </div>
                                        </td>
                                      </tr>
                                    )}
                                  </React.Fragment>
                                );
                              }
                            });
                          })()
                        })()}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            )}

            {/* RESOLUTION MODAL (V7 - GRANULAR) */}
            {resolutionBet && (
              <div className="fixed inset-0 bg-black/90 z-[80] flex items-center justify-center p-4 animate-fade-in backdrop-blur-md">
                <div className="bg-slate-900 w-full max-w-lg rounded-xl border border-slate-700 shadow-2xl overflow-hidden animate-scale-in">
                  <div className="p-6 bg-gradient-to-r from-slate-900 to-indigo-900/20 border-b border-slate-800">
                    <h3 className="text-xl font-bold text-white mb-1">Resolución Detallada</h3>
                    <p className="text-sm text-slate-400">Define el resultado de cada línea para el Scout.</p>
                  </div>
                  <div className="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                    {/* LIVE PREVIEW (Phase 16) */}
                    {(() => {
                      const isV7 = resolutionBet.tempLines && resolutionBet.tempLines.length > 0;
                      const lines = isV7 ? resolutionBet.tempLines : resolutionBet.tempSubPicks;

                      let effOdds = resolutionBet.odds;
                      let estProfit = (resolutionBet.stake * effOdds) - resolutionBet.stake;
                      let status = 'WIN';
                      let statusColor = 'text-emerald-400';

                      if (resolutionBet.isGroup && resolutionBet.children) {
                        // --- GROUP SIMULATION ---
                        estProfit = 0;
                        let totalStake = 0;
                        let anyPending = false;

                        resolutionBet.children.forEach(child => {
                          totalStake += parseFloat(child.stake);
                          const childLines = child.betLines || [];

                          // Simulate matching
                          const resolvedChildLines = childLines.map(cl => {
                            const clOdds = parseFloat(String(cl.odds).replace(',', '.'));
                            const match = lines.find(rl => {
                              const rlOdds = parseFloat(String(rl.odds).replace(',', '.'));
                              return rl.description === cl.description &&
                                rl.tipster === cl.tipster &&
                                Math.abs(rlOdds - clOdds) < 0.01;
                            });
                            return match ? { ...cl, result: match.result } : cl;
                          });

                          const isPending = resolvedChildLines.some(l => !l.result || l.result === 'pending');
                          if (isPending) {
                            anyPending = true;
                            return;
                          }

                          const isLoss = resolvedChildLines.some(l => l.result === 'loss');
                          const isVoid = resolvedChildLines.every(l => l.result === 'void');

                          if (isLoss) {
                            estProfit -= parseFloat(child.stake);
                          } else if (isVoid) {
                            // Void = Stake returned (Profit 0)
                          } else {
                            // Win
                            const wins = resolvedChildLines.filter(l => l.result !== 'void');
                            let childOdds = 1.0;
                            if (wins.length > 0) {
                              childOdds = wins.reduce((acc, l) => acc * (parseFloat(String(l.odds).replace(',', '.')) || 1), 1);
                            }
                            estProfit += (parseFloat(child.stake) * childOdds) - parseFloat(child.stake);
                          }
                        });

                        if (anyPending) {
                          status = 'PENDING';
                          statusColor = 'text-yellow-400';
                          effOdds = 0; // Not relevant
                        } else {
                          // All resolved
                          status = estProfit >= 0 ? 'WIN' : 'PARTIAL'; // Or just WIN/LOSS logic based on total
                          if (estProfit < 0 && estProfit > -totalStake) status = 'PARTIAL LOSS';
                          if (estProfit === -totalStake) status = 'LOSS';

                          statusColor = estProfit >= 0 ? 'text-emerald-400' : 'text-red-400';
                          // effOdds is tricky for systems, maybe implied odds? (Profit + Stake) / Stake
                          effOdds = (estProfit + totalStake) / totalStake;
                        }

                      } else {
                        // --- SINGLE BET SIMULATION (Existing) ---
                        const anyLoss = isV7 ? lines.some(l => l.result === 'loss') : lines.some(l => l.status === 'loss');
                        const allVoid = isV7 ? lines.every(l => l.result === 'void') : false;

                        if (anyLoss) { status = 'LOSS'; estProfit = -resolutionBet.stake; statusColor = 'text-red-400'; effOdds = 0; }
                        else if (allVoid) { status = 'VOID'; estProfit = 0; statusColor = 'text-slate-400'; effOdds = 1.00; }
                        else if (isV7) {
                          const winningLines = lines.filter(l => l.result !== 'void');
                          if (winningLines.length > 0) {
                            effOdds = winningLines.reduce((acc, l) => acc * (parseFloat(l.odds) || 1), 1);
                            estProfit = (resolutionBet.stake * effOdds) - resolutionBet.stake;
                          } else {
                            // Should be void if no winning lines and no loss? Handled by allVoid check mostly.
                            // Covers edge case of just one line remaining valid?
                            // Actually winningLines logic handles it. 
                          }
                        }
                      }

                      return (
                        <div className="bg-slate-950/50 rounded-lg border border-slate-700 p-4 mb-4 flex justify-between items-center animate-pulse-slow">
                          <div>
                            <div className="text-[10px] uppercase font-bold text-slate-500">Resultado Estimado</div>
                            <div className={`text-xl font-bold font-mono ${statusColor}`}>{status}</div>
                          </div>
                          <div className="text-right">
                            <div className="text-[10px] uppercase font-bold text-slate-500">Cuota Efectiva</div>
                            <div className="text-sm font-mono text-white">@{effOdds.toFixed(2)}</div>
                          </div>
                          <div className="text-right">
                            <div className="text-[10px] uppercase font-bold text-slate-500">Beneficio</div>
                            <div className={`text-xl font-bold font-mono ${estProfit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{estProfit > 0 ? '+' : ''}{estProfit.toFixed(2)}€</div>
                          </div>
                        </div>
                      );
                    })()}

                    {/* Support V7 Lines */}
                    {resolutionBet.tempLines && resolutionBet.tempLines.length > 0 && resolutionBet.tempLines.map((line, idx) => (
                      <div key={idx} className="bg-slate-950 p-4 rounded-lg border border-slate-800 flex flex-col gap-2">
                        <div className="flex justify-between">
                          {(resolutionBet.tipster === 'Mezcla-Tips' || resolutionBet.tipster === 'Combis (Apuesta D)') && <span className="font-bold text-indigo-400 text-sm">{line.tipster || resolutionBet.tipster}</span>}
                          <span className="text-slate-500 text-xs text-right">@{line.odds}</span>
                        </div>
                        <div className="text-sm text-slate-300">{line.description}</div>
                        <div className="grid grid-cols-3 gap-2 mt-2">
                          <button onClick={() => {
                            const newLines = [...resolutionBet.tempLines]; newLines[idx].result = 'win';
                            setResolutionBet({ ...resolutionBet, tempLines: newLines });
                          }} className={`p-2 rounded text-xs font-bold border transition-all ${line.result === 'win' ? 'bg-emerald-500 text-white border-emerald-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-emerald-500'}`}>GANADA</button>
                          <button onClick={() => {
                            const newLines = [...resolutionBet.tempLines]; newLines[idx].result = 'void';
                            setResolutionBet({ ...resolutionBet, tempLines: newLines });
                          }} className={`p-2 rounded text-xs font-bold border transition-all ${line.result === 'void' ? 'bg-slate-500 text-white border-slate-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-slate-500'}`}>NULA</button>
                          <button onClick={() => {
                            const newLines = [...resolutionBet.tempLines]; newLines[idx].result = 'loss';
                            setResolutionBet({ ...resolutionBet, tempLines: newLines });
                          }} className={`p-2 rounded text-xs font-bold border transition-all ${line.result === 'loss' ? 'bg-red-500 text-white border-red-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-red-500'}`}>PERDIDA</button>
                        </div>
                      </div>
                    ))}

                    {/* Support V3 SubPicks (Legacy) */}
                    {(!resolutionBet.tempLines || resolutionBet.tempLines.length === 0) && resolutionBet.tempSubPicks && resolutionBet.tempSubPicks.map((sub, idx) => (
                      <div key={idx} className="bg-slate-950 p-4 rounded-lg border border-slate-800 flex flex-col gap-2">
                        <div className="flex justify-between">
                          <span className="font-bold text-blue-400 text-sm">{sub.tipster}</span>
                        </div>
                        <div className="text-sm text-slate-300">{sub.detail}</div>
                        <div className="grid grid-cols-3 gap-2 mt-2">
                          <button onClick={() => {
                            const newSubs = [...resolutionBet.tempSubPicks]; newSubs[idx].status = 'win';
                            setResolutionBet({ ...resolutionBet, tempSubPicks: newSubs });
                          }} className={`p-2 rounded text-xs font-bold border transition-all ${sub.status === 'win' ? 'bg-emerald-500 text-white border-emerald-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-emerald-500'}`}>GANADA</button>
                          <button onClick={() => {
                            const newSubs = [...resolutionBet.tempSubPicks]; newSubs[idx].status = 'pending';
                            setResolutionBet({ ...resolutionBet, tempSubPicks: newSubs });
                          }} className={`p-2 rounded text-xs font-bold border transition-all ${sub.status === 'pending' ? 'bg-slate-500 text-white border-slate-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-slate-500'}`}>PENDIENTE</button>
                          <button onClick={() => {
                            const newSubs = [...resolutionBet.tempSubPicks]; newSubs[idx].status = 'loss';
                            setResolutionBet({ ...resolutionBet, tempSubPicks: newSubs });
                          }} className={`p-2 rounded text-xs font-bold border transition-all ${sub.status === 'loss' ? 'bg-red-500 text-white border-red-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-red-500'}`}>PERDIDA</button>
                        </div>
                      </div>
                    ))}
                  </div>
                  <div className="p-6 border-t border-slate-800 flex justify-end gap-3 bg-slate-900">
                    <button onClick={() => setResolutionBet(null)} className="px-4 py-2 text-slate-400 hover:text-white font-bold transition-colors">Cancelar</button>
                    <button onClick={() => {
                      const isV7 = resolutionBet.tempLines && resolutionBet.tempLines.length > 0;
                      const lines = isV7 ? resolutionBet.tempLines : resolutionBet.tempSubPicks;

                      // --- GROUP RESOLUTION LOGIC ---
                      if (resolutionBet.isGroup) {
                        const updatedBets = bets.map(b => {
                          // Allow update if it matches one of the children IDs
                          const isChild = resolutionBet.children.some(child => child.id === b.id);
                          if (isChild) {
                            // Determine Child Result based on Lines
                            const childLines = b.betLines || [];
                            let childResult = 'win';
                            let childOdds = 1.0;

                            // Map results from resolution lines to child lines
                            // Map results from resolution lines to child lines
                            const resolvedChildLines = childLines.map(cl => {
                              // Find matching line in resolutionBet.tempLines (which is `lines` here)
                              // Match by description AND tipster AND odds (robust float check)
                              // Normalize comma to dot for odds just in case
                              const clOdds = parseFloat(String(cl.odds).replace(',', '.'));

                              const match = lines.find(rl => {
                                const rlOdds = parseFloat(String(rl.odds).replace(',', '.'));
                                return rl.description === cl.description &&
                                  rl.tipster === cl.tipster &&
                                  Math.abs(rlOdds - clOdds) < 0.01;
                              });
                              return match ? { ...cl, result: match.result } : cl;
                            });

                            const anyLoss = resolvedChildLines.some(l => l.result === 'loss');
                            const allVoid = resolvedChildLines.every(l => l.result === 'void');
                            const anyPending = resolvedChildLines.some(l => !l.result || l.result === 'pending');

                            if (anyPending) {
                              childResult = 'pending';
                              childOdds = 1.0; // Placeholder
                            } else if (anyLoss) {
                              childResult = 'loss';
                              childOdds = 0;
                            } else if (allVoid) {
                              childResult = 'void';
                              childOdds = 1.0;
                            } else {
                              const wins = resolvedChildLines.filter(l => l.result !== 'void');
                              if (wins.length > 0) {
                                childOdds = wins.reduce((acc, l) => acc * (parseFloat(String(l.odds).replace(',', '.')) || 1), 1);
                              }
                            }

                            const childProfit = childResult === 'win' ? (b.stake * childOdds) - b.stake : (childResult === 'loss' ? -b.stake : 0);

                            return {
                              ...b,
                              result: childResult,
                              profit: parseFloat(childProfit.toFixed(2)),
                              odds: parseFloat(childOdds.toFixed(2)),
                              betLines: resolvedChildLines
                            };
                          }
                          return b;
                        });
                        setBets(updatedBets);
                        setResolutionBet(null);
                        return; // EXIT
                      }

                      // --- SINGLE BET RESOLUTION LOGIC (Existing) ---
                      let parentResult = 'win';
                      let finalOdds = resolutionBet.odds;
                      let parentProfit = 0;

                      const anyLoss = isV7 ? lines.some(l => l.result === 'loss') : lines.some(l => l.status === 'loss');
                      const allVoid = isV7 ? lines.every(l => l.result === 'void') : false;

                      if (anyLoss) {
                        parentResult = 'loss';
                        parentProfit = -resolutionBet.stake;
                      } else if (allVoid) {
                        parentResult = 'void';
                        parentProfit = 0;
                      } else {
                        // WIN CASE (Check for Voids in V7)
                        if (isV7) {
                          // Recalculate Odds excluding Voids
                          const winningLines = lines.filter(l => l.result !== 'void');
                          if (winningLines.length > 0) {
                            const recalculatedOdds = winningLines.reduce((acc, l) => acc * (parseFloat(l.odds) || 1), 1);
                            finalOdds = parseFloat(recalculatedOdds.toFixed(2));
                          }
                        }
                        parentProfit = (resolutionBet.stake * finalOdds) - resolutionBet.stake;
                      }

                      const updatedBets = bets.map(b => {
                        if (b.id === resolutionBet.id) {
                          return {
                            ...b,
                            result: parentResult,
                            profit: parseFloat(parentProfit.toFixed(2)),
                            odds: finalOdds, // Update Odds with Recalculated Value
                            betLines: isV7 ? resolutionBet.tempLines : undefined,
                            subPicks: !isV7 ? resolutionBet.tempSubPicks : undefined
                          };
                        }
                        return b;
                      });
                      setBets(updatedBets);
                      setResolutionBet(null);
                    }} className="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg shadow-lg shadow-emerald-900/20 transition-all transform active:scale-95">
                      Confirmar Resolución
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* RESOLUTION CHALLENGE MODAL (V17) */}
            {resolutionChallengeBet && (
              <div className="fixed inset-0 bg-black/90 z-[90] flex items-center justify-center p-4 animate-fade-in backdrop-blur-md">
                <div className="bg-slate-900 w-full max-w-lg rounded-xl border border-slate-700 shadow-2xl overflow-hidden animate-scale-in">
                  <div className="p-6 bg-gradient-to-r from-slate-900 to-indigo-900/20 border-b border-slate-800">
                    <h3 className="text-xl font-bold text-white mb-1">Resolución Detallada (Reto)</h3>
                    <p className="text-sm text-slate-400">Define el resultado de cada línea del reto.</p>
                  </div>

                  {/* LIVE PREVIEW (V17) */}
                  <div className="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                    {(() => {
                      const lines = resolutionChallengeBet.tempLines || [];
                      let effOdds = resolutionChallengeBet.odds;
                      let estProfit = (resolutionChallengeBet.stake * effOdds) - resolutionChallengeBet.stake;
                      let status = 'WIN';
                      let statusColor = 'text-emerald-400';

                      const anyLoss = lines.some(l => l.result === 'loss');
                      const allVoid = lines.every(l => l.result === 'void');

                      if (anyLoss) { status = 'LOSS'; estProfit = -resolutionChallengeBet.stake; statusColor = 'text-red-400'; effOdds = 0; }
                      else if (allVoid) { status = 'VOID'; estProfit = 0; statusColor = 'text-slate-400'; effOdds = 1.00; }
                      else {
                        const winningLines = lines.filter(l => l.result !== 'void');
                        if (winningLines.length > 0) {
                          const recalculatedOdds = winningLines.reduce((acc, l) => acc * (parseFloat(l.odds) || 1), 1);
                          effOdds = parseFloat(recalculatedOdds.toFixed(2));
                        }
                        estProfit = (resolutionChallengeBet.stake * effOdds) - resolutionChallengeBet.stake;
                      }

                      return (
                        <div className="bg-slate-950/50 rounded-lg border border-slate-700 p-4 mb-4 flex justify-between items-center animate-pulse-slow">
                          <div>
                            <div className="text-[10px] uppercase font-bold text-slate-500">Resultado Estimado</div>
                            <div className={`text-xl font-bold font-mono ${statusColor}`}>{status}</div>
                          </div>
                          <div className="text-right">
                            <div className="text-[10px] uppercase font-bold text-slate-500">Cuota Efectiva</div>
                            <div className="text-sm font-mono text-white">@{effOdds.toFixed(2)}</div>
                          </div>
                          <div className="text-right">
                            <div className="text-[10px] uppercase font-bold text-slate-500">Beneficio</div>
                            <div className={`text-xl font-bold font-mono ${estProfit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{estProfit > 0 ? '+' : ''}{estProfit.toFixed(2)}€</div>
                          </div>
                        </div>
                      );
                    })()}

                    {resolutionChallengeBet.tempLines.map((line, idx) => (
                      <div key={idx} className="bg-slate-950 p-4 rounded-lg border border-slate-800 flex flex-col gap-2">
                        <div className="flex justify-between">
                          <span className="font-bold text-indigo-400 text-sm">Línea #{idx + 1}</span>
                          <span className="text-slate-500 text-xs text-right">@{line.odds}</span>
                        </div>
                        <div className="text-sm text-slate-300">{line.desc}</div>
                        <div className="grid grid-cols-3 gap-2 mt-2">
                          <button onClick={() => {
                            const newLines = [...resolutionChallengeBet.tempLines]; newLines[idx].result = 'win';
                            setResolutionChallengeBet({ ...resolutionChallengeBet, tempLines: newLines });
                          }} className={`p-2 rounded text-xs font-bold border transition-all ${line.result === 'win' ? 'bg-emerald-500 text-white border-emerald-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-emerald-500'}`}>GANADA</button>
                          <button onClick={() => {
                            const newLines = [...resolutionChallengeBet.tempLines]; newLines[idx].result = 'void';
                            setResolutionChallengeBet({ ...resolutionChallengeBet, tempLines: newLines });
                          }} className={`p-2 rounded text-xs font-bold border transition-all ${line.result === 'void' ? 'bg-slate-500 text-white border-slate-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-slate-500'}`}>NULA</button>
                          <button onClick={() => {
                            const newLines = [...resolutionChallengeBet.tempLines]; newLines[idx].result = 'loss';
                            setResolutionChallengeBet({ ...resolutionChallengeBet, tempLines: newLines });
                          }} className={`p-2 rounded text-xs font-bold border transition-all ${line.result === 'loss' ? 'bg-red-500 text-white border-red-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-red-500'}`}>PERDIDA</button>
                        </div>
                      </div>
                    ))}
                  </div>

                  <div className="p-6 border-t border-slate-800 flex justify-end gap-3 bg-slate-900">
                    <button onClick={() => setResolutionChallengeBet(null)} className="px-4 py-2 text-slate-400 hover:text-white font-bold transition-colors">Cancelar</button>
                    <button onClick={() => {
                      // APPLY LOGIC TO CHALLENGES
                      const lines = resolutionChallengeBet.tempLines;
                      let parentResult = 'win';
                      let finalOdds = resolutionChallengeBet.odds;
                      let parentProfit = 0;

                      const anyLoss = lines.some(l => l.result === 'loss');
                      const allVoid = lines.every(l => l.result === 'void');

                      if (anyLoss) { parentResult = 'loss'; parentProfit = -resolutionChallengeBet.stake; }
                      else if (allVoid) { parentResult = 'void'; parentProfit = 0; }
                      else {
                        const winningLines = lines.filter(l => l.result !== 'void');
                        if (winningLines.length > 0) {
                          const recalculatedOdds = winningLines.reduce((acc, l) => acc * (parseFloat(l.odds) || 1), 1);
                          finalOdds = parseFloat(recalculatedOdds.toFixed(2));
                        }
                        parentProfit = (resolutionChallengeBet.stake * finalOdds) - resolutionChallengeBet.stake;
                      }

                      const updatedChallenges = challenges.map(c => {
                        if (c.id === resolutionChallengeBet.challengeId) {
                          const newHistory = c.history.map(h => {
                            if (h.id === resolutionChallengeBet.id) {
                              return { ...h, result: parentResult, profit: parseFloat(parentProfit.toFixed(2)), odds: finalOdds, lines: resolutionChallengeBet.tempLines };
                            }
                            return h;
                          });
                          const newChallenge = { ...c, history: newHistory };
                          newChallenge.currentBank = recalculateChallengeBank(newChallenge);
                          return newChallenge;
                        }
                        return c;
                      });
                      setChallenges(updatedChallenges);
                      setResolutionChallengeBet(null);
                    }} className="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg shadow-lg shadow-emerald-900/20 transition-all transform active:scale-95">
                      Confirmar Resolución
                    </button>
                  </div>
                </div>
              </div>
            )}

          </div>

          {/* CALCULATOR MODAL (V18 - RECOVERED) */}
          {
            showCalculator && (
              <div className="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4 animate-fade-in backdrop-blur-md" onClick={() => setShowCalculator(false)}>
                <div className="bg-slate-900 w-full max-w-lg rounded-xl border border-slate-700 shadow-2xl overflow-hidden animate-scale-in" onClick={e => e.stopPropagation()}>
                  <div className="p-6 bg-slate-950 border-b border-slate-800 flex justify-between items-center">
                    <h3 className="text-xl font-bold text-white flex items-center gap-2"><Calculator className="text-indigo-500" /> Calculadora Rápida</h3>
                    <button onClick={() => setShowCalculator(false)} className="text-slate-500 hover:text-white"><X size={20} /></button>
                  </div>
                  <div className="p-6 space-y-4">

                    {/* TABS */}
                    <div className="flex p-1 bg-slate-800 rounded-lg mb-4">
                      <button onClick={() => setCalculatorData({ ...calculatorData, mode: 'simple' })} className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${calculatorData.mode === 'simple' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>Simple</button>
                      <button onClick={() => setCalculatorData({ ...calculatorData, mode: 'combo' })} className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${calculatorData.mode === 'combo' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>Combinada</button>
                    </div>

                    {calculatorData.mode === 'simple' ? (
                      <div className="space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Stake (€)</label>
                            <input type="number" value={calculatorData.stake} onChange={e => {
                              const stake = parseFloat(e.target.value) || 0;
                              const odds = parseFloat(calculatorData.odds) || 0;
                              setCalculatorData({ ...calculatorData, stake: e.target.value, profit: ((stake * odds) - stake).toFixed(2) });
                            }} className="w-full bg-slate-800 border border-slate-700 rounded p-3 text-white focus:border-indigo-500" />
                          </div>
                          <div>
                            <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Cuota (@)</label>
                            <input type="number" value={calculatorData.odds} onChange={e => {
                              const odds = parseFloat(e.target.value) || 0;
                              const stake = parseFloat(calculatorData.stake) || 0;
                              setCalculatorData({ ...calculatorData, odds: e.target.value, profit: ((stake * odds) - stake).toFixed(2) });
                            }} className="w-full bg-slate-800 border border-slate-700 rounded p-3 text-white focus:border-indigo-500" />
                          </div>
                        </div>
                        <div className="bg-slate-950 p-4 rounded border border-slate-800 text-center">
                          <div className="text-xs font-bold text-slate-500 uppercase mb-1">Beneficio Neto</div>
                          <div className="text-3xl font-mono font-bold text-emerald-400">{calculatorData.profit || '0.00'}€</div>
                        </div>
                      </div>
                    ) : (
                      <div className="space-y-4">
                        {/* COMBO LINES */}
                        <div className="space-y-2 max-h-[200px] overflow-y-auto pr-1">
                          {calculatorData.lines.map((line, idx) => (
                            <div key={idx} className="flex gap-2 items-end">
                              <div className="flex-1">
                                {idx === 0 && <label className="text-xs font-bold text-slate-400 mb-1 block">Cuota @</label>}
                                <input type="number" value={line.odds} placeholder="1.50" onChange={e => {
                                  const newLines = [...calculatorData.lines];
                                  newLines[idx].odds = e.target.value;
                                  setCalculatorData({ ...calculatorData, lines: newLines });
                                }} className={`w-full bg-slate-800 border-slate-700 rounded p-2 text-white text-sm ${line.void ? 'opacity-50 line-through' : ''}`} disabled={line.void} />
                              </div>

                              <button onClick={() => {
                                const newLines = [...calculatorData.lines];
                                newLines[idx].void = !newLines[idx].void;
                                setCalculatorData({ ...calculatorData, lines: newLines });
                              }} className={`p-2 mb-0.5 rounded border ${line.void ? 'bg-slate-600 text-white border-slate-500' : 'bg-slate-800 text-slate-400 border-slate-700 hover:text-white'}`} title="Marcar Nula">VOID</button>

                              <button onClick={() => {
                                const newLines = calculatorData.lines.filter((_, i) => i !== idx);
                                setCalculatorData({ ...calculatorData, lines: newLines });
                              }} className="p-2 mb-0.5 rounded bg-red-900/20 text-red-400 border border-red-900/30 hover:bg-red-900/40"><Trash2 size={16} /></button>
                            </div>
                          ))}
                        </div>
                        <button onClick={() => setCalculatorData({ ...calculatorData, lines: [...calculatorData.lines, { odds: '', desc: '', void: false }] })} className="w-full py-2 bg-slate-800 text-slate-300 text-xs font-bold rounded hover:bg-slate-700 flex items-center justify-center gap-2"><Plus size={14} /> AÑADIR LÍNEA</button>

                        {/* STATS */}
                        <div className="grid grid-cols-2 gap-4 pt-4 border-t border-slate-800">
                          <div className="bg-slate-950 p-3 rounded border border-slate-800">
                            <div className="text-[10px] font-bold text-slate-500 uppercase">Cuota Total</div>
                            <div className="text-xl font-mono font-bold text-white">
                              @{calculatorData.lines.filter(l => !l.void).reduce((acc, l) => acc * (parseFloat(l.odds) || 1), 1).toFixed(2)}
                            </div>
                          </div>
                          <div className="bg-slate-950 p-3 rounded border border-slate-800">
                            <input type="number" value={calculatorData.stake} onChange={e => setCalculatorData({ ...calculatorData, stake: e.target.value })} className="w-full bg-transparent text-right text-white font-mono font-bold focus:outline-none mb-1 border-b border-slate-700 pb-1" placeholder="Stake" />
                            <div className="text-[10px] font-bold text-slate-500 uppercase text-right">Benef: {((parseFloat(calculatorData.stake) || 0) * (calculatorData.lines.filter(l => !l.void).reduce((acc, l) => acc * (parseFloat(l.odds) || 1), 1) - 1)).toFixed(2)}€</div>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )
          }

          {/* BANK MANAGER MODAL (V18) */}
          {
            showBankManager && (
              <div className="fixed inset-0 bg-black/90 z-[90] flex items-center justify-center p-4 animate-fade-in backdrop-blur-md" onClick={() => setShowBankManager(false)}>
                <div className="bg-slate-900 w-full max-w-lg rounded-xl border border-slate-700 shadow-2xl overflow-hidden animate-scale-in" onClick={e => e.stopPropagation()}>
                  <div className="p-6 bg-slate-950 border-b border-slate-800 flex justify-between items-center">
                    <h3 className="text-xl font-bold text-white flex items-center gap-2"><PieChart className="text-emerald-500" /> Gestión de Fondos</h3>
                    <button onClick={() => setShowBankManager(false)} className="text-slate-500 hover:text-white"><X size={20} /></button>
                  </div>
                  <div className="p-6 space-y-6">
                    <div className="bg-slate-800/50 p-4 rounded-lg flex justify-between items-center border border-slate-700">
                      <div>
                        <div className="text-xs font-bold text-slate-400 uppercase">Bank Actual (Calculado)</div>
                        <div className="text-3xl font-bold font-mono text-white">{currentGlobalBank.toFixed(2)}€</div>
                      </div>
                      <div className="text-right text-xs text-slate-500">
                        <div>Inversión: {bankTransactions.filter(t => t.type !== 'withdraw').reduce((a, b) => a + parseFloat(b.amount || 0), 0).toFixed(2)}€</div>
                        <div>Retiros: {bankTransactions.filter(t => t.type === 'withdraw').reduce((a, b) => a + parseFloat(b.amount || 0), 0).toFixed(2)}€</div>
                        <div className={financialStats.profit >= 0 ? "text-emerald-500" : "text-red-500"}>Beneficio: {financialStats.profit >= 0 ? '+' : ''}{financialStats.profit.toFixed(2)}€</div>
                      </div>
                    </div>

                    <div className="grid grid-cols-2 gap-3">
                      <button onClick={() => {
                        const amount = prompt("Introduce Bank Inicial (€):");
                        if (amount && !isNaN(amount)) {
                          const newTrans = { id: Date.now(), date: new Date().toISOString(), type: 'initial', amount: parseFloat(amount), note: 'Bank Inicial' };
                          // Filter out old initial if exists? Usually one initial.
                          setBankTransactions([...bankTransactions.filter(t => t.type !== 'initial'), newTrans]);
                        }
                      }} className="p-3 bg-slate-800 hover:bg-slate-700 rounded border border-slate-600 text-sm font-bold text-slate-300 flex items-center justify-center gap-2 transition-colors">
                        <Target size={16} /> FIJAR INICIAL
                      </button>
                      <button onClick={() => {
                        const amount = prompt("Cantidad a Ingresar (€):");
                        if (amount && !isNaN(amount)) {
                          setBankTransactions([...bankTransactions, { id: Date.now(), date: new Date().toISOString(), type: 'deposit', amount: parseFloat(amount), note: 'Depósito' }]);
                        }
                      }} className="p-3 bg-emerald-600/20 hover:bg-emerald-600/30 rounded border border-emerald-500/50 text-sm font-bold text-emerald-400 flex items-center justify-center gap-2 transition-colors">
                        <TrendingUp size={16} /> INGRESAR
                      </button>
                      <button onClick={() => {
                        const amount = prompt("Cantidad a Retirar (€):");
                        if (amount && !isNaN(amount)) {
                          setBankTransactions([...bankTransactions, { id: Date.now(), date: new Date().toISOString(), type: 'withdraw', amount: parseFloat(amount), note: 'Retiro' }]);
                        }
                      }} className="p-3 bg-red-600/20 hover:bg-red-600/30 rounded border border-red-500/50 text-sm font-bold text-red-400 flex items-center justify-center gap-2 transition-colors">
                        <TrendingDown size={16} /> RETIRAR
                      </button>
                      <button onClick={() => {
                        if (confirm("¿Borrar historial de transacciones?")) setBankTransactions([]);
                      }} className="p-3 bg-slate-900 hover:bg-red-900/20 rounded border border-slate-700 hover:border-red-500/30 text-sm font-bold text-slate-500 hover:text-red-400 flex items-center justify-center gap-2 transition-colors">
                        <Trash2 size={16} /> RESET
                      </button>
                    </div>

                    <div className="space-y-2">
                      <h4 className="text-xs font-bold text-slate-500 uppercase">Historial de Movimientos</h4>
                      <div className="max-h-[150px] overflow-y-auto space-y-1 pr-1">
                        {bankTransactions.sort((a, b) => b.id - a.id).map(t => (
                          <div key={t.id} className="flex justify-between items-center p-2 bg-slate-950 rounded border border-slate-800 text-xs">
                            <div className="flex items-center gap-2">
                              <span className={`w-2 h-2 rounded-full ${t.type === 'initial' ? 'bg-blue-500' : (t.type === 'deposit' ? 'bg-emerald-500' : 'bg-red-500')}`}></span>
                              <span className="text-slate-300 font-bold uppercase">{t.type}</span>
                              <span className="text-slate-500">{new Date(t.date).toLocaleDateString()}</span>
                            </div>
                            <div className="font-mono font-bold text-white">{t.amount.toFixed(2)}€</div>
                          </div>
                        ))}
                        {bankTransactions.length === 0 && <div className="text-center text-slate-600 italic py-2">Sin movimientos registrados.</div>}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )
          }

          {/* ADD BET MODAL - REFACTORED V30 */}
          {
            showAddBetModal && (
              <div className="fixed inset-0 bg-black/90 z-[90] flex items-center justify-center p-4 animate-fade-in backdrop-blur-md" onClick={() => { setShowAddBetModal(false); setEditingBet(null); }}>
                <div className="bg-slate-900 w-full max-w-4xl rounded-xl border border-slate-700 shadow-2xl overflow-hidden animate-scale-in flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                  <div className="p-4 border-b border-slate-800 bg-slate-950 flex justify-between items-center shrink-0">
                    <h3 className="font-bold text-white uppercase text-lg flex items-center gap-2">
                      {editingBet ? <Edit size={20} className="text-blue-500" /> : <Plus size={20} className="text-emerald-500" />}
                      {editingBet ? 'Editar Apuesta' : 'Registrar Nueva Apuesta'}
                    </h3>
                    <div className="flex items-center gap-2">
                      <button type="button" onClick={() => setShowTipsterManager(true)} className="text-xs flex items-center gap-1 bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1.5 rounded transition-colors border border-slate-700">
                        <Users size={14} /> Gestionar Tipsters
                      </button>
                      <button onClick={() => { setShowAddBetModal(false); setEditingBet(null); }} className="text-slate-500 hover:text-white transition-colors"><X size={24} /></button>
                    </div>
                  </div>

                  <div className="p-6 overflow-y-auto custom-scrollbar">
                    <form onSubmit={handleAddBet} className="space-y-6 relative z-10">


                      {/* 1. TIPSTER & STAKE (Top Row) */}
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="relative z-20">
                          <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Tipster Principal</label>
                          <div className="relative">
                            <select value={formTipster} onChange={e => {
                              const val = e.target.value;
                              setFormTipster(val);
                              const t = tipsters.find(ti => ti.name === val);
                              if (t) setFormStake(t.defaultStake);
                            }} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:border-emerald-500 appearance-none">
                              {tipsters.map(t => <option key={t.id || t.name} value={t.name}>{t.name}</option>)}
                              {/* Ensure IA option exists visually if not in list yet (though usually better to add to list) */}
                              {!tipsters.some(t => t.name === 'IA') && <option value="IA">IA (Sistema Marcador)</option>}
                            </select>
                            <ChevronRight className="absolute right-3 top-3.5 text-slate-500 rotate-90 pointer-events-none" size={16} />
                          </div>
                        </div>
                        <div>
                          <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">
                            {formTipster === 'IA' ? 'Stake POR APUESTA (€)' : 'Stake Total (€)'}
                          </label>
                          <input type="number" step="0.01" value={formStake} onChange={e => {
                            const newStake = e.target.value;
                            setFormStake(newStake);
                            // Auto-calc profit if odds exist (Non-IA)
                            const o = parseFloat(formOdds);
                            if (o > 1 && newStake && formTipster !== 'IA') {
                              const s = parseFloat(newStake);
                              setManualProfit(((s * o) - s).toFixed(2));
                            }
                          }} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white font-mono text-lg focus:border-emerald-500" />
                          {formTipster === 'IA' && (
                            <div className="text-right text-[10px] text-emerald-500 mt-1 font-mono">
                              Total Inversión: {((parseFloat(formStake) || 0) * 4).toFixed(2)}€
                            </div>
                          )}
                        </div>
                      </div>

                      {/* --- IA SPECIAL FORM --- */}
                      {formTipster === 'IA' ? (
                        <div className="bg-slate-800/40 p-4 rounded-xl border border-indigo-500/30 space-y-4 animate-fade-in">
                          <div className="flex items-center gap-2 mb-2">
                            <div className="p-1 bg-indigo-500 rounded text-white"><LayoutGrid size={16} /></div>
                            <h4 className="font-bold text-indigo-300 uppercase text-sm">Matriz de Marcador Exacto (2 Partidos)</h4>
                          </div>

                          {/* MATCH 1 */}
                          <div className="space-y-2">
                            <label className="text-xs font-bold text-slate-400 uppercase block">Partido 1</label>
                            <input type="text" placeholder="Ej: Roma vs Lazio"
                              value={iaBetData.m1.name}
                              onChange={e => setIaBetData({ ...iaBetData, m1: { ...iaBetData.m1, name: e.target.value } })}
                              className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white text-sm focus:border-indigo-500"
                            />
                            <div className="grid grid-cols-2 gap-2">
                              <div className="flex gap-1">
                                <input type="text" placeholder="Score 1 (1-0)" value={iaBetData.m1.s1.score} onChange={e => setIaBetData({ ...iaBetData, m1: { ...iaBetData.m1, s1: { ...iaBetData.m1.s1, score: e.target.value } } })} className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white" />
                                <input type="number" placeholder="@" value={iaBetData.m1.s1.odds} onChange={e => setIaBetData({ ...iaBetData, m1: { ...iaBetData.m1, s1: { ...iaBetData.m1.s1, odds: e.target.value } } })} className="w-20 bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white font-mono text-center" />
                              </div>
                              <div className="flex gap-1">
                                <input type="text" placeholder="Score 2 (2-0)" value={iaBetData.m1.s2.score} onChange={e => setIaBetData({ ...iaBetData, m1: { ...iaBetData.m1, s2: { ...iaBetData.m1.s2, score: e.target.value } } })} className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white" />
                                <input type="number" placeholder="@" value={iaBetData.m1.s2.odds} onChange={e => setIaBetData({ ...iaBetData, m1: { ...iaBetData.m1, s2: { ...iaBetData.m1.s2, odds: e.target.value } } })} className="w-20 bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white font-mono text-center" />
                              </div>
                            </div>
                          </div>

                          {/* MATCH 2 */}
                          <div className="space-y-2 pt-2 border-t border-slate-700/50">
                            <label className="text-xs font-bold text-slate-400 uppercase block">Partido 2</label>
                            <input type="text" placeholder="Ej: Dortmund vs Bayern"
                              value={iaBetData.m2.name}
                              onChange={e => setIaBetData({ ...iaBetData, m2: { ...iaBetData.m2, name: e.target.value } })}
                              className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white text-sm focus:border-indigo-500"
                            />
                            <div className="grid grid-cols-2 gap-2">
                              <div className="flex gap-1">
                                <input type="text" placeholder="Score 1 (2-1)" value={iaBetData.m2.s1.score} onChange={e => setIaBetData({ ...iaBetData, m2: { ...iaBetData.m2, s1: { ...iaBetData.m2.s1, score: e.target.value } } })} className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white" />
                                <input type="number" placeholder="@" value={iaBetData.m2.s1.odds} onChange={e => setIaBetData({ ...iaBetData, m2: { ...iaBetData.m2, s1: { ...iaBetData.m2.s1, odds: e.target.value } } })} className="w-20 bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white font-mono text-center" />
                              </div>
                              <div className="flex gap-1">
                                <input type="text" placeholder="Score 2 (3-1)" value={iaBetData.m2.s2.score} onChange={e => setIaBetData({ ...iaBetData, m2: { ...iaBetData.m2, s2: { ...iaBetData.m2.s2, score: e.target.value } } })} className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white" />
                                <input type="number" placeholder="@" value={iaBetData.m2.s2.odds} onChange={e => setIaBetData({ ...iaBetData, m2: { ...iaBetData.m2, s2: { ...iaBetData.m2.s2, odds: e.target.value } } })} className="w-20 bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white font-mono text-center" />
                              </div>
                            </div>
                          </div>

                          {/* IA TAG SELECTION */}
                          <div>
                            <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Etiqueta (Opcional)</label>
                            <div className="relative group">
                              <input
                                list="tags-list-ia"
                                type="text"
                                value={formTag}
                                onChange={e => setFormTag(e.target.value.toUpperCase())}
                                placeholder="SISTEMA IA"
                                className="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-white text-sm focus:border-indigo-500 uppercase font-bold"
                                onFocus={e => e.target.select()}
                              />
                              <datalist id="tags-list-ia">
                                {userTags.filter(t => t !== 'ALL').map(tag => <option key={tag} value={tag} />)}
                              </datalist>
                              <div className="absolute top-0 right-0 h-full flex items-center pr-3 pointer-events-none text-slate-600"><Tag size={14} /></div>
                            </div>
                          </div>

                          {/* IA PROFIT PREVIEW */}
                          <div className="bg-slate-950/50 p-2 rounded border border-slate-700/50">
                            <details className="group">
                              <summary className="flex justify-between items-center cursor-pointer text-xs font-bold text-indigo-400 hover:text-indigo-300">
                                <span>Ver Ganancias Potenciales (x4)</span>
                                <ChevronDown size={14} className="group-open:rotate-180 transition-transform" />
                              </summary>
                              <div className="mt-2 space-y-1 max-h-[150px] overflow-y-auto custom-scrollbar">
                                {(() => {
                                  const stP = parseFloat(formStake) || 0;
                                  const { m1, m2 } = iaBetData;
                                  const combosPreview = [
                                    { lines: [m1.s1, m2.s1], desc: 'S1+S1' },
                                    { lines: [m1.s1, m2.s2], desc: 'S1+S2' },
                                    { lines: [m1.s2, m2.s1], desc: 'S2+S1' },
                                    { lines: [m1.s2, m2.s2], desc: 'S2+S2' }
                                  ];
                                  return combosPreview.map((c, i) => {
                                    const o1 = parseFloat(c.lines[0].odds) || 1;
                                    const o2 = parseFloat(c.lines[1].odds) || 1;
                                    const combined = (o1 * o2).toFixed(2);
                                    const prof = ((stP * combined) - stP).toFixed(2);
                                    return (
                                      <div key={i} className="flex justify-between text-[10px] text-slate-400 p-1 hover:bg-slate-800 rounded">
                                        <span>{c.desc} (@{combined})</span>
                                        <span className="font-mono text-emerald-400">+{prof}€</span>
                                      </div>
                                    )
                                  });
                                })()}
                              </div>
                            </details>
                          </div>
                        </div>
                      ) : (
                        <>

                          {/* 2. DESCRIPTION & TAGS */}
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                              <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Descripción General</label>
                              <input type="text" value={formDescription} onChange={e => setFormDescription(e.target.value)} placeholder="Ej: Real Madrid vs Barcelona" className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:border-emerald-500" />
                            </div>
                            <div>
                              <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Etiqueta Principal (Selector Dinámico)</label>
                              <div className="relative group">
                                <input
                                  list="tags-list"
                                  type="text"
                                  value={formTag}
                                  onChange={e => setFormTag(e.target.value.toUpperCase())}
                                  placeholder="Escribe o selecciona..."
                                  className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white text-sm focus:border-blue-500 uppercase font-bold"
                                  onFocus={e => e.target.select()}
                                />
                                <datalist id="tags-list">
                                  {userTags.filter(t => t !== 'ALL').map(tag => <option key={tag} value={tag} />)}
                                </datalist>
                                <div className="absolute top-0 right-0 h-full flex items-center pr-3 pointer-events-none text-slate-600"><Tag size={14} /></div>
                              </div>
                            </div>
                          </div>

                          {/* 3. MULTI-LINE BUILDER (Always On) */}
                          <div className="bg-slate-800/30 p-4 rounded-xl border border-slate-700/50 space-y-3">
                            <div className="flex justify-between items-center">
                              <div className="text-xs font-bold text-indigo-400 uppercase flex items-center gap-2"><Layers size={14} /> Líneas de Apuesta (Multi/Mezcla)</div>
                              <button type="button" onClick={() => setIsMultiLine(!isMultiLine)} className="text-[10px] text-slate-500 hover:text-white underline">{isMultiLine ? 'Ocultar Constructor' : 'Mostrar Constructor'}</button>
                            </div>

                            {(isMultiLine || betLines.length > 0) && (
                              <div className="space-y-2 animate-fade-in">
                                {betLines.map((line, idx) => (
                                  <div key={idx} className="flex flex-col md:flex-row gap-2 items-start md:items-center bg-slate-900/50 p-3 rounded border border-slate-700">
                                    {/* EDICIÃ“N: SELECTOR RESULTADO LÍNEA (V35) */}
                                    {editingBet && (
                                      <div className="md:w-24 shrink-0">
                                        <select
                                          value={line.result || line.status || 'pending'}
                                          onChange={e => updateLine(idx, 'result', e.target.value)}
                                          className={`w-full text-[10px] font-bold uppercase rounded p-1 border outline-none ${(line.result === 'win' || line.status === 'win') ? 'bg-emerald-900/30 text-emerald-400 border-emerald-500/50' :
                                            ((line.result === 'loss' || line.status === 'loss') ? 'bg-red-900/30 text-red-400 border-red-500/50' :
                                              ((line.result === 'void' || line.status === 'void') ? 'bg-slate-800 text-slate-400 border-slate-600' : 'bg-slate-950 text-blue-400 border-slate-700'))
                                            }`}
                                        >
                                          <option value="pending">PEND</option>
                                          <option value="win">WIN</option>
                                          <option value="loss">LOSS</option>
                                          <option value="void">VOID</option>
                                        </select>
                                      </div>
                                    )}
                                    <div className="flex-1 w-full md:w-auto">
                                      <div className="flex gap-1 mb-1">
                                        {/* MULTI TIPSTER LOGIC */}
                                        {/* MULTI TIPSTER LOGIC - RESTRICTED */}
                                        <div className="flex items-center gap-1 flex-wrap">
                                          {formTipster === 'Mezcla-Tips' ? (
                                            <div className="flex flex-col gap-1 min-w-[140px]">
                                              {/* Dynamic Dropdowns for Tipsters */}
                                              {(line.tipster ? line.tipster.split(' + ') : ['']).map((tName, tIdx) => (
                                                <div key={tIdx} className="flex items-center gap-1">
                                                  <select
                                                    className={`w-full border rounded p-1.5 text-xs text-white truncate focus:border-indigo-500 appearance-none ${tIdx === 0 ? 'bg-slate-950 border-slate-700' : 'bg-indigo-900/20 border-indigo-500/30 text-indigo-200'}`}
                                                    value={tName}
                                                    onChange={e => {
                                                      const currentParts = line.tipster ? line.tipster.split(' + ') : [''];
                                                      currentParts[tIdx] = e.target.value;
                                                      updateBetLine(idx, 'tipster', currentParts.join(' + '));
                                                    }}
                                                  >
                                                    <option value="">Seleccionar...</option>
                                                    {tipsters.filter(t => t.name !== 'Mezcla-Tips' && t.name !== 'Combis (Apuesta D)').map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                                                  </select>
                                                  {tIdx > 0 && (
                                                    <button type="button" onClick={() => {
                                                      const currentParts = line.tipster ? line.tipster.split(' + ') : [''];
                                                      const newParts = currentParts.filter((_, i) => i !== tIdx);
                                                      updateBetLine(idx, 'tipster', newParts.join(' + '));
                                                    }} className="text-red-400 hover:text-red-300 p-1"><X size={12} /></button>
                                                  )}
                                                </div>
                                              ))}
                                              <button type="button" onClick={() => {
                                                const current = line.tipster ? line.tipster : '';
                                                updateBetLine(idx, 'tipster', current + (current ? ' + ' : '') + ''); // Append empty slot
                                              }} className="self-start text-[10px] text-emerald-400 hover:text-white bg-emerald-900/20 px-2 py-0.5 rounded border border-emerald-500/30 flex items-center gap-1 mt-0.5">
                                                <Plus size={10} /> Añadir Co-Tipster
                                              </button>
                                            </div>
                                          ) : null}
                                        </div>
                                      </div>
                                      <input type="text" placeholder="Descripción selección..." value={line.description || ''} onChange={e => updateBetLine(idx, 'description', e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white focus:border-indigo-500" />
                                    </div>
                                    <div className="flex gap-2 w-full md:w-auto">
                                      <input type="number" placeholder="@" step="0.01" value={line.odds || ''} onChange={e => updateBetLine(idx, 'odds', e.target.value)} className="w-20 bg-slate-950 border border-slate-700 rounded p-2 text-sm text-center font-bold text-white focus:border-indigo-500" />
                                      <button type="button" onClick={() => removeBetLine(idx)} className="p-2 text-slate-500 hover:text-red-400 hover:bg-red-900/10 rounded"><Trash2 size={16} /></button>
                                    </div>
                                  </div>
                                ))}
                                <button type="button" onClick={addBetLine} className="w-full py-2 border border-dashed border-slate-700 text-slate-400 text-xs rounded hover:bg-slate-800 hover:text-indigo-400 transition-colors flex justify-center items-center gap-2">
                                  <Plus size={14} /> AÑADIR LÍNEA
                                </button>
                              </div>
                            )}
                            {/* Auto-enable if empty */}
                            {betLines.length === 0 && <div className="text-center text-xs text-slate-500 italic py-2 cursor-pointer hover:text-indigo-400" onClick={addBetLine}>Haga clic para añadir líneas detalladas</div>}
                          </div>

                          {/* SYSTEM BETS SECTION (V42) */}
                          {betLines.length >= 2 && (
                            <div className="bg-slate-800/30 p-4 rounded-xl border border-slate-700/50 space-y-3">
                              <div className="flex justify-between items-center cursor-pointer" onClick={() => !systemType && setSystemType({ k: betLines.length, name: 'Combi', count: 1 })}>
                                <div className="text-xs font-bold text-cyan-400 uppercase flex items-center gap-2"><LayoutGrid size={14} /> Apuestas de Sistema (Combinadas)</div>
                                {systemType && <button type="button" onClick={(e) => { e.stopPropagation(); setSystemType(null); }} className="text-[10px] text-red-400 hover:text-red-300">Cancelar Sistema</button>}
                              </div>

                              <div className="space-y-2">
                                {/* Main Accordion / List */}
                                <div className="p-2 bg-slate-950 rounded border border-slate-800">
                                  <div className="text-xs text-slate-500 mb-2">Opciones disponibles para {betLines.length} selecciones:</div>
                                  <div className="space-y-1 max-h-[150px] overflow-y-auto custom-scrollbar">
                                    {/* ALWAYS ADD ACCUMULATOR OPTION */}
                                    <button type="button"
                                      onClick={() => setSystemType(null)}
                                      className={`w-full text-left flex justify-between px-3 py-2 rounded text-xs font-bold border transition-colors ${!systemType ? 'bg-emerald-900/30 text-emerald-400 border-emerald-500/50' : 'bg-slate-900 text-slate-400 border-slate-700 hover:bg-slate-800'}`}
                                    >
                                      <span>Combinada Normal (1 Apuesta)</span>
                                      <span>x{parseFloat(formOdds).toFixed(2)}</span>
                                    </button>

                                    {/* SYSTEM OPTIONS */}
                                    {getSystemOptions(betLines.length).map((sys, idx) => (
                                      <button
                                        key={idx}
                                        type="button"
                                        onClick={() => setSystemType(sys)}
                                        className={`w-full text-left flex justify-between px-3 py-2 rounded text-xs font-bold border transition-colors ${systemType?.name === sys.name && systemType?.count === sys.count ? 'bg-cyan-900/30 text-cyan-400 border-cyan-500/50' : 'bg-slate-900 text-slate-400 border-slate-700 hover:bg-slate-800'}`}
                                      >
                                        <span>{sys.name} {sys.type === 'named' ? '(Sistema)' : ''}</span>
                                        <span className="bg-slate-800 px-1.5 rounded text-[10px] text-slate-300">{sys.count}x</span>
                                      </button>
                                    ))}
                                  </div>
                                </div>

                                {/* INPUT STAKE PER BET */}
                                {systemType && (
                                  <div className="animate-fade-in p-3 bg-cyan-900/10 border border-cyan-500/30 rounded-lg">
                                    <div className="flex justify-between items-center mb-2">
                                      <label className="text-xs font-bold text-cyan-200 uppercase">Stake por apuesta</label>
                                      <span className="text-[10px] text-cyan-500 font-mono">Total: {((parseFloat(systemStake) || 0) * systemType.count).toFixed(2)}€</span>
                                    </div>
                                    <input
                                      type="number"
                                      step="0.01"
                                      value={systemStake}
                                      onChange={e => setSystemStake(e.target.value)}
                                      placeholder="1.00"
                                      className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white font-mono focus:border-cyan-500"
                                    />
                                    <p className="text-[10px] text-slate-400 mt-1 italic">
                                      Se crearán <strong>{systemType.count}</strong> apuestas de <strong>{systemType.name}</strong>.
                                    </p>
                                    {/* SYSTEM PREVIEW (V44) */}
                                    <div className="mt-3">
                                      <details className="group">
                                        <summary className="flex justify-between items-center cursor-pointer text-xs font-bold text-slate-500 hover:text-cyan-400 transition-colors">
                                          <span>Ver Desglose de Apuestas ({systemType.count})</span>
                                          <ChevronDown size={14} className="group-open:rotate-180 transition-transform" />
                                        </summary>
                                        <div className="mt-2 space-y-1 max-h-[150px] overflow-y-auto bg-slate-950/50 p-2 rounded border border-slate-800 custom-scrollbar">
                                          {(() => {
                                            // LIVE PREVIEW GENERATION
                                            let previewBets = [];
                                            if (systemType.type === 'named' && systemType.composition) {
                                              systemType.composition.forEach(part => {
                                                const partCombos = getCombinations(betLines, part.k);
                                                const partName = part.k === 2 ? 'Dobles' : part.k === 3 ? 'Triples' : part.k === 4 ? 'Cuatros' : part.k === 5 ? 'Cincos' : `${part.k} Sel`;
                                                partCombos.forEach((combo, idx) => {
                                                  const odds = combo.reduce((acc, l) => acc * (parseFloat(l.odds) || 1), 1);
                                                  const profit = (parseFloat(systemStake) || 0) * odds - (parseFloat(systemStake) || 0);
                                                  previewBets.push({ name: `${partName} ${idx + 1}/${partCombos.length}`, odds, profit, lines: combo });
                                                });
                                              });
                                            } else {
                                              const combos = getCombinations(betLines, systemType.k);
                                              const partName = systemType.k === 2 ? 'Dobles' : systemType.k === 3 ? 'Triples' : `${systemType.k} Sel`;
                                              combos.forEach((combo, idx) => {
                                                const odds = combo.reduce((acc, l) => acc * (parseFloat(l.odds) || 1), 1);
                                                const profit = (parseFloat(systemStake) || 0) * odds - (parseFloat(systemStake) || 0);
                                                previewBets.push({ name: `${partName} ${idx + 1}/${combos.length}`, odds, profit, lines: combo });
                                              });
                                            }

                                            return previewBets.map((pb, i) => (
                                              <div key={i} className="flex justify-between items-center text-[10px] p-1 hover:bg-slate-800 rounded">
                                                <div className="flex flex-col">
                                                  <span className="font-bold text-slate-300">{pb.name}</span>
                                                  <span className="text-slate-500 truncate w-[180px]">{pb.lines.map(l => l.description).join(' + ')}</span>
                                                </div>
                                                <div className="text-right">
                                                  <div className="font-mono text-cyan-400">@{pb.odds.toFixed(2)}</div>
                                                  <div className="text-emerald-500 font-bold">+{pb.profit > 0 ? pb.profit.toFixed(2) : '0.00'}€</div>
                                                </div>
                                              </div>
                                            ));
                                          })()}
                                        </div>
                                      </details>
                                    </div>
                                  </div>
                                )}
                              </div>
                            </div>
                          )}

                          {/* 4. ODDS & PROFIT CALCULATOR (Hidden if System Selected) */}
                          {!systemType && (
                            <div className="grid grid-cols-2 gap-4 bg-slate-800/30 p-4 rounded-xl border border-slate-700/50">
                              <div>
                                <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Cuota Final (@)</label>
                                <input type="number" step="0.01" value={formOdds} onChange={e => {
                                  const val = e.target.value;
                                  setFormOdds(val);
                                  // Auto-calc profit
                                  const s = parseFloat(formStake);
                                  const o = parseFloat(val);
                                  if (s > 0 && o > 1) {
                                    setManualProfit(((s * o) - s).toFixed(2));
                                  } else {
                                    if (!val) setManualProfit('');
                                  }
                                }} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white text-xl font-bold font-mono focus:border-emerald-500" placeholder="1.00" />
                              </div>
                              <div>
                                <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">O Ganancia Neta (€)</label>
                                <div className="relative">
                                  <input type="number" step="0.01" value={manualProfit} onChange={e => {
                                    const val = e.target.value;
                                    setManualProfit(val);

                                    const s = parseFloat(formStake);
                                    const p = parseFloat(val);

                                    if (s > 0 && p > 0) {
                                      const targetTotalOdds = (p + s) / s;

                                      // 1. Update Global Odds Display
                                      setFormOdds(targetTotalOdds.toFixed(2));

                                      // 2. Prop-Odds Scaling for Multi-Line
                                      // (Trigger if lines exist, regardless of implicit mode state, for UI consistency)
                                      if (betLines.length > 0) {
                                        const currentTotalProduct = betLines.reduce((acc, line) => acc * (parseFloat(line.odds) || 1), 1);
                                        if (currentTotalProduct > 0) {
                                          // Math: NewLine = OldLine * (TargetTotal / CurrentTotal)^(1/n)
                                          const ratio = targetTotalOdds / currentTotalProduct;
                                          const n = betLines.length;
                                          const multiplier = Math.pow(ratio, 1 / n);

                                          const newLines = betLines.map(line => ({
                                            ...line,
                                            odds: ((parseFloat(line.odds) || 1) * multiplier).toFixed(2)
                                          }));
                                          setBetLines(newLines);
                                        }
                                      }
                                    } else {
                                      if (!val) setFormOdds(''); // Optional: clear odds if profit cleared? Or keep last.
                                    }
                                  }} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-emerald-400 font-bold font-mono text-xl focus:border-emerald-500" placeholder="0.00" />
                                  {/* Removed AUTO-CALC label as requested */}
                                </div>
                              </div>
                            </div>
                          )}

                          {/* EDICIÃ“N: BOTONES RESULTADO GENERAL (V35 - Refined) */}
                          {editingBet && (
                            <div className="bg-slate-800/50 p-3 rounded-xl border border-slate-700/50 flex flex-col gap-2">
                              <label className="text-xs font-bold text-slate-400 uppercase text-center">Estado Final de la Apuesta</label>
                              <div className="grid grid-cols-4 gap-2">
                                <button type="button" onClick={() => setFormResult('pending')} className={`p-2 rounded font-bold text-xs transition-colors border ${formResult === 'pending' ? 'bg-blue-900/40 text-blue-400 border-blue-500' : 'bg-slate-950 text-slate-500 border-slate-800 hover:border-blue-500/50'}`}>PENDIENTE â³</button>
                                <button type="button" onClick={() => setFormResult('win')} className={`p-2 rounded font-bold text-xs transition-colors border ${formResult === 'win' ? 'bg-emerald-900/40 text-emerald-400 border-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.2)]' : 'bg-slate-950 text-slate-500 border-slate-800 hover:border-emerald-500/50'}`}>GANADA ✅</button>
                                <button type="button" onClick={() => setFormResult('loss')} className={`p-2 rounded font-bold text-xs transition-colors border ${formResult === 'loss' ? 'bg-red-900/40 text-red-400 border-red-500 shadow-[0_0_10px_rgba(239,68,68,0.2)]' : 'bg-slate-950 text-slate-500 border-slate-800 hover:border-red-500/50'}`}>PERDIDA âŒ</button>
                                <button type="button" onClick={() => setFormResult('void')} className={`p-2 rounded font-bold text-xs transition-colors border ${formResult === 'void' ? 'bg-slate-700 text-slate-300 border-slate-500' : 'bg-slate-950 text-slate-500 border-slate-800 hover:border-slate-500/50'}`}>ANULADA ðŸš«</button>
                              </div>
                              <p className="text-[10px] text-slate-500 text-center italic">
                                {formResult === 'win' && `Ganancia: +${((parseFloat(formStake) * parseFloat(formOdds)) - parseFloat(formStake)).toFixed(2)}€ (Aprox)`}
                                {formResult === 'loss' && `Pérdida: -${parseFloat(formStake).toFixed(2)}€`}
                                {formResult === 'void' && `Reembolso: 0.00€`}
                                {formResult === 'pending' && `Esperando resultado...`}
                              </p>
                            </div>
                          )}

                        </>
                      )}

                      <button type="submit" className="w-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 py-4 rounded-xl font-bold text-white shadow-lg shadow-emerald-900/20 text-lg transition-all transform active:scale-95 flex items-center justify-center gap-3">
                        <Save size={20} /> REGISTRAR APUESTA (DEBUG)
                      </button>
                    </form>
                  </div>
                </div >
              </div >
            )
          }

          {/* TIPSTER MANAGER MODAL (V30) */}
          {
            showTipsterManager && (
              <div className="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4 animate-fade-in backdrop-blur-md" onClick={() => setShowTipsterManager(false)}>
                <div className="bg-slate-900 w-full max-w-2xl rounded-xl border border-slate-700 shadow-2xl overflow-hidden animate-scale-in" onClick={e => e.stopPropagation()}>
                  <div className="p-6 bg-slate-950 border-b border-slate-800 flex justify-between items-center">
                    <h3 className="text-xl font-bold text-white flex items-center gap-2"><Users className="text-blue-500" /> Gestión de Tipsters</h3>
                    <button onClick={() => setShowTipsterManager(false)} className="text-slate-500 hover:text-white"><X size={20} /></button>
                  </div>
                  <div className="p-6 max-h-[60vh] overflow-y-auto">
                    <div className="flex gap-2 mb-6">
                      <input type="text" id="newTipsterName" placeholder="Nombre del Tipster..." className="flex-1 bg-slate-800 border border-slate-700 rounded p-3 text-white focus:border-blue-500" />
                      <input type="number" id="newTipsterStake" placeholder="Stake Def (€)..." className="w-32 bg-slate-800 border border-slate-700 rounded p-3 text-white focus:border-blue-500" />
                      <button onClick={() => {
                        const nameEl = document.getElementById('newTipsterName');
                        const stakeEl = document.getElementById('newTipsterStake');
                        if (nameEl.value) {
                          handleAddTipster(nameEl.value, stakeEl.value);
                          nameEl.value = '';
                          stakeEl.value = '';
                        }
                      }} className="bg-blue-600 hover:bg-blue-500 text-white font-bold px-4 rounded flex items-center gap-2"><Plus size={18} /> Añadir</button>
                    </div>

                    <div className="space-y-2">
                      {tipsters.map(t => (
                        <div key={t.id} className="flex items-center justify-between bg-slate-800/50 p-3 rounded border border-slate-700 hover:border-slate-500 transition-colors">
                          <div className="flex items-center gap-4">
                            <div className="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center font-bold text-slate-300">{t.name.charAt(0)}</div>
                            <div>
                              <div className="font-bold text-white">{t.name}</div>
                              <div className="text-xs text-slate-500">Stake Base: {t.defaultStake}€</div>
                            </div>
                          </div>
                          <div className="flex items-center gap-2">
                            <button onClick={() => {
                              // Logic: Use stored originalName if available, else name
                              const originalLabel = t.originalName && t.originalName !== t.name
                                ? t.originalName
                                : DEFAULT_TIPSTERS.find(dt => dt.id === t.id)?.name; // Fallback for really old defaults if strict mode fails

                              const label = (originalLabel && originalLabel !== t.name)
                                ? `Editar Nombre (Original: ${originalLabel}):`
                                : "Editar Nombre del Tipster:";

                              const newName = prompt(label, t.name);
                              if (newName !== null) {
                                const newStake = prompt("Editar Stake Base (€):", t.defaultStake);
                                if (newStake !== null) {
                                  handleEditTipster(t.id, newName || t.name, newStake || t.defaultStake);
                                }
                              }
                            }} className="p-2 text-slate-400 hover:text-white bg-slate-900 rounded border border-slate-700 hover:border-emerald-500 transition-colors"><Edit size={14} /></button>
                            <button onClick={() => handleDeleteTipster(t.id)} className="p-2 text-red-400 hover:text-red-300 bg-red-900/20 rounded"><Trash2 size={14} /></button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            )
          }

          {/* CHALLENGE BET MODAL - BUGFIX V30 */}
          {
            activeChallengeId && (
              <div className="fixed inset-0 bg-black/90 z-[95] flex items-center justify-center p-4 animate-fade-in backdrop-blur-md" onClick={() => setActiveChallengeId(null)}>
                <div className="bg-slate-900 w-full max-w-lg rounded-xl border border-slate-700 shadow-2xl overflow-hidden animate-scale-in" onClick={e => e.stopPropagation()}>
                  <div className="p-4 bg-slate-950 border-b border-slate-800 flex justify-between items-center">
                    <h3 className="text-lg font-bold text-white flex items-center gap-2"><Trophy className="text-yellow-500" /> Nuevo Paso del Reto</h3>
                    <button onClick={() => setActiveChallengeId(null)} className="text-slate-500 hover:text-white"><X size={20} /></button>
                  </div>
                  <form onSubmit={(e) => { addChallengeBet(e, activeChallengeId); setActiveChallengeId(null); }} className="p-6 space-y-4">
                    {/* HEADER FORM */}
                    <div className="flex justify-end mb-2">
                      <button type="button" onClick={() => setIsChallengeMulti(!isChallengeMulti)} className={`text-xs font-bold px-3 py-1 rounded border transition-colors ${isChallengeMulti ? 'bg-indigo-600 border-indigo-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-400'}`}>
                        {isChallengeMulti ? 'Modo Combinada ACTIVADO' : 'Activar Modo Combinada'}
                      </button>
                    </div>

                    <div>
                      <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Descripción del Paso</label>
                      <input type="text" value={challengeForm.desc} onChange={e => setChallengeForm({ ...challengeForm, desc: e.target.value })} className="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white focus:border-yellow-500" required placeholder="Ej: Paso 1 - Real Madrid vs..." />
                    </div>

                    {/* CHALLENGE MULTI-LINE BUILDER */}
                    {isChallengeMulti && (
                      <div className="bg-slate-800/30 p-3 rounded-lg border border-slate-700/50 space-y-2">
                        <div className="text-[10px] font-bold text-indigo-400 uppercase flex items-center gap-2"><Layers size={12} /> Líneas del Reto</div>
                        {challengeForm.lines.map((line, idx) => (
                          <div key={idx} className="flex flex-col gap-2 bg-slate-900/50 p-2 rounded border border-slate-700">
                            {/* TIPSTER SELECT V30 */}
                            <div className="relative">
                              <select value={line.tipster} onChange={e => updateChallengeLine(idx, 'tipster', e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-xs text-white appearance-none focus:border-indigo-500">
                                <option value="">Seleccionar Tipster...</option>
                                {tipsters.map(t => <option key={t.id || t.name} value={t.name}>{t.name}</option>)}
                              </select>
                              <ChevronRight className="absolute right-2 top-2.5 text-slate-500 rotate-90 pointer-events-none" size={14} />
                            </div>

                            <input type="text" placeholder="Descripción..." value={line.desc} onChange={e => updateChallengeLine(idx, 'desc', e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-xs text-white" />
                            <div className="flex gap-2">
                              <input type="number" placeholder="@" step="0.01" value={line.odds} onChange={e => updateChallengeLine(idx, 'odds', e.target.value)} className="w-20 bg-slate-950 border border-slate-700 rounded p-2 text-xs font-bold text-center text-white" />
                              <button type="button" onClick={() => removeChallengeLine(idx)} className="p-2 text-red-400 hover:bg-red-900/20 rounded"><Trash2 size={14} /></button>
                            </div>
                          </div>
                        ))}
                        <button type="button" onClick={addChallengeLine} className="w-full py-2 border border-dashed border-slate-700 text-slate-400 text-xs rounded hover:bg-slate-800 hover:text-indigo-400 flex justify-center items-center gap-2">
                          <Plus size={12} /> Añadir Línea
                        </button>
                      </div>
                    )}

                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="text-xs font-bold text-slate-400 uppercase mb-1 flex justify-between">
                          <span>Stake (€)</span>
                          {/* ALL IN BUTTON V30 */}
                          <button type="button" onClick={() => {
                            const currentCh = challenges.find(c => c.id === activeChallengeId);
                            if (currentCh) setChallengeForm({ ...challengeForm, stake: currentCh.currentBank });
                          }} className="text-[10px] bg-yellow-600/20 text-yellow-500 px-1.5 rounded hover:bg-yellow-600 hover:text-white transition-colors border border-yellow-600/30">ALL-IN</button>
                        </label>
                        <input type="number" step="0.01" value={challengeForm.stake} onChange={e => setChallengeForm({ ...challengeForm, stake: e.target.value })} className="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white font-mono focus:border-yellow-500" required />
                      </div>
                      <div>
                        <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Cuota Total (@)</label>
                        <input type="number" step="0.01" value={challengeForm.odds} onChange={e => setChallengeForm({ ...challengeForm, odds: e.target.value })} className="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white font-mono focus:border-yellow-500" required />
                      </div>
                    </div>
                    <button type="submit" className="w-full bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-3 rounded-lg shadow-lg">REGISTRAR PASO</button>
                  </form>
                </div>
              </div>
            )
          }
          {/* CLOUD MODAL (V32) */}
          {
            showCloudModal && (
              <div className="fixed inset-0 bg-black/95 z-[200] flex items-center justify-center p-4 backdrop-blur-md">
                <div className="bg-slate-900 w-full max-w-lg rounded-xl border border-indigo-500/50 shadow-2xl flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                  <div className="p-4 bg-indigo-950/30 border-b border-indigo-900/30 flex justify-between items-center shrink-0">
                    <h3 className="text-lg font-bold text-white flex items-center gap-2"><Cloud className="text-indigo-400" /> Sincronización en la Nube</h3>
                    <button onClick={() => setShowCloudModal(false)}><X size={20} className="text-slate-400 hover:text-white" /></button>
                  </div>

                  <div className="p-6 space-y-6 overflow-y-auto custom-scrollbar">
                    {/* STATUS INDICATOR */}
                    <div className={`p-3 rounded-lg border text-center font-bold ${cloudStatus === 'error' ? 'bg-red-900/20 border-red-500 text-red-500' :
                      cloudStatus === 'success' ? 'bg-emerald-900/20 border-emerald-500 text-emerald-500' :
                        cloudStatus === 'uploading' || cloudStatus === 'downloading' ? 'bg-blue-900/20 border-blue-500 text-blue-400 animate-pulse' :
                          'bg-slate-800 border-slate-700 text-slate-400'
                      }`}>
                      {cloudStatus === 'idle' && 'Listo para sincronizar'}
                      {cloudStatus === 'uploading' && 'Subiendo datos a la nube...'}
                      {cloudStatus === 'downloading' && 'Descargando datos de la nube...'}
                      {cloudStatus === 'success' && '¡Operación Completada!'}
                      {cloudStatus === 'error' && 'Error en la operación'}
                    </div>

                    {/* SYNC ACTIONS */}
                    <div className="grid grid-cols-2 gap-4">
                      <button onClick={handleCloudUpload} disabled={cloudStatus !== 'idle' && cloudStatus !== 'success' && cloudStatus !== 'error'} className="flex flex-col items-center justify-center gap-2 p-4 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-xl transition-all group">
                        <UploadCloud size={32} className="text-indigo-400 group-hover:scale-110 transition-transform" />
                        <span className="font-bold text-sm text-indigo-100">SUBIR DATOS</span>
                        <span className="text-[10px] text-slate-500">Sobrescribe la nube con tus datos actuales</span>
                      </button>
                      <button onClick={handleCloudDownload} disabled={cloudStatus !== 'idle' && cloudStatus !== 'success' && cloudStatus !== 'error'} className="flex flex-col items-center justify-center gap-2 p-4 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-xl transition-all group">
                        <DownloadCloud size={32} className="text-emerald-400 group-hover:scale-110 transition-transform" />
                        <span className="font-bold text-sm text-emerald-100">BAJAR DATOS</span>
                        <span className="text-[10px] text-slate-500">Sobrescribe tu dispositivo con datos de la nube</span>
                      </button>
                    </div>

                    {/* CONFIGURATION */}
                    <div className="border-t border-slate-800 pt-4">
                      <div className="text-xs font-bold text-slate-500 uppercase mb-2">Configuración de Conexión</div>
                      <div className="space-y-3">
                        <div>
                          <label className="text-[10px] text-slate-400 block mb-1">ID Sincronización (Tu Contraseña Secreta)</label>
                          <input type="text" value={cloudConfig.syncId} onChange={e => setCloudConfig({ ...cloudConfig, syncId: e.target.value })} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white font-mono text-xs focus:border-indigo-500" />
                          <p className="text-[9px] text-slate-500 mt-1">Usa la misma ID en todos tus dispositivos para compartir datos.</p>
                        </div>

                        <label className="flex items-center gap-2 cursor-pointer">
                          <input type="checkbox" checked={cloudConfig.autoSync} onChange={(e) => setCloudConfig({ ...cloudConfig, autoSync: e.target.checked })} className="rounded bg-slate-700 border-slate-600 text-emerald-500 focus:ring-emerald-500" />
                          <span className="text-slate-300">Auto-Sincronizar (cada 3s al detectar cambios)</span>
                        </label>
                      </div>

                      <div className="mt-8 pt-8 border-t border-slate-700">
                        <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                          <Sparkles className="text-purple-400" size={20} /> Gestión de Era
                        </h3>
                        <div className="bg-slate-900/50 p-4 rounded-xl border border-dashed border-slate-700">
                          <p className="text-sm text-slate-400 mb-4">
                            ¿Quieres hacer borrón y cuenta nueva? Esta opción archiva todo tu historial actual como "Antiguo" y te permite empezar de 0 estadísticas y gráficas, sin perder los datos viejos.
                          </p>
                          <button
                            onClick={handleGlobalReset}
                            className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold flex items-center justify-center gap-2 transition-all"
                          >
                            <History size={20} /> Empezar Nueva Etapa (Reset)
                          </button>
                          {eraResetDate && (
                            <p className="text-xs text-center text-slate-500 mt-2">
                              Último reset: {new Date(eraResetDate).toLocaleString()}
                            </p>
                          )}
                        </div>
                      </div>

                      <div className="mt-8 pt-8 border-t border-slate-700">
                        <h3 className="text-lg font-bold text-white mb-4">Zona de Peligro</h3>
                        <details className="group">
                          <summary className="text-[10px] cursor-pointer text-slate-500 hover:text-indigo-400 select-none">Opciones Avanzadas (URL & Key)</summary>
                          <div className="mt-2 space-y-2 pl-2 border-l-2 border-slate-800">
                            <input type="text" placeholder="Supabase URL" value={cloudConfig.url} onChange={e => setCloudConfig({ ...cloudConfig, url: e.target.value })} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-slate-400 text-[10px]" />
                            <input type="password" placeholder="Supabase Anon Key" value={cloudConfig.key} onChange={e => setCloudConfig({ ...cloudConfig, key: e.target.value })} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-slate-400 text-[10px]" />
                          </div>
                        </details>
                      </div>
                    </div>

                    {/* LOCAL MEMORY SECTION (Moved from Sidebar V35) */}
                    <div className="border-t border-slate-800 pt-4">
                      <div className="text-xs font-bold text-slate-500 uppercase mb-2 flex items-center gap-2"><Save size={12} /> Memoria Local & Respaldo</div>
                      <div className="grid grid-cols-2 gap-2">
                        <button onClick={exportData} className="bg-slate-950 p-3 rounded border border-slate-700 hover:border-emerald-500 transition-colors text-xs text-slate-300 hover:text-emerald-400 flex items-center gap-2 justify-center">
                          <Save size={14} /> Exportar JSON
                        </button>
                        <label className="bg-slate-950 p-3 rounded border border-slate-700 hover:border-blue-500 transition-colors text-xs text-slate-300 hover:text-blue-400 flex items-center gap-2 justify-center cursor-pointer">
                          <RefreshCw size={14} /> Importar JSON
                          <input type="file" onChange={importData} accept=".json" className="hidden" />
                        </label>
                      </div>
                      <div className="flex gap-2 mt-2">
                        <button onClick={scanStorage} className="flex-1 bg-red-900/10 border border-red-900/30 hover:bg-red-900/20 text-red-400 p-2 rounded text-[10px] font-bold flex items-center justify-center gap-2">
                          <Activity size={12} /> Rescatar Memoria
                        </button>
                        <button onClick={factoryReset} className="flex-1 bg-slate-800 border border-slate-700 hover:bg-slate-700 text-slate-400 hover:text-red-400 p-2 rounded text-[10px] font-bold flex items-center justify-center gap-2">
                          <Trash2 size={12} /> Reset Fábrica
                        </button>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            )
          }
          {/* RECOVERY MODAL */}
          {
            showRecoveryModal && (
              <div className="fixed inset-0 bg-black/95 z-[200] flex items-center justify-center p-4 backdrop-blur-md" onClick={() => setShowRecoveryModal(false)}>
                <div className="bg-slate-900 w-full max-w-2xl rounded-xl border border-red-900/50 shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
                  <div className="p-4 bg-red-950/30 border-b border-red-900/30 flex justify-between items-center">
                    <h3 className="text-lg font-bold text-white flex items-center gap-2">ðŸš‘ Recuperación de Datos (Storage)</h3>
                    <button onClick={() => setShowRecoveryModal(false)}><X size={20} className="text-slate-400 hover:text-white" /></button>
                  </div>
                  <div className="p-6">
                    <div className="bg-blue-900/20 border border-blue-900/40 p-3 rounded mb-4 text-xs text-blue-300">
                      <p className="font-bold mb-1">â„¹ï¸ Instrucciones:</p>
                      <p>Busca en la lista una clave con un tamaño grande. Si perdiste "Retos", busca claves antiguas o backups. Pulsa "Restaurar" para cargar esos datos.</p>
                    </div>
                    <div className="max-h-[50vh] overflow-y-auto space-y-2">
                      {recoveryKeys.length === 0 ? (
                        <div className="text-center text-slate-500 py-8">No se encontraron copias en este navegador.</div>
                      ) : (
                        recoveryKeys.map((item, idx) => (
                          <div key={idx} className="bg-slate-950 p-3 rounded border border-slate-800 flex flex-col md:flex-row gap-3 justify-between items-center">
                            <div className="overflow-hidden w-full md:w-auto">
                              <div className="font-mono text-xs font-bold text-yellow-500 break-all">{item.key}</div>
                              <div className="text-[10px] text-slate-500 mt-1">Tamaño: {item.size} chars | {item.preview}</div>
                            </div>
                            <div className="flex gap-2 shrink-0">
                              <button
                                onClick={() => {
                                  navigator.clipboard.writeText(localStorage.getItem(item.key));
                                  alert("Datos copiados al portapapeles");
                                }}
                                className="px-3 py-1.5 bg-slate-800 text-slate-300 text-xs rounded hover:bg-slate-700"
                              >Copiar Raw</button>
                              <button
                                onClick={() => restoreBackup(item.key)}
                                className="px-3 py-1.5 bg-emerald-600 text-white text-xs font-bold rounded hover:bg-emerald-500 shadow-lg shadow-emerald-900/20"
                              >
                                RESTAURAR
                              </button>
                            </div>
                          </div>
                        ))
                      )}
                    </div>
                  </div>
                </div>
              </div>
            )
          }

          {/* IMPORT MODAL (V45) - Fixed Z-Index to be above Cloud Modal (z-200) -> Z-500 */}
          {
            importModalOpen && pendingImportData && (
              <div className="fixed inset-0 bg-black/95 z-[500] flex items-center justify-center p-4 animate-fade-in backdrop-blur-md">
                <div className="bg-slate-900 w-full max-w-lg rounded-xl border-2 border-emerald-500 shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
                  <div className="p-4 border-b border-slate-800 bg-slate-950 flex justify-between items-center">
                    <div>
                      <h3 className="font-bold text-white uppercase text-sm flex items-center gap-2"><DownloadCloud size={16} className="text-indigo-400" /> Restauración Selectiva</h3>
                      <div className="text-[10px] text-slate-500">Backup del: {new Date(pendingImportData.timestamp || Date.now()).toLocaleString()}</div>
                    </div>
                    <button onClick={() => { setImportModalOpen(false); setPendingImportData(null); }}><X size={20} className="text-slate-500 hover:text-white" /></button>
                  </div>

                  <div className="p-6">
                    <div className="bg-blue-900/20 text-blue-300 p-3 rounded mb-4 text-xs border border-blue-500/30 flex items-start gap-2">
                      <AlertCircle size={14} className="mt-0.5 shrink-0" />
                      <span>Selecciona qué datos quieres restaurar. Los datos no seleccionados se mantendrán tal como están ahora en tu navegador.</span>
                    </div>

                    <form onSubmit={(e) => {
                      e.preventDefault();
                      const formData = new FormData(e.target);
                      confirmImport({
                        includeBets: formData.get('includeBets') === 'on',
                        includeChallenges: formData.get('includeChallenges') === 'on',
                        includeTipsters: formData.get('includeTipsters') === 'on',
                        includeConfig: formData.get('includeConfig') === 'on'
                      });
                    }} className="space-y-3">

                      <label className="flex items-center justify-between p-3 bg-slate-950 rounded border border-slate-800 hover:border-slate-600 transition-colors cursor-pointer group">
                        <div className="flex items-center gap-3">
                          <input type="checkbox" name="includeBets" defaultChecked className="w-4 h-4 accent-emerald-500" />
                          <div>
                            <div className="font-bold text-white text-sm">Apuestas (Portfolio)</div>
                            <div className="text-[10px] text-slate-500">Historial principal y estadísticas</div>
                          </div>
                        </div>
                        <div className="text-right">
                          <span className="text-xs font-bold text-indigo-400">{pendingImportData.bets?.length || 0}</span>
                          <span className="text-[10px] text-slate-600 block">vs {bets.length} actuales</span>
                        </div>
                      </label>

                      <label className="flex items-center justify-between p-3 bg-slate-950 rounded border border-slate-800 hover:border-slate-600 transition-colors cursor-pointer group">
                        <div className="flex items-center gap-3">
                          <input type="checkbox" name="includeChallenges" defaultChecked className="w-4 h-4 accent-emerald-500" />
                          <div>
                            <div className="font-bold text-white text-sm">Retos y Objetivos</div>
                            <div className="text-[10px] text-slate-500">Todos los retos y sus pasos</div>
                          </div>
                        </div>
                        <div className="text-right">
                          <span className="text-xs font-bold text-indigo-400">{pendingImportData.challenges?.length || 0}</span>
                          <span className="text-[10px] text-slate-600 block">vs {challenges.length} actuales</span>
                        </div>
                      </label>

                      <label className="flex items-center justify-between p-3 bg-slate-950 rounded border border-slate-800 hover:border-slate-600 transition-colors cursor-pointer group">
                        <div className="flex items-center gap-3">
                          <input type="checkbox" name="includeTipsters" defaultChecked className="w-4 h-4 accent-emerald-500" />
                          <div>
                            <div className="font-bold text-white text-sm">Lista de Tipsters</div>
                            <div className="text-[10px] text-slate-500">Configuración de Tipsters y Stakes</div>
                          </div>
                        </div>
                        <div className="text-right">
                          <span className="text-xs font-bold text-indigo-400">{pendingImportData.tipsters?.length || 0}</span>
                          <span className="text-[10px] text-slate-600 block">vs {tipsters.length} actuales</span>
                        </div>
                      </label>

                      <label className="flex items-center justify-between p-3 bg-slate-950 rounded border border-slate-800 hover:border-slate-600 transition-colors cursor-pointer group">
                        <div className="flex items-center gap-3">
                          <input type="checkbox" name="includeConfig" defaultChecked className="w-4 h-4 accent-emerald-500" />
                          <div>
                            <div className="font-bold text-white text-sm">Configuración y Bank</div>
                            <div className="text-[10px] text-slate-500">Etiquetas personalizadas y Transacciones Bank</div>
                          </div>
                        </div>
                        <div className="text-right">
                          <span className="text-xs font-bold text-indigo-400">Info</span>
                          <span className="text-[10px] text-slate-600 block">Global</span>
                        </div>
                      </label>

                      <div className="pt-4 flex gap-3">
                        <button type="submit" className="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-2.5 rounded font-bold shadow-lg shadow-emerald-900/20 text-sm">
                          Confirmar Restauración
                        </button>
                        <button type="button" onClick={() => { setImportModalOpen(false); setPendingImportData(null); }} className="px-4 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded font-bold text-sm">
                          Cancelar
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            )
          }

        </div >
      );
    }

    // --- RENDERIZADO ---
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<PortfolioManager />);

    // Inicializar iconos Lucide (por si acaso se usan fuera de React, aunque aquí no debería hacer falta si se usan como componentes)
    lucide.createIcons();
  </script>
</body>

</html>