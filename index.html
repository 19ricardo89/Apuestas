<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BetManager</title>

  <!-- ICONS: Favicon SVG (Data URI) y Apple Touch Icon -->
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%230f172a%22/><path d=%22M20 70 L40 50 L60 60 L80 30%22 stroke=%22%2310b981%22 stroke-width=%228%22 fill=%22none%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22/><circle cx=%2280%22 cy=%2230%22 r=%226%22 fill=%22%2310b981%22/></svg>">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2622/2622312.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="BetManager">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Prop-types (Dependencies) -->
  <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>

  <!-- Recharts (CDNjs) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js"></script>

  <!-- Lucide -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #0f172a;
    }

    ::-webkit-scrollbar-thumb {
      background: #334155;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #475569;
    }

    .animate-fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body class="bg-slate-950 text-slate-100 h-screen overflow-hidden">


  <div id="root" class="h-full"></div>

  <script type="text/babel" data-presets="react">
    // --- IMPORTS GLOBALIZADOS ---
    const { useState, useEffect, useMemo, useRef } = React;

    // --- GEMINI AI CONFIG (V4) ---
    const GEMINI_API_KEY = "AIzaSyCUVnkzykwI8XhQsqRweZlJ2vEG5zSwOJ4";
    // Mapeamos la solicitud del usuario "2.5" al modelo real disponible p√∫blicamente para evitar errores 404.
    // Si realmente existe 2.5 en el futuro, se cambiar√≠a aqu√≠. Actualmente 2.0-flash-exp es el SOTA experimental.
    const GEMINI_MODEL = "gemini-2.0-flash-exp";

    const analyzeImageWithGemini = async (base64Image, prompt) => {
      try {
        const payload = {
          contents: [{
            parts: [
              { text: prompt },
              { inline_data: { mime_type: "image/jpeg", data: base64Image } }
            ]
          }]
        };

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error(`Error API: ${response.statusText}`);

        const data = await response.json();
        const text = data.candidates[0].content.parts[0].text;
        // Limpiar markdown json si existe
        const cleanJson = text.replace(/```json|```/g, '').trim();
        return JSON.parse(cleanJson);
      } catch (error) {
        console.error("Gemini Error:", error);
        throw error;
      }
    };

    // --- ORACLE HELPER (TEXT ONLY) ---
    const analyzeTextWithGemini = async (prompt) => {
      try {
        const payload = { contents: [{ parts: [{ text: prompt }] }] };
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(`Error API: ${response.statusText}`);
        const data = await response.json();
        return data.candidates[0].content.parts[0].text;
      } catch (error) {
        console.error("Gemini Text Error:", error);
        throw error;
      }
    };
    // --- ADAPTADOR LUCIDE-REACT PARA CDN ---
    // Convierte las definiciones de iconos de la librer√≠a 'lucide' (vanilla) en componentes React
    const LucideIcon = ({ name, size = 24, color = "currentColor", className = "", ...props }) => {
      const iconDef = lucide.icons[name];
      if (!iconDef) { console.warn(`Icono ${name} no encontrado en lucide.icons`); return null; }

      return React.createElement('svg', {
        xmlns: "http://www.w3.org/2000/svg",
        width: size,
        height: size,
        viewBox: "0 0 24 24",
        fill: "none",
        stroke: color,
        strokeWidth: 2,
        strokeLinecap: "round",
        strokeLinejoin: "round",
        className: className,
        ...props
      }, iconDef.map(([tag, attrs], index) => React.createElement(tag, { ...attrs, key: index })));
    };

    // Crear componentes individuales para uso directo (ej: <Plus />)
    // Extraemos solo los que usamos para evitar procesar toda la librer√≠a si no es necesario, aunque aqu√≠ mapeamos din√°micamente
    // los que necesitamos
    const IconList = [
      'Plus', 'Trash2', 'Users', 'Save', 'History', 'PieChart', 'TrendingUp',
      'CheckCircle', 'XCircle', 'Clock', 'Activity', 'Target', 'Zap',
      'BarChart2', 'Menu', 'ChevronRight', 'AlertCircle', 'RefreshCw', 'Check', 'X', 'Calendar', 'Layers', 'Trophy', 'Flame',
      'Filter', 'Tag', 'Camera', 'Sparkles', 'Brain', 'Upload', 'Scan'
    ];

    const Icons = IconList.reduce((acc, name) => {
      acc[name] = (props) => <LucideIcon name={name} {...props} />;
      return acc;
    }, {});

    const {
      Plus, Trash2, Users, Save, History, PieChart, TrendingUp,
      CheckCircle, XCircle, Clock, Activity, Target, Zap,
      BarChart2, Menu, ChevronRight, AlertCircle, RefreshCw, Check, X, Calendar, Layers, Trophy, Flame,
      Filter, Tag, Camera, Sparkles, Brain, Upload, Scan
    } = Icons;
    const {
      LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, ResponsiveContainer,
      BarChart, Bar, Cell, PieChart: RechartsPieChart, Pie, Legend,
      AreaChart, Area, ScatterChart, Scatter, ZAxis
    } = Recharts;

    // --- COMPONENTES UI AUXILIARES ---
    const StatCard = ({ title, value, subtext, icon: Icon, colorClass }) => (
      <div className={`bg-slate-800 p-4 rounded-xl border border-slate-700 relative overflow-hidden group hover:border-slate-500 transition-all duration-300`}>
        <div className={`absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity ${colorClass}`}>
          <Icon size={40} />
        </div>
        <div className="text-slate-400 text-xs uppercase tracking-wider mb-1 font-semibold">{title}</div>
        <div className={`text-2xl md:text-3xl font-bold text-white`}>
          {value}
        </div>
        <div className="text-xs text-slate-500 mt-2 flex items-center gap-1">
          {subtext}
        </div>
      </div>
    );

    // --- APP PRINCIPAL ---

    function PortfolioManager() {
      const [activeSection, setActiveSection] = useState('dashboard');
      const [sidebarOpen, setSidebarOpen] = useState(false);

      // CONFIGURACI√ìN DE TIPSTERS
      const [tipsters] = useState([
        { name: 'Zona Tipster (Alta)', defaultStake: 50 },
        { name: 'Club Vip (Media)', defaultStake: 10 },
        { name: 'Club Remates (Media)', defaultStake: 10 },
        { name: 'Elitebets', defaultStake: 5 },
        { name: 'Stakazo', defaultStake: 5 },
        { name: 'Copete', defaultStake: 5 },
        { name: 'Torete', defaultStake: 5 },
        { name: 'Zona Tenis', defaultStake: 5 },
        { name: 'Mezcla-Tips', defaultStake: 5 },
        { name: 'Combis (Apuesta D)', defaultStake: 5 }
      ]);

      // HISTORIAL DE APUESTAS (BASE DE DATOS COMPLETA - CORREGIDA V29)
      const fullHistory = [
        // --- D√çA 3 (17 Dic) ---
        {
          id: 20, date: '2025-12-17', tipster: 'Combis (Apuesta D)', stake: 5.00, odds: 10.28, result: 'pending', description: 'Celta class + Villarreal class + Madrid gana + Brentford +7.5r + Fulham +9.5r + PSG', profit: 0, subPicks: []
        },
        {
          id: 19, date: '2025-12-17', tipster: 'Mezcla-Tips', stake: 5.00, odds: 1.44, result: 'pending', description: 'Alexander Blockx (Apuesta Compartida)', profit: 0,
          subPicks: [
            { id: 's4', tipster: 'Torete', status: 'pending', detail: 'Alexander Blockx (Shared)' },
            { id: 's5', tipster: 'Elitebets', status: 'pending', detail: 'Alexander Blockx (Shared)' }
          ]
        },
        {
          id: 18, date: '2025-12-17', tipster: 'Copete', stake: 5.00, odds: 1.47, result: 'pending', description: 'Herlev Eagels', profit: 0, subPicks: []
        },
        {
          id: 17, date: '2025-12-17', tipster: 'Stakazo', stake: 5.00, odds: 1.96, result: 'win', description: 'Jose David Segovia + Kabeer Kapasi', profit: 4.82, subPicks: []
        },

        // --- D√çA 2 (16 Dic) ---
        {
          id: 15, date: '2025-12-16', tipster: 'Club Remates (Media)', stake: 10.00, odds: 2.00, result: 'loss', description: 'Joel Colwill (1+ Remates) + Chelsea Gana', profit: -10.00, subPicks: []
        },
        {
          id: 14, date: '2025-12-16', tipster: 'Copete', stake: 5.00, odds: 1.90, result: 'loss', description: 'Bol√≠var Gana y +2.5 Goles', profit: -5.00, subPicks: []
        },
        {
          id: 13, date: '2025-12-16', tipster: 'Club Vip (Media)', stake: 10.00, odds: 2.37, result: 'win', description: 'Tyrique George (+1.5 Remates a Puerta)', profit: 13.70, subPicks: []
        },
        {
          id: 12, date: '2025-12-16', tipster: 'Combis (Apuesta D)', stake: 5.00, odds: 11.56, result: 'loss', description: 'Copa: Real Sociedad + Mallorca X2 (Fallo) + Elche Clasif + Bar√ßa a 0 + Valencia Clasif', profit: -5.00, subPicks: []
        },
        {
          id: 11, date: '2025-12-16', tipster: 'Zona Tipster (Alta)', stake: 50.00, odds: 1.61, result: 'win', description: 'Cardiff (+7.5 Remates) vs Chelsea', profit: 30.50, subPicks: []
        },
        {
          id: 10, date: '2025-12-16', tipster: 'Elitebets', stake: 5.00, odds: 1.50, result: 'loss', description: 'Peter Goldsteinier Gana', profit: -5.00, subPicks: []
        },
        {
          id: 9, date: '2025-12-16', tipster: 'Torete', stake: 5.00, odds: 1.66, result: 'loss', description: 'Sporting de Gij√≥n Gana o Empata', profit: -5.00, subPicks: []
        },
        {
          id: 8, date: '2025-12-16', tipster: 'Copete', stake: 5.00, odds: 1.57, result: 'win', description: 'Hapoel Tel Aviv Gana + Bar√ßa Gana y +1.5 Goles', profit: 2.85, subPicks: []
        },

        // --- D√çA 1 (15 Dic) ---
        {
          id: 1, date: '2025-12-15', tipster: 'Mezcla-Tips', stake: 5.00, odds: 2.42, result: 'win', description: 'Combinada Mixta D√≠a 1', profit: 7.10,
          subPicks: [
            { id: 's1', tipster: 'Torete', status: 'win', detail: 'CD Castell√≥n' },
            { id: 's2', tipster: 'Elitebets', status: 'win', detail: 'Jakub Prachar' },
            { id: 's3', tipster: 'Copete', status: 'win', detail: 'Rayo Vallecano' }
          ]
        },
        {
          id: 2, date: '2025-12-15', tipster: 'Stakazo', stake: 5.00, odds: 1.92, result: 'win', description: 'Combinada Doble Tenis (Axel + John)', profit: 4.60, subPicks: []
        },
        {
          id: 3, date: '2025-12-15', tipster: 'Combis (Apuesta D)', stake: 5.00, odds: 13.01, result: 'win', description: 'Remates: Serrano, Athletic, Mbapp√©...', profit: 60.05, subPicks: []
        },
        {
          id: 4, date: '2025-12-15', tipster: 'Club Remates (Media)', stake: 10.00, odds: 1.50, result: 'loss', description: 'Bournemouth (Menos 13.5) + Senne', profit: -10.00, subPicks: []
        },
        {
          id: 5, date: '2025-12-15', tipster: 'Zona Tipster (Alta)', stake: 50.00, odds: 1.70, result: 'win', description: 'Rayo Vallecano (+11.5 Remates) + No Roja', profit: 35.00, subPicks: []
        },
        {
          id: 6, date: '2025-12-15', tipster: 'Club Vip (Media)', stake: 10.00, odds: 1.53, result: 'win', description: 'Samuel Aghehowa (1.5+ Tiros Puerta)', profit: 5.30, subPicks: []
        },
        {
          id: 7, date: '2025-12-15', tipster: 'Combis (Apuesta D)', stake: 5.00, odds: 5.57, result: 'loss', description: 'Triple Combinada Remates', profit: -5.00, subPicks: []
        }
      ];

      // ESTADO APUESTAS PORTFOLIO
      const [bets, setBets] = useState([]);

      // ESTADO RETOS
      const initialChallenges = [
        {
          id: 1,
          title: 'Escalera iPhone (Copete)',
          subtitle: 'Objetivo 1.000‚Ç¨ (Navidad)',
          initialBank: 30,
          currentBank: 54.00,
          targetBank: 1000,
          color: 'emerald',
          history: [
            {
              id: 1001,
              date: '2025-12-16',
              stake: 30.00,
              odds: 1.80,
              description: 'Paso 1: Hapoel Tel Aviv Gana + Paris Under 96.5pts',
              result: 'win',
              profit: 24.00
            }
          ]
        },
        {
          id: 2,
          title: 'Reto Torete ITF',
          subtitle: 'Objetivo 10.000‚Ç¨',
          initialBank: 100,
          currentBank: 570,
          targetBank: 10000,
          color: 'blue',
          history: [
            {
              id: 1002,
              date: '2025-12-16',
              stake: 470.00,
              odds: 1.45,
              description: 'Paso Fuerte: Becroft + K.Smith + Kuhar + Sach',
              result: 'loss',
              profit: -470.00
            },
            {
              id: 999,
              date: '2025-12-15',
              stake: 100,
              odds: 5.70,
              description: 'Ganancias Acumuladas Previas (Ajuste Inicial)',
              result: 'win',
              profit: 470
            }
          ]
        },
        {
          id: 3,
          title: 'Reto Torete NextGen',
          subtitle: 'Objetivo 11.000‚Ç¨',
          initialBank: 100,
          currentBank: 100,
          targetBank: 11000,
          color: 'purple',
          history: [
            {
              id: 1003,
              date: '2025-12-16',
              stake: 100.00,
              odds: 2.00,
              description: 'Dino Prizmic vs Nishesh (M√°s de 1.5 Tie Breaks)',
              result: 'pending',
              profit: 0
            }
          ]
        },
        {
          id: 4,
          title: 'Reto Elitebets NextGen',
          subtitle: 'Objetivo 1.000‚Ç¨',
          initialBank: 50,
          currentBank: 50,
          targetBank: 1000,
          color: 'orange',
          history: [
            {
              id: 1004,
              date: '2025-12-16',
              stake: 50.00,
              odds: 1.57,
              description: 'Dino Prizmic Gana',
              result: 'pending',
              profit: 0
            }
          ]
        }
      ];

      const [challenges, setChallenges] = useState([]);

      // ESTADO FORMULARIO RETO
      const [challengeForm, setChallengeForm] = useState({ id: null, stake: '', odds: '', desc: '' });

      // --- UTILIDAD: RECALCULAR SALDO RETOS ---
      const recalculateChallengeBank = (challenge) => {
        const historyProfit = challenge.history.reduce((acc, bet) => {
          if (bet.result === 'pending') return acc;
          return acc + bet.profit;
        }, 0);
        return parseFloat((challenge.initialBank + historyProfit).toFixed(2));
      };

      // --- CARGA Y PERSISTENCIA ---
      useEffect(() => {
        const savedBets = localStorage.getItem('betPortfolioV29_bets');
        if (savedBets) setBets(JSON.parse(savedBets));
        else setBets(fullHistory);

        // Al cargar, siempre recalculamos el saldo actual basado en el historial para corregir inconsistencias
        const savedChallenges = localStorage.getItem('betPortfolioV29_challenges');
        let challengesToLoad = savedChallenges ? JSON.parse(savedChallenges) : initialChallenges;

        // Forzamos la actualizaci√≥n de datos 'hardcoded' si estamos en desarrollo o para corregir
        // En este caso, si el usuario ya tiene datos, queremos respetar sus nuevos datos pero corregir el saldo
        // Si usamos initialChallenges (primera carga/cache borrada), recalculamos

        const correctedChallenges = challengesToLoad.map(c => ({
          ...c,
          currentBank: recalculateChallengeBank(c)
        }));

        setChallenges(correctedChallenges);
      }, []);

      useEffect(() => {
        if (bets.length > 0) localStorage.setItem('betPortfolioV29_bets', JSON.stringify(bets));
      }, [bets]);

      useEffect(() => {
        if (challenges.length > 0) localStorage.setItem('betPortfolioV29_challenges', JSON.stringify(challenges));
      }, [challenges]);

      // --- L√ìGICA PORTFOLIO ---
      const updateSimpleStatus = (id, newStatus) => {
        const updatedBets = bets.map(b => {
          if (b.id === id) {
            let newProfit = 0;
            if (newStatus === 'win') newProfit = (b.stake * b.odds) - b.stake;
            if (newStatus === 'loss') newProfit = -b.stake;
            if (newStatus === 'void') newProfit = 0;
            return { ...b, result: newStatus, profit: parseFloat(newProfit.toFixed(2)) };
          }
          return b;
        });
        setBets(updatedBets);
      };

      const updateSubPickStatus = (betId, subPickIndex, newStatus) => {
        const updatedBets = bets.map(b => {
          if (b.id === betId) {
            const newSubPicks = [...b.subPicks];
            newSubPicks[subPickIndex].status = newStatus;
            const anyLoss = newSubPicks.some(sp => sp.status === 'loss');
            const anyPending = newSubPicks.some(sp => sp.status === 'pending');
            let parentResult = 'pending';
            let parentProfit = 0;
            if (anyLoss) { parentResult = 'loss'; parentProfit = -b.stake; }
            else if (!anyPending) { parentResult = 'win'; parentProfit = (b.stake * b.odds) - b.stake; }
            return { ...b, subPicks: newSubPicks, result: parentResult, profit: parseFloat(parentProfit.toFixed(2)) };
          }
          return b;
        });
        setBets(updatedBets);
      };

      const deleteBet = (id) => {
        if (window.confirm("¬øBorrar registro permanentemente?")) setBets(bets.filter(b => b.id !== id));
      };

      // --- L√ìGICA RETOS ---
      const addChallengeBet = (e, challengeId) => {
        e.preventDefault();
        const updatedChallenges = challenges.map(c => {
          if (c.id === challengeId) {
            const stake = parseFloat(challengeForm.stake);
            const odds = parseFloat(challengeForm.odds);
            const newBet = {
              id: Date.now(),
              date: new Date().toISOString().split('T')[0],
              stake: stake,
              odds: odds,
              description: challengeForm.desc,
              result: 'pending',
              profit: 0
            };
            const updatedHistory = [newBet, ...c.history];
            // No cambia el banco al a√±adir pending, pero mantenemos consistencia
            return { ...c, history: updatedHistory };
          }
          return c;
        });
        setChallenges(updatedChallenges);
        setChallengeForm({ id: null, stake: '', odds: '', desc: '' });
      };

      const resolveChallengeBet = (challengeId, betId, result) => {
        const updatedChallenges = challenges.map(c => {
          if (c.id === challengeId) {
            const updatedHistory = c.history.map(b => {
              if (b.id === betId) {
                let profit = 0;
                if (result === 'win') profit = (b.stake * b.odds) - b.stake;
                if (result === 'loss') profit = -b.stake;
                if (result === 'void') profit = 0;
                return { ...b, result, profit };
              }
              return b;
            });
            // Recalculamos banco total
            const newChallenge = { ...c, history: updatedHistory };
            newChallenge.currentBank = recalculateChallengeBank(newChallenge);
            return newChallenge;
          }
          return c;
        });
        setChallenges(updatedChallenges);
      };

      const deleteChallengeBet = (challengeId, betId) => {
        if (!window.confirm("¬øEliminar apuesta del reto? Se recalcular√° el saldo.")) return;
        const updatedChallenges = challenges.map(c => {
          if (c.id === challengeId) {
            const updatedHistory = c.history.filter(b => b.id !== betId);
            const newChallenge = { ...c, history: updatedHistory };
            newChallenge.currentBank = recalculateChallengeBank(newChallenge);
            return newChallenge;
          }
          return c;
        });
        setChallenges(updatedChallenges);
      };

      // --- TAGS SYSTEM (V3) ---
      const [filterTag, setFilterTag] = useState('ALL');
      const availableTags = useMemo(() => {
        const tags = new Set();
        bets.forEach(b => {
          if (b.tags && Array.isArray(b.tags)) b.tags.forEach(t => tags.add(t));
        });
        return ['ALL', ...Array.from(tags).sort()];
      }, [bets]);

      // Global Filtered Bets
      const filteredBets = useMemo(() => {
        if (filterTag === 'ALL') return bets;
        return bets.filter(b => b.tags && b.tags.includes(filterTag));
      }, [bets, filterTag]);

      // --- STATS GLOBALES ---
      const financialStats = useMemo(() => {
        const valid = filteredBets.filter(b => b.result !== 'void' && b.result !== 'pending');
        const staked = valid.reduce((acc, b) => acc + b.stake, 0);
        const profit = valid.reduce((acc, b) => acc + b.profit, 0);
        const yield_val = staked > 0 ? ((profit / staked) * 100).toFixed(2) : 0;

        // Gr√°fico acumulativo
        let runningProfit = 0;
        const chartData = [...filteredBets]
          .filter(b => b.result !== 'pending')
          .sort((a, b) => new Date(a.date) - new Date(b.date) || a.id - b.id)
          .map(b => {
            runningProfit += b.profit;
            return { name: b.date.slice(5), fullDate: b.date, profit: runningProfit };
          });

        return { staked, profit, yield_val, chartData };
      }, [filteredBets]);

      const strategyStats = useMemo(() => {
        const stats = {};
        tipsters.forEach(t => { stats[t.name] = { name: t.name, staked: 0, profit: 0, bets: 0, wins: 0, losses: 0, voids: 0, oddsSum: 0, validOddsCount: 0 }; });
        filteredBets.forEach(b => {
          if (b.result !== 'pending') {
            if (!stats[b.tipster]) stats[b.tipster] = { name: b.tipster, staked: 0, profit: 0, bets: 0, wins: 0, losses: 0, voids: 0, oddsSum: 0, validOddsCount: 0 };
            if (b.result === 'win') stats[b.tipster].wins += 1;
            if (b.result === 'loss') stats[b.tipster].losses += 1;
            if (b.result === 'void') stats[b.tipster].voids += 1;
            if (b.result !== 'void') {
              stats[b.tipster].staked += b.stake;
              stats[b.tipster].profit += b.profit;
              stats[b.tipster].bets += 1;
              stats[b.tipster].oddsSum += b.odds;
              stats[b.tipster].validOddsCount += 1;
            }
          }
        });
        return Object.values(stats).filter(s => (s.bets > 0 || s.voids > 0)).map(s => ({
          ...s,
          yield: s.staked > 0 ? ((s.profit / s.staked) * 100).toFixed(2) : 0,
          winRate: s.bets > 0 ? ((s.wins / s.bets) * 100).toFixed(0) : 0,
          avgOdds: s.validOddsCount > 0 ? (s.oddsSum / s.validOddsCount).toFixed(2) : '0.00'
        })).sort((a, b) => b.profit - a.profit);
      }, [filteredBets, tipsters]);

      const scoutStats = useMemo(() => {
        const stats = {};
        tipsters.forEach(t => {
          if (t.name === 'Mezcla-Tips' || t.name.includes('Combis')) return;
          const cleanName = t.name.split(' (')[0];
          stats[cleanName] = { name: cleanName, picks: 0, wins: 0, losses: 0, voids: 0, pending: 0 };
        });
        filteredBets.forEach(bet => {
          if (bet.tipster !== 'Mezcla-Tips' && bet.tipster !== 'Combis (Apuesta D)') {
            const cleanName = bet.tipster.split(' (')[0];
            if (stats[cleanName]) {
              if (bet.result === 'win') { stats[cleanName].wins++; stats[cleanName].picks++; }
              if (bet.result === 'loss') { stats[cleanName].losses++; stats[cleanName].picks++; }
              if (bet.result === 'void') { stats[cleanName].voids++; }
              if (bet.result === 'pending') { stats[cleanName].pending++; }
            }
          }
          if (bet.subPicks && bet.subPicks.length > 0) {
            bet.subPicks.forEach(sub => {
              const cleanName = sub.tipster.split(' (')[0];
              if (stats[cleanName]) {
                if (sub.status === 'win') { stats[cleanName].wins++; stats[cleanName].picks++; }
                if (sub.status === 'loss') { stats[cleanName].losses++; stats[cleanName].picks++; }
                if (sub.status === 'void') { stats[cleanName].voids++; }
                if (sub.status === 'pending') { stats[cleanName].pending++; }
              }
            });
          }
        });
        return Object.values(stats).filter(s => s.picks > 0 || s.pending > 0).map(s => ({ ...s, winRate: s.picks > 0 ? ((s.wins / s.picks) * 100).toFixed(1) : 0 })).sort((a, b) => parseFloat(b.winRate) - parseFloat(a.winRate));
      }, [filteredBets, tipsters]);

      // --- CUOTAS STATS ---
      const oddsStats = useMemo(() => {
        const ranges = [
          { label: 'Seguras (1.0-1.5)', min: 1.0, max: 1.5, bets: 0, profit: 0, staked: 0 },
          { label: 'Valor (1.51-2.0)', min: 1.51, max: 2.0, bets: 0, profit: 0, staked: 0 },
          { label: 'Riesgo (2.01-5.0)', min: 2.01, max: 5.0, bets: 0, profit: 0, staked: 0 },
          { label: 'Loter√≠a (5.0+)', min: 5.01, max: 999, bets: 0, profit: 0, staked: 0 },
        ];
        filteredBets.forEach(b => {
          if (b.result !== 'pending' && b.result !== 'void') {
            const range = ranges.find(r => b.odds >= r.min && b.odds <= r.max);
            if (range) { range.bets++; range.profit += b.profit; range.staked += b.stake; }
          }
        });
        return ranges.filter(r => r.bets > 0).map(r => ({ ...r, yield: r.staked > 0 ? ((r.profit / r.staked) * 100).toFixed(2) : 0 }));
      }, [filteredBets]);

      // --- DEEP ANALYTICS ENGINE (SIA-Pro) ---

      // 1. Drawdown Chart Data
      const drawdownStats = useMemo(() => {
        let currentBank = 1000; // Asumimos bank inicial fijo para visualizacion relativa
        let peak = 1000;
        const data = [];

        // Ordenar apuestas cronologicamente para simular la evolucion
        const sorted = [...filteredBets].filter(b => b.result !== 'pending' && b.result !== 'void').sort((a, b) => a.id - b.id);

        sorted.forEach(bet => {
          currentBank += bet.profit;
          if (currentBank > peak) peak = currentBank;
          const dd = ((currentBank - peak) / peak) * 100;
          data.push({
            date: bet.date,
            drawdown: dd.toFixed(2),
            bank: currentBank.toFixed(2)
          });
        });
        return data;
      }, [filteredBets]);

      // 2. Streaks (Rachas)
      const streakStats = useMemo(() => {
        let maxWin = 0, maxLoss = 0, current = 0;
        const sorted = [...filteredBets].filter(b => b.result !== 'pending' && b.result !== 'void').sort((a, b) => a.id - b.id);

        sorted.forEach(b => {
          if (b.result === 'win') {
            if (current < 0) current = 0;
            current++;
            if (current > maxWin) maxWin = current;
          } else if (b.result === 'loss') {
            if (current > 0) current = 0;
            current--;
            if (Math.abs(current) > maxLoss) maxLoss = Math.abs(current);
          }
        });
        return { maxWin, maxLoss, current: current > 0 ? `+${current}` : current };
      }, [filteredBets]);

      // 3. Sniper Chart (Scatter: Odds vs Profit)
      const sniperData = useMemo(() => {
        return filteredBets.filter(b => b.result !== 'pending' && b.result !== 'void').map(b => ({
          x: b.odds, // Eje X: Cuota
          y: b.profit, // Eje Y: Beneficio
          z: 1, // Tama√±o burbuja (opcional, set to 1 for standard scatter)
          name: b.tipster,
          desc: b.description
        }));
      }, [filteredBets]);

      // 4. Heatmap Data (Calendar)
      const heatmapData = useMemo(() => {
        const map = {};
        filteredBets.filter(b => b.result !== 'pending' && b.result !== 'void').forEach(b => {
          if (!map[b.date]) map[b.date] = 0;
          map[b.date] += b.profit;
        });
        // Rellenar ultimos 30 dias para grid
        const days = [];
        for (let i = 29; i >= 0; i--) {
          const d = new Date();
          d.setDate(d.getDate() - i);
          const dateStr = d.toISOString().split('T')[0];
          days.push({
            date: dateStr,
            value: map[dateStr] || 0,
            hasActivity: !!map[dateStr]
          });
        }
        return days;
      }, [filteredBets]);


      // --- FORM STATE ---
      const [formTipster, setFormTipster] = useState(tipsters[0].name);
      const [formStake, setFormStake] = useState(tipsters[0].defaultStake);
      // formOdds ahora ser√° calculada o manual, mantenemos el state para el input final
      const [formOdds, setFormOdds] = useState(1.50);
      const [formDesc, setFormDesc] = useState('');
      const [formTags, setFormTags] = useState(''); // NEW V3

      // AI State (V4)
      const [isAnalyzing, setIsAnalyzing] = useState(false);
      const fileInputRef = useRef(null);

      const handleImageUpload = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        setIsAnalyzing(true);
        const reader = new FileReader();
        reader.onloadend = async () => {
          const base64 = reader.result.split(',')[1];
          const prompt = `Analiza esta imagen de una apuesta deportiva. Extrae los siguientes datos en formato JSON estricto:
- stake: cantidad apostada (n√∫mero).
- totalOdds: cuota total (n√∫mero).
- description: resumen de la apuesta (texto breve, incluye equipos y mercado).
- lines: array de objetos { description: nombre del evento/mercado, odds: cuota individual }.
- isParlay: booleano, true si detectas multiples lineas o es combinada.
Si no encuentras alg√∫n dato, usa null. Devuelve SOLO el JSON sin markdown.`;

          try {
            const data = await analyzeImageWithGemini(base64, prompt);
            if (data) {
              if (data.stake) setFormStake(data.stake);
              if (data.totalOdds) setFormOdds(data.totalOdds);
              if (data.description) setFormDesc(data.description);

              if (data.isParlay && data.lines && data.lines.length > 0) {
                setIsMultiLine(true);
                setBetLines(data.lines.map(l => ({ odds: l.odds || 1.0, description: l.description || '' })));
                if (formTipster !== 'Mezcla-Tips') {
                  // Opcional: Sugerir cambio a Mezcla-Tips si detectamos multiples lineas? 
                  // Dejamos que el usuario decida, pero rellenamos lines.
                }
              } else {
                // setIsMultiLine(false); // No forzamos false para no borrar trabajo manual si el usuario sube foto despues
              }
              // alert("Datos extra√≠dos por Gemini IA correctamente.");
            }
          } catch (err) {
            alert("Error analizando imagen: " + err.message);
          } finally {
            setIsAnalyzing(false);
            if (fileInputRef.current) fileInputRef.current.value = '';
          }
        };
        reader.readAsDataURL(file);
      };

      const handleOracle = async (descOverride = null, oddsOverride = null) => {
        const d = descOverride || formDesc;
        const o = oddsOverride || formOdds;

        if (!d) { alert("No hay descripci√≥n para analizar."); return; }

        setIsAnalyzing(true);
        try {
          const prompt = `Act√∫a como experto en apuestas deportivas. Analiza esta apuesta: "${d}" a cuota @${o}. Estima la probabilidad real (%) y calcula si tiene EV+ (Valor Esperado). Responde en formato corto: "Probabilidad: X% | EV: Positivo/Negativo | Consejo: [Frase corta]".`;
          const text = await analyzeTextWithGemini(prompt);
          alert("üîÆ ORACULO GEMINI DICE:\n\n" + text);
        } catch (err) {
          alert("Error Or√°culo: " + err.message);
        } finally {
          setIsAnalyzing(false);
        }
      };

      // Multi-linea state
      const [isMultiLine, setIsMultiLine] = useState(false);
      const [betLines, setBetLines] = useState([]); // { odds: 1.0, description: '' }

      // Simulator State (V5 Refined)
      const [simBank, setSimBank] = useState(1000);
      const [simWinRate, setSimWinRate] = useState(50);
      const [simAvgOdds, setSimAvgOdds] = useState(2.00);
      const [simNumBets, setSimNumBets] = useState(500);
      const [simResults, setSimResults] = useState(null);

      // V5 New States
      const [simMode, setSimMode] = useState('GLOBAL'); // GLOBAL | TIPSTER | MONTHLY_GOAL
      const [simSelectedTipster, setSimSelectedTipster] = useState('');
      const [excludeFunbets, setExcludeFunbets] = useState(true); // Default ON

      // Goal Seeker State
      const [goalProfit, setGoalProfit] = useState(1000);
      const [goalMonth, setGoalMonth] = useState('Pr√≥ximo Mes');
      const [goalResults, setGoalResults] = useState(null); // { betsNeeded, reqWinRate }

      const loadRealStats = () => {
        let sourceBets = [];
        if (simMode === 'GLOBAL') {
          sourceBets = filteredBets.filter(b => b.result !== 'pending' && b.result !== 'void');
        } else if (simMode === 'TIPSTER' && simSelectedTipster) {
          sourceBets = filteredBets.filter(b => b.result !== 'pending' && b.result !== 'void' && b.tipster === simSelectedTipster);
        }

        if (sourceBets.length === 0) { alert("No hay suficientes datos para calcular estad√≠sticas."); return; }

        const wins = sourceBets.filter(b => b.result === 'win').length;
        const wr = (wins / sourceBets.length) * 100;
        const avgOdds = sourceBets.reduce((a, b) => a + b.odds, 0) / sourceBets.length;

        setSimWinRate(wr.toFixed(1));
        setSimAvgOdds(avgOdds.toFixed(2));
        alert(`Datos cargados (${simMode}): WinRate ${wr.toFixed(1)}% | Cuota Media @${avgOdds.toFixed(2)}`);
      };

      const calculateGoal = () => {
        const wr = parseFloat(simWinRate) / 100;
        const odds = parseFloat(simAvgOdds);
        const stake = 10;

        const profitPerBet = (stake * (odds - 1) * wr) - (stake * (1 - wr));

        if (profitPerBet <= 0) {
          setGoalResults({ error: "Matem√°ticamente imposible con EV actual (Neutro o Negativo)." });
        } else {
          const betsNeeded = parseFloat(goalProfit) / profitPerBet;
          setGoalResults({
            betsNeeded: Math.ceil(betsNeeded),
            avgStakeUsed: stake,
            profitPerBet: profitPerBet
          });
        }
      };

      const runSimulation = () => {
        const paths = [];
        const iterations = 5; // 5 caminos visuales
        let bestFinal = -Infinity;
        let worstFinal = Infinity;
        let totalFinal = 0;

        for (let i = 0; i < iterations; i++) {
          let current = parseFloat(simBank);
          const path = [{ x: 0, y: current }];

          for (let b = 1; b <= simNumBets; b++) {
            const won = Math.random() * 100 < simWinRate;
            // Stake plano simple: 1% del bank INICIAL (conservador) o dinamico? Usaremos 1% fijo por simplicidad visual
            const stake = parseFloat(simBank) * 0.01;

            if (won) {
              current += stake * (simAvgOdds - 1);
            } else {
              current -= stake;
            }
            if (b % 10 === 0) path.push({ x: b, y: current }); // Sampleo para no saturar grafica
          }
          paths.push({ name: `Sim ${i + 1}`, data: path });
          if (current > bestFinal) bestFinal = current;
          if (current < worstFinal) worstFinal = current;
          totalFinal += current;
        }

        setSimResults({
          best: bestFinal,
          worst: worstFinal,
          avg: totalFinal / iterations,
          paths: paths
        });
      };

      // Manual profit
      const [manualProfit, setManualProfit] = useState('');

      // Sub-picks para Mezcla-Tips (Legacy/Special logic)
      const [subPicks, setSubPicks] = useState([]);
      const [subTipster, setSubTipster] = useState('');
      const [subDetail, setSubDetail] = useState('');

      // Efecto para calcular cuota total si hay lineas
      useEffect(() => {
        if (isMultiLine && betLines.length > 0) {
          const totalOdds = betLines.reduce((acc, line) => acc * (parseFloat(line.odds) || 1), 1);
          setFormOdds(totalOdds.toFixed(2));
        }
      }, [betLines, isMultiLine]);

      const handleAddBet = (e) => {
        e.preventDefault();
        if (formTipster === 'Mezcla-Tips' && subPicks.length === 0) { alert("¬°A√±ade al menos una l√≠nea!"); return; }

        let calculatedProfit = 0; // Se calcular√° al resolver, pero si hay manual profit lo guardamos en description o similar?
        // En v29 el profit se calcula al cerrar. Pero si el usuario QUIERE fijar la ganancia potencial visualmente
        // podriamos guardarlo. Sin embargo, el sistema actual calcula (stake*odds)-stake al ganar.
        // Si el usuario mete 'manualProfit', podriamos ajustar la cuota para que cuadre?
        // O mejor: simplemente guardamos la apuesta. La "ganancia posible" es informativa. 
        // Si el usuario quiere "Ganancia Manual" para el resultado final, eso es al resolver. 
        // Si se refiere a "Ganancia Posible" que pide el usuario ("a√±adir ganancia posible si me la se"), es informativo.

        // INTERPRETACI√ìN: El usuario dice "a√±adir ganancia posible".
        // Vamos a guardar esto quiz√°s en la descripci√≥n o solo mostrarlo.
        // Pero lo m√°s √∫til es ajustar la CUOTA si el usuario mete la ganancia.
        // Odds = (Profit + Stake) / Stake.

        const finalDesc = isMultiLine ? (formDesc + ' | ' + betLines.map(l => l.description).join(' + ')) : formDesc;
        const tagsArray = formTags.split(',').map(t => t.trim().toUpperCase()).filter(t => t); // V3 Tags

        const newBet = {
          id: Date.now(),
          date: new Date().toISOString().split('T')[0],
          tipster: formTipster,
          stake: parseFloat(formStake),
          odds: parseFloat(formOdds),
          result: 'pending',
          description: finalDesc,
          profit: 0, // Se actualiza al ganar/perder
          subPicks: formTipster === 'Mezcla-Tips' ? subPicks : [],
          tags: tagsArray // V3
        };
        setBets([newBet, ...bets]);

        // Reset
        setFormDesc('');
        setFormTags(''); // V3
        setSubPicks([]);
        setSubDetail('');
        setBetLines([]);
        setIsMultiLine(false);
        setManualProfit('');
        setActiveSection('dashboard');
      };

      const addLine = () => {
        setBetLines([...betLines, { odds: '', description: '' }]);
      };

      const updateLine = (index, field, value) => {
        const newLines = [...betLines];
        newLines[index][field] = value;
        setBetLines(newLines);
      };

      const removeLine = (index) => {
        setBetLines(betLines.filter((_, i) => i !== index));
      };

      const calculateOddsFromProfit = (profit) => {
        const st = parseFloat(formStake) || 0;
        if (st > 0) {
          const p = parseFloat(profit) || 0;
          return ((p + st) / st).toFixed(2);
        }
        return 0;
      };

      const addSubPickToForm = () => {
        if (!subTipster || !subDetail) return;
        setSubPicks([...subPicks, { id: Date.now() + Math.random(), tipster: subTipster, detail: subDetail, status: 'pending' }]);
        setSubDetail('');
      };

      // --- BACKUP SYSTEM (V3) ---
      const exportData = () => {
        const data = {
          version: 'v29.1',
          timestamp: new Date().toISOString(),
          bets: bets,
          challenges: challenges
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `betmanager_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      };

      const importData = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const imported = JSON.parse(event.target.result);
            if (imported.bets && Array.isArray(imported.bets)) {
              setBets(imported.bets);
              if (imported.challenges) setChallenges(imported.challenges);
              alert('¬°Datos restaurados con √©xito! (' + imported.bets.length + ' apuestas)');
            } else {
              alert('Error: Formato de archivo inv√°lido.');
            }
          } catch (err) {
            alert('Error al leer el archivo.');
          }
        };
        reader.readAsText(file);
      };

      const factoryReset = () => {
        if (confirm("¬øEST√ÅS SEGURO? Se borrar√°n TODOS los datos y se volver√° al estado inicial. Esta acci√≥n no se puede deshacer.")) {
          localStorage.clear();
          window.location.reload();
        }
      };

      const COLORS = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#ec4899', '#6366f1'];
      const pendingBetsList = bets.filter(b => b.result === 'pending');

      const NavItem = ({ id, icon: Icon, label }) => (
        <button
          onClick={() => { setActiveSection(id); setSidebarOpen(false); }}
          className={`w-full flex items-center gap-3 px-4 py-4 rounded-lg transition-all mb-2 ${activeSection === id
            ? 'bg-emerald-600 text-white shadow-lg'
            : 'text-slate-400 hover:bg-slate-800'
            }`}
        >
          <Icon size={24} />
          <span className="font-medium text-lg">{label}</span>
          {activeSection === id && <ChevronRight size={20} className="ml-auto opacity-50" />}
        </button>
      );

      // Auto-update odds if manual profit changes
      useEffect(() => {
        if (manualProfit) {
          const newOdds = calculateOddsFromProfit(manualProfit);
          if (newOdds > 0 && newOdds !== Infinity) setFormOdds(newOdds);
        }
      }, [manualProfit, formStake]);

      return (
        <div className="h-screen bg-slate-950 text-slate-100 font-sans flex flex-col md:flex-row overflow-hidden">
          {/* ... (Header y Sidebar sin cambios) ... */}

          {/* HEADER MOBILE */}
          <div className="md:hidden bg-slate-900 border-b border-slate-800 p-4 flex justify-between items-center z-50 sticky top-0 shadow-lg">
            <div className="font-bold text-xl text-emerald-400 tracking-tight">BET<span className="text-white">MANAGER</span></div>
            <button onClick={() => setSidebarOpen(!sidebarOpen)} className="p-2 text-white"><Menu size={28} /></button>
          </div>

          {/* SIDEBAR */}
          <div className={`fixed inset-0 bg-slate-950/95 z-40 transform transition-transform duration-300 md:relative md:translate-x-0 md:w-72 md:bg-slate-900 md:border-r md:border-slate-800 flex flex-col ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
            <div className="hidden md:flex p-6 border-b border-slate-800 items-center justify-between">
              <h1 className="font-bold text-2xl text-emerald-400 tracking-tight">BET<span className="text-white">MANAGER</span></h1>
            </div>

            <div className="flex-1 p-6 overflow-y-auto">
              <div className="text-xs font-bold text-slate-500 mb-6 uppercase tracking-wider">Navegaci√≥n</div>
              <NavItem id="dashboard" icon={Activity} label="Dashboard" />
              <NavItem id="add" icon={Plus} label="A√±adir Apuesta" />
              <NavItem id="challenges" icon={Trophy} label="Retos" />
              <NavItem id="stats" icon={BarChart2} label="Estad√≠sticas" />
              <NavItem id="simulador" icon={TrendingUp} label="Sim. Ganancias" />
              <NavItem id="history" icon={History} label="Historial" />
            </div>
            <div className="p-6 border-t border-slate-800">
              <div className="text-xs font-bold text-slate-500 mb-4 uppercase tracking-wider">Gesti√≥n de Datos (V3)</div>
              <div className="flex flex-col gap-2">
                <button onClick={exportData} className="flex items-center gap-2 text-xs bg-slate-800/50 hover:bg-emerald-600/20 hover:text-emerald-400 text-slate-400 p-2 rounded transition-colors border border-transparent hover:border-emerald-500/30">
                  <Save size={14} /> <span>Exportar Backup (JSON)</span>
                </button>
                <label className="flex items-center gap-2 text-xs bg-slate-800/50 hover:bg-blue-600/20 hover:text-blue-400 text-slate-400 p-2 rounded transition-colors border border-transparent hover:border-blue-500/30 cursor-pointer">
                  <RefreshCw size={14} /> <span>Importar Backup</span>
                  <input type="file" onChange={importData} accept=".json" className="hidden" />
                </label>
                <button onClick={factoryReset} className="flex items-center gap-2 text-xs bg-slate-800/50 hover:bg-red-600/20 hover:text-red-400 text-slate-400 p-2 rounded transition-colors border border-transparent hover:border-red-500/30">
                  <Trash2 size={14} /> <span>Factory Reset</span>
                </button>
              </div>
              <div className="mt-4 text-center text-[10px] text-slate-600">v29.1 PRO - Local Storage</div>
            </div>
          </div>

          {/* MAIN CONTENT */}
          <div className="flex-1 overflow-y-auto bg-slate-950 p-4 md:p-8 pb-20">

            {/* 1. DASHBOARD */}
            {activeSection === 'dashboard' && (
              <div className="space-y-6 animate-fade-in">
                {/* TAG FILTER UI (V3) */}
                {availableTags.length > 1 && (
                  <div className="flex justify-end mb-2">
                    <div className="flex items-center gap-2 bg-slate-900 p-2 rounded-lg border border-slate-800">
                      <Filter size={14} className="text-slate-400" />
                      <select value={filterTag} onChange={e => setFilterTag(e.target.value)} className="bg-slate-900 text-xs text-white focus:outline-none uppercase font-bold cursor-pointer">
                        {availableTags.map(tag => <option key={tag} value={tag}>{tag === 'ALL' ? 'Todas las Etiquetas' : tag}</option>)}
                      </select>
                    </div>
                  </div>
                )}

                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                  <StatCard title="Beneficio Neto" value={`${financialStats.profit >= 0 ? '+' : ''}${financialStats.profit.toFixed(2)}‚Ç¨`} icon={PieChart} colorClass="text-emerald-500" />
                  <StatCard title="Yield / ROI" value={`${financialStats.yield_val}%`} icon={TrendingUp} colorClass="text-blue-500" />
                  <StatCard title="Win Rate Scout" value={`${scoutStats.length > 0 ? (scoutStats.reduce((acc, s) => acc + parseFloat(s.winRate), 0) / scoutStats.length).toFixed(1) : 0}%`} subtext="Efectividad Media" icon={Target} colorClass="text-purple-500" />
                  <StatCard title="Riesgo Activo" value={`${pendingBetsList.reduce((a, b) => a + b.stake, 0).toFixed(2)}‚Ç¨`} subtext="En juego" icon={Clock} colorClass="text-yellow-500" />
                </div>

                {pendingBetsList.length > 0 && (
                  <div className="bg-slate-900 rounded-xl border-l-4 border-yellow-500 p-4 shadow-xl">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-bold text-lg flex items-center gap-2 text-white"><AlertCircle className="text-yellow-500" /> Apuestas Activas ({pendingBetsList.length})</h3>
                    </div>
                    <div className="space-y-4">
                      {pendingBetsList.map(bet => (
                        <div key={bet.id} className="bg-slate-950 p-4 rounded-xl border border-slate-800 shadow-sm">
                          <div className="mb-2">
                            <div className="flex items-center gap-2 mb-1 flex-wrap">
                              <span className="font-bold text-emerald-400">{bet.tipster}</span>
                              <span className="text-xs bg-slate-800 px-2 py-0.5 rounded text-slate-400 border border-slate-700">@{bet.odds.toFixed(2)}</span>
                            </div>
                            <p className="text-sm text-slate-300">{bet.description}</p>
                          </div>
                          <div className="flex gap-2 w-full mt-3">
                            <button onClick={() => handleOracle(bet.description, bet.odds)} className="w-10 py-2 bg-purple-600/20 text-purple-400 border border-purple-600/50 rounded hover:bg-purple-600 hover:text-white font-bold text-sm flex justify-center items-center" title="Analizar con IA"><Sparkles size={16} /></button>
                            <button onClick={() => updateSimpleStatus(bet.id, 'win')} className="flex-1 py-2 bg-emerald-600/20 text-emerald-400 border border-emerald-600/50 rounded hover:bg-emerald-600 hover:text-white font-bold text-sm">Ganada</button>
                            <button onClick={() => updateSimpleStatus(bet.id, 'void')} className="w-10 py-2 bg-slate-700/50 text-slate-400 border border-slate-600/50 rounded hover:bg-slate-600 hover:text-slate-200 font-bold text-sm" title="Anulada">A</button>
                            <button onClick={() => updateSimpleStatus(bet.id, 'loss')} className="flex-1 py-2 bg-red-600/20 text-red-400 border border-red-600/50 rounded hover:bg-red-600 hover:text-white font-bold text-sm">Perdida</button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                  <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-xl col-span-1 lg:col-span-2">
                    <h3 className="font-bold text-sm mb-4 flex items-center gap-2 text-slate-400 uppercase tracking-wider"><Activity size={16} /> Curva de Ganancias</h3>
                    <div className="h-[250px] w-full">
                      <ResponsiveContainer width="100%" height="100%">
                        <LineChart data={financialStats.chartData}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                          <XAxis dataKey="name" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} />
                          <YAxis stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} tickFormatter={(val) => `${val}‚Ç¨`} />
                          <RechartsTooltip contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px', color: '#fff' }} formatter={(value) => [`${value.toFixed(2)}‚Ç¨`, 'Beneficio']} />
                          <Line type="monotone" dataKey="profit" stroke="#10b981" strokeWidth={3} dot={false} activeDot={{ r: 6, fill: '#10b981' }} />
                        </LineChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                  <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-xl">
                    <h3 className="font-bold text-sm mb-4 flex items-center gap-2 text-slate-400 uppercase tracking-wider"><PieChart size={16} /> Distribuci√≥n del Riesgo (Stake)</h3>
                    <div className="h-[250px] w-full flex justify-center items-center">
                      <ResponsiveContainer width="100%" height="100%">
                        <RechartsPieChart>
                          <Pie data={strategyStats} dataKey="staked" nameKey="name" cx="50%" cy="50%" outerRadius={80} fill="#8884d8" label={({ percent }) => `${(percent * 100).toFixed(0)}%`}>
                            {strategyStats.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />)}
                          </Pie>
                          <Legend layout="horizontal" verticalAlign="bottom" align="center" wrapperStyle={{ fontSize: '10px' }} />
                        </RechartsPieChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                  <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-xl">
                    <h3 className="font-bold text-sm mb-4 flex items-center gap-2 text-slate-400 uppercase tracking-wider"><BarChart2 size={16} /> Rentabilidad Neta (‚Ç¨)</h3>
                    <div className="h-[250px] w-full">
                      <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={strategyStats}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                          <XAxis dataKey="name" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} interval={0} angle={-15} textAnchor="end" height={60} />
                          <YAxis stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} />
                          <Bar dataKey="profit" radius={[4, 4, 0, 0]}>
                            {strategyStats.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.profit >= 0 ? '#10b981' : '#ef4444'} />)}
                          </Bar>
                        </BarChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* 2. CHALLENGES */}
            {activeSection === 'challenges' && (
              <div className="space-y-6 animate-fade-in">
                <header>
                  <h2 className="text-2xl font-bold text-white mb-2 flex items-center gap-2"><Trophy className="text-yellow-500" /> Retos Activos</h2>
                  <p className="text-sm text-slate-400">Seguimiento independiente de retos de capitalizaci√≥n compuesta.</p>
                </header>

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {challenges.map(challenge => {
                    const percent = Math.min(100, (challenge.currentBank / challenge.targetBank) * 100).toFixed(1);
                    const isAdding = challengeForm.id === challenge.id;

                    let headerColor = "from-slate-900 to-slate-800";
                    let barColor = "bg-emerald-500";
                    if (challenge.color === 'purple') { headerColor = "from-slate-900 to-purple-900/30"; barColor = "bg-purple-500"; }
                    if (challenge.color === 'blue') { headerColor = "from-slate-900 to-blue-900/30"; barColor = "bg-blue-500"; }
                    if (challenge.color === 'orange') { headerColor = "from-slate-900 to-orange-900/30"; barColor = "bg-orange-500"; }

                    return (
                      <div key={challenge.id} className="bg-slate-900 rounded-xl border border-slate-800 shadow-xl overflow-hidden">
                        <div className={`p-6 border-b border-slate-800 bg-gradient-to-r ${headerColor}`}>
                          <div className="flex justify-between items-start mb-4">
                            <div>
                              <h3 className="text-xl font-bold text-white flex items-center gap-2">
                                {challenge.title}
                              </h3>
                              <div className="text-slate-400 text-sm mt-1">{challenge.subtitle}</div>
                            </div>
                            <div className="text-right">
                              <div className={`text-3xl font-bold font-mono ${challenge.currentBank >= challenge.initialBank ? 'text-emerald-400' : 'text-red-400'}`}>{challenge.currentBank.toFixed(2)}‚Ç¨</div>
                              <div className="text-xs text-slate-500">Saldo Actual</div>
                            </div>
                          </div>
                          <div className="relative h-4 bg-slate-950 rounded-full overflow-hidden border border-slate-800">
                            <div className={`absolute top-0 left-0 h-full ${barColor} transition-all duration-1000`} style={{ width: `${percent}%` }}></div>
                          </div>
                          <div className="flex justify-between mt-2 text-xs font-bold text-slate-500">
                            <span>Inicio: {challenge.initialBank}‚Ç¨</span>
                            <span>{percent}% Completado</span>
                          </div>
                        </div>

                        {isAdding ? (
                          <div className="p-4 bg-slate-950 border-b border-slate-800 animate-fade-in">
                            <h4 className="text-sm font-bold text-emerald-400 mb-3 uppercase">Registrar paso del reto</h4>
                            <form onSubmit={(e) => addChallengeBet(e, challenge.id)} className="space-y-3">
                              <div className="grid grid-cols-2 gap-3">
                                <input type="number" placeholder="Stake" step="0.01" value={challengeForm.stake} onChange={e => setChallengeForm({ ...challengeForm, stake: e.target.value })} className="bg-slate-900 border border-slate-700 rounded p-2 text-white text-sm" required />
                                <input type="number" placeholder="Cuota" step="0.01" value={challengeForm.odds} onChange={e => setChallengeForm({ ...challengeForm, odds: e.target.value })} className="bg-slate-900 border border-slate-700 rounded p-2 text-white text-sm" required />
                              </div>
                              <input type="text" placeholder="Descripci√≥n (ej: Paso 1 - Madrid)" value={challengeForm.desc} onChange={e => setChallengeForm({ ...challengeForm, desc: e.target.value })} className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-sm" required />
                              <div className="flex gap-2">
                                <button type="submit" className="flex-1 bg-emerald-600 text-white py-2 rounded font-bold text-sm hover:bg-emerald-500">Guardar Apuesta</button>
                                <button type="button" onClick={() => setChallengeForm({ id: null, stake: '', odds: '', desc: '' })} className="px-4 bg-slate-800 text-slate-400 py-2 rounded font-bold text-sm hover:bg-slate-700">Cancelar</button>
                              </div>
                            </form>
                          </div>
                        ) : (
                          <div className="p-4 bg-slate-900 border-b border-slate-800 flex justify-end">
                            <button onClick={() => setChallengeForm({ id: challenge.id, stake: '', odds: '', desc: '' })} className="flex items-center gap-2 text-emerald-400 text-sm font-bold hover:text-emerald-300 bg-emerald-900/20 px-3 py-2 rounded border border-emerald-900/50"><Plus size={16} /> A√±adir Apuesta al Reto</button>
                          </div>
                        )}

                        <div className="max-h-[300px] overflow-y-auto">
                          <table className="w-full text-left text-sm">
                            <thead className="bg-slate-950 text-slate-500 text-xs uppercase sticky top-0">
                              <tr><th className="p-3">Detalle</th><th className="p-3 text-center">Stake/Cuota</th><th className="p-3 text-right">Resultado</th><th className="p-3 text-center">Acci√≥n</th></tr>
                            </thead>
                            <tbody className="divide-y divide-slate-800">
                              {challenge.history.length === 0 ? (
                                <tr><td colSpan="4" className="p-6 text-center text-slate-500 text-xs italic">A√∫n no hay movimientos en este reto.</td></tr>
                              ) : (
                                challenge.history.map(bet => (
                                  <tr key={bet.id} className="hover:bg-slate-800/50">
                                    <td className="p-3"><div className="font-bold text-white text-xs">{bet.description}</div><div className="text-[10px] text-slate-500">{bet.date}</div></td>
                                    <td className="p-3 text-center text-xs text-slate-300"><div>{bet.stake}‚Ç¨</div><div className="text-slate-500">@{bet.odds}</div></td>
                                    <td className="p-3 text-right">
                                      {bet.result === 'pending' ? (
                                        <div className="flex justify-end gap-1">
                                          <button onClick={() => resolveChallengeBet(challenge.id, bet.id, 'win')} className="p-1 bg-emerald-600/20 text-emerald-400 rounded"><Check size={14} /></button>
                                          <button onClick={() => resolveChallengeBet(challenge.id, bet.id, 'loss')} className="p-1 bg-red-600/20 text-red-400 rounded"><X size={14} /></button>
                                        </div>
                                      ) : (
                                        <span className={`font-bold text-xs ${bet.result === 'win' ? 'text-emerald-400' : 'text-red-400'}`}>{bet.result === 'win' ? `+${bet.profit.toFixed(2)}‚Ç¨` : `-${bet.stake}‚Ç¨`}</span>
                                      )}
                                    </td>
                                    <td className="p-3 text-center"><button onClick={() => deleteChallengeBet(challenge.id, bet.id)} className="text-slate-600 hover:text-red-400"><Trash2 size={14} /></button></td>
                                  </tr>
                                ))
                              )}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* 3. STATS (CON CUOTA MEDIA Y W/L/V) */}
            {activeSection === 'stats' && (
              <div className="space-y-8 animate-fade-in">
                <section>
                  <header className="mb-4">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2"><Layers className="text-blue-500" /> Rendimiento Financiero Global</h2>
                    <p className="text-sm text-slate-400">Resultados reales por estrategia. Desglose W-L-V (Win-Loss-Void).</p>
                  </header>
                  <div className="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden shadow-lg">
                    <div className="overflow-x-auto">
                      <table className="w-full text-left text-sm min-w-[700px]">
                        <thead className="bg-slate-950 text-slate-400 uppercase text-xs font-bold tracking-wider">
                          <tr>
                            <th className="p-4">Estrategia</th>
                            <th className="p-4 text-center">Bets (W-L-V)</th>
                            <th className="p-4 text-center">Cuota Media</th>
                            <th className="p-4 text-right">Inversi√≥n</th>
                            <th className="p-4 text-right">Beneficio</th>
                            <th className="p-4 text-center">Yield</th>
                            <th className="p-4 text-center">Win %</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-800">
                          {strategyStats.map((s) => (
                            <tr key={s.name} className="hover:bg-slate-800/50">
                              <td className="p-4 font-bold text-white">{s.name}</td>
                              <td className="p-4 text-center text-slate-300">
                                <span className="text-emerald-400 font-bold">{s.wins}</span>-<span className="text-red-400 font-bold">{s.losses}</span>-<span className="text-slate-500 font-bold">{s.voids}</span>
                              </td>
                              <td className="p-4 text-center text-slate-300 font-mono">@{s.avgOdds}</td>
                              <td className="p-4 text-right text-slate-300">{s.staked.toFixed(2)}‚Ç¨</td>
                              <td className={`p-4 text-right font-bold font-mono ${s.profit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                {s.profit >= 0 ? '+' : ''}{s.profit.toFixed(2)}‚Ç¨
                              </td>
                              <td className={`p-4 text-center font-bold ${parseFloat(s.yield) > 0 ? 'text-blue-400' : 'text-slate-500'}`}>{s.yield}%</td>
                              <td className="p-4 text-center text-slate-400">
                                <div className="flex items-center justify-center gap-2">
                                  <div className="w-12 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                    <div className={`h-full rounded-full ${parseFloat(s.winRate) > 50 ? 'bg-emerald-500' : 'bg-yellow-500'}`} style={{ width: `${s.winRate}%` }}></div>
                                  </div>
                                  <span>{s.winRate}%</span>
                                </div>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </section>
                <section>
                  <header className="mb-4">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2"><Target className="text-purple-500" /> Rendimiento por Rango de Cuota</h2>
                  </header>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden shadow-lg">
                      <table className="w-full text-left text-sm">
                        <thead className="bg-slate-950 text-slate-400 uppercase text-xs font-bold">
                          <tr><th className="p-3">Rango</th><th className="p-3 text-center">Bets</th><th className="p-3 text-right">Profit</th><th className="p-3 text-center">Yield</th></tr>
                        </thead>
                        <tbody className="divide-y divide-slate-800">
                          {oddsStats.map((r, i) => (
                            <tr key={i} className="hover:bg-slate-800/50">
                              <td className="p-3 font-bold text-white">{r.label}</td>
                              <td className="p-3 text-center text-slate-400">{r.bets}</td>
                              <td className={`p-3 text-right font-bold ${r.profit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{r.profit.toFixed(2)}‚Ç¨</td>
                              <td className={`p-3 text-center font-bold ${parseFloat(r.yield) > 0 ? 'text-blue-400' : 'text-slate-500'}`}>{r.yield}%</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                    <div className="bg-slate-900 rounded-xl border border-slate-800 p-4 shadow-lg">
                      <ResponsiveContainer width="100%" height={200}>
                        <BarChart data={oddsStats}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} /><XAxis dataKey="label" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} interval={0} /><YAxis stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} /><Bar dataKey="profit" radius={[4, 4, 0, 0]}>{oddsStats.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.profit >= 0 ? '#8b5cf6' : '#ef4444'} />)}</Bar>
                        </BarChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                </section>
                <section>
                  <header className="mb-4">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2"><Zap className="text-yellow-500" /> Scout Predictivo Individual</h2>
                  </header>
                  <div className="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden shadow-lg">
                    <div className="overflow-x-auto">
                      <table className="w-full text-left text-sm min-w-[600px]">
                        <thead className="bg-slate-950 text-slate-400 uppercase text-xs font-bold tracking-wider">
                          <tr><th className="p-4">Tipster</th><th className="p-4 text-center">Picks Totales</th><th className="p-4 text-center">W - L - V</th><th className="p-4 text-center">Efectividad %</th></tr>
                        </thead>
                        <tbody className="divide-y divide-slate-800">
                          {scoutStats.map((s) => (
                            <tr key={s.name} className="hover:bg-slate-800/50">
                              <td className="p-4 font-bold text-white">{s.name}</td>
                              <td className="p-4 text-center text-slate-300">{s.picks}</td>
                              <td className="p-4 text-center text-slate-300"><span className="text-emerald-400 font-bold">{s.wins}</span> - <span className="text-red-400 font-bold">{s.losses}</span> - {s.voids}</td>
                              <td className="p-4 text-center"><div className="flex items-center justify-center gap-2"><div className="w-16 h-2 bg-slate-700 rounded-full overflow-hidden"><div className={`h-full rounded-full ${parseFloat(s.winRate) > 60 ? 'bg-emerald-500' : 'bg-yellow-500'}`} style={{ width: `${s.winRate}%` }}></div></div><span className="font-mono font-bold">{s.winRate}%</span></div></td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </section>

                {/* --- DEEP ANALYTICS MODULES (SIA-Pro) --- */}
                <div className="pt-8 border-t border-slate-800">
                  <h2 className="text-2xl font-bold text-white mb-6 flex items-center gap-2"><Activity className="text-pink-500" /> Deep Analytics (SIA-Pro)</h2>

                  {/* 1. BANKROLL HEALTH: DRAWDOWN & STREAKS */}
                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    {/* CHART */}
                    <div className="lg:col-span-2 bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-lg">
                      <h3 className="font-bold text-sm mb-4 text-slate-400 uppercase tracking-wider flex justify-between">
                        <span><TrendingUp size={16} className="inline mr-2" /> Drawdown (Profundidad Submarina)</span>
                        <span className="text-xs text-slate-500">Ca√≠da desde M√°ximo Hist√≥rico</span>
                      </h3>
                      <div className="h-[250px] w-full">
                        <ResponsiveContainer width="100%" height="100%">
                          <AreaChart data={drawdownStats}>
                            <defs>
                              <linearGradient id="colorDd" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="5%" stopColor="#ef4444" stopOpacity={0.3} />
                                <stop offset="95%" stopColor="#ef4444" stopOpacity={0} />
                              </linearGradient>
                            </defs>
                            <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                            <XAxis dataKey="date" stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} tickFormatter={(val) => val.slice(5)} />
                            <YAxis stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} unit="%" />
                            <RechartsTooltip contentStyle={{ backgroundColor: '#0f172a', borderColor: '#334155', color: '#f8fafc' }} formatter={(val) => [val + '%', 'Drawdown']} labelFormatter={(l) => l} />
                            <Area type="monotone" dataKey="drawdown" stroke="#ef4444" fillOpacity={1} fill="url(#colorDd)" strokeWidth={2} />
                          </AreaChart>
                        </ResponsiveContainer>
                      </div>
                    </div>

                    {/* STREAKS KPIs */}
                    <div className="space-y-4">
                      <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 border-l-4 border-l-emerald-500 shadow-lg">
                        <div className="text-slate-400 text-xs uppercase font-bold mb-1">Mejor Racha Ganadora</div>
                        <div className="text-3xl font-bold text-white flex items-baseline gap-2">
                          {streakStats.maxWin} <span className="text-sm text-emerald-500 font-normal">Aciertos</span>
                        </div>
                      </div>
                      <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 border-l-4 border-l-red-500 shadow-lg">
                        <div className="text-slate-400 text-xs uppercase font-bold mb-1">Peor Racha Perdedora</div>
                        <div className="text-3xl font-bold text-white flex items-baseline gap-2">
                          {streakStats.maxLoss} <span className="text-sm text-red-500 font-normal">Fallos</span>
                        </div>
                      </div>
                      <div className="bg-slate-900 p-5 rounded-xl border border-slate-800 shadow-lg flex items-center justify-between">
                        <div>
                          <div className="text-slate-400 text-[10px] uppercase font-bold">Racha Actual</div>
                          <div className={`text-xl font-bold ${parseInt(streakStats.current) > 0 ? 'text-emerald-400' : (parseInt(streakStats.current) < 0 ? 'text-red-400' : 'text-slate-400')}`}>
                            {streakStats.current > 0 ? '+' : ''}{streakStats.current}
                          </div>
                        </div>
                        <Activity className="text-slate-600" size={24} />
                      </div>
                    </div>
                  </div>

                  {/* 2. SNIPER & HEATMAP */}
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {/* SNIPER CHART */}
                    <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-lg">
                      <h3 className="font-bold text-sm mb-4 text-slate-400 uppercase tracking-wider flex items-center gap-2"><Target size={16} /> Sniper: Yield vs Cuota</h3>
                      <div className="h-[300px] w-full">
                        <ResponsiveContainer width="100%" height="100%">
                          <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: 0 }}>
                            <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                            <XAxis type="number" dataKey="x" name="Cuota" stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} unit="x" domain={['auto', 'auto']} />
                            <YAxis type="number" dataKey="y" name="Profit" stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} unit="‚Ç¨" />
                            <ZAxis type="number" dataKey="z" range={[60, 60]} />
                            <RechartsTooltip cursor={{ strokeDasharray: '3 3' }} content={({ active, payload }) => {
                              if (active && payload && payload.length) {
                                const data = payload[0].payload;
                                return (
                                  <div className="bg-slate-950 border border-slate-700 p-2 rounded shadow-xl text-xs">
                                    <div className="font-bold text-emerald-400">{data.name}</div>
                                    <div className="text-white">Profit: {data.y}‚Ç¨</div>
                                    <div className="text-slate-400">Cuota: @{data.x}</div>
                                    <div className="text-slate-500 italic max-w-[150px] truncate">{data.desc}</div>
                                  </div>
                                );
                              }
                              return null;
                            }} />
                            <Scatter name="Bets" data={sniperData} fill="#8b5cf6" shape="circle" />
                          </ScatterChart>
                        </ResponsiveContainer>
                      </div>
                    </div>

                    {/* ACTIVITY HEATMAP */}
                    <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-lg flex flex-col">
                      <h3 className="font-bold text-sm mb-4 text-slate-400 uppercase tracking-wider flex items-center gap-2"><Calendar size={16} /> Actividad Reciente (30 d√≠as)</h3>
                      <div className="flex-1 flex items-center justify-center p-4">
                        <div className="grid grid-cols-7 gap-2">
                          {heatmapData.map((day, i) => (
                            <div key={i} title={`${day.date}: ${day.value.toFixed(2)}‚Ç¨`}
                              className={`w-8 h-8 rounded-md flex items-center justify-center text-[10px] font-bold transition-all cursor-help
                                            ${!day.hasActivity ? 'bg-slate-800 text-slate-600' :
                                  (day.value > 0 ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/50 hover:bg-emerald-500 hover:text-white' :
                                    'bg-red-500/20 text-red-400 border border-red-500/50 hover:bg-red-500 hover:text-white')
                                }`}>
                              {day.date.split('-')[2]}
                            </div>
                          ))}
                        </div>
                      </div>
                      <div className="mt-4 text-center text-[10px] text-slate-500 italic">
                        * Intensidad basada en Profit/Loss diario.
                      </div>
                    </div>
                  </div>

                  {/* KELLY CRITERION (BONUS) */}
                  <div className="mt-6 bg-gradient-to-r from-indigo-900/20 to-purple-900/20 p-4 rounded-xl border border-indigo-500/30 text-center">
                    <div className="text-xs font-bold text-indigo-400 uppercase mb-2">Consejo Money Management (Kelly Simplificado)</div>
                    <p className="text-sm text-slate-300 max-w-3xl mx-auto">
                      Para una cuota media de <span className="text-white font-bold">@{(strategyStats.length > 0 && strategyStats.reduce((a, b) => a + parseFloat(b.avgOdds), 0) / strategyStats.length) || '2.00'}</span>
                      {' '}y un WinRate del <span className="text-white font-bold">{(scoutStats.length > 0 && (scoutStats.reduce((a, s) => a + parseFloat(s.winRate), 0) / scoutStats.length).toFixed(0)) || '50'}%</span>,
                      tu stake √≥ptimo sugerido (Kelly/4) ser√≠a del <span className="text-emerald-400 font-bold">1.5% - 2.5%</span>.
                      ¬°Mant√©n la disciplina!
                    </p>
                  </div>
                </div>

              </div>
            )}

            {/* 4. ADD BET (Sin cambios) */}
            {activeSection === 'add' && (
              <div className="max-w-2xl mx-auto space-y-6 animate-fade-in-up">
                <h2 className="text-2xl font-bold text-white">Nuevo Registro</h2>
                <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 shadow-2xl">
                  <form onSubmit={handleAddBet} className="space-y-6">
                    {/* AI SCANNER BUTTON (V4) */}
                    <div className="flex gap-2 mb-4">
                      <button type="button" onClick={() => fileInputRef.current && fileInputRef.current.click()} className="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 py-3 rounded-lg font-bold text-white shadow-lg flex justify-center items-center gap-2 transition-all transform active:scale-95">
                        <Camera size={18} /> Escanear Boleto (Gemini IA)
                      </button>
                      <input type="file" ref={fileInputRef} onChange={handleImageUpload} accept="image/*" className="hidden" />
                    </div>

                    {isAnalyzing && (
                      <div className="fixed inset-0 bg-slate-950/90 z-[60] flex flex-col items-center justify-center animate-fade-in backdrop-blur-sm">
                        <Brain size={64} className="text-emerald-500 animate-bounce mb-4" />
                        <div className="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-500 mb-4 absolute"></div>
                        <div className="text-emerald-400 font-bold text-xl animate-pulse">Analizando con Gemini 2.5...</div>
                        <div className="text-slate-400 text-sm mt-2 font-mono">Extrayendo Datos Smart Vision</div>
                      </div>
                    )}

                    <div className="grid grid-cols-2 gap-4">
                      <div><label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Tipster</label><select value={formTipster} onChange={e => { setFormTipster(e.target.value); const t = tipsters.find(ti => ti.name === e.target.value); if (t) setFormStake(t.defaultStake) }} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-emerald-500">{tipsters.map(t => <option key={t.name} value={t.name}>{t.name}</option>)}</select></div>
                      <div><label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Stake Total (‚Ç¨)</label><input type="number" step="0.01" value={formStake} onChange={e => setFormStake(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-emerald-500" /></div>
                    </div>

                    {/* MULTI-LINE TOGGLE */}
                    {formTipster !== 'Mezcla-Tips' && (
                      <div className="flex items-center gap-3 bg-slate-950 p-3 rounded border border-slate-800">
                        <input type="checkbox" id="multiLine" checked={isMultiLine} onChange={e => setIsMultiLine(e.target.checked)} className="w-5 h-5 accent-emerald-500" />
                        <label htmlFor="multiLine" className="text-sm font-bold text-slate-300 select-none cursor-pointer">Activar Modo Multil√≠nea (Suma de cuotas autom√°tica)</label>
                      </div>
                    )}

                    {/* LOGICA LINEAS MULTIPLES */}
                    {isMultiLine && (
                      <div className="bg-slate-800/50 p-4 rounded-lg border border-slate-700 space-y-3">
                        <h4 className="text-xs font-bold text-emerald-400 uppercase flex items-center gap-2"><Layers size={14} /> L√≠neas de Apuesta</h4>
                        {betLines.map((line, idx) => (
                          <div key={idx} className="flex gap-2 items-center">
                            <input type="text" placeholder="Descripci√≥n l√≠nea..." className="flex-1 bg-slate-950 border border-slate-700 rounded p-2 text-xs text-white" value={line.description} onChange={e => updateLine(idx, 'description', e.target.value)} />
                            <input type="number" placeholder="Cuota" step="0.01" className="w-20 bg-slate-950 border border-slate-700 rounded p-2 text-xs text-white" value={line.odds} onChange={e => updateLine(idx, 'odds', e.target.value)} />
                            <button type="button" onClick={() => removeLine(idx)} className="text-red-400 hover:text-red-300"><X size={16} /></button>
                          </div>
                        ))}
                        <button type="button" onClick={addLine} className="text-xs font-bold text-emerald-400 hover:text-white flex items-center gap-1"><Plus size={14} /> A√±adir L√≠nea</button>
                      </div>
                    )}

                    {formTipster === 'Mezcla-Tips' && (<div className="bg-blue-900/10 border border-blue-900/50 p-4 rounded-lg space-y-3"><h4 className="text-sm font-bold text-blue-400 flex items-center gap-2"><Zap size={16} /> Configurar L√≠neas Scout</h4><div className="space-y-2"><select value={subTipster} onChange={e => setSubTipster(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white"><option value="">1. Elige Tipster...</option>{tipsters.filter(t => t.name !== 'Mezcla-Tips').map(t => <option key={t.name} value={t.name}>{t.name}</option>)}</select><div className="flex gap-2"><input type="text" value={subDetail} onChange={e => setSubDetail(e.target.value)} placeholder="2. Detalle (ej: Madrid gana)" className="flex-1 bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white" /><button type="button" onClick={addSubPickToForm} className="bg-blue-600 hover:bg-blue-500 px-4 rounded text-white font-bold"><Plus size={20} /></button></div></div>{subPicks.length > 0 && (<div className="mt-3 space-y-2">{subPicks.map((sub, idx) => (<div key={idx} className="flex justify-between items-center text-xs bg-slate-800 p-2 rounded border border-slate-700"><span className="text-blue-200 font-bold mr-2">{sub.tipster}:</span><span className="text-slate-400 truncate flex-1">{sub.detail}</span><button type="button" onClick={() => setSubPicks(subPicks.filter((_, i) => i !== idx))} className="text-red-400 p-1"><Trash2 size={14} /></button></div>))}</div>)}</div>)}

                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="text-xs font-bold text-slate-400 uppercase mb-2 block flex justify-between items-center">
                          <span>Cuota Final {isMultiLine && '(Auto)'}</span>
                          <button type="button" onClick={handleOracle} className="text-[10px] bg-purple-600/20 text-purple-400 border border-purple-500/30 px-2 py-0.5 rounded hover:bg-purple-600 hover:text-white transition-colors flex items-center gap-1 group">
                            <Sparkles size={10} className="group-hover:animate-spin" /> ORACULO IA
                          </button>
                        </label>
                        <input type="number" step="0.01" value={formOdds} onChange={e => setFormOdds(e.target.value)} className={`w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white text-lg font-mono focus:outline-none focus:border-emerald-500 ${isMultiLine ? 'text-emerald-400 font-bold' : ''}`} readOnly={isMultiLine && betLines.length > 0} />
                      </div>
                      <div>
                        <label className="text-xs font-bold text-slate-400 uppercase mb-2 block flex items-center gap-1">Ganancia Posible <span className="text-[10px] text-slate-500 lowercase">(opcional)</span></label>
                        <input type="number" step="0.01" placeholder="Auto" value={manualProfit} onChange={e => setManualProfit(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white text-lg font-mono focus:outline-none focus:border-emerald-500 placeholder-slate-600" />
                      </div>
                    </div>

                    <div><label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Descripci√≥n General</label><input type="text" value={formDesc} onChange={e => setFormDesc(e.target.value)} placeholder="Ej: Combi Fin de Semana" className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-emerald-500" /></div>

                    {/* TAGS INPUT (V3) */}
                    <div>
                      <label className="text-xs font-bold text-slate-400 uppercase mb-2 block flex items-center gap-2"><Tag size={14} /> Etiquetas (Opcional)</label>
                      <input type="text" value={formTags} onChange={e => setFormTags(e.target.value)} placeholder="Ej: FUTBOL, LIVE, ESTRATEGIA1 (Separadas por coma)" className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500 text-sm" />
                    </div>

                    <div className="p-3 bg-slate-800 rounded border border-slate-700 flex justify-between items-center text-sm">
                      <span className="text-slate-400">Beneficio Potencial:</span>
                      <span className="font-bold text-emerald-400 text-lg">
                        {manualProfit ? `+${parseFloat(manualProfit).toFixed(2)}‚Ç¨` : (formStake && formOdds ? `+${((formStake * formOdds) - formStake).toFixed(2)}‚Ç¨` : '0.00‚Ç¨')}
                      </span>
                    </div>

                    <button type="submit" className="w-full bg-emerald-600 hover:bg-emerald-500 py-4 rounded-lg font-bold text-white shadow-lg text-lg">Guardar Apuesta</button>
                  </form>
                </div>
              </div>
            )}

            {/* SIMULATOR V5 (Goal Seeker) */}
            {activeSection === 'simulador' && (
              <div className="space-y-6 animate-fade-in pb-10">
                <h2 className="text-2xl font-bold text-emerald-400 flex items-center gap-2"><TrendingUp /> Simulador de Ganancias (Goal Seeker)</h2>

                {/* 1. DATA SOURCE & VIABILITY */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {/* CONF DATA */}
                  <div className="bg-slate-900 p-5 rounded-xl border border-slate-800 shadow-xl space-y-4">
                    <h3 className="text-sm font-bold text-slate-400 uppercase border-b border-slate-800 pb-2 mb-2 flex items-center gap-2"><Zap size={14} className="text-yellow-500" /> Configuraci√≥n de Datos</h3>
                    <div className="flex gap-2 bg-slate-950 p-2 rounded-lg">
                      <button onClick={() => setSimMode('GLOBAL')} className={`flex-1 py-2 rounded text-xs font-bold transition-all ${simMode === 'GLOBAL' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-slate-800'}`}>GLOBAL</button>
                      <button onClick={() => setSimMode('TIPSTER')} className={`flex-1 py-2 rounded text-xs font-bold transition-all ${simMode === 'TIPSTER' ? 'bg-purple-600 text-white' : 'text-slate-400 hover:bg-slate-800'}`}>POR TIPSTER</button>
                    </div>

                    {simMode === 'TIPSTER' && (
                      <select value={simSelectedTipster} onChange={e => setSimSelectedTipster(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white text-sm">
                        <option value="">Selecciona Tipster...</option>
                        {tipsters.map(t => <option key={t.name} value={t.name}>{t.name}</option>)}
                      </select>
                    )}

                    {/* INPUTS EDITABLES & TOGGLE */}
                    <div className="flex items-center gap-2 mb-2">
                      <label className="flex items-center gap-2 cursor-pointer bg-slate-950 px-3 py-2 rounded border border-slate-700 hover:border-slate-500 transition-colors">
                        <input type="checkbox" checked={excludeFunbets} onChange={e => setExcludeFunbets(e.target.checked)} className="rounded text-emerald-500 focus:ring-emerald-500 bg-slate-800 border-slate-600" />
                        <span className="text-xs font-bold text-slate-300 select-none">Excluir Funbets / Combis</span>
                      </label>
                    </div>

                    <button onClick={loadRealStats} className="w-full py-2 border border-slate-700 hover:bg-slate-800 text-slate-300 rounded flex justify-center items-center gap-2 text-sm font-bold transition-colors">
                      <RefreshCw size={14} /> Cargar Estad√≠sticas Reales
                    </button>

                    <div className="grid grid-cols-2 gap-3 pt-2">
                      <div className="bg-slate-950 p-2 rounded border border-slate-800">
                        <div className="text-[10px] text-slate-500 uppercase mb-1">Win Rate Actual (%)</div>
                        <input type="number" value={simWinRate} onChange={e => setSimWinRate(e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded p-1 text-white font-bold text-center focus:border-emerald-500 outline-none" />
                      </div>
                      <div className="bg-slate-950 p-2 rounded border border-slate-800">
                        <div className="text-[10px] text-slate-500 uppercase mb-1">Cuota Media (@)</div>
                        <input type="number" step="0.01" value={simAvgOdds} onChange={e => setSimAvgOdds(e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded p-1 text-white font-bold text-center focus:border-emerald-500 outline-none" />
                      </div>
                    </div>
                  </div>

                  {/* VIABILITY PANEL */}
                  <div className="bg-slate-900 p-5 rounded-xl border border-slate-800 shadow-xl space-y-4 relative overflow-hidden">
                    <div className="absolute top-0 right-0 p-4 opacity-5"><Activity size={100} /></div>
                    <h3 className="text-sm font-bold text-slate-400 uppercase border-b border-slate-800 pb-2 mb-2 flex items-center gap-2"><Activity size={14} className="text-emerald-500" /> An√°lisis de Salud</h3>

                    <div className="flex justify-between items-center">
                      <span className="text-slate-300 text-sm">Punto de Equilibrio (Break Even):</span>
                      <span className="font-mono font-bold text-yellow-500 text-lg">{(100 / simAvgOdds).toFixed(1)}% WR</span>
                    </div>
                    <div className="w-full bg-slate-800 h-2 rounded-full overflow-hidden flex">
                      <div className="bg-red-500 h-full" style={{ width: `${(100 / simAvgOdds)}%` }}></div>
                      <div className="bg-emerald-500 h-full flex-1"></div>
                    </div>
                    <div className="text-[10px] text-slate-500 text-right">Zona Roja: P√©rdidas | Zona Verde: Ganancias</div>

                    <div className="mt-4 pt-4 border-t border-slate-800 flex justify-between items-center">
                      <span className="text-slate-300 text-sm">Proyecci√≥n Rentable (ROI 10%):</span>
                      {/* ROI = ((Yield + 1) * Turnover) - Turnover? No. Yield = (Profit/Stake)*100. 
                                Yield 10% -> Profit = 0.10 * Stake.
                                Profit = (Stake*(Odds-1)*WR) - (Stake*(1-WR)).
                                0.10 Stake = Stake [ (Odds-1)WR - (1-WR) ]
                                0.10 = (Odds-1)WR - 1 + WR
                                1.10 = WR(Odds-1+1) = WR(Odds)
                                WR = 1.10 / Odds
                            */}
                      <span className="font-mono font-bold text-emerald-400 text-lg">{((1.10 / simAvgOdds) * 100).toFixed(1)}% WR</span>
                    </div>
                  </div>
                </div>

                {/* 2. GOAL SEEKER MODULE */}
                <div className="bg-gradient-to-r from-indigo-900/40 to-purple-900/40 p-6 rounded-xl border border-indigo-500/30 shadow-2xl">
                  <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><Target className="text-indigo-400" /> Buscador de Objetivos (Goal Seeker)</h3>
                  <div className="flex flex-col md:flex-row gap-4 items-end">
                    <div className="flex-1 w-full">
                      <label className="text-xs font-bold text-indigo-300 uppercase mb-1 block">Objetivo de Ganancia (‚Ç¨)</label>
                      <input type="number" value={goalProfit} onChange={e => setGoalProfit(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white focus:border-indigo-500 font-bold text-lg" placeholder="ej: 1000" />
                    </div>
                    <div className="flex-1 w-full">
                      <label className="text-xs font-bold text-indigo-300 uppercase mb-1 block">Periodo Objetivo</label>
                      <select value={goalMonth} onChange={e => setGoalMonth(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white text-sm">
                        <option>Este Mes</option>
                        <option>Pr√≥ximo Mes</option>
                        <option>Trimestre</option>
                        <option>A√±o Completo</option>
                      </select>
                    </div>
                    <button onClick={calculateGoal} className="w-full md:w-auto bg-indigo-600 hover:bg-indigo-500 px-8 py-3 rounded font-bold text-white shadow-lg flex items-center justify-center gap-2 mb-[1px]">
                      <Sparkles size={18} /> Calcular Plan
                    </button>
                  </div>

                  {goalResults && !goalResults.error && (
                    <div className="mt-6 bg-slate-950/50 p-4 rounded-lg border border-indigo-500/50 flex flex-col md:flex-row gap-6 items-center animate-fade-in">
                      <div className="text-center md:text-left">
                        <div className="text-xs text-slate-400 uppercase mb-1">Volumen Necesario</div>
                        <div className="text-3xl font-bold text-white">{goalResults.betsNeeded} <span className="text-sm font-normal text-slate-500">apuestas</span></div>
                      </div>
                      <div className="h-10 w-[1px] bg-slate-700 hidden md:block"></div>
                      <div className="text-sm text-slate-300 flex-1">
                        Para ganar <span className="text-white font-bold">{goalProfit}‚Ç¨</span> en <span className="text-white font-bold">{goalMonth}</span> con tus m√©tricas actuales, necesitas realizar un volumen de {goalResults.betsNeeded} apuestas (aprox {(goalResults.betsNeeded / 30).toFixed(1)} al d√≠a).
                      </div>
                    </div>
                  )}
                  {goalResults && goalResults.error && (
                    <div className="mt-4 text-red-400 font-bold bg-red-900/20 p-3 rounded border border-red-500/30 text-sm text-center animate-pulse">{goalResults.error}</div>
                  )}
                </div>

                {/* 3. CLASSIC MONTE CARLO */}
                <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 shadow-xl space-y-6 opacity-75 hover:opacity-100 transition-opacity">
                  <h3 className="text-sm font-bold text-slate-500 uppercase flex items-center gap-2"><Layers size={14} /> Simulaci√≥n Monte Carlo Cl√°sica</h3>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Bank Inicial</label><input type="number" value={simBank} onChange={e => setSimBank(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white" /></div>
                    <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Win Rate (%)</label><input type="number" value={simWinRate} onChange={e => setSimWinRate(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white" /></div>
                    <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Cuota Media</label><input type="number" step="0.01" value={simAvgOdds} onChange={e => setSimAvgOdds(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white" /></div>
                    <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">N¬∫ Apuestas</label><input type="number" value={simNumBets} onChange={e => setSimNumBets(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white" /></div>
                  </div>
                  <button onClick={runSimulation} className="w-full bg-slate-700 hover:bg-slate-600 py-3 rounded font-bold text-slate-200 flex justify-center items-center gap-2 shadow-lg transition-all"><Zap size={18} /> Ejecutar Simulaci√≥n Visual</button>
                </div>

                {simResults && (
                  <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-xl space-y-4 animate-fade-in">
                    <div className="grid grid-cols-3 gap-4 text-center">
                      <div className="p-3 bg-slate-950 rounded border border-slate-800"><div className="text-xs text-slate-500">Peor Caso</div><div className="text-red-400 font-bold text-lg">{simResults.worst.toFixed(2)}‚Ç¨</div></div>
                      <div className="p-3 bg-slate-950 rounded border border-slate-800"><div className="text-xs text-slate-500">Promedio</div><div className="text-blue-400 font-bold text-lg">{simResults.avg.toFixed(2)}‚Ç¨</div></div>
                      <div className="p-3 bg-slate-950 rounded border border-slate-800"><div className="text-xs text-slate-500">Mejor Caso</div><div className="text-emerald-400 font-bold text-lg">{simResults.best.toFixed(2)}‚Ç¨</div></div>
                    </div>
                    <div className="h-[300px] w-full bg-slate-950 p-2 rounded border border-slate-800">
                      <ResponsiveContainer width="100%" height="100%">
                        <LineChart>
                          <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                          <XAxis dataKey="x" type="number" allowDuplicatedCategory={false} stroke="#94a3b8" fontSize={10} tickCount={10} />
                          <YAxis stroke="#94a3b8" domain={['auto', 'auto']} fontSize={10} tickFormatter={(val) => `${val.toFixed(0)}‚Ç¨`} />
                          <RechartsTooltip contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px', color: '#fff' }} formatter={(val) => [`${val.toFixed(2)}‚Ç¨`, 'Bank']} labelFormatter={(l) => `Apuesta #${l}`} />
                          {simResults.paths.map((s, i) => (
                            <Line key={i} data={s.data} type="monotone" dataKey="y" stroke={["#ef4444", "#ebb305", "#3b82f6", "#8b5cf6", "#10b981"][i]} strokeWidth={2} dot={false} name={s.name} activeDot={{ r: 4 }} />
                          ))}
                        </LineChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* 5. HISTORY */}
            {activeSection === 'history' && (
              <div className="space-y-6 animate-fade-in">
                <h2 className="text-2xl font-bold text-white">Historial</h2>
                <div className="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden shadow-xl">
                  <div className="overflow-x-auto">
                    <table className="w-full text-left text-sm min-w-[600px]">
                      <thead className="bg-slate-950 text-slate-400 uppercase text-xs font-bold">
                        <tr><th className="p-4">Fecha</th><th className="p-4">Tipster</th><th className="p-4 text-right">P&L</th><th className="p-4 text-center">Acci√≥n</th></tr>
                      </thead>
                      <tbody className="divide-y divide-slate-800">
                        {bets.sort((a, b) => b.id - a.id).map((bet) => (
                          <tr key={bet.id} className="hover:bg-slate-800/50">
                            <td className="p-4 text-slate-400 text-xs">{bet.date}</td>
                            <td className="p-4"><div className="font-bold text-white">{bet.tipster}</div><div className="text-xs text-slate-500 truncate max-w-[200px]">{bet.description}</div>{bet.subPicks && bet.subPicks.length > 0 && (<div className="mt-2 text-[10px] space-y-1">{bet.subPicks.map((s, i) => (<div key={i} className="flex items-center gap-2"><span className={`w-2 h-2 rounded-full ${s.status === 'win' ? 'bg-emerald-500' : s.status === 'loss' ? 'bg-red-500' : 'bg-slate-500'}`}></span><span className="text-slate-300">{s.tipster}</span></div>))}</div>)}</td>
                            <td className={`p-4 text-right font-bold font-mono ${bet.profit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{bet.result === 'pending' ? '...' : (bet.profit >= 0 ? '+' : '') + bet.profit.toFixed(2) + '‚Ç¨'}</td>
                            <td className="p-4 text-center"><button onClick={() => deleteBet(bet.id)} className="text-slate-600 hover:text-red-400 p-2"><Trash2 size={18} /></button></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            )}

          </div>
        </div >
      );
    }

    // --- RENDERIZADO ---
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<PortfolioManager />);

    // Inicializar iconos Lucide (por si acaso se usan fuera de React, aunque aqu√≠ no deber√≠a hacer falta si se usan como componentes)
    lucide.createIcons();
  </script>
</body>

</html>