<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BetManager</title>

  <!-- ICONS: Favicon SVG (Data URI) y Apple Touch Icon -->
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%230f172a%22/><path d=%22M20 70 L40 50 L60 60 L80 30%22 stroke=%22%2310b981%22 stroke-width=%228%22 fill=%22none%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22/><circle cx=%2280%22 cy=%2230%22 r=%226%22 fill=%22%2310b981%22/></svg>">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2622/2622312.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="BetManager">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Prop-types (Dependencies) -->
  <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>

  <!-- Recharts (CDNjs) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js"></script>

  <!-- Lucide -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #0f172a;
    }

    ::-webkit-scrollbar-thumb {
      background: #334155;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #475569;
    }

    .animate-fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body class="bg-slate-950 text-slate-100 h-screen overflow-hidden">


  <div id="root" class="h-full"></div>

  <script type="text/babel" data-presets="react">
    // --- IMPORTS GLOBALIZADOS ---
    const { useState, useEffect, useMemo, useRef } = React;

    // --- GEMINI AI CONFIG (V4) ---
    const GEMINI_API_KEY = "AIzaSyCUVnkzykwI8XhQsqRweZlJ2vEG5zSwOJ4";
    // Si realmente existe 2.5 en el futuro, se cambiarÃ­a aquÃ­. Usamos 1.5-flash por estabilidad.
    const GEMINI_MODEL = "gemini-1.5-flash";
    const analyzeImageWithGemini = async (base64Image, prompt) => {
      try {
        const payload = {
          contents: [{
            parts: [
              { text: prompt },
              { inline_data: { mime_type: "image/jpeg", data: base64Image } }
            ]
          }]
        };

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errData = await response.json().catch(() => ({}));
          throw new Error(`Error API ${response.status}: ${errData.error?.message || response.statusText}`);
        }

        const data = await response.json();
        const text = data.candidates[0].content.parts[0].text;
        // Limpiar markdown json si existe
        const cleanJson = text.replace(/```json|```/g, '').trim();
        return JSON.parse(cleanJson);
      } catch (error) {
        console.error("Gemini Error:", error);
        throw error;
      }
    };

    // --- ORACLE HELPER (TEXT ONLY) ---
    const analyzeTextWithGemini = async (prompt) => {
      try {
        const payload = { contents: [{ parts: [{ text: prompt }] }] };
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          const errData = await response.json().catch(() => ({}));
          throw new Error(`Error API ${response.status}: ${errData.error?.message || response.statusText}`);
        }
        const data = await response.json();
        return data.candidates[0].content.parts[0].text;
      } catch (error) {
        console.error("Gemini Text Error:", error);
        throw error;
      }
    };
    // --- ADAPTADOR LUCIDE-REACT PARA CDN ---
    // Convierte las definiciones de iconos de la librerÃ­a 'lucide' (vanilla) en componentes React
    const LucideIcon = ({ name, size = 24, color = "currentColor", className = "", ...props }) => {
      const iconDef = lucide.icons[name];
      if (!iconDef) { console.warn(`Icono ${name} no encontrado en lucide.icons`); return null; }

      return React.createElement('svg', {
        xmlns: "http://www.w3.org/2000/svg",
        width: size,
        height: size,
        viewBox: "0 0 24 24",
        fill: "none",
        stroke: color,
        strokeWidth: 2,
        strokeLinecap: "round",
        strokeLinejoin: "round",
        className: className,
        ...props
      }, iconDef.map(([tag, attrs], index) => React.createElement(tag, { ...attrs, key: index })));
    };

    // Crear componentes individuales para uso directo (ej: <Plus />)
    // Extraemos solo los que usamos para evitar procesar toda la librerÃ­a si no es necesario, aunque aquÃ­ mapeamos dinÃ¡micamente
    // los que necesitamos
    const IconList = [
      'Plus', 'Trash2', 'Users', 'Save', 'History', 'PieChart', 'TrendingUp',
      'CheckCircle', 'XCircle', 'Clock', 'Activity', 'Target', 'Zap',
      'BarChart2', 'Menu', 'ChevronRight', 'AlertCircle', 'RefreshCw', 'Check', 'X', 'Calendar', 'Layers', 'Trophy', 'Flame',
      'Filter', 'Tag', 'Camera', 'Sparkles', 'Brain', 'Upload', 'Scan', 'TrendingDown', 'UserPlus', 'Edit', 'Calculator', 'LayoutDashboard', 'Copy'
    ];

    const Icons = IconList.reduce((acc, name) => {
      acc[name] = (props) => <LucideIcon name={name} {...props} />;
      return acc;
    }, {});

    const {
      Plus, Trash2, Users, Save, History, PieChart, TrendingUp,
      CheckCircle, XCircle, Clock, Activity, Target, Zap,
      BarChart2, Menu, ChevronRight, AlertCircle, RefreshCw, Check, X, Calendar, Layers, Trophy, Flame,
      Filter, Tag, Camera, Sparkles, Brain, Upload, Scan, TrendingDown, UserPlus, Edit, Calculator, LayoutDashboard, Copy
    } = Icons;
    const {
      LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, ResponsiveContainer,
      BarChart, Bar, Cell, PieChart: RechartsPieChart, Pie, Legend,
      AreaChart, Area, ScatterChart, Scatter, ZAxis
    } = Recharts;

    // --- COMPONENTES UI AUXILIARES ---
    const StatCard = ({ title, value, subtext, icon: Icon, colorClass }) => (
      <div className={`bg-slate-800 p-4 rounded-xl border border-slate-700 relative overflow-hidden group hover:border-slate-500 transition-all duration-300`}>
        <div className={`absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity ${colorClass}`}>
          <Icon size={40} />
        </div>
        <div className="text-slate-400 text-xs uppercase tracking-wider mb-1 font-semibold">{title}</div>
        <div className={`text-2xl md:text-3xl font-bold text-white`}>
          {value}
        </div>
        <div className="text-xs text-slate-500 mt-2 flex items-center gap-1">
          {subtext}
        </div>
      </div>
    );

    // --- APP PRINCIPAL ---

    // CONSTANTS
    const DEFAULT_TIPSTERS = [
      { id: 't1', name: 'Zona Tipster (Alta)', defaultStake: 50 },
      { id: 't2', name: 'Club Vip (Media)', defaultStake: 10 },
      { id: 't3', name: 'Club Remates (Media)', defaultStake: 10 },
      { id: 't4', name: 'Elitebets', defaultStake: 5 },
      { id: 't5', name: 'Stakazo', defaultStake: 5 },
      { id: 't6', name: 'Copete', defaultStake: 5 },
      { id: 't7', name: 'Torete', defaultStake: 5 },
      { id: 't8', name: 'Zona Tenis', defaultStake: 5 },
      { id: 't9', name: 'Mezcla-Tips', defaultStake: 5 },
      { id: 't10', name: 'Combis (Apuesta D)', defaultStake: 5 }
    ];

    function PortfolioManager() {
      const [activeSection, setActiveSection] = useState('dashboard');
      const [sidebarOpen, setSidebarOpen] = useState(false);

      // V18: GLOBAL BANK MANAGEMENT (Moved to top to fix ReferenceError)
      const [bankTransactions, setBankTransactions] = useState([]);
      const [showBankManager, setShowBankManager] = useState(false);

      // CONFIGURACIÃ“N DE TIPSTERS (DINÃMICA V11 - Refactor V30)
      const [tipsters, setTipsters] = useState(() => {
        const saved = localStorage.getItem('betPortfolioV29_tipsters');
        try {
          let loaded = saved ? JSON.parse(saved) : DEFAULT_TIPSTERS;
          // FIX: Ensure all tipsters have IDs (Migration for legacy data)
          if (Array.isArray(loaded)) {
            loaded = loaded.map((t, i) => ({
              ...t,
              id: t.id || `legacy_${Date.now()}_${i}`
            }));
          }
          return loaded;
        } catch (e) {
          console.error("Error loading tipsters", e);
          return DEFAULT_TIPSTERS;
        }
      });

      const [showTipsterManager, setShowTipsterManager] = useState(false);

      // PERSISTENCIA TIPSTERS
      useEffect(() => {
        localStorage.setItem('betPortfolioV29_tipsters', JSON.stringify(tipsters));
      }, [tipsters]);

      // PERSISTENCIA BANK (V30)
      useEffect(() => {
        const savedBank = localStorage.getItem('betPortfolioV29_bank');
        if (savedBank) {
          const parsed = JSON.parse(savedBank);
          setBankTransactions(parsed.transactions || []);
          // currentGlobalBank is derived, no need to save directly if transactions are saved
        }
      }, []);

      useEffect(() => {
        localStorage.setItem('betPortfolioV29_bank', JSON.stringify({ transactions: bankTransactions }));
      }, [bankTransactions]);

      const handleAddTipster = (name, stake) => {
        if (tipsters.some(t => t.name.toLowerCase() === name.toLowerCase())) {
          alert("Â¡Este Tipster ya existe!");
          return;
        }
        setTipsters([...tipsters, { id: Date.now(), name, defaultStake: parseFloat(stake) || 10 }]);
      };

      const handleEditTipster = (id, newName, newStake) => {
        setTipsters(tipsters.map(t => t.id === id ? { ...t, name: newName, defaultStake: parseFloat(newStake) } : t));
      };

      const handleDeleteTipster = (id) => {
        if (confirm("Â¿Eliminar tipster? Sus apuestas histÃ³ricas se mantendrÃ¡n, pero no aparecerÃ¡ en el selector.")) {
          setTipsters(tipsters.filter(t => t.id !== id));
        }
      };

      // HISTORIAL DE APUESTAS (BASE DE DATOS COMPLETA - CORREGIDA V29)
      const fullHistory = [
        // --- DÃA 3 (17 Dic) ---
        {
          id: 20, date: '2025-12-17', tipster: 'Combis (Apuesta D)', stake: 5.00, odds: 10.28, result: 'pending', description: 'Celta class + Villarreal class + Madrid gana + Brentford +7.5r + Fulham +9.5r + PSG', profit: 0, subPicks: []
        },
        {
          id: 19, date: '2025-12-17', tipster: 'Mezcla-Tips', stake: 5.00, odds: 1.44, result: 'pending', description: 'Alexander Blockx (Apuesta Compartida)', profit: 0,
          subPicks: [
            { id: 's4', tipster: 'Torete', status: 'pending', detail: 'Alexander Blockx (Shared)' },
            { id: 's5', tipster: 'Elitebets', status: 'pending', detail: 'Alexander Blockx (Shared)' }
          ]
        },
        {
          id: 18, date: '2025-12-17', tipster: 'Copete', stake: 5.00, odds: 1.47, result: 'pending', description: 'Herlev Eagels', profit: 0, subPicks: []
        },
        {
          id: 17, date: '2025-12-17', tipster: 'Stakazo', stake: 5.00, odds: 1.96, result: 'win', description: 'Jose David Segovia + Kabeer Kapasi', profit: 4.82, subPicks: []
        },

        // --- DÃA 2 (16 Dic) ---
        {
          id: 15, date: '2025-12-16', tipster: 'Club Remates (Media)', stake: 10.00, odds: 2.00, result: 'loss', description: 'Joel Colwill (1+ Remates) + Chelsea Gana', profit: -10.00, subPicks: []
        },
        {
          id: 14, date: '2025-12-16', tipster: 'Copete', stake: 5.00, odds: 1.90, result: 'loss', description: 'BolÃ­var Gana y +2.5 Goles', profit: -5.00, subPicks: []
        },
        {
          id: 13, date: '2025-12-16', tipster: 'Club Vip (Media)', stake: 10.00, odds: 2.37, result: 'win', description: 'Tyrique George (+1.5 Remates a Puerta)', profit: 13.70, subPicks: []
        },
        {
          id: 12, date: '2025-12-16', tipster: 'Combis (Apuesta D)', stake: 5.00, odds: 11.56, result: 'loss', description: 'Copa: Real Sociedad + Mallorca X2 (Fallo) + Elche Clasif + BarÃ§a a 0 + Valencia Clasif', profit: -5.00, subPicks: []
        },
        {
          id: 11, date: '2025-12-16', tipster: 'Zona Tipster (Alta)', stake: 50.00, odds: 1.61, result: 'win', description: 'Cardiff (+7.5 Remates) vs Chelsea', profit: 30.50, subPicks: []
        },
        {
          id: 10, date: '2025-12-16', tipster: 'Elitebets', stake: 5.00, odds: 1.50, result: 'loss', description: 'Peter Goldsteinier Gana', profit: -5.00, subPicks: []
        },
        {
          id: 9, date: '2025-12-16', tipster: 'Torete', stake: 5.00, odds: 1.66, result: 'loss', description: 'Sporting de GijÃ³n Gana o Empata', profit: -5.00, subPicks: []
        },
        {
          id: 8, date: '2025-12-16', tipster: 'Copete', stake: 5.00, odds: 1.57, result: 'win', description: 'Hapoel Tel Aviv Gana + BarÃ§a Gana y +1.5 Goles', profit: 2.85, subPicks: []
        },

        // --- DÃA 1 (15 Dic) ---
        {
          id: 1, date: '2025-12-15', tipster: 'Mezcla-Tips', stake: 5.00, odds: 2.42, result: 'win', description: 'Combinada Mixta DÃ­a 1', profit: 7.10,
          subPicks: [
            { id: 's1', tipster: 'Torete', status: 'win', detail: 'CD CastellÃ³n' },
            { id: 's2', tipster: 'Elitebets', status: 'win', detail: 'Jakub Prachar' },
            { id: 's3', tipster: 'Copete', status: 'win', detail: 'Rayo Vallecano' }
          ]
        },
        {
          id: 2, date: '2025-12-15', tipster: 'Stakazo', stake: 5.00, odds: 1.92, result: 'win', description: 'Combinada Doble Tenis (Axel + John)', profit: 4.60, subPicks: []
        },
        {
          id: 3, date: '2025-12-15', tipster: 'Combis (Apuesta D)', stake: 5.00, odds: 13.01, result: 'win', description: 'Remates: Serrano, Athletic, MbappÃ©...', profit: 60.05, subPicks: []
        },
        {
          id: 4, date: '2025-12-15', tipster: 'Club Remates (Media)', stake: 10.00, odds: 1.50, result: 'loss', description: 'Bournemouth (Menos 13.5) + Senne', profit: -10.00, subPicks: []
        },
        {
          id: 5, date: '2025-12-15', tipster: 'Zona Tipster (Alta)', stake: 50.00, odds: 1.70, result: 'win', description: 'Rayo Vallecano (+11.5 Remates) + No Roja', profit: 35.00, subPicks: []
        },
        {
          id: 6, date: '2025-12-15', tipster: 'Club Vip (Media)', stake: 10.00, odds: 1.53, result: 'win', description: 'Samuel Aghehowa (1.5+ Tiros Puerta)', profit: 5.30, subPicks: []
        },
        {
          id: 7, date: '2025-12-15', tipster: 'Combis (Apuesta D)', stake: 5.00, odds: 5.57, result: 'loss', description: 'Triple Combinada Remates', profit: -5.00, subPicks: []
        }
      ];

      // ESTADO APUESTAS PORTFOLIO
      const [bets, setBets] = useState([]);

      // ESTADO RETOS
      const initialChallenges = [
        {
          id: 1,
          title: 'Escalera iPhone (Copete)',
          subtitle: 'Objetivo 1.000â‚¬ (Navidad)',
          initialBank: 30,
          currentBank: 54.00,
          targetBank: 1000,
          color: 'emerald',
          status: 'active',
          history: [
            {
              id: 1001,
              date: '2025-12-16',
              stake: 30.00,
              odds: 1.80,
              description: 'Paso 1: Hapoel Tel Aviv Gana + Paris Under 96.5pts',
              result: 'win',
              profit: 24.00
            }
          ]
        },
        {
          id: 2,
          title: 'Reto Torete ITF',
          subtitle: 'Objetivo 10.000â‚¬',
          initialBank: 100,
          currentBank: 570,
          targetBank: 10000,
          color: 'blue',
          history: [
            {
              id: 1002,
              date: '2025-12-16',
              stake: 470.00,
              odds: 1.45,
              description: 'Paso Fuerte: Becroft + K.Smith + Kuhar + Sach',
              result: 'loss',
              profit: -470.00
            },
            {
              id: 999,
              date: '2025-12-15',
              stake: 100,
              odds: 5.70,
              description: 'Ganancias Acumuladas Previas (Ajuste Inicial)',
              result: 'win',
              profit: 470
            }
          ]
        },
        {
          id: 3,
          title: 'Reto Torete NextGen',
          subtitle: 'Objetivo 11.000â‚¬',
          initialBank: 100,
          currentBank: 100,
          targetBank: 11000,
          color: 'purple',
          status: 'active', // 'active', 'won', 'lost'
          history: [
            {
              id: 1003,
              date: '2025-12-16',
              stake: 100.00,
              odds: 2.00,
              description: 'Dino Prizmic vs Nishesh (MÃ¡s de 1.5 Tie Breaks)',
              result: 'pending',
              profit: 0
            }
          ]
        },
        {
          id: 4,
          title: 'Reto Elitebets NextGen',
          subtitle: 'Objetivo 1.000â‚¬',
          initialBank: 50,
          currentBank: 50,
          targetBank: 1000,
          color: 'orange',
          status: 'active',
          history: [
            {
              id: 1004,
              date: '2025-12-16',
              stake: 50.00,
              odds: 1.57,
              description: 'Dino Prizmic Gana',
              result: 'pending',
              profit: 0
            }
          ]
        }
      ];

      const [challenges, setChallenges] = useState(initialChallenges);

      // ESTADO UI RETOS (V9)
      const [challengeTab, setChallengeTab] = useState('active');
      const [isCreatingChallenge, setIsCreatingChallenge] = useState(false);
      const [newChallengeData, setNewChallengeData] = useState({ title: '', target: '', bank: '', color: 'emerald' });
      const [activeChallengeId, setActiveChallengeId] = useState(null); // ID del reto donde estamos aÃ±adiendo un paso
      const [challengeStatsFilter, setChallengeStatsFilter] = useState('ALL');
      const [showCalculator, setShowCalculator] = useState(false);
      const [calculatorData, setCalculatorData] = useState({ mode: 'simple', stake: '10', odds: '', profit: '', targetProfit: '', lines: [{ odds: '', desc: '', void: false }] });

      // ESTADO FORMULARIO APUESTA RETO (V14: Tipster Support)
      const [challengeForm, setChallengeForm] = useState({ id: null, stake: '', odds: '', profit: '', desc: '', tipster: '', lines: [] });


      const [resolutionChallengeBet, setResolutionChallengeBet] = useState(null); // V17: Granular Challenge Resolution

      // V20: RESTORED MAIN BET FORM STATE
      // V20: RESTORED MAIN BET FORM STATE & LEGACY CONSOLIDATION
      const [formDescription, setFormDescription] = useState('');
      const [formStake, setFormStake] = useState('10');
      const [formOdds, setFormOdds] = useState('');
      const [formDate, setFormDate] = useState(new Date().toISOString().split('T')[0]);
      const [formResult, setFormResult] = useState('pending');
      const [formTipster, setFormTipster] = useState('Personal');
      const [formTag, setFormTag] = useState('ALL');
      const [manualProfit, setManualProfit] = useState('');
      const [isMulti, setIsMulti] = useState(false);
      const [betLines, setBetLines] = useState([{ tipster: '', description: '', odds: '' }]);

      // Legacy State (Moved from line ~1087 to prevent ReferenceErrors)
      const [formDesc, setFormDesc] = useState('');
      const [formTags, setFormTags] = useState('');



      const addChallengeLine = () => setChallengeForm({ ...challengeForm, lines: [...challengeForm.lines, { desc: '', odds: '' }] });
      const updateChallengeLine = (idx, field, val) => {
        const newLines = [...challengeForm.lines];
        newLines[idx][field] = val;
        setChallengeForm({ ...challengeForm, lines: newLines });
      };
      const removeChallengeLine = (idx) => setChallengeForm({ ...challengeForm, lines: challengeForm.lines.filter((_, i) => i !== idx) });

      // ESTADO EDICIÃ“N EN VIVO (V10)
      const [editingBet, setEditingBet] = useState(null);

      // ESTADO HISTORIAL 2.0 (V12)
      const [historyFilters, setHistoryFilters] = useState({ range: 'today', customDate: '', tipster: 'ALL', odds: 'ALL' });
      const [expandedBets, setExpandedBets] = useState([]); // Array of IDs

      const toggleHistoryExpansion = (id) => {
        if (expandedBets.includes(id)) {
          setExpandedBets(expandedBets.filter(bid => bid !== id));
        } else {
          setExpandedBets([...expandedBets, id]);
        }
      };

      const handleSaveEditedBet = (e) => {
        e.preventDefault();
        if (!editingBet) return;
        setBets(bets.map(b => b.id === editingBet.id ? editingBet : b));
        setEditingBet(null);
      };

      const toggleLineVoid = (lineIndex) => {
        if (!editingBet.betLines) return;
        const newLines = [...editingBet.betLines];
        const line = newLines[lineIndex];
        // Toggle void/active. If void, we mark it.
        // Simplified: We assume pending status unless voided.
        line.status = line.status === 'void' ? 'pending' : 'void';

        // Recalculate Global Odds
        let newOdds = 0;
        const activeLines = newLines.filter(l => l.status !== 'void');
        if (activeLines.length > 0) {
          newOdds = activeLines.reduce((acc, l) => acc * parseFloat(l.odds), 1);
        }

        setEditingBet({ ...editingBet, betLines: newLines, odds: parseFloat(newOdds.toFixed(2)) });
      };

      // LÃ“GICA DE RETOS (V9)
      const handleCreateChallenge = (e) => {
        e.preventDefault();
        const newCh = {
          id: Date.now(),
          title: newChallengeData.title,
          subtitle: `Objetivo ${parseFloat(newChallengeData.target).toLocaleString()}â‚¬`,
          initialBank: parseFloat(newChallengeData.bank),
          currentBank: parseFloat(newChallengeData.bank),
          targetBank: parseFloat(newChallengeData.target),
          color: newChallengeData.color,
          status: 'active',
          history: []
        };
        setChallenges([...challenges, newCh]);
        setIsCreatingChallenge(false);
        setNewChallengeData({ title: '', target: '', bank: '', color: 'emerald' });
      };

      const updateChallengeStatus = (id, newStatus) => {
        if (confirm(newStatus === 'won' ? 'Â¿Marcar reto como COMPLETADO/GANADO?' : 'Â¿Marcar reto como FALLIDO? Se moverÃ¡ al historial.')) {
          setChallenges(challenges.map(c => c.id === id ? { ...c, status: newStatus } : c));
        }
      };

      const rescueChallenge = (oldChallenge) => {
        if (confirm('Â¿Rescatar este reto? Se crearÃ¡ una copia nueva con el bank inicial original.')) {
          const rescued = {
            ...oldChallenge,
            id: Date.now(),
            title: `${oldChallenge.title} (Rescue)`,
            currentBank: oldChallenge.initialBank,
            status: 'active',
            history: [] // Start fresh
          };
          setChallenges([...challenges, rescued]);
          setChallengeTab('active');
        }
      };

      // --- UTILIDAD: RECALCULAR SALDO RETOS ---
      const recalculateChallengeBank = (challenge) => {
        const historyProfit = challenge.history.reduce((acc, bet) => {
          if (bet.result === 'pending') return acc;
          return acc + bet.profit;
        }, 0);
        return parseFloat((challenge.initialBank + historyProfit).toFixed(2));
      };

      // --- CARGA Y PERSISTENCIA ---
      useEffect(() => {
        const savedBets = localStorage.getItem('betPortfolioV29_bets');
        if (savedBets) setBets(JSON.parse(savedBets));
        else setBets(fullHistory);

        // Al cargar, siempre recalculamos el saldo actual basado en el historial para corregir inconsistencias
        const savedChallenges = localStorage.getItem('betPortfolioV29_challenges');
        let challengesToLoad = savedChallenges ? JSON.parse(savedChallenges) : initialChallenges;

        // Forzamos la actualizaciÃ³n de datos 'hardcoded' si estamos en desarrollo o para corregir
        // En este caso, si el usuario ya tiene datos, queremos respetar sus nuevos datos pero corregir el saldo
        // Si usamos initialChallenges (primera carga/cache borrada), recalculamos

        const correctedChallenges = challengesToLoad.map(c => ({
          ...c,
          currentBank: recalculateChallengeBank(c)
        }));

        setChallenges(correctedChallenges);
      }, []);

      useEffect(() => {
        if (bets.length > 0) localStorage.setItem('betPortfolioV29_bets', JSON.stringify(bets));
      }, [bets]);

      useEffect(() => {
        if (challenges.length > 0) localStorage.setItem('betPortfolioV29_challenges', JSON.stringify(challenges));
      }, [challenges]);

      // --- LÃ“GICA PORTFOLIO ---
      const updateSimpleStatus = (id, newStatus) => {
        const targetBet = bets.find(b => b.id === id);
        // Intercept V7 Multi-line or V3 SubPicks for Granular Resolution
        if (targetBet && ((targetBet.betLines && targetBet.betLines.length > 0) || (targetBet.subPicks && targetBet.subPicks.length > 0))) {
          setResolutionBet({ ...targetBet, tempLines: targetBet.betLines || [], tempSubPicks: targetBet.subPicks || [] });
          return;
        } else if (targetBet && (targetBet.tipster === 'Mezcla-Tips' || targetBet.description.includes('Mezcla') || (targetBet.betLines && targetBet.betLines.length === 0 && targetBet.subPicks && targetBet.subPicks.length === 0 && targetBet.tipster.includes('+')))) {
          // Safety check for broken old bets
          alert("âš ï¸ Esta apuesta parece ser una Mezcla antigua o daÃ±ada (sin lÃ­neas guardadas). Por favor elimÃ­nala y crÃ©ala de nuevo para usar la resoluciÃ³n detallada.");
          return;
        }

        const updatedBets = bets.map(b => {
          if (b.id === id) {
            let newProfit = 0;
            if (newStatus === 'win') newProfit = (b.stake * b.odds) - b.stake;
            if (newStatus === 'loss') newProfit = -b.stake;
            if (newStatus === 'void') newProfit = 0;
            return { ...b, result: newStatus, profit: parseFloat(newProfit.toFixed(2)) };
          }
          return b;
        });
        setBets(updatedBets);
      };



      // (Deleted legacy handleSaveBet to fix conflict)

      const addBetLine = () => setBetLines([...betLines, { tipster: formTipster, description: '', odds: '' }]);
      const removeBetLine = (idx) => setBetLines(betLines.filter((_, i) => i !== idx));

      const updateSubPickStatus = (betId, subPickIndex, newStatus) => {
        const updatedBets = bets.map(b => {
          if (b.id === betId) {
            const newSubPicks = [...b.subPicks];
            newSubPicks[subPickIndex].status = newStatus;
            const anyLoss = newSubPicks.some(sp => sp.status === 'loss');
            const anyPending = newSubPicks.some(sp => sp.status === 'pending');
            let parentResult = 'pending';
            let parentProfit = 0;
            if (anyLoss) { parentResult = 'loss'; parentProfit = -b.stake; }
            else if (!anyPending) { parentResult = 'win'; parentProfit = (b.stake * b.odds) - b.stake; }
            return { ...b, subPicks: newSubPicks, result: parentResult, profit: parseFloat(parentProfit.toFixed(2)) };
          }
          return b;
        });
        setBets(updatedBets);
      };

      const deleteBet = (id) => {
        if (window.confirm("Â¿Borrar registro permanentemente?")) setBets(bets.filter(b => b.id !== id));
      };

      // --- LÃ“GICA RETOS ---
      const addChallengeBet = (e, challengeId) => {
        e.preventDefault();
        const updatedChallenges = challenges.map(c => {
          if (c.id === challengeId) {
            const stake = parseFloat(challengeForm.stake);
            let odds = parseFloat(challengeForm.odds);
            const profitInput = parseFloat(challengeForm.profit);

            // AUTO-CALC ODDS FROM PROFIT
            if ((!odds || isNaN(odds)) && profitInput && !isNaN(profitInput) && stake > 0) {
              odds = (profitInput / stake) + 1;
            }

            // AUTO-CALC ODDS FROM MULIT-LINES
            if (isChallengeMulti && challengeForm.lines.length > 0) {
              const combinedOdds = challengeForm.lines.reduce((acc, line) => acc * (parseFloat(line.odds) || 1), 1);
              if (combinedOdds > 1) odds = combinedOdds;
            }

            if (!odds || isNaN(odds)) { alert("Introduce Cuota o Ganancia vÃ¡lida"); return c; }

            const newBet = {
              id: Date.now(),
              date: new Date().toISOString().split('T')[0],
              stake: stake,
              odds: parseFloat(odds.toFixed(2)),
              description: challengeForm.desc,
              tipster: challengeForm.tipster || 'Personal', // V14 Default
              result: 'pending',
              profit: 0,
              betLines: isChallengeMulti ? challengeForm.lines : []
            };
            const updatedHistory = [newBet, ...c.history];
            return { ...c, history: updatedHistory };
          }
          return c;
        });
        setChallenges(updatedChallenges);
        setChallengeForm({ id: null, stake: '', odds: '', profit: '', desc: '', lines: [] });
        setIsChallengeMulti(false);
      };

      const addFunds = (challengeId) => {
        const amount = prompt("Â¿Cantidad a reingresar (â‚¬)?");
        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) return;

        const updatedChallenges = challenges.map(c => {
          if (c.id === challengeId) {
            const deposit = {
              id: Date.now(),
              date: new Date().toISOString().split('T')[0],
              stake: 0,
              odds: 1,
              description: 'Reingreso Saldo ðŸ”„',
              result: 'deposit',
              profit: parseFloat(amount)
            };
            const updatedHistory = [deposit, ...c.history];
            const newChallenge = { ...c, history: updatedHistory };
            newChallenge.currentBank = recalculateChallengeBank(newChallenge);
            return newChallenge;
          }
          return c;
        });
        setChallenges(updatedChallenges);
      };

      const resolveChallengeBet = (challengeId, betId, result) => {
        // V17: Granular Resolution Check
        if (result === 'win') {
          const targetChallenge = challenges.find(c => c.id === challengeId);
          const targetBet = targetChallenge?.history.find(b => b.id === betId);
          if (targetBet && targetBet.lines && targetBet.lines.length > 0) {
            setResolutionChallengeBet({ ...targetBet, challengeId, tempLines: targetBet.lines });
            return;
          }
        }

        const updatedChallenges = challenges.map(c => {
          if (c.id === challengeId) {
            const updatedHistory = c.history.map(b => {
              if (b.id === betId) {
                let profit = 0;
                if (result === 'win') profit = (b.stake * b.odds) - b.stake;
                if (result === 'loss') profit = -b.stake;
                if (result === 'void') profit = 0;
                return { ...b, result, profit };
              }
              return b;
            });
            // Recalculamos banco total
            const newChallenge = { ...c, history: updatedHistory };
            newChallenge.currentBank = recalculateChallengeBank(newChallenge);
            return newChallenge;
          }
          return c;
        });
        setChallenges(updatedChallenges);
      };

      const deleteChallengeBet = (challengeId, betId) => {
        if (!window.confirm("Â¿Eliminar apuesta del reto? Se recalcularÃ¡ el saldo.")) return;
        const updatedChallenges = challenges.map(c => {
          if (c.id === challengeId) {
            const updatedHistory = c.history.filter(b => b.id !== betId);
            const newChallenge = { ...c, history: updatedHistory };
            newChallenge.currentBank = recalculateChallengeBank(newChallenge);
            return newChallenge;
          }
          return c;
        });
        setChallenges(updatedChallenges);
      };

      // --- TAGS SYSTEM (V3) ---
      const [filterTag, setFilterTag] = useState('ALL');
      const availableTags = useMemo(() => {
        const tags = new Set();
        bets.forEach(b => {
          if (b.tag && b.tag !== 'ALL') tags.add(b.tag); // Legacy singular support
          if (b.tags && Array.isArray(b.tags)) b.tags.forEach(t => tags.add(t));
        });
        return ['ALL', ...Array.from(tags).sort()];
      }, [bets]);

      // Global Filtered Bets
      const filteredBets = useMemo(() => {
        if (filterTag === 'ALL') return bets;
        return bets.filter(b => b.tags && b.tags.includes(filterTag));
      }, [bets, filterTag]);

      // --- STATS GLOBALES ---
      // (financialStats moved below to consolidate with deep analytics logic)

      const strategyStats = useMemo(() => {
        const stats = {};
        tipsters.forEach(t => { stats[t.name] = { name: t.name, staked: 0, profit: 0, bets: 0, wins: 0, losses: 0, voids: 0, oddsSum: 0, validOddsCount: 0 }; });
        filteredBets.forEach(b => {
          if (b.result !== 'pending') {
            if (!stats[b.tipster]) stats[b.tipster] = { name: b.tipster, staked: 0, profit: 0, bets: 0, wins: 0, losses: 0, voids: 0, oddsSum: 0, validOddsCount: 0 };
            if (b.result === 'win') stats[b.tipster].wins += 1;
            if (b.result === 'loss') stats[b.tipster].losses += 1;
            if (b.result === 'void') stats[b.tipster].voids += 1;
            if (b.result !== 'void') {
              stats[b.tipster].staked += b.stake;
              stats[b.tipster].profit += b.profit;
              stats[b.tipster].bets += 1;
              stats[b.tipster].oddsSum += b.odds;
              stats[b.tipster].validOddsCount += 1;
            }
          }
        });
        return Object.values(stats).filter(s => (s.bets > 0 || s.voids > 0)).map(s => ({
          ...s,
          yield: s.staked > 0 ? ((s.profit / s.staked) * 100).toFixed(2) : 0,
          winRate: s.bets > 0 ? ((s.wins / s.bets) * 100).toFixed(0) : 0,
          avgOdds: s.validOddsCount > 0 ? (s.oddsSum / s.validOddsCount).toFixed(2) : '0.00'
        })).sort((a, b) => b.profit - a.profit);
      }, [filteredBets, tipsters]);

      const scoutStats = useMemo(() => {
        const stats = {};
        tipsters.forEach(t => {
          if (t.name === 'Mezcla-Tips' || t.name.includes('Combis')) return;
          const cleanName = t.name.split(' (')[0];
          stats[cleanName] = { name: cleanName, picks: 0, wins: 0, losses: 0, voids: 0, pending: 0 };
        });
        filteredBets.forEach(bet => {
          if (bet.tipster !== 'Mezcla-Tips' && bet.tipster !== 'Combis (Apuesta D)') {
            const cleanName = bet.tipster.split(' (')[0];
            if (stats[cleanName]) {
              if (bet.result === 'win') { stats[cleanName].wins++; stats[cleanName].picks++; }
              if (bet.result === 'loss') { stats[cleanName].losses++; stats[cleanName].picks++; }
              if (bet.result === 'void') { stats[cleanName].voids++; }
              if (bet.result === 'pending') { stats[cleanName].pending++; }
            }
          }
          if (bet.subPicks && bet.subPicks.length > 0) {
            bet.subPicks.forEach(sub => {
              const cleanName = sub.tipster.split(' (')[0];
              if (stats[cleanName]) {
                if (sub.status === 'win') { stats[cleanName].wins++; stats[cleanName].picks++; }
                if (sub.status === 'loss') { stats[cleanName].losses++; stats[cleanName].picks++; }
                if (sub.status === 'void') { stats[cleanName].voids++; }
                if (sub.status === 'pending') { stats[cleanName].pending++; }
              }
            });
          }
          // V7 Granular Support (New) with Joint Tipster Support
          // FIX: Only count lines if it is a Mixed/Combi bet. 
          // If it is a Single Tipster with multiple lines, we only want the Main Result (counted above), not each line individually.
          if ((bet.tipster === 'Mezcla-Tips' || bet.tipster === 'Combis (Apuesta D)') && bet.betLines && bet.betLines.length > 0) {
            bet.betLines.forEach(line => {
              const tName = line.tipster || bet.tipster;
              if (!tName) return;
              // Split joint tipsters (e.g., "Torete + Elite")
              const names = tName.split(' + ');
              names.forEach(rawName => {
                const cleanName = rawName.trim().split(' (')[0];
                if (stats[cleanName]) {
                  if (line.result === 'win') { stats[cleanName].wins++; stats[cleanName].picks++; }
                  if (line.result === 'loss') { stats[cleanName].losses++; stats[cleanName].picks++; }
                  if (line.result === 'void') { stats[cleanName].voids++; }
                  if (!line.result || line.result === 'pending' || bet.result === 'pending') { stats[cleanName].pending++; }
                }
              });
            });
          }
        });
        return Object.values(stats).filter(s => s.picks > 0 || s.pending > 0).map(s => ({ ...s, winRate: s.picks > 0 ? ((s.wins / s.picks) * 100).toFixed(1) : 0 })).sort((a, b) => parseFloat(b.winRate) - parseFloat(a.winRate));
      }, [filteredBets, tipsters]);

      // --- CUOTAS STATS ---
      const oddsStats = useMemo(() => {
        const ranges = [
          { label: 'Seguras (1.0-1.5)', min: 1.0, max: 1.5, bets: 0, profit: 0, staked: 0 },
          { label: 'Valor (1.51-2.0)', min: 1.51, max: 2.0, bets: 0, profit: 0, staked: 0 },
          { label: 'Riesgo (2.01-5.0)', min: 2.01, max: 5.0, bets: 0, profit: 0, staked: 0 },
          { label: 'LoterÃ­a (5.0+)', min: 5.01, max: 999, bets: 0, profit: 0, staked: 0 },
        ];
        filteredBets.forEach(b => {
          if (b.result !== 'pending' && b.result !== 'void') {
            const range = ranges.find(r => b.odds >= r.min && b.odds <= r.max);
            if (range) { range.bets++; range.profit += b.profit; range.staked += b.stake; }
          }
        });
        return ranges.filter(r => r.bets > 0).map(r => ({ ...r, yield: r.staked > 0 ? ((r.profit / r.staked) * 100).toFixed(2) : 0 }));
      }, [filteredBets]);

      // --- DEEP ANALYTICS ENGINE (SIA-Pro) ---

      // Phase 14: Rescue without Reset
      const resumeChallenge = (challenge) => {
        if (!window.confirm("Â¿Reactivar el reto manteniendo el historial y saldo actual?")) return;
        setChallenges(challenges.map(c => c.id === challenge.id ? { ...c, status: 'active' } : c));
      };

      // Phase 14: Global Challenge Stats
      const challengesGlobalStats = useMemo(() => {
        const totalChallenges = challenges.length;
        const active = challenges.filter(c => c.status === 'active').length;
        const completed = challenges.filter(c => c.status === 'won').length;
        const failed = challenges.filter(c => c.status === 'lost').length;

        let totalInvested = 0;
        let totalCurrentValue = 0;
        let allSteps = [];

        challenges.forEach(c => {
          // Initial Bank is investment
          let cInvested = c.initialBank;
          // Add deposits
          c.history.forEach(h => {
            if (h.result === 'deposit') cInvested += h.profit;
            else if (h.result !== 'deposit') allSteps.push({ ...h, challengeTitle: c.title, challengeId: c.id });
          });
          totalInvested += cInvested;
          totalCurrentValue += (c.status === 'lost' ? 0 : c.currentBank); // If lost, value is 0? Or residal? Usually 0.
        });

        const totalNetProfit = totalCurrentValue - totalInvested;
        const totalRoi = totalInvested > 0 ? ((totalNetProfit / totalInvested) * 100).toFixed(2) : 0;

        return { totalChallenges, active, completed, failed, totalInvested, totalCurrentValue, totalNetProfit, totalRoi, allSteps };
      }, [challenges]);

      // 1. Drawdown Chart Data
      const drawdownStats = useMemo(() => {
        let currentBank = 1000; // Asumimos bank inicial fijo para visualizacion relativa
        let peak = 1000;
        const data = [];

        // Ordenar apuestas cronologicamente para simular la evolucion
        const sorted = [...filteredBets].filter(b => b.result !== 'pending' && b.result !== 'void').sort((a, b) => a.id - b.id);

        sorted.forEach(bet => {
          currentBank += bet.profit;
          if (currentBank > peak) peak = currentBank;
          const dd = ((currentBank - peak) / peak) * 100;
          data.push({
            date: bet.date,
            drawdown: dd.toFixed(2),
            bank: currentBank.toFixed(2)
          });
        });
        return data;
      }, [filteredBets]);

      // 2. Streaks (Rachas)
      const streakStats = useMemo(() => {
        let maxWin = 0, maxLoss = 0, current = 0;
        const sorted = [...filteredBets].filter(b => b.result !== 'pending' && b.result !== 'void').sort((a, b) => a.id - b.id);

        sorted.forEach(b => {
          if (b.result === 'win') {
            if (current < 0) current = 0;
            current++;
            if (current > maxWin) maxWin = current;
          } else if (b.result === 'loss') {
            if (current > 0) current = 0;
            current--;
            if (Math.abs(current) > maxLoss) maxLoss = Math.abs(current);
          }
        });
        return { maxWin, maxLoss, current: current > 0 ? `+${current}` : current };
      }, [filteredBets]);

      // 3. Sniper Chart (Scatter: Odds vs Profit)
      const sniperData = useMemo(() => {
        return filteredBets.filter(b => b.result !== 'pending' && b.result !== 'void').map(b => ({
          x: b.odds, // Eje X: Cuota
          y: b.profit, // Eje Y: Beneficio
          z: 1,
          name: b.tipster,
          desc: b.description,
          result: b.result // Needed for coloring
        }));
      }, [filteredBets]);

      // --- STATS GLOBALES ---
      const financialStats = useMemo(() => {
        const valid = filteredBets.filter(b => b.result !== 'void' && b.result !== 'pending');
        const staked = valid.reduce((acc, b) => acc + b.stake, 0);
        const profit = valid.reduce((acc, b) => acc + b.profit, 0);
        const yield_val = staked > 0 ? ((profit / staked) * 100).toFixed(2) : 0;

        // GrÃ¡fico acumulativo Ganancias
        let runningProfit = 0;
        const chartData = [...filteredBets]
          .filter(b => b.result !== 'pending')
          .sort((a, b) => new Date(a.date) - new Date(b.date) || a.id - b.id)
          .map(b => {
            runningProfit += b.profit;
            return { name: b.date.slice(5), fullDate: b.date, profit: runningProfit };
          });

        // GrÃ¡fico acumulativo PÃ‰RDIDAS (Solo suma los rojos)
        let runningLoss = 0;
        const lossChartData = [...filteredBets]
          .filter(b => b.result !== 'pending')
          .sort((a, b) => new Date(a.date) - new Date(b.date) || a.id - b.id)
          .map(b => {
            // Si es perdida, sumamos (en negativo). Si es ganancia, se mantiene plano (o sube si queremos Net Loss? No, Cumulative Loss suelo ser solo las perdidas sumadas).
            // User dijo: "cuente las apuestas perdidas... acumulativa igual que las ganancias".
            // InterpretaciÃ³n: Una linea que baja (o sube en valor absoluto) cada vez que pierdes.
            // Para visualizar "PÃ©rdida Total Acumulada", mejor que vaya bajando (negativo).
            if (b.result === 'loss') runningLoss += b.profit; // b.profit es negativo (-stake)
            return { name: b.date.slice(5), fullDate: b.date, loss: runningLoss };
          });


        // GrÃ¡fico Semanal (Weekly Evolution)
        const weeklyMap = {};
        filteredBets.filter(b => b.result !== 'pending' && b.result !== 'void').forEach(b => {
          const d = new Date(b.date);
          const onejan = new Date(d.getFullYear(), 0, 1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay() + 1) / 7);
          const key = `W${week}-${d.getFullYear().toString().slice(2)}`; // W42-24

          if (!weeklyMap[key]) weeklyMap[key] = 0;
          weeklyMap[key] += b.profit;
        });

        const weeklyChartData = Object.keys(weeklyMap).map(k => ({
          name: k,
          profit: weeklyMap[k]
        })).sort((a, b) => {
          const [wA, yA] = a.name.substring(1).split('-');
          const [wB, yB] = b.name.substring(1).split('-');
          return parseInt(yA) - parseInt(yB) || parseInt(wA) - parseInt(wB);
        });

        return { staked, profit, yield_val, chartData, weeklyChartData };
      }, [filteredBets]);

      // V18: GLOBAL BANK CALCULATION (Must be after financialStats)
      const currentGlobalBank = useMemo(() => {
        const initial = bankTransactions.filter(t => t.type === 'initial').reduce((acc, t) => acc + parseFloat(t.amount || 0), 0);
        const deposits = bankTransactions.filter(t => t.type === 'deposit').reduce((acc, t) => acc + parseFloat(t.amount || 0), 0);
        const withdrawals = bankTransactions.filter(t => t.type === 'withdraw').reduce((acc, t) => acc + parseFloat(t.amount || 0), 0);
        const bettingProfit = financialStats.profit || 0; // financialStats is now available

        if (bankTransactions.length === 0) return 0;
        return initial + deposits - withdrawals + bettingProfit;
      }, [bankTransactions, financialStats.profit]);

      // 4. Heatmap Data (Calendar)
      const heatmapData = useMemo(() => {
        const map = {};
        filteredBets.filter(b => b.result !== 'pending' && b.result !== 'void').forEach(b => {
          if (!map[b.date]) map[b.date] = 0;
          map[b.date] += b.profit;
        });
        // Rellenar ultimos 30 dias para grid
        const days = [];
        for (let i = 29; i >= 0; i--) {
          const d = new Date();
          d.setDate(d.getDate() - i);
          const dateStr = d.toISOString().split('T')[0];
          days.push({
            date: dateStr,
            value: map[dateStr] || 0,
            hasActivity: !!map[dateStr]
          });
        }
        return days;
      }, [filteredBets]);


      // --- FORM STATE (MOVED TO TOP) ---
      // (Consolidated at line 441 to fix scope issues)

      // AI State (V4)
      const [isAnalyzing, setIsAnalyzing] = useState(false);
      const fileInputRef = useRef(null);

      const handleImageUpload = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        setIsAnalyzing(true);
        const reader = new FileReader();
        reader.onloadend = async () => {
          const base64 = reader.result.split(',')[1];
          const prompt = `Analiza esta imagen de una apuesta deportiva. Extrae los siguientes datos en formato JSON estricto:
- stake: cantidad apostada (nÃºmero).
- totalOdds: cuota total (nÃºmero).
- description: resumen de la apuesta (texto breve, incluye equipos y mercado).
- lines: array de objetos { description: nombre del evento/mercado, odds: cuota individual }.
- isParlay: booleano, true si detectas multiples lineas o es combinada.
Si no encuentras algÃºn dato, usa null. Devuelve SOLO el JSON sin markdown.`;

          try {
            const data = await analyzeImageWithGemini(base64, prompt);
            if (data) {
              if (data.stake) setFormStake(data.stake);
              if (data.totalOdds) setFormOdds(data.totalOdds);
              if (data.description) setFormDesc(data.description);

              if (data.isParlay && data.lines && data.lines.length > 0) {
                setIsMultiLine(true);
                setBetLines(data.lines.map(l => ({ odds: l.odds || 1.0, description: l.description || '' })));
                if (formTipster !== 'Mezcla-Tips') {
                  // Opcional: Sugerir cambio a Mezcla-Tips si detectamos multiples lineas? 
                  // Dejamos que el usuario decida, pero rellenamos lines.
                }
              } else {
                // setIsMultiLine(false); // No forzamos false para no borrar trabajo manual si el usuario sube foto despues
              }
              // alert("Datos extraÃ­dos por Gemini IA correctamente.");
            }
          } catch (err) {
            alert("Error analizando imagen: " + err.message);
          } finally {
            setIsAnalyzing(false);
            if (fileInputRef.current) fileInputRef.current.value = '';
          }
        };
        reader.readAsDataURL(file);
      };

      const handleOracle = async (descOverride = null, oddsOverride = null) => {
        const d = descOverride || formDesc;
        const o = oddsOverride || formOdds;

        if (!d) { alert("No hay descripciÃ³n para analizar."); return; }

        setIsAnalyzing(true);
        try {
          const prompt = `ActÃºa como experto en apuestas deportivas. Analiza esta apuesta: "${d}" a cuota @${o}. Estima la probabilidad real (%) y calcula si tiene EV+ (Valor Esperado). Responde en formato corto: "Probabilidad: X% | EV: Positivo/Negativo | Consejo: [Frase corta]".`;
          const text = await analyzeTextWithGemini(prompt);
          alert("ðŸ”® ORACULO GEMINI DICE:\n\n" + text);
        } catch (err) {
          alert("Error OrÃ¡culo: " + err.message);
        } finally {
          setIsAnalyzing(false);
        }
      };

      // Multi-linea state
      const [isMultiLine, setIsMultiLine] = useState(false);


      // Simulator State (V5 Refined)
      const [simBank, setSimBank] = useState(1000);
      const [simWinRate, setSimWinRate] = useState(50);
      const [simAvgOdds, setSimAvgOdds] = useState(2.00);
      const [simNumBets, setSimNumBets] = useState(500);
      const [simResults, setSimResults] = useState(null);

      // V5 New States
      const [simMode, setSimMode] = useState('GLOBAL'); // GLOBAL | TIPSTER | MONTHLY_GOAL
      const [simSelectedTipster, setSimSelectedTipster] = useState('');
      const [excludeFunbets, setExcludeFunbets] = useState(true); // Default ON

      // Deep Analytics State
      const [selectedDay, setSelectedDay] = useState(null); // For Heatmap Modal
      const [resolutionBet, setResolutionBet] = useState(null); // For Multi-line Resolution Modal (V7)
      const [showAddBetModal, setShowAddBetModal] = useState(false); // Modal AÃ±adir Apuesta

      // Goal Seeker State
      const [goalProfit, setGoalProfit] = useState(1000);
      const [goalMonth, setGoalMonth] = useState('PrÃ³ximo Mes');
      const [goalResults, setGoalResults] = useState(null); // { betsNeeded, reqWinRate }

      const loadRealStats = () => {
        let sourceBets = [];
        if (simMode === 'GLOBAL') {
          sourceBets = filteredBets.filter(b => b.result !== 'pending' && b.result !== 'void');
        } else if (simMode === 'TIPSTER' && simSelectedTipster) {
          sourceBets = filteredBets.filter(b => b.result !== 'pending' && b.result !== 'void' && b.tipster === simSelectedTipster);
        }

        // 2. Filtro Anti-Ludopatia (Excluir Combis/Funbets)
        if (excludeFunbets) {
          sourceBets = sourceBets.filter(b => {
            const d = b.description.toLowerCase();
            const t = b.tipster.toLowerCase();
            const isLuck =
              d.includes('combi') || d.includes('combinada') || d.includes('funbet') ||
              t.includes('combi') ||
              (b.tags && b.tags.includes('FUNBET'));
            return !isLuck;
          });
        }

        if (sourceBets.length === 0) { alert("No hay suficientes datos para calcular estadÃ­sticas (o el filtro ha eliminado todo)."); return; }

        const wins = sourceBets.filter(b => b.result === 'win').length;
        const wr = (wins / sourceBets.length) * 100;
        const avgOdds = sourceBets.reduce((a, b) => a + b.odds, 0) / sourceBets.length;

        setSimWinRate(wr.toFixed(1));
        setSimAvgOdds(avgOdds.toFixed(2));
        alert(`Datos cargados (${simMode})${excludeFunbets ? ' [Sin Funbets]' : ''}: WinRate ${wr.toFixed(1)}% | Cuota Media @${avgOdds.toFixed(2)}`);
      };

      const calculateGoal = () => {
        const wr = parseFloat(simWinRate) / 100;
        const odds = parseFloat(simAvgOdds);
        const stake = 10;

        const profitPerBet = (stake * (odds - 1) * wr) - (stake * (1 - wr));

        if (profitPerBet <= 0) {
          setGoalResults({ error: "MatemÃ¡ticamente imposible con EV actual (Neutro o Negativo)." });
        } else {
          const betsNeeded = parseFloat(goalProfit) / profitPerBet;
          setGoalResults({
            betsNeeded: Math.ceil(betsNeeded),
            avgStakeUsed: stake,
            profitPerBet: profitPerBet
          });
        }
      };

      const runSimulation = () => {
        const paths = [];
        const iterations = 5; // 5 caminos visuales
        let bestFinal = -Infinity;
        let worstFinal = Infinity;
        let totalFinal = 0;

        for (let i = 0; i < iterations; i++) {
          let current = parseFloat(simBank);
          const path = [{ x: 0, y: current }];

          for (let b = 1; b <= simNumBets; b++) {
            const won = Math.random() * 100 < simWinRate;
            // Stake plano simple: 1% del bank INICIAL (conservador) o dinamico? Usaremos 1% fijo por simplicidad visual
            const stake = parseFloat(simBank) * 0.01;

            if (won) {
              current += stake * (simAvgOdds - 1);
            } else {
              current -= stake;
            }
            if (b % 10 === 0) path.push({ x: b, y: current }); // Sampleo para no saturar grafica
          }
          paths.push({ name: `Sim ${i + 1}`, data: path });
          if (current > bestFinal) bestFinal = current;
          if (current < worstFinal) worstFinal = current;
          totalFinal += current;
        }

        setSimResults({
          best: bestFinal,
          worst: worstFinal,
          avg: totalFinal / iterations,
          paths: paths
        });
      };

      // Manual profit


      // Sub-picks para Mezcla-Tips (Legacy/Special logic)
      const [subPicks, setSubPicks] = useState([]);
      const [subTipster, setSubTipster] = useState('');
      const [subDetail, setSubDetail] = useState('');

      // (Removed duplicate availableTags definition)

      // Efecto para calcular cuota total si hay lineas
      useEffect(() => {
        if (isMultiLine && betLines.length > 0) {
          const totalOdds = betLines.reduce((acc, line) => acc * (parseFloat(line.odds) || 1), 1);
          const finalOdds = parseFloat(totalOdds.toFixed(2));
          setFormOdds(finalOdds);

          // Auto-calc profit if stake exists
          const s = parseFloat(formStake);
          if (s > 0) {
            const potentialProfit = (s * finalOdds) - s;
            setManualProfit(potentialProfit.toFixed(2));
          }
        }
      }, [betLines, isMultiLine, formStake]);

      const handleSaveBet = (e) => {
        e.preventDefault();
        if ((formTipster === 'Mezcla-Tips' || isMultiLine) && betLines.length === 0) { alert("Â¡AÃ±ade al menos una lÃ­nea!"); return; }

        let calculatedProfit = 0; // Se calcularÃ¡ al resolver, pero si hay manual profit lo guardamos en description o similar?
        // En v29 el profit se calcula al cerrar. Pero si el usuario QUIERE fijar la ganancia potencial visualmente
        // podriamos guardarlo. Sin embargo, el sistema actual calcula (stake*odds)-stake al ganar.
        // Si el usuario mete 'manualProfit', podriamos ajustar la cuota para que cuadre?
        // O mejor: simplemente guardamos la apuesta. La "ganancia posible" es informativa. 
        // Si el usuario quiere "Ganancia Manual" para el resultado final, eso es al resolver. 
        // Si se refiere a "Ganancia Posible" que pide el usuario ("aÃ±adir ganancia posible si me la se"), es informativo.

        // INTERPRETACIÃ“N: El usuario dice "aÃ±adir ganancia posible".
        // Vamos a guardar esto quizÃ¡s en la descripciÃ³n o solo mostrarlo.
        // Pero lo mÃ¡s Ãºtil es ajustar la CUOTA si el usuario mete la ganancia.
        // Odds = (Profit + Stake) / Stake.

        const finalDesc = isMultiLine ? (formDesc + ' | ' + betLines.map(l => l.description).join(' + ')) : formDesc;
        const tagsArray = formTags.split(',').map(t => t.trim().toUpperCase()).filter(t => t); // V3 Tags

        const newBet = {
          id: Date.now(),
          date: new Date().toISOString().split('T')[0],
          tipster: formTipster,
          stake: parseFloat(formStake),
          odds: parseFloat(formOdds),
          result: 'pending',
          description: finalDesc,
          profit: 0,
          betLines: isMultiLine ? betLines : [], // FIX: Save V7 lines
          subPicks: formTipster === 'Mezcla-Tips' ? subPicks : [],
          tags: tagsArray // V3
        };
        setBets([newBet, ...bets]);

        // Reset
        setFormDesc('');
        setFormTags(''); // V3
        setSubPicks([]);
        setSubDetail('');
        setBetLines([]);
        setIsMultiLine(false);
        setManualProfit('');
        setShowAddBetModal(false);
        setActiveSection('dashboard');
      };

      const addLine = () => {
        setBetLines([...betLines, { odds: '', description: '', tipster: '', isJoint: false }]);
      };

      const updateLine = (index, field, value) => {
        setBetLines(prev => prev.map((line, i) => i === index ? { ...line, [field]: value } : line));
      };

      const removeLine = (index) => {
        setBetLines(betLines.filter((_, i) => i !== index));
      };

      const calculateOddsFromProfit = (profit) => {
        const st = parseFloat(formStake) || 0;
        if (st > 0) {
          const p = parseFloat(profit) || 0;
          return ((p + st) / st).toFixed(2);
        }
        return 0;
      };

      const addSubPickToForm = () => {
        if (!subTipster || !subDetail) return;
        setSubPicks([...subPicks, { id: Date.now() + Math.random(), tipster: subTipster, detail: subDetail, status: 'pending' }]);
        setSubDetail('');
      };

      // --- BACKUP SYSTEM (V3) ---
      const exportData = () => {
        const data = {
          version: 'v29.1',
          timestamp: new Date().toISOString(),
          bets: bets,
          challenges: challenges,
          bankTransactions: bankTransactions // V18
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `betmanager_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      const importData = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const imported = JSON.parse(event.target.result);
            if (imported.bets && Array.isArray(imported.bets)) {
              setBets(imported.bets);
              if (imported.challenges) setChallenges(imported.challenges);
              if (imported.bankTransactions) setBankTransactions(imported.bankTransactions); // V18
              alert('Â¡Datos restaurados con Ã©xito! (' + imported.bets.length + ' apuestas)');
            } else {
              alert('Formato de archivo invÃ¡lido');
            }
          } catch (err) {
            alert('Error al leer el archivo');
            console.error(err);
          }
        };
        reader.readAsText(file);
      };

      const factoryReset = () => {
        if (confirm("Â¿ESTÃS SEGURO? Se borrarÃ¡n TODOS los datos y se volverÃ¡ al estado inicial. Esta acciÃ³n no se puede deshacer.")) {
          localStorage.clear();
          window.location.reload();
        }
      };

      const COLORS = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#ec4899', '#6366f1'];
      const pendingBetsList = bets.filter(b => b.result === 'pending');

      const NavItem = ({ id, icon: Icon, label }) => (
        <button
          onClick={() => { setActiveSection(id); setSidebarOpen(false); }}
          className={`w-full flex items-center gap-3 px-4 py-4 rounded-lg transition-all mb-2 ${activeSection === id
            ? 'bg-emerald-600 text-white shadow-lg'
            : 'text-slate-400 hover:bg-slate-800'
            }`}
        >
          <Icon size={24} />
          <span className="font-medium text-lg">{label}</span>
          {activeSection === id && <ChevronRight size={20} className="ml-auto opacity-50" />}
        </button>
      );



      return (
        <div className="h-screen bg-slate-950 text-slate-100 font-sans flex flex-col md:flex-row overflow-hidden">
          {/* ... (Header y Sidebar sin cambios) ... */}

          {/* HEADER MOBILE */}
          <div className="md:hidden bg-slate-900 border-b border-slate-800 p-4 flex justify-between items-center z-50 sticky top-0 shadow-lg">
            <div className="font-bold text-xl text-emerald-400 tracking-tight">BET<span className="text-white">MANAGER</span></div>
            <button onClick={() => setSidebarOpen(!sidebarOpen)} className="p-2 text-white"><Menu size={28} /></button>
          </div>

          {/* SIDEBAR */}
          <div className={`fixed inset-0 bg-slate-950/95 z-40 transform transition-transform duration-300 md:relative md:translate-x-0 md:w-72 md:bg-slate-900 md:border-r md:border-slate-800 flex flex-col ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
            {/* HEADING PRO (V18: Bank Badge) */}
            <div className="hidden md:flex p-6 border-b border-slate-800 items-center justify-between">
              <h1 className="font-bold text-2xl text-emerald-400 tracking-tight">BET<span className="text-white">MANAGER</span></h1>
              <button onClick={() => setShowBankManager(true)} className="flex items-center gap-2 px-3 py-1.5 bg-slate-800 rounded-lg border border-slate-700 hover:border-emerald-500 transition-colors group">
                <div className="text-[10px] uppercase font-bold text-slate-400 group-hover:text-emerald-400">BANK ACTUAL</div>
                <div className="text-lg font-bold font-mono text-white group-hover:text-emerald-300">{currentGlobalBank.toFixed(2)}â‚¬</div>
              </button>
            </div>

            <div className="flex-1 p-6 overflow-y-auto">
              <div className="text-xs font-bold text-slate-500 mb-6 uppercase tracking-wider">NavegaciÃ³n</div>
              <nav className="flex-1 px-2 py-4 space-y-2">
                <NavItem id="dashboard" icon={LayoutDashboard} label="Dashboard" />
                <button onClick={() => { setShowAddBetModal(true); setSidebarOpen(false); }} className="w-full flex items-center gap-3 px-4 py-4 rounded-lg transition-all mb-2 text-emerald-400 hover:bg-slate-800 border border-transparent hover:border-emerald-500/30">
                  <Plus size={24} />
                  <span className="font-bold text-lg">Nueva Apuesta</span>
                </button>
                <NavItem id="challenges" icon={Trophy} label="Retos" />
                <NavItem id="stats" icon={BarChart2} label="EstadÃ­sticas" />
                <NavItem id="history" icon={History} label="Historial" />
                <button onClick={() => { setShowBankManager(true); setSidebarOpen(false); }} className="w-full flex items-center gap-3 px-4 py-4 rounded-lg transition-all mb-2 text-slate-400 hover:bg-slate-800">
                  <PieChart size={24} />
                  <span className="font-medium text-lg">GestiÃ³n de Bank</span>
                </button>
                <button onClick={() => { setShowCalculator(true); setSidebarOpen(false); }} className="w-full flex items-center gap-3 px-4 py-4 rounded-lg transition-all mb-2 text-slate-400 hover:bg-slate-800">
                  <Calculator size={24} />
                  <span className="font-medium text-lg">Calculadora</span>
                </button>
              </nav>
            </div>
            <div className="p-6 border-t border-slate-800">
              <div className="text-xs font-bold text-slate-500 mb-4 uppercase tracking-wider">GestiÃ³n de Datos (V3)</div>
              <div className="flex flex-col gap-2">
                <button onClick={exportData} className="flex items-center gap-2 text-xs bg-slate-800/50 hover:bg-emerald-600/20 hover:text-emerald-400 text-slate-400 p-2 rounded transition-colors border border-transparent hover:border-emerald-500/30">
                  <Save size={14} /> <span>Exportar Backup (JSON)</span>
                </button>
                <label className="flex items-center gap-2 text-xs bg-slate-800/50 hover:bg-blue-600/20 hover:text-blue-400 text-slate-400 p-2 rounded transition-colors border border-transparent hover:border-blue-500/30 cursor-pointer">
                  <RefreshCw size={14} /> <span>Importar Backup</span>
                  <input type="file" onChange={importData} accept=".json" className="hidden" />
                </label>
                <button onClick={factoryReset} className="flex items-center gap-2 text-xs bg-slate-800/50 hover:bg-red-600/20 hover:text-red-400 text-slate-400 p-2 rounded transition-colors border border-transparent hover:border-red-500/30">
                  <Trash2 size={14} /> <span>Factory Reset</span>
                </button>
              </div>
              <div className="mt-4 text-center text-[10px] text-slate-600">v29.1 PRO - Local Storage</div>
            </div>
          </div>

          {/* MAIN CONTENT */}
          <div className="flex-1 overflow-y-auto bg-slate-950 p-4 md:p-8 pb-20">

            {/* 1. DASHBOARD */}
            {activeSection === 'dashboard' && (
              <div className="space-y-6 animate-fade-in">
                {/* TAG FILTER UI (V3) */}
                {availableTags.length > 1 && (
                  <div className="flex justify-end mb-2">
                    <div className="flex items-center gap-2 bg-slate-900 p-2 rounded-lg border border-slate-800">
                      <Filter size={14} className="text-slate-400" />
                      <select value={filterTag} onChange={e => setFilterTag(e.target.value)} className="bg-slate-900 text-xs text-white focus:outline-none uppercase font-bold cursor-pointer">
                        {availableTags.map(tag => <option key={tag} value={tag}>{tag === 'ALL' ? 'Todas las Etiquetas' : tag}</option>)}
                      </select>
                    </div>
                  </div>
                )}


                {/* 0. ADD BET FORM (RESTORED V20) */}
                {/* 0. ADD BET FORM MOVED TO MODAL */}

                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                  <StatCard title="Beneficio Neto" value={`${financialStats.profit >= 0 ? '+' : ''}${financialStats.profit.toFixed(2)}â‚¬`} icon={PieChart} colorClass="text-emerald-500" />
                  <StatCard title="Yield / ROI" value={`${financialStats.yield_val}%`} icon={TrendingUp} colorClass="text-blue-500" />
                  <StatCard title="Win Rate Scout" value={`${scoutStats.length > 0 ? (scoutStats.reduce((acc, s) => acc + parseFloat(s.winRate), 0) / scoutStats.length).toFixed(1) : 0}%`} subtext="Efectividad Media" icon={Target} colorClass="text-purple-500" />
                  <StatCard title="Riesgo Activo" value={`${pendingBetsList.reduce((a, b) => a + b.stake, 0).toFixed(2)}â‚¬`} subtext="En juego" icon={Clock} colorClass="text-yellow-500" />
                </div>

                {pendingBetsList.length > 0 && (
                  <div className="bg-slate-900 rounded-xl border-l-4 border-yellow-500 p-4 shadow-xl">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-bold text-lg flex items-center gap-2 text-white"><AlertCircle className="text-yellow-500" /> Apuestas Activas ({pendingBetsList.length})</h3>
                    </div>
                    <div className="space-y-4">
                      {pendingBetsList.map(bet => (
                        <div key={bet.id} className="bg-slate-950 p-4 rounded-xl border border-slate-800 shadow-sm">
                          <div className="mb-2">
                            <div className="flex items-center gap-2 mb-1 flex-wrap">
                              <span className="font-bold text-emerald-400">{bet.tipster}</span>
                              <span className="text-xs bg-slate-800 px-2 py-0.5 rounded text-slate-400 border border-slate-700">@{bet.odds.toFixed(2)}</span>
                            </div>
                            <p className="text-sm text-slate-300">{bet.description}</p>
                          </div>
                          <div className="flex gap-2 w-full mt-3">
                            <button onClick={() => handleOracle(bet.description, bet.odds)} className="w-10 py-2 bg-purple-600/20 text-purple-400 border border-purple-600/50 rounded hover:bg-purple-600 hover:text-white font-bold text-sm flex justify-center items-center" title="Analizar con IA"><Sparkles size={16} /></button>
                            <button onClick={() => setEditingBet(bet)} className="w-10 py-2 bg-blue-600/20 text-blue-400 border border-blue-600/50 rounded hover:bg-blue-600 hover:text-white font-bold text-sm flex justify-center items-center" title="Editar Apuesta"><Edit size={16} /></button>
                            <button onClick={() => updateSimpleStatus(bet.id, 'win')} className="flex-1 py-2 bg-emerald-600/20 text-emerald-400 border border-emerald-600/50 rounded hover:bg-emerald-600 hover:text-white font-bold text-sm">Ganada</button>
                            <button onClick={() => updateSimpleStatus(bet.id, 'void')} className="w-10 py-2 bg-slate-700/50 text-slate-400 border border-slate-600/50 rounded hover:bg-slate-600 hover:text-slate-200 font-bold text-sm" title="Anulada">A</button>
                            <button onClick={() => updateSimpleStatus(bet.id, 'loss')} className="flex-1 py-2 bg-red-600/20 text-red-400 border border-red-600/50 rounded hover:bg-red-600 hover:text-white font-bold text-sm">Perdida</button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                  <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-xl col-span-1 lg:col-span-2">
                    <h3 className="font-bold text-sm mb-4 flex items-center gap-2 text-slate-400 uppercase tracking-wider"><Activity size={16} /> Curva de Ganancias</h3>
                    <div className="h-[250px] w-full">
                      <ResponsiveContainer width="100%" height="100%">
                        <LineChart data={financialStats.chartData}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                          <XAxis dataKey="name" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} />
                          <YAxis stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} tickFormatter={(val) => `${val}â‚¬`} />
                          <RechartsTooltip contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px', color: '#fff' }} formatter={(value) => [`${value.toFixed(2)}â‚¬`, 'Beneficio']} />
                          <Line type="monotone" dataKey="profit" stroke="#10b981" strokeWidth={3} dot={false} activeDot={{ r: 6, fill: '#10b981' }} />
                        </LineChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                  <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-xl">
                    <h3 className="font-bold text-sm mb-4 flex items-center gap-2 text-slate-400 uppercase tracking-wider"><BarChart2 size={16} /> EvoluciÃ³n Semanal</h3>
                    <div className="h-[250px] w-full">
                      <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={financialStats.weeklyChartData}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                          <XAxis dataKey="name" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} />
                          <YAxis stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} tickFormatter={(val) => `${val}â‚¬`} />
                          <RechartsTooltip contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px', color: '#fff' }} formatter={(value) => [`${value.toFixed(2)}â‚¬`, 'Profit Semanal']} />
                          <Bar dataKey="profit" radius={[4, 4, 4, 4]}>
                            {financialStats.weeklyChartData.map((entry, index) => (
                              <Cell key={`cell-${index}`} fill={entry.profit >= 0 ? '#10b981' : '#ef4444'} />
                            ))}
                          </Bar>
                        </BarChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                  <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-xl">
                    <h3 className="font-bold text-sm mb-4 flex items-center gap-2 text-slate-400 uppercase tracking-wider"><BarChart2 size={16} /> Rentabilidad Neta (â‚¬)</h3>
                    <div className="h-[250px] w-full">
                      <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={strategyStats}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                          <XAxis dataKey="name" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} interval={0} angle={-15} textAnchor="end" height={60} />
                          <YAxis stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} />
                          <Bar dataKey="profit" radius={[4, 4, 0, 0]}>
                            {strategyStats.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.profit >= 0 ? '#10b981' : '#ef4444'} />)}
                          </Bar>
                        </BarChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* 2. CHALLENGES */}
            {/* 2. CHALLENGES (IMPROVED V9) */}
            {activeSection === 'challenges' && (
              <div className="space-y-6 animate-fade-in relative">
                <header className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                  <div>
                    <h2 className="text-2xl font-bold text-white mb-2 flex items-center gap-2"><Trophy className="text-yellow-500" /> Retos & CompeticiÃ³n</h2>
                    <p className="text-sm text-slate-400">Seguimiento de interÃ©s compuesto y objetivos.</p>
                  </div>
                  <div className="flex gap-2">
                    <div className="bg-slate-900 p-1 rounded-lg border border-slate-800 flex">
                      <button onClick={() => setChallengeTab('active')} className={`px-4 py-2 text-xs font-bold rounded-md transition-all ${challengeTab === 'active' ? 'bg-slate-800 text-white shadow' : 'text-slate-500 hover:text-slate-300'}`}>ACTIVOS</button>
                      <button onClick={() => setChallengeTab('history')} className={`px-4 py-2 text-xs font-bold rounded-md transition-all ${challengeTab === 'history' ? 'bg-slate-800 text-white shadow' : 'text-slate-500 hover:text-slate-300'}`}>HISTORIAL</button>
                    </div>
                    <button onClick={() => setIsCreatingChallenge(true)} className="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold text-xs flex items-center gap-2 shadow-lg hover:shadow-emerald-900/20 transition-all"><Plus size={16} /> NUEVO RETO</button>
                  </div>
                </header>

                {/* CHALLENGES GLOBAL ANALYTICS DASHBOARD (V14) */}
                <div className="bg-slate-900 rounded-xl border border-slate-800 p-6 mb-8 shadow-2xl relative overflow-hidden">
                  <div className="flex justify-between items-start mb-6 z-10 relative">
                    <div className="flex items-center gap-3">
                      <div className="p-3 bg-indigo-500/20 rounded-lg border border-indigo-500/30 text-indigo-400"><Trophy size={24} /></div>
                      <div>
                        <h2 className="text-xl font-bold text-white tracking-tight">Challenge Center Pro</h2>
                        <p className="text-xs text-slate-400">Panel de Control de Retos</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      <Filter size={14} className="text-slate-500" />
                      <select className="bg-slate-950 border border-slate-700 text-xs rounded px-2 py-1 text-slate-300 outline-none focus:border-indigo-500" value={challengeStatsFilter} onChange={e => setChallengeStatsFilter(e.target.value)}>
                        <option value="ALL">Todos los Tipsters</option>
                        {tipsters.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                        <option value="Personal">Personal</option>
                      </select>
                    </div>
                  </div>

                  {/* CALCULATE FILTERED STATS ON THE FLY */}
                  {(() => {
                    const allSteps = challengesGlobalStats.allSteps.filter(s => challengeStatsFilter === 'ALL' || s.tipster === challengeStatsFilter);

                    // For "Total Invested" and "Current Value", filtering by Tipster is tricky because challenges are mixed.
                    // PROPOSAL: If Filter is active, Show "Contribution" of that Tipster (Profit generated by his steps).
                    // If Filter is ALL, show Global Bank stats.

                    const stepsWon = allSteps.filter(s => s.result === 'win').length;
                    const stepsTotal = allSteps.filter(s => s.result !== 'void' && s.result !== 'pending' && s.result !== 'deposit').length;
                    const winRate = stepsTotal > 0 ? ((stepsWon / stepsTotal) * 100).toFixed(1) : 0;
                    const stepsProfit = allSteps.reduce((sum, s) => sum + (s.profit || 0), 0);

                    return (
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 z-10 relative">
                        {challengeStatsFilter === 'ALL' ? (
                          <>
                            <div className="bg-slate-950/50 p-4 rounded-xl border border-slate-800">
                              <div className="text-xs text-slate-500 uppercase font-bold mb-1">Total Invertido</div>
                              <div className="text-2xl font-mono text-white font-bold">{challengesGlobalStats.totalInvested.toFixed(2)}â‚¬</div>
                            </div>
                            <div className="bg-slate-950/50 p-4 rounded-xl border border-slate-800">
                              <div className="text-xs text-slate-500 uppercase font-bold mb-1">Valor Actual</div>
                              <div className={`text-2xl font-mono font-bold ${challengesGlobalStats.totalCurrentValue >= challengesGlobalStats.totalInvested ? 'text-emerald-400' : 'text-red-400'}`}>{challengesGlobalStats.totalCurrentValue.toFixed(2)}â‚¬</div>
                            </div>
                          </>
                        ) : (
                          <div className="bg-slate-950/50 p-4 rounded-xl border border-slate-800 col-span-2">
                            <div className="text-xs text-slate-500 uppercase font-bold mb-1">Profit Generado ({challengeStatsFilter})</div>
                            <div className={`text-2xl font-mono font-bold ${stepsProfit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{stepsProfit > 0 ? '+' : ''}{stepsProfit.toFixed(2)}â‚¬</div>
                          </div>
                        )}

                        <div className="bg-slate-950/50 p-4 rounded-xl border border-slate-800">
                          <div className="text-xs text-slate-500 uppercase font-bold mb-1">Pasos Ganados</div>
                          <div className="text-2xl font-mono text-indigo-400 font-bold">{stepsWon}/{stepsTotal} <span className="text-sm text-slate-500">({winRate}%)</span></div>
                        </div>
                        <div className="bg-slate-950/50 p-4 rounded-xl border border-slate-800">
                          <div className="text-xs text-slate-500 uppercase font-bold mb-1">Retos Activos</div>
                          <div className="text-2xl font-mono text-white font-bold">{challengesGlobalStats.active} <span className="text-sm text-slate-500">/ {challengesGlobalStats.totalChallenges}</span></div>
                        </div>
                      </div>
                    );
                  })()}

                  {/* Background Decor */}
                  <div className="absolute top-0 right-0 -mr-10 -mt-10 w-64 h-64 bg-indigo-500/10 rounded-full blur-3xl pointer-events-none"></div>
                </div>

                {/* MODAL CREAR RETO */}
                {isCreatingChallenge && (
                  <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4 animate-fade-in backdrop-blur-sm" onClick={() => setIsCreatingChallenge(false)}>
                    <div className="bg-slate-900 w-full max-w-md rounded-xl border border-slate-700 shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
                      <div className="p-4 border-b border-slate-800 bg-slate-950 flex justify-between items-center">
                        <h3 className="font-bold text-white uppercase text-sm">Nuevo Reto Personalizado</h3>
                        <button onClick={() => setIsCreatingChallenge(false)}><X size={20} className="text-slate-500 hover:text-white" /></button>
                      </div>
                      <form onSubmit={handleCreateChallenge} className="p-6 space-y-4">
                        <div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">TÃ­tulo del Reto</label><input type="text" value={newChallengeData.title} onChange={e => setNewChallengeData({ ...newChallengeData, title: e.target.value })} className="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white text-sm" placeholder="Ej: Reto Verano 10k" required /></div>
                        <div className="grid grid-cols-2 gap-4">
                          <div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Bank Inicial (â‚¬)</label><input type="number" step="0.01" value={newChallengeData.bank} onChange={e => setNewChallengeData({ ...newChallengeData, bank: e.target.value })} className="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white text-sm" placeholder="100" required /></div>
                          <div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Objetivo Total (â‚¬)</label><input type="number" step="1" value={newChallengeData.target} onChange={e => setNewChallengeData({ ...newChallengeData, target: e.target.value })} className="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white text-sm" placeholder="10000" required /></div>
                        </div>
                        <div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Color Tema</label><select value={newChallengeData.color} onChange={e => setNewChallengeData({ ...newChallengeData, color: e.target.value })} className="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white text-sm"><option value="emerald">Verde (Default)</option><option value="purple">PÃºrpura (High Stakes)</option><option value="blue">Azul (Conservador)</option><option value="orange">Naranja (Agresivo)</option></select></div>
                        <button type="submit" className="w-full bg-emerald-600 hover:bg-emerald-500 py-3 rounded font-bold text-white shadow-lg mt-2">Crear Reto</button>
                      </form>
                    </div>
                  </div>
                )}

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {challenges.filter(c => (challengeTab === 'active' ? (!c.status || c.status === 'active') : (c.status === 'won' || c.status === 'lost'))).map(challenge => {
                    const percent = Math.min(100, (challenge.currentBank / challenge.targetBank) * 100).toFixed(1);
                    const isAdding = challengeForm.id === challenge.id;

                    let headerColor = "from-slate-900 to-slate-800";
                    let barColor = "bg-emerald-500";
                    if (challenge.color === 'purple') { headerColor = "from-slate-900 to-purple-900/30"; barColor = "bg-purple-500"; }
                    if (challenge.color === 'blue') { headerColor = "from-slate-900 to-blue-900/30"; barColor = "bg-blue-500"; }
                    if (challenge.color === 'orange') { headerColor = "from-slate-900 to-orange-900/30"; barColor = "bg-orange-500"; }

                    // STATUS BADGES FOR HISTORY
                    const isWon = challenge.status === 'won';
                    const isLost = challenge.status === 'lost';

                    return (
                      <div key={challenge.id} className={`bg-slate-900 rounded-xl border ${isWon ? 'border-emerald-500/50' : (isLost ? 'border-red-500/50' : 'border-slate-800')} shadow-xl overflow-hidden relative`}>
                        {isWon && <div className="absolute top-4 right-4 z-10 text-emerald-500 font-black text-6xl opacity-10 rotate-12 pointer-events-none">WIN</div>}
                        {isLost && <div className="absolute top-4 right-4 z-10 text-red-500 font-black text-6xl opacity-10 rotate-12 pointer-events-none">LOST</div>}

                        <div className={`p-6 border-b border-slate-800 bg-gradient-to-r ${headerColor}`}>
                          <div className="flex justify-between items-start mb-4">
                            <div className="flex-1">
                              <h3 className="text-xl font-bold text-white flex items-center gap-2">
                                {challenge.title}
                                {challengeTab === 'active' && (
                                  <button onClick={() => addFunds(challenge.id)} title="Reingresar Saldo (Another Bullet)" className="text-xs bg-slate-800 hover:bg-emerald-600/30 text-slate-400 hover:text-emerald-400 p-1.5 rounded border border-slate-700 transition-colors">
                                    <RefreshCw size={12} />
                                  </button>
                                )}
                              </h3>
                              <div className="text-slate-400 text-sm mt-1">{challenge.subtitle}</div>
                              {/* ACTION BUTTONS FOR ACTIVE & HISTORY */}
                              <div className="flex gap-2 mt-3">
                                {challengeTab === 'active' ? (
                                  <>
                                    <button onClick={() => updateChallengeStatus(challenge.id, 'won')} className="px-2 py-1 bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 rounded text-[10px] font-bold flex items-center gap-1 transition-colors"><CheckCircle size={10} /> COMPLETADO</button>
                                    <button onClick={() => updateChallengeStatus(challenge.id, 'lost')} className="px-2 py-1 bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/30 rounded text-[10px] font-bold flex items-center gap-1 transition-colors"><XCircle size={10} /> FALLIDO</button>
                                  </>
                                ) : (
                                  <>
                                    <span className={`px-2 py-1 rounded text-[10px] font-bold border ${isWon ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/30' : 'bg-red-500/10 text-red-400 border-red-500/30'}`}>{isWon ? 'RETO COMPLETADO' : 'RETO FALLIDO'}</span>
                                    {isLost && (
                                      <>
                                        <button onClick={() => resumeChallenge(challenge)} className="px-2 py-1 bg-yellow-500/10 hover:bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 rounded text-[10px] font-bold flex items-center gap-1 transition-colors"><Activity size={10} /> CONTINUAR</button>
                                        <button onClick={() => rescueChallenge(challenge)} className="px-2 py-1 bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 border border-blue-500/30 rounded text-[10px] font-bold flex items-center gap-1 transition-colors"><RefreshCw size={10} /> REINICIAR</button>
                                      </>
                                    )}
                                  </>
                                )}
                              </div>
                            </div>
                            <div className="text-right">
                              <div className={`text-3xl font-bold font-mono ${challenge.currentBank >= challenge.initialBank ? 'text-emerald-400' : 'text-red-400'}`}>{challenge.currentBank.toFixed(2)}â‚¬</div>
                              <div className="text-xs text-slate-500">Saldo Actual</div>
                            </div>
                          </div>
                          <div className="relative h-4 bg-slate-950 rounded-full overflow-hidden border border-slate-800">
                            <div className={`absolute top-0 left-0 h-full ${barColor} transition-all duration-1000`} style={{ width: `${percent}%` }}></div>
                          </div>
                          <div className="flex justify-between mt-2 text-xs font-bold text-slate-500">
                            <span>Inicio: {challenge.initialBank}â‚¬</span>
                            <span>{percent}% Completado</span>
                          </div>
                        </div>

                        {challengeTab === 'active' && (
                          activeChallengeId === challenge.id ? (
                            <div className="p-4 bg-slate-950 border-b border-slate-800 animate-fade-in">
                              <div className="flex justify-between items-center mb-3">
                                <h4 className="text-sm font-bold text-emerald-400 uppercase">Nuevo Paso</h4>
                                <button type="button" onClick={() => setIsChallengeMulti(!isChallengeMulti)} className={`text-[10px] font-bold px-2 py-1 rounded border ${isChallengeMulti ? 'bg-indigo-500 text-white border-indigo-500' : 'bg-slate-900 text-slate-500 border-slate-700'}`}>
                                  {isChallengeMulti ? 'MODO COMBINADA' : 'MODO SIMPLE'}
                                </button>
                              </div>

                              <form onSubmit={(e) => addChallengeBet(e, challenge.id)} className="space-y-3">
                                {/* Stake */}
                                <div className="relative">
                                  <input type="number" placeholder="Stake" step="0.01" value={challengeForm.stake} onChange={e => setChallengeForm({ ...challengeForm, stake: e.target.value })} className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-sm pr-12 focus:border-emerald-500 transition-colors" required />
                                  <button type="button" onClick={() => setChallengeForm({ ...challengeForm, stake: challenge.currentBank })} className="absolute right-1 top-1 bottom-1 text-[10px] font-bold text-emerald-500 hover:bg-emerald-900/30 px-2 rounded">ALL-IN</button>
                                </div>

                                {/* INPUTS: SIMPLE vs MULTI */}
                                {isChallengeMulti ? (
                                  <div className="bg-slate-900 rounded p-3 border border-slate-800 space-y-2">
                                    <div className="flex justify-between text-[10px] text-slate-500 uppercase font-bold"><span>LÃ­neas ({challengeForm.lines.length})</span> <span>Cuota Total: {challengeForm.lines.reduce((a, b) => a * (parseFloat(b.odds) || 1), 1).toFixed(2)}</span></div>
                                    {challengeForm.lines.map((line, idx) => (
                                      <div key={idx} className="flex gap-2">
                                        <input type="text" placeholder="DescripciÃ³n..." value={line.desc} onChange={e => updateChallengeLine(idx, 'desc', e.target.value)} className="flex-1 bg-slate-950 border border-slate-700 rounded p-1 text-xs text-white" />
                                        <input type="number" placeholder="@" step="0.01" value={line.odds} onChange={e => updateChallengeLine(idx, 'odds', e.target.value)} className="w-16 bg-slate-950 border border-slate-700 rounded p-1 text-xs text-white text-center" />
                                        <button type="button" onClick={() => removeChallengeLine(idx)} className="text-red-500 hover:bg-red-900/20 p-1 rounded"><Trash2 size={12} /></button>
                                      </div>
                                    ))}
                                    <button type="button" onClick={addChallengeLine} className="w-full py-1 text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 rounded font-bold transition-colors">+ AÃ±adir LÃ­nea</button>
                                  </div>
                                ) : (
                                  <div className="grid grid-cols-2 gap-3">
                                    <div className="relative">
                                      <span className="absolute left-2 top-2 text-[10px] text-emerald-500 font-bold">@</span>
                                      <input type="number" placeholder="Cuota" step="0.01" value={challengeForm.odds} onChange={e => setChallengeForm({ ...challengeForm, odds: e.target.value, profit: '' })} className="w-full bg-slate-900 border border-slate-700 rounded p-2 pl-6 text-white text-sm focus:border-emerald-500" disabled={!!challengeForm.profit} />
                                    </div>
                                    <div className="relative">
                                      <span className="absolute left-2 top-2 text-[10px] text-emerald-500 font-bold">Gain</span>
                                      <input type="number" placeholder="Ganancia" step="0.01" value={challengeForm.profit} onChange={e => setChallengeForm({ ...challengeForm, profit: e.target.value, odds: '' })} className="w-full bg-slate-900 border border-slate-700 rounded p-2 pl-8 text-white text-sm focus:border-emerald-500" disabled={!!challengeForm.odds} />
                                    </div>
                                  </div>
                                )}

                                <div className="grid grid-cols-3 gap-3">
                                  <div className="col-span-1">
                                    <select value={challengeForm.tipster} onChange={e => setChallengeForm({ ...challengeForm, tipster: e.target.value })} className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-xs outline-none focus:border-emerald-500">
                                      <option value="">Personal</option>
                                      {tipsters.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                                    </select>
                                  </div>
                                  <div className="col-span-2">
                                    {!isChallengeMulti && <input type="text" placeholder="DescripciÃ³n (ej: Paso 1 - Madrid)" value={challengeForm.desc} onChange={e => setChallengeForm({ ...challengeForm, desc: e.target.value })} className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-sm focus:border-emerald-500" required />}
                                  </div>
                                </div>

                                <div className="flex gap-2 pt-2">
                                  <button type="submit" className="flex-1 bg-emerald-600 text-white py-2 rounded font-bold text-sm hover:bg-emerald-500 shadow-lg shadow-emerald-900/20 transform active:scale-95 transition-all">Guardar Paso</button>
                                  <button type="button" onClick={() => { setActiveChallengeId(null); setChallengeForm({ id: null, stake: '', odds: '', profit: '', desc: '', lines: [] }); setIsChallengeMulti(false); }} className="px-3 bg-slate-800 text-slate-400 rounded hover:bg-slate-700 font-bold text-sm">Cancelar</button>
                                </div>
                              </form>
                            </div>
                          ) : (
                            <div className="p-4 space-y-4">
                              <button onClick={() => setActiveChallengeId(challenge.id)} className="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-bold shadow-lg shadow-indigo-900/20 transition-all flex items-center justify-center gap-2 transform active:scale-95">
                                <Plus size={18} /> Registrar Nuevo Paso
                              </button>

                              {/* CHALLENGE ANALYTICS DASHBOARD (V13) */}
                              <div className="bg-slate-950 rounded-xl border border-slate-800 p-4 space-y-4">
                                <div className="flex items-center gap-2 mb-2">
                                  <BarChart2 size={16} className="text-indigo-400" />
                                  <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider">AnalÃ­tica del Reto</h4>
                                </div>

                                {/* KPIs GRID */}
                                <div className="grid grid-cols-2 lg:grid-cols-4 gap-3">
                                  {(() => {
                                    const invested = challenge.initialBank + challenge.history.filter(h => h.result === 'deposit').reduce((sum, d) => sum + d.profit, 0);
                                    const netProfit = challenge.currentBank - invested;
                                    const roi = invested > 0 ? ((netProfit / invested) * 100).toFixed(1) : 0;

                                    // Max Streak Calculation
                                    let maxStreak = 0;
                                    let currentStreak = 0;
                                    challenge.history.slice().slice().reverse().forEach(h => {
                                      if (h.result === 'win') { currentStreak++; maxStreak = Math.max(maxStreak, currentStreak); }
                                      else if (h.result === 'loss') currentStreak = 0;
                                    });

                                    return (
                                      <>
                                        <div className="bg-slate-900 p-2 rounded border border-slate-800">
                                          <div className="text-[10px] text-slate-500 uppercase">InversiÃ³n Total</div>
                                          <div className="text-sm font-bold text-white">{invested.toFixed(2)}â‚¬</div>
                                        </div>
                                        <div className="bg-slate-900 p-2 rounded border border-slate-800">
                                          <div className="text-[10px] text-slate-500 uppercase">Beneficio Neto</div>
                                          <div className={`text-sm font-bold ${netProfit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{netProfit >= 0 ? '+' : ''}{netProfit.toFixed(2)}â‚¬</div>
                                        </div>
                                        <div className="bg-slate-900 p-2 rounded border border-slate-800">
                                          <div className="text-[10px] text-slate-500 uppercase">ROI Reto</div>
                                          <div className={`text-sm font-bold ${roi >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{roi}%</div>
                                        </div>
                                        <div className="bg-slate-900 p-2 rounded border border-slate-800">
                                          <div className="text-[10px] text-slate-500 uppercase">Mejor Racha</div>
                                          <div className="text-sm font-bold text-orange-400 flex items-center gap-1"><Flame size={12} /> {maxStreak} Pasos</div>
                                        </div>
                                      </>
                                    );
                                  })()}
                                </div>

                                {/* BANK EVOLUTION CHART */}
                                <div className="h-32 w-full mt-4">
                                  <ResponsiveContainer width="100%" height="100%">
                                    <AreaChart data={[
                                      { name: 'Inicio', bank: challenge.initialBank },
                                      ...challenge.history.slice().reverse().reduce((acc, curr, idx) => {
                                        const prevBank = idx === 0 ? challenge.initialBank : acc[idx - 1].bank;
                                        const newBank = prevBank + (curr.profit || 0);
                                        acc.push({ name: `P${idx + 1}`, bank: newBank });
                                        return acc;
                                      }, [])
                                    ]}>
                                      <defs>
                                        <linearGradient id="colorBank" x1="0" y1="0" x2="0" y2="1">
                                          <stop offset="5%" stopColor="#10b981" stopOpacity={0.3} />
                                          <stop offset="95%" stopColor="#10b981" stopOpacity={0} />
                                        </linearGradient>
                                      </defs>
                                      <RechartsTooltip contentStyle={{ backgroundColor: '#0f172a', borderColor: '#1e293b' }} itemStyle={{ color: '#fff' }} />
                                      <Area type="monotone" dataKey="bank" stroke="#10b981" fillOpacity={1} fill="url(#colorBank)" strokeWidth={2} />
                                    </AreaChart>
                                  </ResponsiveContainer>
                                </div>
                              </div>
                            </div>
                          )
                        )}

                        <div className="max-h-[300px] overflow-y-auto">
                          <table className="w-full text-left text-sm">
                            <thead className="bg-slate-950 text-slate-500 text-xs uppercase sticky top-0">
                              <tr><th className="p-3">Detalle</th><th className="p-3 text-center">Stake/Cuota</th><th className="p-3 text-right">Resultado</th><th className="p-3 text-center">AcciÃ³n</th></tr>
                            </thead>
                            <tbody className="divide-y divide-slate-800">
                              {challenge.history.length === 0 ? (
                                <tr><td colSpan="4" className="p-6 text-center text-slate-500 text-xs italic">AÃºn no hay movimientos en este reto.</td></tr>
                              ) : (
                                challenge.history.map(bet => (
                                  <tr key={bet.id} className="hover:bg-slate-800/50">
                                    <td className="p-3"><div className="font-bold text-white text-xs">{bet.description}</div><div className="text-[10px] text-slate-500">{bet.date}</div></td>
                                    <td className="p-3 text-center text-xs text-slate-300"><div>{bet.stake}â‚¬</div><div className="text-slate-500">@{bet.odds}</div></td>
                                    <td className="p-3 text-right">
                                      {bet.result === 'pending' ? (
                                        <div className="flex justify-end gap-1">
                                          <button onClick={() => resolveChallengeBet(challenge.id, bet.id, 'win')} className="p-1 bg-emerald-600/20 text-emerald-400 rounded"><Check size={14} /></button>
                                          <button onClick={() => resolveChallengeBet(challenge.id, bet.id, 'loss')} className="p-1 bg-red-600/20 text-red-400 rounded"><X size={14} /></button>
                                        </div>
                                      ) : (
                                        <span className={`font-bold text-xs ${bet.result === 'win' ? 'text-emerald-400' : 'text-red-400'}`}>{bet.result === 'win' ? `+${bet.profit.toFixed(2)}â‚¬` : `-${bet.stake}â‚¬`}</span>
                                      )}
                                    </td>
                                    <td className="p-3 text-center"><button onClick={() => deleteChallengeBet(challenge.id, bet.id)} className="text-slate-600 hover:text-red-400"><Trash2 size={14} /></button></td>
                                  </tr>
                                ))
                              )}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* 3. STATS (CON CUOTA MEDIA Y W/L/V) */}
            {activeSection === 'stats' && (
              <div className="space-y-8 animate-fade-in">
                <section>
                  <header className="mb-4">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2"><Layers className="text-blue-500" /> Rendimiento Financiero Global</h2>
                    <p className="text-sm text-slate-400">Resultados reales por estrategia. Desglose W-L-V (Win-Loss-Void).</p>
                  </header>
                  <div className="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden shadow-lg">
                    <div className="overflow-x-auto">
                      <table className="w-full text-left text-sm min-w-[700px]">
                        <thead className="bg-slate-950 text-slate-400 uppercase text-xs font-bold tracking-wider">
                          <tr>
                            <th className="p-4">Estrategia</th>
                            <th className="p-4 text-center">Bets (W-L-V)</th>
                            <th className="p-4 text-center">Cuota Media</th>
                            <th className="p-4 text-right">InversiÃ³n</th>
                            <th className="p-4 text-right">Beneficio</th>
                            <th className="p-4 text-center">Yield</th>
                            <th className="p-4 text-center">Win %</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-800">
                          {strategyStats.map((s) => (
                            <tr key={s.name} className="hover:bg-slate-800/50">
                              <td className="p-4 font-bold text-white">{s.name}</td>
                              <td className="p-4 text-center text-slate-300">
                                <span className="text-emerald-400 font-bold">{s.wins}</span>-<span className="text-red-400 font-bold">{s.losses}</span>-<span className="text-slate-500 font-bold">{s.voids}</span>
                              </td>
                              <td className="p-4 text-center text-slate-300 font-mono">@{s.avgOdds}</td>
                              <td className="p-4 text-right text-slate-300">{s.staked.toFixed(2)}â‚¬</td>
                              <td className={`p-4 text-right font-bold font-mono ${s.profit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                {s.profit >= 0 ? '+' : ''}{s.profit.toFixed(2)}â‚¬
                              </td>
                              <td className={`p-4 text-center font-bold ${parseFloat(s.yield) > 0 ? 'text-blue-400' : 'text-slate-500'}`}>{s.yield}%</td>
                              <td className="p-4 text-center text-slate-400">
                                <div className="flex items-center justify-center gap-2">
                                  <div className="w-12 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                    <div className={`h-full rounded-full ${parseFloat(s.winRate) > 50 ? 'bg-emerald-500' : 'bg-yellow-500'}`} style={{ width: `${s.winRate}%` }}></div>
                                  </div>
                                  <span>{s.winRate}%</span>
                                </div>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </section>
                <section>
                  <header className="mb-4">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2"><Target className="text-purple-500" /> Rendimiento por Rango de Cuota</h2>
                  </header>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden shadow-lg">
                      <table className="w-full text-left text-sm">
                        <thead className="bg-slate-950 text-slate-400 uppercase text-xs font-bold">
                          <tr><th className="p-3">Rango</th><th className="p-3 text-center">Bets</th><th className="p-3 text-right">Profit</th><th className="p-3 text-center">Yield</th></tr>
                        </thead>
                        <tbody className="divide-y divide-slate-800">
                          {oddsStats.map((r, i) => (
                            <tr key={i} className="hover:bg-slate-800/50">
                              <td className="p-3 font-bold text-white">{r.label}</td>
                              <td className="p-3 text-center text-slate-400">{r.bets}</td>
                              <td className={`p-3 text-right font-bold ${r.profit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{r.profit.toFixed(2)}â‚¬</td>
                              <td className={`p-3 text-center font-bold ${parseFloat(r.yield) > 0 ? 'text-blue-400' : 'text-slate-500'}`}>{r.yield}%</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                    <div className="bg-slate-900 rounded-xl border border-slate-800 p-4 shadow-lg">
                      <ResponsiveContainer width="100%" height={200}>
                        <BarChart data={oddsStats}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} /><XAxis dataKey="label" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} interval={0} /><YAxis stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} /><Bar dataKey="profit" radius={[4, 4, 0, 0]}>{oddsStats.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.profit >= 0 ? '#8b5cf6' : '#ef4444'} />)}</Bar>
                        </BarChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                </section>
                <section>
                  <header className="mb-4">
                    <h2 className="text-xl font-bold text-white flex items-center gap-2"><Zap className="text-yellow-500" /> Scout Predictivo Individual</h2>
                  </header>
                  <div className="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden shadow-lg">
                    <div className="overflow-x-auto">
                      <table className="w-full text-left text-sm min-w-[600px]">
                        <thead className="bg-slate-950 text-slate-400 uppercase text-xs font-bold tracking-wider">
                          <tr><th className="p-4">Tipster</th><th className="p-4 text-center">Picks Totales</th><th className="p-4 text-center">W - L - V</th><th className="p-4 text-center">Efectividad %</th></tr>
                        </thead>
                        <tbody className="divide-y divide-slate-800">
                          {scoutStats.map((s) => (
                            <tr key={s.name} className="hover:bg-slate-800/50">
                              <td className="p-4 font-bold text-white">{s.name}</td>
                              <td className="p-4 text-center text-slate-300">{s.picks}</td>
                              <td className="p-4 text-center text-slate-300"><span className="text-emerald-400 font-bold">{s.wins}</span> - <span className="text-red-400 font-bold">{s.losses}</span> - {s.voids}</td>
                              <td className="p-4 text-center"><div className="flex items-center justify-center gap-2"><div className="w-16 h-2 bg-slate-700 rounded-full overflow-hidden"><div className={`h-full rounded-full ${parseFloat(s.winRate) > 60 ? 'bg-emerald-500' : 'bg-yellow-500'}`} style={{ width: `${s.winRate}%` }}></div></div><span className="font-mono font-bold">{s.winRate}%</span></div></td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </section>

                {/* --- DEEP ANALYTICS MODULES (SIA-Pro) --- */}
                <div className="pt-8 border-t border-slate-800">
                  <h2 className="text-2xl font-bold text-white mb-6 flex items-center gap-2"><Activity className="text-pink-500" /> Deep Analytics (SIA-Pro)</h2>

                  {/* 1. BANKROLL HEALTH: DRAWDOWN & STREAKS */}
                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    {/* CHART */}
                    <div className="lg:col-span-2 bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-lg">
                      <h3 className="font-bold text-sm mb-4 text-slate-400 uppercase tracking-wider flex justify-between">
                        <span><TrendingUp size={16} className="inline mr-2" /> Drawdown (Profundidad Submarina)</span>
                        <span className="text-xs text-slate-500">CaÃ­da desde MÃ¡ximo HistÃ³rico</span>
                      </h3>
                      <div className="h-[250px] w-full">
                        <ResponsiveContainer width="100%" height="100%">
                          <AreaChart data={drawdownStats}>
                            <defs>
                              <linearGradient id="colorDd" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="5%" stopColor="#ef4444" stopOpacity={0.3} />
                                <stop offset="95%" stopColor="#ef4444" stopOpacity={0} />
                              </linearGradient>
                            </defs>
                            <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                            <XAxis dataKey="date" stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} tickFormatter={(val) => val.slice(5)} />
                            <YAxis stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} unit="%" />
                            <RechartsTooltip contentStyle={{ backgroundColor: '#0f172a', borderColor: '#334155', color: '#f8fafc' }} formatter={(val) => [val + '%', 'Drawdown']} labelFormatter={(l) => l} />
                            <Area type="monotone" dataKey="drawdown" stroke="#ef4444" fillOpacity={1} fill="url(#colorDd)" strokeWidth={2} />
                          </AreaChart>
                        </ResponsiveContainer>
                      </div>
                    </div>

                    {/* STREAKS KPIs */}
                    <div className="space-y-4">
                      <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 border-l-4 border-l-emerald-500 shadow-lg">
                        <div className="text-slate-400 text-xs uppercase font-bold mb-1">Mejor Racha Ganadora</div>
                        <div className="text-3xl font-bold text-white flex items-baseline gap-2">
                          {streakStats.maxWin} <span className="text-sm text-emerald-500 font-normal">Aciertos</span>
                        </div>
                      </div>
                      <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 border-l-4 border-l-red-500 shadow-lg">
                        <div className="text-slate-400 text-xs uppercase font-bold mb-1">Peor Racha Perdedora</div>
                        <div className="text-3xl font-bold text-white flex items-baseline gap-2">
                          {streakStats.maxLoss} <span className="text-sm text-red-500 font-normal">Fallos</span>
                        </div>
                      </div>
                      <div className="bg-slate-900 p-5 rounded-xl border border-slate-800 shadow-lg flex items-center justify-between">
                        <div>
                          <div className="text-slate-400 text-[10px] uppercase font-bold">Racha Actual</div>
                          <div className={`text-xl font-bold ${parseInt(streakStats.current) > 0 ? 'text-emerald-400' : (parseInt(streakStats.current) < 0 ? 'text-red-400' : 'text-slate-400')}`}>
                            {streakStats.current > 0 ? '+' : ''}{streakStats.current}
                          </div>
                        </div>
                        <Activity className="text-slate-600" size={24} />
                      </div>
                    </div>
                  </div>

                  {/* 2. SNIPER & HEATMAP */}
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {/* SNIPER CHART */}
                    <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-lg">
                      <h3 className="font-bold text-sm mb-4 text-slate-400 uppercase tracking-wider flex items-center gap-2"><Target size={16} /> Sniper: Yield vs Cuota</h3>
                      <div className="h-[300px] w-full">
                        <ResponsiveContainer width="100%" height="100%">
                          <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: 0 }}>
                            <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                            <XAxis type="number" dataKey="x" name="Cuota" stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} unit="x" domain={['auto', 'auto']} />
                            <YAxis type="number" dataKey="y" name="Profit" stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} unit="â‚¬" />
                            <ZAxis type="number" dataKey="z" range={[60, 60]} />
                            <RechartsTooltip cursor={{ strokeDasharray: '3 3' }} content={({ active, payload }) => {
                              if (active && payload && payload.length) {
                                const data = payload[0].payload;
                                return (
                                  <div className="bg-slate-950 border border-slate-700 p-2 rounded shadow-xl text-xs">
                                    <div className="font-bold text-emerald-400">{data.name}</div>
                                    <div className="text-white">Profit: {data.y}â‚¬</div>
                                    <div className="text-slate-400">Cuota: @{data.x}</div>
                                    <div className="text-slate-500 italic max-w-[150px] truncate">{data.desc}</div>
                                  </div>
                                );
                              }
                              return null;
                            }} />
                            <Scatter name="Bets" data={sniperData} shape="circle">
                              {sniperData.map((entry, index) => (
                                <Cell key={`cell-${index}`} fill={entry.result === 'win' ? '#10b981' : '#ef4444'} />
                              ))}
                            </Scatter>
                          </ScatterChart>
                        </ResponsiveContainer>
                      </div>
                    </div>

                    {/* ACTIVITY HEATMAP */}
                    <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-lg flex flex-col">
                      <h3 className="font-bold text-sm mb-4 text-slate-400 uppercase tracking-wider flex items-center gap-2"><Calendar size={16} /> Actividad Reciente (30 dÃ­as)</h3>
                      <div className="flex-1 flex items-center justify-center p-4">
                        <div className="grid grid-cols-7 gap-2">
                          {heatmapData.map((day, i) => (
                            <div key={i} title={`${day.date}: ${day.value.toFixed(2)}â‚¬`} onClick={() => day.hasActivity && setSelectedDay(day)}
                              className={`w-8 h-8 rounded-md flex items-center justify-center text-[10px] font-bold transition-all cursor-pointer
                                            ${!day.hasActivity ? 'bg-slate-800 text-slate-600' :
                                  (day.value > 0 ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/50 hover:bg-emerald-500 hover:text-white' :
                                    'bg-red-500/20 text-red-400 border border-red-500/50 hover:bg-red-500 hover:text-white')
                                }`}>
                              {day.date.split('-')[2]}
                            </div>
                          ))}
                        </div>
                      </div>
                      <div className="mt-4 text-center text-[10px] text-slate-500 italic">
                        * Intensidad basada en Profit/Loss diario.
                      </div>
                    </div>
                  </div>

                  {/* KELLY CRITERION (BONUS) */}
                  <div className="mt-6 bg-gradient-to-r from-indigo-900/20 to-purple-900/20 p-4 rounded-xl border border-indigo-500/30 text-center">
                    <div className="text-xs font-bold text-indigo-400 uppercase mb-2">Consejo Money Management (Kelly Simplificado)</div>
                    <p className="text-sm text-slate-300 max-w-3xl mx-auto">
                      Para una cuota media de <span className="text-white font-bold">@{(strategyStats.length > 0 && strategyStats.reduce((a, b) => a + parseFloat(b.avgOdds), 0) / strategyStats.length) || '2.00'}</span>
                      {' '}y un WinRate del <span className="text-white font-bold">{(scoutStats.length > 0 && (scoutStats.reduce((a, s) => a + parseFloat(s.winRate), 0) / scoutStats.length).toFixed(0)) || '50'}%</span>,
                      tu stake Ã³ptimo sugerido (Kelly/4) serÃ­a del <span className="text-emerald-400 font-bold">1.5% - 2.5%</span>.
                      Â¡MantÃ©n la disciplina!
                    </p>
                  </div>

                  {/* HEATMAP DETAILS MODAL (V6) */}
                  {selectedDay && (
                    <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4 animate-fade-in backdrop-blur-sm" onClick={() => setSelectedDay(null)}>
                      <div className="bg-slate-900 w-full max-w-md rounded-xl border border-slate-700 shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className={`p-4 ${selectedDay.value >= 0 ? 'bg-emerald-900/30 border-b border-emerald-500/30' : 'bg-red-900/30 border-b border-red-500/30'} flex justify-between items-center`}>
                          <div>
                            <h3 className="text-lg font-bold text-white flex items-center gap-2"><Calendar size={18} /> {selectedDay.date}</h3>
                            <div className={`text-sm font-mono font-bold ${selectedDay.value >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                              {selectedDay.value > 0 ? '+' : ''}{selectedDay.value.toFixed(2)}â‚¬
                            </div>
                          </div>
                          <button onClick={() => setSelectedDay(null)} className="p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-white transition-colors"><X size={20} /></button>
                        </div>
                        <div className="max-h-[400px] overflow-y-auto p-0">
                          <table className="w-full text-sm text-left">
                            <thead className="bg-slate-950 text-slate-500 text-xs uppercase sticky top-0">
                              <tr><th className="p-3">Tipster</th><th className="p-3 text-center">Cuota</th><th className="p-3 text-right">Profit</th></tr>
                            </thead>
                            <tbody className="divide-y divide-slate-800">
                              {filteredBets.filter(b => b.date === selectedDay.date && b.result !== 'pending' && b.result !== 'void').map(bet => (
                                <tr key={bet.id} className="hover:bg-slate-800/50">
                                  <td className="p-3">
                                    <div className="font-bold text-white">{bet.tipster}</div>
                                    <div className="text-[10px] text-slate-500 truncate max-w-[120px]">{bet.description}</div>
                                  </td>
                                  <td className="p-3 text-center text-slate-400 bg-slate-900/50 font-mono">@{bet.odds.toFixed(2)}</td>
                                  <td className={`p-3 text-right font-bold ${bet.profit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                    {bet.profit > 0 ? '+' : ''}{bet.profit.toFixed(2)}â‚¬
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* RESOLUTION MODAL (V7 - GRANULAR) */}
                  {resolutionBet && (
                    <div className="fixed inset-0 bg-black/90 z-[80] flex items-center justify-center p-4 animate-fade-in backdrop-blur-md">
                      <div className="bg-slate-900 w-full max-w-lg rounded-xl border border-slate-700 shadow-2xl overflow-hidden animate-scale-in">
                        <div className="p-6 bg-gradient-to-r from-slate-900 to-indigo-900/20 border-b border-slate-800">
                          <h3 className="text-xl font-bold text-white mb-1">ResoluciÃ³n Detallada</h3>
                          <p className="text-sm text-slate-400">Define el resultado de cada lÃ­nea para el Scout.</p>
                        </div>
                        <div className="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                          {/* Support V7 Lines */}
                          {resolutionBet.tempLines && resolutionBet.tempLines.length > 0 && resolutionBet.tempLines.map((line, idx) => (
                            <div key={idx} className="bg-slate-950 p-4 rounded-lg border border-slate-800 flex flex-col gap-2">
                              <div className="flex justify-between">
                                <span className="font-bold text-indigo-400 text-sm">{line.tipster || resolutionBet.tipster}</span>
                                <span className="text-slate-500 text-xs text-right">@{line.odds}</span>
                              </div>
                              <div className="text-sm text-slate-300">{line.description}</div>
                              <div className="grid grid-cols-3 gap-2 mt-2">
                                <button onClick={() => {
                                  const newLines = [...resolutionBet.tempLines]; newLines[idx].result = 'win';
                                  setResolutionBet({ ...resolutionBet, tempLines: newLines });
                                }} className={`p-2 rounded text-xs font-bold border transition-all ${line.result === 'win' ? 'bg-emerald-500 text-white border-emerald-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-emerald-500'}`}>GANADA</button>
                                <button onClick={() => {
                                  const newLines = [...resolutionBet.tempLines]; newLines[idx].result = 'void';
                                  setResolutionBet({ ...resolutionBet, tempLines: newLines });
                                }} className={`p-2 rounded text-xs font-bold border transition-all ${line.result === 'void' ? 'bg-slate-500 text-white border-slate-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-slate-500'}`}>NULA</button>
                                <button onClick={() => {
                                  const newLines = [...resolutionBet.tempLines]; newLines[idx].result = 'loss';
                                  setResolutionBet({ ...resolutionBet, tempLines: newLines });
                                }} className={`p-2 rounded text-xs font-bold border transition-all ${line.result === 'loss' ? 'bg-red-500 text-white border-red-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-red-500'}`}>PERDIDA</button>
                              </div>
                            </div>
                          ))}

                          {/* Support V3 SubPicks (Legacy) */}
                          {(!resolutionBet.tempLines || resolutionBet.tempLines.length === 0) && resolutionBet.tempSubPicks && resolutionBet.tempSubPicks.map((sub, idx) => (
                            <div key={idx} className="bg-slate-950 p-4 rounded-lg border border-slate-800 flex flex-col gap-2">
                              <div className="flex justify-between">
                                <span className="font-bold text-blue-400 text-sm">{sub.tipster}</span>
                              </div>
                              <div className="text-sm text-slate-300">{sub.detail}</div>
                              <div className="grid grid-cols-3 gap-2 mt-2">
                                <button onClick={() => {
                                  const newSubs = [...resolutionBet.tempSubPicks]; newSubs[idx].status = 'win';
                                  setResolutionBet({ ...resolutionBet, tempSubPicks: newSubs });
                                }} className={`p-2 rounded text-xs font-bold border transition-all ${sub.status === 'win' ? 'bg-emerald-500 text-white border-emerald-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-emerald-500'}`}>GANADA</button>
                                <button onClick={() => {
                                  const newSubs = [...resolutionBet.tempSubPicks]; newSubs[idx].status = 'pending';
                                  setResolutionBet({ ...resolutionBet, tempSubPicks: newSubs });
                                }} className={`p-2 rounded text-xs font-bold border transition-all ${sub.status === 'pending' ? 'bg-slate-500 text-white border-slate-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-slate-500'}`}>PENDIENTE</button>
                                <button onClick={() => {
                                  const newSubs = [...resolutionBet.tempSubPicks]; newSubs[idx].status = 'loss';
                                  setResolutionBet({ ...resolutionBet, tempSubPicks: newSubs });
                                }} className={`p-2 rounded text-xs font-bold border transition-all ${sub.status === 'loss' ? 'bg-red-500 text-white border-red-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-red-500'}`}>PERDIDA</button>
                              </div>
                            </div>
                          ))}
                        </div>
                        <div className="p-6 border-t border-slate-800 flex justify-end gap-3 bg-slate-900">
                          <button onClick={() => setResolutionBet(null)} className="px-4 py-2 text-slate-400 hover:text-white font-bold transition-colors">Cancelar</button>
                          <button onClick={() => {
                            const isV7 = resolutionBet.tempLines && resolutionBet.tempLines.length > 0;
                            const lines = isV7 ? resolutionBet.tempLines : resolutionBet.tempSubPicks;

                            let parentResult = 'win';
                            let parentProfit = (resolutionBet.stake * resolutionBet.odds) - resolutionBet.stake;

                            const anyLoss = isV7 ? lines.some(l => l.result === 'loss') : lines.some(l => l.status === 'loss');
                            const allVoid = isV7 ? lines.every(l => l.result === 'void') : false;

                            if (anyLoss) {
                              parentResult = 'loss';
                              parentProfit = -resolutionBet.stake;
                            } else if (allVoid) {
                              parentResult = 'void';
                              parentProfit = 0;
                            }

                            const updatedBets = bets.map(b => {
                              if (b.id === resolutionBet.id) {
                                return {
                                  ...b,
                                  result: parentResult,
                                  profit: parseFloat(parentProfit.toFixed(2)),
                                  betLines: isV7 ? resolutionBet.tempLines : undefined,
                                  subPicks: !isV7 ? resolutionBet.tempSubPicks : undefined
                                };
                              }
                              return b;
                            });
                            setBets(updatedBets);
                            setResolutionBet(null);
                          }} className="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg shadow-lg shadow-emerald-900/20 transition-all transform active:scale-95">
                            Confirmar ResoluciÃ³n
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </div>

              </div>
            )}

            {/* 4. ADD BET (Sin cambios) */}
            {activeSection === 'add' && (
              <div className="max-w-2xl mx-auto space-y-6 animate-fade-in-up">
                <h2 className="text-2xl font-bold text-white">Nuevo Registro</h2>
                <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 shadow-2xl">
                  <form onSubmit={handleAddBet} className="space-y-6">
                    {/* AI SCANNER BUTTON (V4) */}
                    <div className="flex gap-2 mb-4">
                      <button type="button" onClick={() => fileInputRef.current && fileInputRef.current.click()} className="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 py-3 rounded-lg font-bold text-white shadow-lg flex justify-center items-center gap-2 transition-all transform active:scale-95">
                        <Camera size={18} /> Escanear Boleto (Gemini IA)
                      </button>
                      <input type="file" ref={fileInputRef} onChange={handleImageUpload} accept="image/*" className="hidden" />
                    </div>

                    {isAnalyzing && (
                      <div className="fixed inset-0 bg-slate-950/90 z-[60] flex flex-col items-center justify-center animate-fade-in backdrop-blur-sm">
                        <Brain size={64} className="text-emerald-500 animate-bounce mb-4" />
                        <div className="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-500 mb-4 absolute"></div>
                        <div className="text-emerald-400 font-bold text-xl animate-pulse">Analizando con Gemini 2.5...</div>
                        <div className="text-slate-400 text-sm mt-2 font-mono">Extrayendo Datos Smart Vision</div>
                      </div>
                    )}

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Tipster</label>
                        <div className="flex gap-2">
                          <select value={formTipster} onChange={e => {
                            const val = e.target.value;
                            setFormTipster(val);
                            if (val === 'Mezcla-Tips') setIsMultiLine(true); // Force V7
                            const t = tipsters.find(ti => ti.name === val);
                            if (t) setFormStake(t.defaultStake)
                          }} className="flex-1 bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-emerald-500">
                            {tipsters.map(t => <option key={t.name} value={t.name}>{t.name}</option>)}
                          </select>
                          <button type="button" onClick={handleAddTipster} className="bg-emerald-600/20 text-emerald-400 border border-emerald-600/50 p-3 rounded-lg hover:bg-emerald-600 hover:text-white transition-colors" title="AÃ±adir Nuevo Tipster">
                            <Plus size={20} />
                          </button>
                        </div>
                      </div>
                      <div><label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Stake Total (â‚¬)</label><input type="number" step="0.01" value={formStake} onChange={e => setFormStake(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-emerald-500" /></div>
                    </div>

                    {/* MULTI-LINE TOGGLE (Always Visible) */}
                    <div className="flex items-center gap-3 bg-slate-950 p-3 rounded border border-slate-800">
                      <input type="checkbox" id="multiLine" checked={isMultiLine} onChange={e => setIsMultiLine(e.target.checked)} className="w-5 h-5 accent-emerald-500" />
                      <label htmlFor="multiLine" className="text-sm font-bold text-slate-300 select-none cursor-pointer">Activar Modo MultilÃ­nea (Suma de cuotas automÃ¡tica)</label>
                    </div>

                    {/* LOGICA LINEAS MULTIPLES */}
                    {isMultiLine && (
                      <div className="bg-slate-800/50 p-4 rounded-lg border border-slate-700 space-y-3">
                        <h4 className={`text-xs font-bold uppercase flex items-center gap-2 ${formTipster === 'Mezcla-Tips' ? 'text-blue-400' : 'text-emerald-400'}`}>
                          {formTipster === 'Mezcla-Tips' ? <><Zap size={14} /> Constructor de Mezcla</> : <><Layers size={14} /> LÃ­neas de Apuesta</>}
                        </h4>
                        {betLines.map((line, idx) => {
                          const safeTipsterStr = (line.tipster !== undefined && line.tipster !== null) ? line.tipster : (formTipster || '');
                          const currentTipsters = safeTipsterStr.split(' + ');
                          return (
                            <div key={idx} className="flex gap-2 items-center flex-wrap bg-slate-900/40 p-2 rounded border border-slate-700/50">
                              {formTipster === 'Mezcla-Tips' && (
                                <div className="flex flex-col gap-2">
                                  {currentTipsters.map((tName, tIdx) => (
                                    <div key={tIdx} className="flex items-center gap-1">
                                      <select
                                        className={`w-28 border rounded p-2 text-xs text-white truncate ${tIdx === 0 ? 'bg-slate-950 border-slate-700' : 'bg-indigo-900/30 border-indigo-500/50 text-indigo-200'}`}
                                        value={tName}
                                        onChange={e => {
                                          const newTipsters = [...currentTipsters];
                                          newTipsters[tIdx] = e.target.value;
                                          updateLine(idx, 'tipster', newTipsters.filter(t => t.trim() !== '').join(' + '));
                                        }}
                                      >
                                        <option value="">Seleccionar...</option>
                                        {tipsters.filter(t => t.name !== 'Mezcla-Tips').map(t => <option key={t.name} value={t.name}>{t.name}</option>)}
                                      </select>
                                      {tIdx > 0 && (
                                        <button type="button" onClick={() => {
                                          const newTipsters = currentTipsters.filter((_, i) => i !== tIdx);
                                          updateLine(idx, 'tipster', newTipsters.join(' + '));
                                        }} className="text-red-400 hover:text-red-300"><X size={12} /></button>
                                      )}
                                    </div>
                                  ))}
                                  <button type="button" onClick={() => {
                                    updateLine(idx, 'tipster', (line.tipster || formTipster) + ' + ');
                                  }} className="text-[10px] mx-auto text-indigo-400 hover:text-white flex items-center gap-1 bg-indigo-900/20 px-2 py-1 rounded border border-indigo-500/30"><UserPlus size={10} /> Co-Tipster</button>
                                </div>
                              )}

                              <input type="text" placeholder="DescripciÃ³n lÃ­nea..." className="flex-1 bg-slate-950 border border-slate-700 rounded p-2 text-xs text-white self-start" value={line.description} onChange={e => updateLine(idx, 'description', e.target.value)} />
                              <input type="number" placeholder="Cuota" step="0.01" className="w-16 bg-slate-950 border border-slate-700 rounded p-2 text-xs text-white self-start" value={line.odds} onChange={e => updateLine(idx, 'odds', e.target.value)} />
                              <button type="button" onClick={() => removeLine(idx)} className="text-red-400 hover:text-red-300 self-start mt-2"><Trash2 size={16} /></button>
                            </div>
                          );
                        })}
                        <button type="button" onClick={addLine} className="text-xs font-bold text-emerald-400 hover:text-white flex items-center gap-1"><Plus size={14} /> AÃ±adir LÃ­nea</button>
                      </div>
                    )}

                    {/* Legacy Mix UI Removed - Unified with V7 Lines */}

                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="text-xs font-bold text-slate-400 uppercase mb-2 block flex justify-between items-center">
                          <span>Cuota Final {isMultiLine && '(Auto)'}</span>
                          <button type="button" onClick={handleOracle} className="text-[10px] bg-purple-600/20 text-purple-400 border border-purple-500/30 px-2 py-0.5 rounded hover:bg-purple-600 hover:text-white transition-colors flex items-center gap-1 group">
                            <Sparkles size={10} className="group-hover:animate-spin" /> ORACULO IA
                          </button>
                        </label>
                        <input type="number" step="0.01" value={formOdds} onChange={e => setFormOdds(e.target.value)} className={`w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white text-lg font-mono focus:outline-none focus:border-emerald-500 ${isMultiLine ? 'text-emerald-400 font-bold' : ''}`} readOnly={isMultiLine && betLines.length > 0} />
                      </div>
                      <div>
                        <label className="text-xs font-bold text-slate-400 uppercase mb-2 block flex items-center gap-1">Ganancia Posible <span className="text-[10px] text-slate-500 lowercase">(opcional)</span></label>
                        <input type="number" step="0.01" placeholder="Auto" value={manualProfit} onChange={e => setManualProfit(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white text-lg font-mono focus:outline-none focus:border-emerald-500 placeholder-slate-600" />
                      </div>
                    </div>

                    <div><label className="text-xs font-bold text-slate-400 uppercase mb-2 block">DescripciÃ³n General</label><input type="text" value={formDesc} onChange={e => setFormDesc(e.target.value)} placeholder="Ej: Combi Fin de Semana" className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-emerald-500" /></div>

                    {/* TAGS INPUT (V3) */}
                    <div>
                      <label className="text-xs font-bold text-slate-400 uppercase mb-2 block flex items-center gap-2"><Tag size={14} /> Etiquetas (Opcional)</label>
                      <input type="text" value={formTags} onChange={e => setFormTags(e.target.value)} placeholder="Ej: FUTBOL, LIVE, ESTRATEGIA1 (Separadas por coma)" className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500 text-sm" />
                    </div>

                    <div className="p-3 bg-slate-800 rounded border border-slate-700 flex justify-between items-center text-sm">
                      <span className="text-slate-400">Beneficio Potencial:</span>
                      <span className="font-bold text-emerald-400 text-lg">
                        {manualProfit ? `+${parseFloat(manualProfit).toFixed(2)}â‚¬` : (formStake && formOdds ? `+${((formStake * formOdds) - formStake).toFixed(2)}â‚¬` : '0.00â‚¬')}
                      </span>
                    </div>

                    <button type="submit" className="w-full bg-emerald-600 hover:bg-emerald-500 py-4 rounded-lg font-bold text-white shadow-lg text-lg">Guardar Apuesta</button>
                  </form>
                </div>
              </div>
            )}

            {/* SIMULATOR V5 (Goal Seeker) */}
            {activeSection === 'simulador' && (
              <div className="space-y-6 animate-fade-in pb-10">
                <h2 className="text-2xl font-bold text-emerald-400 flex items-center gap-2"><TrendingUp /> Simulador de Ganancias (Goal Seeker)</h2>

                {/* 1. DATA SOURCE & VIABILITY */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {/* CONF DATA */}
                  <div className="bg-slate-900 p-5 rounded-xl border border-slate-800 shadow-xl space-y-4">
                    <h3 className="text-sm font-bold text-slate-400 uppercase border-b border-slate-800 pb-2 mb-2 flex items-center gap-2"><Zap size={14} className="text-yellow-500" /> ConfiguraciÃ³n de Datos</h3>
                    <div className="flex gap-2 bg-slate-950 p-2 rounded-lg">
                      <button onClick={() => setSimMode('GLOBAL')} className={`flex-1 py-2 rounded text-xs font-bold transition-all ${simMode === 'GLOBAL' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-slate-800'}`}>GLOBAL</button>
                      <button onClick={() => setSimMode('TIPSTER')} className={`flex-1 py-2 rounded text-xs font-bold transition-all ${simMode === 'TIPSTER' ? 'bg-purple-600 text-white' : 'text-slate-400 hover:bg-slate-800'}`}>POR TIPSTER</button>
                    </div>

                    {simMode === 'TIPSTER' && (
                      <select value={simSelectedTipster} onChange={e => setSimSelectedTipster(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white text-sm">
                        <option value="">Selecciona Tipster...</option>
                        {tipsters.map(t => <option key={t.name} value={t.name}>{t.name}</option>)}
                      </select>
                    )}

                    {/* INPUTS EDITABLES & TOGGLE */}
                    <div className="flex items-center gap-2 mb-2">
                      <label className="flex items-center gap-2 cursor-pointer bg-slate-950 px-3 py-2 rounded border border-slate-700 hover:border-slate-500 transition-colors">
                        <input type="checkbox" checked={excludeFunbets} onChange={e => setExcludeFunbets(e.target.checked)} className="rounded text-emerald-500 focus:ring-emerald-500 bg-slate-800 border-slate-600" />
                        <span className="text-xs font-bold text-slate-300 select-none">Excluir Funbets / Combis</span>
                      </label>
                    </div>

                    <button onClick={loadRealStats} className="w-full py-2 border border-slate-700 hover:bg-slate-800 text-slate-300 rounded flex justify-center items-center gap-2 text-sm font-bold transition-colors">
                      <RefreshCw size={14} /> Cargar EstadÃ­sticas Reales
                    </button>

                    <div className="grid grid-cols-2 gap-3 pt-2">
                      <div className="bg-slate-950 p-2 rounded border border-slate-800">
                        <div className="text-[10px] text-slate-500 uppercase mb-1">Win Rate Actual (%)</div>
                        <input type="number" value={simWinRate} onChange={e => setSimWinRate(e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded p-1 text-white font-bold text-center focus:border-emerald-500 outline-none" />
                      </div>
                      <div className="bg-slate-950 p-2 rounded border border-slate-800">
                        <div className="text-[10px] text-slate-500 uppercase mb-1">Cuota Media (@)</div>
                        <input type="number" step="0.01" value={simAvgOdds} onChange={e => setSimAvgOdds(e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded p-1 text-white font-bold text-center focus:border-emerald-500 outline-none" />
                      </div>
                    </div>
                  </div>

                  {/* VIABILITY PANEL */}
                  <div className="bg-slate-900 p-5 rounded-xl border border-slate-800 shadow-xl space-y-4 relative overflow-hidden">
                    <div className="absolute top-0 right-0 p-4 opacity-5"><Activity size={100} /></div>
                    <h3 className="text-sm font-bold text-slate-400 uppercase border-b border-slate-800 pb-2 mb-2 flex items-center gap-2"><Activity size={14} className="text-emerald-500" /> AnÃ¡lisis de Salud</h3>

                    <div className="flex justify-between items-center">
                      <span className="text-slate-300 text-sm">Punto de Equilibrio (Break Even):</span>
                      <span className="font-mono font-bold text-yellow-500 text-lg">{(100 / simAvgOdds).toFixed(1)}% WR</span>
                    </div>
                    <div className="w-full bg-slate-800 h-2 rounded-full overflow-hidden flex">
                      <div className="bg-red-500 h-full" style={{ width: `${(100 / simAvgOdds)}%` }}></div>
                      <div className="bg-emerald-500 h-full flex-1"></div>
                    </div>
                    <div className="text-[10px] text-slate-500 text-right">Zona Roja: PÃ©rdidas | Zona Verde: Ganancias</div>

                    <div className="mt-4 pt-4 border-t border-slate-800 flex justify-between items-center">
                      <span className="text-slate-300 text-sm">ProyecciÃ³n Rentable (ROI 10%):</span>
                      {/* ROI = ((Yield + 1) * Turnover) - Turnover? No. Yield = (Profit/Stake)*100. 
                                Yield 10% -> Profit = 0.10 * Stake.
                                Profit = (Stake*(Odds-1)*WR) - (Stake*(1-WR)).
                                0.10 Stake = Stake [ (Odds-1)WR - (1-WR) ]
                                0.10 = (Odds-1)WR - 1 + WR
                                1.10 = WR(Odds-1+1) = WR(Odds)
                                WR = 1.10 / Odds
                            */}
                      <span className="font-mono font-bold text-emerald-400 text-lg">{((1.10 / simAvgOdds) * 100).toFixed(1)}% WR</span>
                    </div>
                  </div>
                </div>

                {/* 2. GOAL SEEKER MODULE */}
                <div className="bg-gradient-to-r from-indigo-900/40 to-purple-900/40 p-6 rounded-xl border border-indigo-500/30 shadow-2xl">
                  <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><Target className="text-indigo-400" /> Buscador de Objetivos (Goal Seeker)</h3>
                  <div className="flex flex-col md:flex-row gap-4 items-end">
                    <div className="flex-1 w-full">
                      <label className="text-xs font-bold text-indigo-300 uppercase mb-1 block">Objetivo de Ganancia (â‚¬)</label>
                      <input type="number" value={goalProfit} onChange={e => setGoalProfit(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white focus:border-indigo-500 font-bold text-lg" placeholder="ej: 1000" />
                    </div>
                    <div className="flex-1 w-full">
                      <label className="text-xs font-bold text-indigo-300 uppercase mb-1 block">Periodo Objetivo</label>
                      <select value={goalMonth} onChange={e => setGoalMonth(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white text-sm">
                        <option>Este Mes</option>
                        <option>PrÃ³ximo Mes</option>
                        <option>Trimestre</option>
                        <option>AÃ±o Completo</option>
                      </select>
                    </div>
                    <button onClick={calculateGoal} className="w-full md:w-auto bg-indigo-600 hover:bg-indigo-500 px-8 py-3 rounded font-bold text-white shadow-lg flex items-center justify-center gap-2 mb-[1px]">
                      <Sparkles size={18} /> Calcular Plan
                    </button>
                  </div>

                  {goalResults && !goalResults.error && (
                    <div className="mt-6 bg-slate-950/50 p-4 rounded-lg border border-indigo-500/50 flex flex-col md:flex-row gap-6 items-center animate-fade-in">
                      <div className="text-center md:text-left">
                        <div className="text-xs text-slate-400 uppercase mb-1">Volumen Necesario</div>
                        <div className="text-3xl font-bold text-white">{goalResults.betsNeeded} <span className="text-sm font-normal text-slate-500">apuestas</span></div>
                      </div>
                      <div className="h-10 w-[1px] bg-slate-700 hidden md:block"></div>
                      <div className="text-sm text-slate-300 flex-1">
                        Para ganar <span className="text-white font-bold">{goalProfit}â‚¬</span> en <span className="text-white font-bold">{goalMonth}</span> con tus mÃ©tricas actuales, necesitas realizar un volumen de {goalResults.betsNeeded} apuestas (aprox {(goalResults.betsNeeded / 30).toFixed(1)} al dÃ­a).
                      </div>
                    </div>
                  )}
                  {goalResults && goalResults.error && (
                    <div className="mt-4 text-red-400 font-bold bg-red-900/20 p-3 rounded border border-red-500/30 text-sm text-center animate-pulse">{goalResults.error}</div>
                  )}
                </div>

                {/* 3. CLASSIC MONTE CARLO */}
                <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 shadow-xl space-y-6 opacity-75 hover:opacity-100 transition-opacity">
                  <h3 className="text-sm font-bold text-slate-500 uppercase flex items-center gap-2"><Layers size={14} /> SimulaciÃ³n Monte Carlo ClÃ¡sica</h3>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Bank Inicial</label><input type="number" value={simBank} onChange={e => setSimBank(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white" /></div>
                    <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Win Rate (%)</label><input type="number" value={simWinRate} onChange={e => setSimWinRate(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white" /></div>
                    <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Cuota Media</label><input type="number" step="0.01" value={simAvgOdds} onChange={e => setSimAvgOdds(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white" /></div>
                    <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">NÂº Apuestas</label><input type="number" value={simNumBets} onChange={e => setSimNumBets(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white" /></div>
                  </div>
                  <button onClick={runSimulation} className="w-full bg-slate-700 hover:bg-slate-600 py-3 rounded font-bold text-slate-200 flex justify-center items-center gap-2 shadow-lg transition-all"><Zap size={18} /> Ejecutar SimulaciÃ³n Visual</button>
                </div>

                {simResults && (
                  <div className="bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-xl space-y-4 animate-fade-in">
                    <div className="grid grid-cols-3 gap-4 text-center">
                      <div className="p-3 bg-slate-950 rounded border border-slate-800"><div className="text-xs text-slate-500">Peor Caso</div><div className="text-red-400 font-bold text-lg">{simResults.worst.toFixed(2)}â‚¬</div></div>
                      <div className="p-3 bg-slate-950 rounded border border-slate-800"><div className="text-xs text-slate-500">Promedio</div><div className="text-blue-400 font-bold text-lg">{simResults.avg.toFixed(2)}â‚¬</div></div>
                      <div className="p-3 bg-slate-950 rounded border border-slate-800"><div className="text-xs text-slate-500">Mejor Caso</div><div className="text-emerald-400 font-bold text-lg">{simResults.best.toFixed(2)}â‚¬</div></div>
                    </div>
                    <div className="h-[300px] w-full bg-slate-950 p-2 rounded border border-slate-800">
                      <ResponsiveContainer width="100%" height="100%">
                        <LineChart>
                          <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                          <XAxis dataKey="x" type="number" allowDuplicatedCategory={false} stroke="#94a3b8" fontSize={10} tickCount={10} />
                          <YAxis stroke="#94a3b8" domain={['auto', 'auto']} fontSize={10} tickFormatter={(val) => `${val.toFixed(0)}â‚¬`} />
                          <RechartsTooltip contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px', color: '#fff' }} formatter={(val) => [`${val.toFixed(2)}â‚¬`, 'Bank']} labelFormatter={(l) => `Apuesta #${l}`} />
                          {simResults.paths.map((s, i) => (
                            <Line key={i} data={s.data} type="monotone" dataKey="y" stroke={["#ef4444", "#ebb305", "#3b82f6", "#8b5cf6", "#10b981"][i]} strokeWidth={2} dot={false} name={s.name} activeDot={{ r: 4 }} />
                          ))}
                        </LineChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* 5. HISTORY */}
            {activeSection === 'history' && (
              <div className="space-y-6 animate-fade-in">
                {/* TOOLBAR HISTORIAL 2.0 */}
                <div className="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4 bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-xl">
                  <div>
                    <h2 className="text-2xl font-bold text-white flex items-center gap-2"><History /> Historial Profesional</h2>
                    <p className="text-xs text-slate-400">Consulta y analiza tu registro detallado.</p>
                  </div>

                  <div className="flex flex-wrap gap-2 w-full xl:w-auto">
                    {/* FILTRO FECHA */}
                    <div className="flex bg-slate-950 rounded border border-slate-800 p-1">
                      {['today', 'week', 'month', 'all'].map(r => (
                        <button key={r} onClick={() => setHistoryFilters({ ...historyFilters, range: r, customDate: '' })} className={`px-3 py-1.5 text-xs font-bold rounded transition-colors ${historyFilters.range === r && !historyFilters.customDate ? 'bg-slate-800 text-white shadow' : 'text-slate-500 hover:text-slate-300'}`}>
                          {r === 'today' ? 'HOY' : r === 'week' ? 'SEMANA' : r === 'month' ? 'MES' : 'TOTAL'}
                        </button>
                      ))}
                    </div>

                    {/* FILTRO CUSTOM DATE */}
                    <input type="date" value={historyFilters.customDate} onChange={e => setHistoryFilters({ ...historyFilters, range: 'custom', customDate: e.target.value })} className={`bg-slate-950 border border-slate-800 rounded px-2 text-xs text-white focus:border-blue-500 ${historyFilters.range === 'custom' ? 'border-blue-500' : ''}`} />

                    {/* FILTRO TIPSTER */}
                    <select value={historyFilters.tipster} onChange={e => setHistoryFilters({ ...historyFilters, tipster: e.target.value })} className="bg-slate-950 border border-slate-800 rounded px-2 py-1 text-xs text-white font-bold focus:border-blue-500">
                      <option value="ALL">TODOS LOS TIPSTERS</option>
                      {tipsters.map(t => <option key={t.name} value={t.name}>{t.name}</option>)}
                    </select>

                    {/* FILTRO CUOTA */}
                    <select value={historyFilters.odds} onChange={e => setHistoryFilters({ ...historyFilters, odds: e.target.value })} className="bg-slate-900 border border-slate-800 rounded px-2 py-1 text-xs text-slate-300 font-bold focus:border-blue-500">
                      <option value="ALL">Cualquier Cuota</option>
                      <option value="low">Baja (1.0 - 1.5)</option>
                      <option value="medium">Media (1.5 - 2.0)</option>
                      <option value="high">Alta (2.0 - 3.0)</option>
                      <option value="lotto">Lotto (+3.0)</option>
                    </select>
                  </div>
                </div>

                <div className="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden shadow-xl">
                  <div className="overflow-x-auto">
                    <table className="w-full text-left text-sm min-w-[600px]">
                      <thead className="bg-slate-950 text-slate-400 uppercase text-xs font-bold">
                        <tr><th className="p-4">Fecha</th><th className="p-4">Tipster / DescripciÃ³n</th><th className="p-4 text-center">Stake</th><th className="p-4 text-center">Cuota</th><th className="p-4 text-right">P&L</th><th className="p-4 text-center">AcciÃ³n</th></tr>
                      </thead>
                      <tbody className="divide-y divide-slate-800">
                        {(() => {
                          // LOGICA DE FILTRADO
                          const today = new Date().toISOString().split('T')[0];
                          const filtered = bets.filter(b => {
                            // Date Filter
                            if (historyFilters.range === 'custom' && historyFilters.customDate) {
                              if (b.date !== historyFilters.customDate) return false;
                            } else if (historyFilters.range === 'today') {
                              if (b.date !== today) return false;
                            } else if (historyFilters.range === 'week') {
                              const d = new Date(b.date);
                              const now = new Date();
                              const diffTime = Math.abs(now - d);
                              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                              if (diffDays > 7) return false;
                            } else if (historyFilters.range === 'month') {
                              const d = new Date(b.date);
                              const now = new Date();
                              if (d.getMonth() !== now.getMonth() || d.getFullYear() !== now.getFullYear()) return false;
                            }

                            // Tipster Filter (Improved: checks lines too)
                            if (historyFilters.tipster !== 'ALL') {
                              const matchMain = b.tipster === historyFilters.tipster;
                              const matchLine = b.betLines?.some(l => l.tipster?.includes(historyFilters.tipster)) || b.subPicks?.some(s => s.tipster === historyFilters.tipster);
                              if (!matchMain && !matchLine) return false;
                            }

                            // Odds Filter
                            if (historyFilters.odds !== 'ALL') {
                              const o = parseFloat(b.odds);
                              if (historyFilters.odds === 'low' && o > 1.5) return false;
                              if (historyFilters.odds === 'medium' && (o <= 1.5 || o > 2.0)) return false;
                              if (historyFilters.odds === 'high' && (o <= 2.0 || o > 3.0)) return false;
                              if (historyFilters.odds === 'lotto' && o <= 3.0) return false;
                            }

                            return true;
                          });

                          if (filtered.length === 0) return <tr><td colSpan="6" className="p-8 text-center text-slate-500 italic">No hay registros con estos filtros</td></tr>;

                          return filtered.sort((a, b) => b.id - a.id).map((bet) => {
                            // COMPACT VIEW LOGIC
                            const isMulti = (bet.betLines && bet.betLines.length > 0) || (bet.subPicks && bet.subPicks.length > 0);
                            const isExpanded = expandedBets.includes(bet.id);

                            return (
                              <React.Fragment key={bet.id}>
                                <tr className={`hover:bg-slate-800/50 transition-colors ${isExpanded ? 'bg-slate-800/30' : ''}`}>
                                  <td className="p-4 text-slate-400 text-xs whitespace-nowrap">{bet.date}</td>

                                  {/* COLUMNA TIPSTER DESCRIPCION (INTERACTIVA SI MULTI) */}
                                  <td className="p-4" onClick={() => isMulti && toggleHistoryExpansion(bet.id)}>
                                    <div className={`flex items-start gap-3 ${isMulti ? 'cursor-pointer group' : ''}`}>
                                      <div className={`p-2 rounded-lg ${isMulti ? 'bg-indigo-900/20 text-indigo-400 group-hover:bg-indigo-900/40' : 'bg-slate-800 text-slate-400'}`}>
                                        {isMulti ? <Layers size={18} /> : (bet.stake > 50 ? <Flame size={18} className="text-orange-500" /> : <Tag size={18} />)}
                                      </div>
                                      <div>
                                        <div className="font-bold text-white flex items-center gap-2">
                                          {bet.tipster}
                                          {isMulti && <span className="text-[10px] bg-slate-800 px-1.5 rounded text-slate-400 font-normal border border-slate-700">{isExpanded ? 'Ocultar' : 'Ver LÃ­neas'}</span>}
                                        </div>
                                        <div className="text-xs text-slate-500 truncate max-w-[250px]">{bet.description}</div>
                                      </div>
                                    </div>
                                  </td>

                                  <td className="p-4 text-center text-slate-300">{bet.stake.toFixed(2)}â‚¬</td>
                                  <td className="p-4 text-center font-mono text-emerald-400 font-bold">@{bet.odds.toFixed(2)}</td>

                                  <td className={`p-4 text-right font-bold font-mono ${bet.result === 'pending' ? 'text-slate-500' : (bet.profit >= 0 ? 'text-emerald-400' : 'text-red-400')}`}>
                                    {bet.result === 'pending' ? 'PEND' : (bet.profit >= 0 ? '+' : '') + bet.profit.toFixed(2) + 'â‚¬'}
                                  </td>

                                  <td className="p-4 text-center flex items-center justify-center gap-2">
                                    {bet.result === 'pending' && <button onClick={() => setEditingBet(bet)} className="text-blue-400 hover:text-white p-1.5 rounded bg-blue-900/20 hover:bg-blue-600 transition-colors" title="Editar"><Edit size={14} /></button>}
                                    <button onClick={() => deleteBet(bet.id)} className="text-slate-600 hover:text-red-400 p-1.5 transition-colors"><Trash2 size={16} /></button>
                                  </td>
                                </tr>

                                {/* EXPANDED DETAILS */}
                                {isMulti && isExpanded && (
                                  <tr className="bg-slate-950/50 animate-fade-in border-b border-slate-800">
                                    <td colSpan="6" className="p-0">
                                      <div className="p-4 pl-16 grid grid-cols-1 gap-2 bg-gradient-to-b from-indigo-900/10 to-transparent">
                                        <div className="text-[10px] font-bold text-slate-500 uppercase flex items-center gap-2 mb-1"><Layers size={10} /> Desglose de Combinada</div>
                                        {(bet.betLines || bet.subPicks).map((line, i) => {
                                          const s = line.result || line.status || 'pending';
                                          let colorClass = 'text-slate-500';
                                          if (s === 'win') colorClass = 'text-emerald-400';
                                          if (s === 'loss') colorClass = 'text-red-400';
                                          if (s === 'void') colorClass = 'text-slate-400 line-through';

                                          return (
                                            <div key={i} className="flex items-center justify-between bg-slate-900 border border-slate-800 p-2 rounded text-xs hover:border-slate-700 transition-colors">
                                              <div className="flex items-center gap-3">
                                                <div className={`w-1.5 h-1.5 rounded-full ${s === 'win' ? 'bg-emerald-500' : (s === 'loss' ? 'bg-red-500' : 'bg-slate-600')}`}></div>
                                                <span className="font-bold text-slate-300">{line.tipster || bet.tipster}</span>
                                                <span className={`${colorClass} truncate max-w-[200px]`}>{line.description}</span>
                                              </div>
                                              <span className="font-mono text-slate-500">@{line.odds || '-'}</span>
                                            </div>
                                          )
                                        })}
                                      </div>
                                    </td>
                                  </tr>
                                )}
                              </React.Fragment>
                            );
                          });
                        })()}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            )}

            {/* RESOLUTION MODAL (V7 - GRANULAR) */}
            {resolutionBet && (
              <div className="fixed inset-0 bg-black/90 z-[80] flex items-center justify-center p-4 animate-fade-in backdrop-blur-md">
                <div className="bg-slate-900 w-full max-w-lg rounded-xl border border-slate-700 shadow-2xl overflow-hidden animate-scale-in">
                  <div className="p-6 bg-gradient-to-r from-slate-900 to-indigo-900/20 border-b border-slate-800">
                    <h3 className="text-xl font-bold text-white mb-1">ResoluciÃ³n Detallada</h3>
                    <p className="text-sm text-slate-400">Define el resultado de cada lÃ­nea para el Scout.</p>
                  </div>
                  <div className="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                    {/* LIVE PREVIEW (Phase 16) */}
                    {(() => {
                      const isV7 = resolutionBet.tempLines && resolutionBet.tempLines.length > 0;
                      const lines = isV7 ? resolutionBet.tempLines : resolutionBet.tempSubPicks;

                      let effOdds = resolutionBet.odds;
                      let estProfit = (resolutionBet.stake * effOdds) - resolutionBet.stake;
                      let status = 'WIN';
                      let statusColor = 'text-emerald-400';

                      const anyLoss = isV7 ? lines.some(l => l.result === 'loss') : lines.some(l => l.status === 'loss');
                      const allVoid = isV7 ? lines.every(l => l.result === 'void') : false;

                      if (anyLoss) { status = 'LOSS'; estProfit = -resolutionBet.stake; statusColor = 'text-red-400'; effOdds = 0; }
                      else if (allVoid) { status = 'VOID'; estProfit = 0; statusColor = 'text-slate-400'; effOdds = 1.00; }
                      else if (isV7) {
                        const winningLines = lines.filter(l => l.result !== 'void');
                        if (winningLines.length > 0) {
                          effOdds = winningLines.reduce((acc, l) => acc * (parseFloat(l.odds) || 1), 1);
                          estProfit = (resolutionBet.stake * effOdds) - resolutionBet.stake;
                        } else {
                          // Should be void if no winning lines and no loss? Handled by allVoid check mostly.
                          // Covers edge case of just one line remaining valid?
                          // Actually winningLines logic handles it. 
                        }
                      }

                      return (
                        <div className="bg-slate-950/50 rounded-lg border border-slate-700 p-4 mb-4 flex justify-between items-center animate-pulse-slow">
                          <div>
                            <div className="text-[10px] uppercase font-bold text-slate-500">Resultado Estimado</div>
                            <div className={`text-xl font-bold font-mono ${statusColor}`}>{status}</div>
                          </div>
                          <div className="text-right">
                            <div className="text-[10px] uppercase font-bold text-slate-500">Cuota Efectiva</div>
                            <div className="text-sm font-mono text-white">@{effOdds.toFixed(2)}</div>
                          </div>
                          <div className="text-right">
                            <div className="text-[10px] uppercase font-bold text-slate-500">Beneficio</div>
                            <div className={`text-xl font-bold font-mono ${estProfit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{estProfit > 0 ? '+' : ''}{estProfit.toFixed(2)}â‚¬</div>
                          </div>
                        </div>
                      );
                    })()}

                    {/* Support V7 Lines */}
                    {resolutionBet.tempLines && resolutionBet.tempLines.length > 0 && resolutionBet.tempLines.map((line, idx) => (
                      <div key={idx} className="bg-slate-950 p-4 rounded-lg border border-slate-800 flex flex-col gap-2">
                        <div className="flex justify-between">
                          <span className="font-bold text-indigo-400 text-sm">{line.tipster || resolutionBet.tipster}</span>
                          <span className="text-slate-500 text-xs text-right">@{line.odds}</span>
                        </div>
                        <div className="text-sm text-slate-300">{line.description}</div>
                        <div className="grid grid-cols-3 gap-2 mt-2">
                          <button onClick={() => {
                            const newLines = [...resolutionBet.tempLines]; newLines[idx].result = 'win';
                            setResolutionBet({ ...resolutionBet, tempLines: newLines });
                          }} className={`p-2 rounded text-xs font-bold border transition-all ${line.result === 'win' ? 'bg-emerald-500 text-white border-emerald-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-emerald-500'}`}>GANADA</button>
                          <button onClick={() => {
                            const newLines = [...resolutionBet.tempLines]; newLines[idx].result = 'void';
                            setResolutionBet({ ...resolutionBet, tempLines: newLines });
                          }} className={`p-2 rounded text-xs font-bold border transition-all ${line.result === 'void' ? 'bg-slate-500 text-white border-slate-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-slate-500'}`}>NULA</button>
                          <button onClick={() => {
                            const newLines = [...resolutionBet.tempLines]; newLines[idx].result = 'loss';
                            setResolutionBet({ ...resolutionBet, tempLines: newLines });
                          }} className={`p-2 rounded text-xs font-bold border transition-all ${line.result === 'loss' ? 'bg-red-500 text-white border-red-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-red-500'}`}>PERDIDA</button>
                        </div>
                      </div>
                    ))}

                    {/* Support V3 SubPicks (Legacy) */}
                    {(!resolutionBet.tempLines || resolutionBet.tempLines.length === 0) && resolutionBet.tempSubPicks && resolutionBet.tempSubPicks.map((sub, idx) => (
                      <div key={idx} className="bg-slate-950 p-4 rounded-lg border border-slate-800 flex flex-col gap-2">
                        <div className="flex justify-between">
                          <span className="font-bold text-blue-400 text-sm">{sub.tipster}</span>
                        </div>
                        <div className="text-sm text-slate-300">{sub.detail}</div>
                        <div className="grid grid-cols-3 gap-2 mt-2">
                          <button onClick={() => {
                            const newSubs = [...resolutionBet.tempSubPicks]; newSubs[idx].status = 'win';
                            setResolutionBet({ ...resolutionBet, tempSubPicks: newSubs });
                          }} className={`p-2 rounded text-xs font-bold border transition-all ${sub.status === 'win' ? 'bg-emerald-500 text-white border-emerald-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-emerald-500'}`}>GANADA</button>
                          <button onClick={() => {
                            const newSubs = [...resolutionBet.tempSubPicks]; newSubs[idx].status = 'pending';
                            setResolutionBet({ ...resolutionBet, tempSubPicks: newSubs });
                          }} className={`p-2 rounded text-xs font-bold border transition-all ${sub.status === 'pending' ? 'bg-slate-500 text-white border-slate-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-slate-500'}`}>PENDIENTE</button>
                          <button onClick={() => {
                            const newSubs = [...resolutionBet.tempSubPicks]; newSubs[idx].status = 'loss';
                            setResolutionBet({ ...resolutionBet, tempSubPicks: newSubs });
                          }} className={`p-2 rounded text-xs font-bold border transition-all ${sub.status === 'loss' ? 'bg-red-500 text-white border-red-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-red-500'}`}>PERDIDA</button>
                        </div>
                      </div>
                    ))}
                  </div>
                  <div className="p-6 border-t border-slate-800 flex justify-end gap-3 bg-slate-900">
                    <button onClick={() => setResolutionBet(null)} className="px-4 py-2 text-slate-400 hover:text-white font-bold transition-colors">Cancelar</button>
                    <button onClick={() => {
                      const isV7 = resolutionBet.tempLines && resolutionBet.tempLines.length > 0;
                      const lines = isV7 ? resolutionBet.tempLines : resolutionBet.tempSubPicks;

                      let parentResult = 'win';
                      let finalOdds = resolutionBet.odds;
                      let parentProfit = 0;

                      const anyLoss = isV7 ? lines.some(l => l.result === 'loss') : lines.some(l => l.status === 'loss');
                      const allVoid = isV7 ? lines.every(l => l.result === 'void') : false;

                      if (anyLoss) {
                        parentResult = 'loss';
                        parentProfit = -resolutionBet.stake;
                      } else if (allVoid) {
                        parentResult = 'void';
                        parentProfit = 0;
                      } else {
                        // WIN CASE (Check for Voids in V7)
                        if (isV7) {
                          // Recalculate Odds excluding Voids
                          const winningLines = lines.filter(l => l.result !== 'void');
                          if (winningLines.length > 0) {
                            const recalculatedOdds = winningLines.reduce((acc, l) => acc * (parseFloat(l.odds) || 1), 1);
                            finalOdds = parseFloat(recalculatedOdds.toFixed(2));
                          }
                        }
                        parentProfit = (resolutionBet.stake * finalOdds) - resolutionBet.stake;
                      }

                      const updatedBets = bets.map(b => {
                        if (b.id === resolutionBet.id) {
                          return {
                            ...b,
                            result: parentResult,
                            profit: parseFloat(parentProfit.toFixed(2)),
                            odds: finalOdds, // Update Odds with Recalculated Value
                            betLines: isV7 ? resolutionBet.tempLines : undefined,
                            subPicks: !isV7 ? resolutionBet.tempSubPicks : undefined
                          };
                        }
                        return b;
                      });
                      setBets(updatedBets);
                      setResolutionBet(null);
                    }} className="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg shadow-lg shadow-emerald-900/20 transition-all transform active:scale-95">
                      Confirmar ResoluciÃ³n
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* RESOLUTION CHALLENGE MODAL (V17) */}
            {resolutionChallengeBet && (
              <div className="fixed inset-0 bg-black/90 z-[90] flex items-center justify-center p-4 animate-fade-in backdrop-blur-md">
                <div className="bg-slate-900 w-full max-w-lg rounded-xl border border-slate-700 shadow-2xl overflow-hidden animate-scale-in">
                  <div className="p-6 bg-gradient-to-r from-slate-900 to-indigo-900/20 border-b border-slate-800">
                    <h3 className="text-xl font-bold text-white mb-1">ResoluciÃ³n Detallada (Reto)</h3>
                    <p className="text-sm text-slate-400">Define el resultado de cada lÃ­nea del reto.</p>
                  </div>

                  {/* LIVE PREVIEW (V17) */}
                  <div className="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                    {(() => {
                      const lines = resolutionChallengeBet.tempLines || [];
                      let effOdds = resolutionChallengeBet.odds;
                      let estProfit = (resolutionChallengeBet.stake * effOdds) - resolutionChallengeBet.stake;
                      let status = 'WIN';
                      let statusColor = 'text-emerald-400';

                      const anyLoss = lines.some(l => l.result === 'loss');
                      const allVoid = lines.every(l => l.result === 'void');

                      if (anyLoss) { status = 'LOSS'; estProfit = -resolutionChallengeBet.stake; statusColor = 'text-red-400'; effOdds = 0; }
                      else if (allVoid) { status = 'VOID'; estProfit = 0; statusColor = 'text-slate-400'; effOdds = 1.00; }
                      else {
                        const winningLines = lines.filter(l => l.result !== 'void');
                        if (winningLines.length > 0) {
                          effOdds = winningLines.reduce((acc, l) => acc * (parseFloat(l.odds) || 1), 1);
                          estProfit = (resolutionChallengeBet.stake * effOdds) - resolutionChallengeBet.stake;
                        }
                      }

                      return (
                        <div className="bg-slate-950/50 rounded-lg border border-slate-700 p-4 mb-4 flex justify-between items-center animate-pulse-slow">
                          <div>
                            <div className="text-[10px] uppercase font-bold text-slate-500">Resultado Estimado</div>
                            <div className={`text-xl font-bold font-mono ${statusColor}`}>{status}</div>
                          </div>
                          <div className="text-right">
                            <div className="text-[10px] uppercase font-bold text-slate-500">Cuota Efectiva</div>
                            <div className="text-sm font-mono text-white">@{effOdds.toFixed(2)}</div>
                          </div>
                          <div className="text-right">
                            <div className="text-[10px] uppercase font-bold text-slate-500">Beneficio</div>
                            <div className={`text-xl font-bold font-mono ${estProfit >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{estProfit > 0 ? '+' : ''}{estProfit.toFixed(2)}â‚¬</div>
                          </div>
                        </div>
                      );
                    })()}

                    {resolutionChallengeBet.tempLines.map((line, idx) => (
                      <div key={idx} className="bg-slate-950 p-4 rounded-lg border border-slate-800 flex flex-col gap-2">
                        <div className="flex justify-between">
                          <span className="font-bold text-indigo-400 text-sm">LÃ­nea #{idx + 1}</span>
                          <span className="text-slate-500 text-xs text-right">@{line.odds}</span>
                        </div>
                        <div className="text-sm text-slate-300">{line.desc}</div>
                        <div className="grid grid-cols-3 gap-2 mt-2">
                          <button onClick={() => {
                            const newLines = [...resolutionChallengeBet.tempLines]; newLines[idx].result = 'win';
                            setResolutionChallengeBet({ ...resolutionChallengeBet, tempLines: newLines });
                          }} className={`p-2 rounded text-xs font-bold border transition-all ${line.result === 'win' ? 'bg-emerald-500 text-white border-emerald-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-emerald-500'}`}>GANADA</button>
                          <button onClick={() => {
                            const newLines = [...resolutionChallengeBet.tempLines]; newLines[idx].result = 'void';
                            setResolutionChallengeBet({ ...resolutionChallengeBet, tempLines: newLines });
                          }} className={`p-2 rounded text-xs font-bold border transition-all ${line.result === 'void' ? 'bg-slate-500 text-white border-slate-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-slate-500'}`}>NULA</button>
                          <button onClick={() => {
                            const newLines = [...resolutionChallengeBet.tempLines]; newLines[idx].result = 'loss';
                            setResolutionChallengeBet({ ...resolutionChallengeBet, tempLines: newLines });
                          }} className={`p-2 rounded text-xs font-bold border transition-all ${line.result === 'loss' ? 'bg-red-500 text-white border-red-500' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-red-500'}`}>PERDIDA</button>
                        </div>
                      </div>
                    ))}
                  </div>

                  <div className="p-6 border-t border-slate-800 flex justify-end gap-3 bg-slate-900">
                    <button onClick={() => setResolutionChallengeBet(null)} className="px-4 py-2 text-slate-400 hover:text-white font-bold transition-colors">Cancelar</button>
                    <button onClick={() => {
                      // APPLY LOGIC TO CHALLENGES
                      const lines = resolutionChallengeBet.tempLines;
                      let parentResult = 'win';
                      let finalOdds = resolutionChallengeBet.odds;
                      let parentProfit = 0;

                      const anyLoss = lines.some(l => l.result === 'loss');
                      const allVoid = lines.every(l => l.result === 'void');

                      if (anyLoss) { parentResult = 'loss'; parentProfit = -resolutionChallengeBet.stake; }
                      else if (allVoid) { parentResult = 'void'; parentProfit = 0; }
                      else {
                        const winningLines = lines.filter(l => l.result !== 'void');
                        if (winningLines.length > 0) {
                          const recalculatedOdds = winningLines.reduce((acc, l) => acc * (parseFloat(l.odds) || 1), 1);
                          finalOdds = parseFloat(recalculatedOdds.toFixed(2));
                        }
                        parentProfit = (resolutionChallengeBet.stake * finalOdds) - resolutionChallengeBet.stake;
                      }

                      const updatedChallenges = challenges.map(c => {
                        if (c.id === resolutionChallengeBet.challengeId) {
                          const newHistory = c.history.map(h => {
                            if (h.id === resolutionChallengeBet.id) {
                              return { ...h, result: parentResult, profit: parseFloat(parentProfit.toFixed(2)), odds: finalOdds, lines: resolutionChallengeBet.tempLines };
                            }
                            return h;
                          });
                          const newChallenge = { ...c, history: newHistory };
                          newChallenge.currentBank = recalculateChallengeBank(newChallenge);
                          return newChallenge;
                        }
                        return c;
                      });
                      setChallenges(updatedChallenges);
                      setResolutionChallengeBet(null);
                    }} className="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg shadow-lg shadow-emerald-900/20 transition-all transform active:scale-95">
                      Confirmar ResoluciÃ³n
                    </button>
                  </div>
                </div>
              </div>
            )}

          </div>


          {/* CALCULATOR MODAL (V18 - RECOVERED) */}
          {showCalculator && (
            <div className="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4 animate-fade-in backdrop-blur-md" onClick={() => setShowCalculator(false)}>
              <div className="bg-slate-900 w-full max-w-lg rounded-xl border border-slate-700 shadow-2xl overflow-hidden animate-scale-in" onClick={e => e.stopPropagation()}>
                <div className="p-6 bg-slate-950 border-b border-slate-800 flex justify-between items-center">
                  <h3 className="text-xl font-bold text-white flex items-center gap-2"><Calculator className="text-indigo-500" /> Calculadora RÃ¡pida</h3>
                  <button onClick={() => setShowCalculator(false)} className="text-slate-500 hover:text-white"><X size={20} /></button>
                </div>
                <div className="p-6 space-y-4">

                  {/* TABS */}
                  <div className="flex p-1 bg-slate-800 rounded-lg mb-4">
                    <button onClick={() => setCalculatorData({ ...calculatorData, mode: 'simple' })} className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${calculatorData.mode === 'simple' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>Simple</button>
                    <button onClick={() => setCalculatorData({ ...calculatorData, mode: 'combo' })} className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${calculatorData.mode === 'combo' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>Combinada</button>
                  </div>

                  {calculatorData.mode === 'simple' ? (
                    <div className="space-y-4">
                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Stake (â‚¬)</label>
                          <input type="number" value={calculatorData.stake} onChange={e => {
                            const stake = parseFloat(e.target.value) || 0;
                            const odds = parseFloat(calculatorData.odds) || 0;
                            setCalculatorData({ ...calculatorData, stake: e.target.value, profit: ((stake * odds) - stake).toFixed(2) });
                          }} className="w-full bg-slate-800 border border-slate-700 rounded p-3 text-white focus:border-indigo-500" />
                        </div>
                        <div>
                          <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Cuota (@)</label>
                          <input type="number" value={calculatorData.odds} onChange={e => {
                            const odds = parseFloat(e.target.value) || 0;
                            const stake = parseFloat(calculatorData.stake) || 0;
                            setCalculatorData({ ...calculatorData, odds: e.target.value, profit: ((stake * odds) - stake).toFixed(2) });
                          }} className="w-full bg-slate-800 border border-slate-700 rounded p-3 text-white focus:border-indigo-500" />
                        </div>
                      </div>
                      <div className="bg-slate-950 p-4 rounded border border-slate-800 text-center">
                        <div className="text-xs font-bold text-slate-500 uppercase mb-1">Beneficio Neto</div>
                        <div className="text-3xl font-mono font-bold text-emerald-400">{calculatorData.profit || '0.00'}â‚¬</div>
                      </div>
                    </div>
                  ) : (
                    <div className="space-y-4">
                      {/* COMBO LINES */}
                      <div className="space-y-2 max-h-[200px] overflow-y-auto pr-1">
                        {calculatorData.lines.map((line, idx) => (
                          <div key={idx} className="flex gap-2 items-end">
                            <div className="flex-1">
                              {idx === 0 && <label className="text-xs font-bold text-slate-400 mb-1 block">Cuota @</label>}
                              <input type="number" value={line.odds} placeholder="1.50" onChange={e => {
                                const newLines = [...calculatorData.lines];
                                newLines[idx].odds = e.target.value;
                                setCalculatorData({ ...calculatorData, lines: newLines });
                              }} className={`w-full bg-slate-800 border-slate-700 rounded p-2 text-white text-sm ${line.void ? 'opacity-50 line-through' : ''}`} disabled={line.void} />
                            </div>

                            <button onClick={() => {
                              const newLines = [...calculatorData.lines];
                              newLines[idx].void = !newLines[idx].void;
                              setCalculatorData({ ...calculatorData, lines: newLines });
                            }} className={`p-2 mb-0.5 rounded border ${line.void ? 'bg-slate-600 text-white border-slate-500' : 'bg-slate-800 text-slate-400 border-slate-700 hover:text-white'}`} title="Marcar Nula">VOID</button>

                            <button onClick={() => {
                              const newLines = calculatorData.lines.filter((_, i) => i !== idx);
                              setCalculatorData({ ...calculatorData, lines: newLines });
                            }} className="p-2 mb-0.5 rounded bg-red-900/20 text-red-400 border border-red-900/30 hover:bg-red-900/40"><Trash2 size={16} /></button>
                          </div>
                        ))}
                      </div>
                      <button onClick={() => setCalculatorData({ ...calculatorData, lines: [...calculatorData.lines, { odds: '', desc: '', void: false }] })} className="w-full py-2 bg-slate-800 text-slate-300 text-xs font-bold rounded hover:bg-slate-700 flex items-center justify-center gap-2"><Plus size={14} /> AÃ‘ADIR LÃNEA</button>

                      {/* STATS */}
                      <div className="grid grid-cols-2 gap-4 pt-4 border-t border-slate-800">
                        <div className="bg-slate-950 p-3 rounded border border-slate-800">
                          <div className="text-[10px] font-bold text-slate-500 uppercase">Cuota Total</div>
                          <div className="text-xl font-mono font-bold text-white">
                            @{calculatorData.lines.filter(l => !l.void).reduce((acc, l) => acc * (parseFloat(l.odds) || 1), 1).toFixed(2)}
                          </div>
                        </div>
                        <div className="bg-slate-950 p-3 rounded border border-slate-800">
                          <input type="number" value={calculatorData.stake} onChange={e => setCalculatorData({ ...calculatorData, stake: e.target.value })} className="w-full bg-transparent text-right text-white font-mono font-bold focus:outline-none mb-1 border-b border-slate-700 pb-1" placeholder="Stake" />
                          <div className="text-[10px] font-bold text-slate-500 uppercase text-right">Benef: {((parseFloat(calculatorData.stake) || 0) * (calculatorData.lines.filter(l => !l.void).reduce((acc, l) => acc * (parseFloat(l.odds) || 1), 1) - 1)).toFixed(2)}â‚¬</div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* MODAL EDICIÃ“N EN VIVO (V10) */}
          {editingBet && (
            <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4 animate-fade-in backdrop-blur-sm" onClick={() => setEditingBet(null)}>
              <div className="bg-slate-900 w-full max-w-lg rounded-xl border border-slate-700 shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b border-slate-800 bg-slate-950 flex justify-between items-center">
                  <h3 className="font-bold text-white uppercase text-sm flex items-center gap-2"><Edit size={16} className="text-blue-400" /> Editar Apuesta en Vivo</h3>
                  <button onClick={() => setEditingBet(null)}><X size={20} className="text-slate-500 hover:text-white" /></button>
                </div>
                <form onSubmit={handleSaveEditedBet} className="p-6 space-y-4">
                  {/* DESCRIPTION */}
                  <div>
                    <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">DescripciÃ³n</label>
                    <input type="text" value={editingBet.description} onChange={e => setEditingBet({ ...editingBet, description: e.target.value })} className="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white text-sm focus:border-blue-500 transition-colors" required />
                  </div>

                  {/* STAKE & ODDS */}
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Stake (â‚¬)</label>
                      <input type="number" step="0.01" value={editingBet.stake} onChange={e => setEditingBet({ ...editingBet, stake: parseFloat(e.target.value) })} className="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white text-sm focus:border-blue-500 transition-colors" required />
                    </div>
                    <div>
                      <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Cuota Total (@)</label>
                      <input type="number" step="0.01" value={editingBet.odds} onChange={e => setEditingBet({ ...editingBet, odds: parseFloat(e.target.value) })} className="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white text-sm font-bold text-emerald-400 focus:border-blue-500 transition-colors" required />
                    </div>
                  </div>

                  {/* LÃNEAS (SOLO SI HAY) */}
                  {editingBet.betLines && editingBet.betLines.length > 0 && (
                    <div className="bg-slate-950/50 rounded border border-slate-800 p-3 mt-2">
                      <label className="text-xs font-bold text-slate-500 uppercase mb-2 block flex items-center gap-2"><Layers size={12} /> GestiÃ³n de LÃ­neas (Marcar Nulas)</label>
                      <div className="space-y-2 max-h-[200px] overflow-y-auto pr-1">
                        {editingBet.betLines.map((line, idx) => {
                          const isVoid = line.status === 'void';
                          return (
                            <div key={idx} className={`flex items-center justify-between p-2 rounded border ${isVoid ? 'bg-slate-800/50 border-slate-700 opacity-60' : 'bg-slate-900 border-slate-700'}`}>
                              <div className="flex-1 min-w-0 mr-2">
                                <div className={`text-xs font-bold truncate ${isVoid ? 'line-through text-slate-500' : 'text-white'}`}>{line.description}</div>
                                <div className="text-[10px] text-slate-400">@{line.odds} â€¢ {line.tipster}</div>
                              </div>
                              <button type="button" onClick={() => toggleLineVoid(idx)} className={`px-2 py-1 text-[10px] font-bold rounded border transition-colors ${isVoid ? 'bg-slate-700 text-slate-400 border-slate-600' : 'bg-red-500/10 text-red-400 border-red-500/30 hover:bg-red-500/20'}`}>
                                {isVoid ? 'ANULADA' : 'ANULAR'}
                              </button>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}

                  <button type="submit" className="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded font-bold text-white shadow-lg mt-2 flex items-center justify-center gap-2">
                    <Save size={16} /> Guardar Cambios
                  </button>
                </form>
              </div>
            </div>
          )}

          {/* BANK MANAGER MODAL (V18) */}
          {showBankManager && (
            <div className="fixed inset-0 bg-black/90 z-[90] flex items-center justify-center p-4 animate-fade-in backdrop-blur-md" onClick={() => setShowBankManager(false)}>
              <div className="bg-slate-900 w-full max-w-lg rounded-xl border border-slate-700 shadow-2xl overflow-hidden animate-scale-in" onClick={e => e.stopPropagation()}>
                <div className="p-6 bg-slate-950 border-b border-slate-800 flex justify-between items-center">
                  <h3 className="text-xl font-bold text-white flex items-center gap-2"><PieChart className="text-emerald-500" /> GestiÃ³n de Fondos</h3>
                  <button onClick={() => setShowBankManager(false)} className="text-slate-500 hover:text-white"><X size={20} /></button>
                </div>
                <div className="p-6 space-y-6">
                  <div className="bg-slate-800/50 p-4 rounded-lg flex justify-between items-center border border-slate-700">
                    <div>
                      <div className="text-xs font-bold text-slate-400 uppercase">Bank Actual (Calculado)</div>
                      <div className="text-3xl font-bold font-mono text-white">{currentGlobalBank.toFixed(2)}â‚¬</div>
                    </div>
                    <div className="text-right text-xs text-slate-500">
                      <div>InversiÃ³n: {bankTransactions.filter(t => t.type !== 'withdraw').reduce((a, b) => a + parseFloat(b.amount || 0), 0).toFixed(2)}â‚¬</div>
                      <div>Retiros: {bankTransactions.filter(t => t.type === 'withdraw').reduce((a, b) => a + parseFloat(b.amount || 0), 0).toFixed(2)}â‚¬</div>
                      <div className={financialStats.profit >= 0 ? "text-emerald-500" : "text-red-500"}>Beneficio: {financialStats.profit >= 0 ? '+' : ''}{financialStats.profit.toFixed(2)}â‚¬</div>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-3">
                    <button onClick={() => {
                      const amount = prompt("Introduce Bank Inicial (â‚¬):");
                      if (amount && !isNaN(amount)) {
                        const newTrans = { id: Date.now(), date: new Date().toISOString(), type: 'initial', amount: parseFloat(amount), note: 'Bank Inicial' };
                        // Filter out old initial if exists? Usually one initial.
                        setBankTransactions([...bankTransactions.filter(t => t.type !== 'initial'), newTrans]);
                      }
                    }} className="p-3 bg-slate-800 hover:bg-slate-700 rounded border border-slate-600 text-sm font-bold text-slate-300 flex items-center justify-center gap-2 transition-colors">
                      <Target size={16} /> FIJAR INICIAL
                    </button>
                    <button onClick={() => {
                      const amount = prompt("Cantidad a Ingresar (â‚¬):");
                      if (amount && !isNaN(amount)) {
                        setBankTransactions([...bankTransactions, { id: Date.now(), date: new Date().toISOString(), type: 'deposit', amount: parseFloat(amount), note: 'DepÃ³sito' }]);
                      }
                    }} className="p-3 bg-emerald-600/20 hover:bg-emerald-600/30 rounded border border-emerald-500/50 text-sm font-bold text-emerald-400 flex items-center justify-center gap-2 transition-colors">
                      <TrendingUp size={16} /> INGRESAR
                    </button>
                    <button onClick={() => {
                      const amount = prompt("Cantidad a Retirar (â‚¬):");
                      if (amount && !isNaN(amount)) {
                        setBankTransactions([...bankTransactions, { id: Date.now(), date: new Date().toISOString(), type: 'withdraw', amount: parseFloat(amount), note: 'Retiro' }]);
                      }
                    }} className="p-3 bg-red-600/20 hover:bg-red-600/30 rounded border border-red-500/50 text-sm font-bold text-red-400 flex items-center justify-center gap-2 transition-colors">
                      <TrendingDown size={16} /> RETIRAR
                    </button>
                    <button onClick={() => {
                      if (confirm("Â¿Borrar historial de transacciones?")) setBankTransactions([]);
                    }} className="p-3 bg-slate-900 hover:bg-red-900/20 rounded border border-slate-700 hover:border-red-500/30 text-sm font-bold text-slate-500 hover:text-red-400 flex items-center justify-center gap-2 transition-colors">
                      <Trash2 size={16} /> RESET
                    </button>
                  </div>

                  <div className="space-y-2">
                    <h4 className="text-xs font-bold text-slate-500 uppercase">Historial de Movimientos</h4>
                    <div className="max-h-[150px] overflow-y-auto space-y-1 pr-1">
                      {bankTransactions.sort((a, b) => b.id - a.id).map(t => (
                        <div key={t.id} className="flex justify-between items-center p-2 bg-slate-950 rounded border border-slate-800 text-xs">
                          <div className="flex items-center gap-2">
                            <span className={`w-2 h-2 rounded-full ${t.type === 'initial' ? 'bg-blue-500' : (t.type === 'deposit' ? 'bg-emerald-500' : 'bg-red-500')}`}></span>
                            <span className="text-slate-300 font-bold uppercase">{t.type}</span>
                            <span className="text-slate-500">{new Date(t.date).toLocaleDateString()}</span>
                          </div>
                          <div className="font-mono font-bold text-white">{t.amount.toFixed(2)}â‚¬</div>
                        </div>
                      ))}
                      {bankTransactions.length === 0 && <div className="text-center text-slate-600 italic py-2">Sin movimientos registrados.</div>}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* ADD BET MODAL - REFACTORED V30 */}
          {showAddBetModal && (
            <div className="fixed inset-0 bg-black/90 z-[90] flex items-center justify-center p-4 animate-fade-in backdrop-blur-md" onClick={() => setShowAddBetModal(false)}>
              <div className="bg-slate-900 w-full max-w-4xl rounded-xl border border-slate-700 shadow-2xl overflow-hidden animate-scale-in flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b border-slate-800 bg-slate-950 flex justify-between items-center shrink-0">
                  <h3 className="font-bold text-white uppercase text-lg flex items-center gap-2"><Plus size={20} className="text-emerald-500" /> Registrar Nueva Apuesta</h3>
                  <div className="flex items-center gap-2">
                    <button type="button" onClick={() => setShowTipsterManager(true)} className="text-xs flex items-center gap-1 bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1.5 rounded transition-colors border border-slate-700">
                      <Users size={14} /> Gestionar Tipsters
                    </button>
                    <button onClick={() => setShowAddBetModal(false)} className="text-slate-500 hover:text-white transition-colors"><X size={24} /></button>
                  </div>
                </div>

                <div className="p-6 overflow-y-auto custom-scrollbar">
                  <form onSubmit={handleSaveBet} className="space-y-6 relative z-10">

                    {/* 1. TIPSTER & STAKE (Top Row) */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="relative z-20">
                        <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Tipster Principal</label>
                        <div className="relative">
                          <select value={formTipster} onChange={e => {
                            const val = e.target.value;
                            setFormTipster(val);
                            const t = tipsters.find(ti => ti.name === val);
                            if (t) setFormStake(t.defaultStake);
                          }} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:border-emerald-500 appearance-none">
                            {tipsters.map(t => <option key={t.id || t.name} value={t.name}>{t.name}</option>)}
                          </select>
                          <ChevronRight className="absolute right-3 top-3.5 text-slate-500 rotate-90 pointer-events-none" size={16} />
                        </div>
                      </div>
                      <div>
                        <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Stake Total (â‚¬)</label>
                        <input type="number" step="0.01" value={formStake} onChange={e => {
                          const newStake = e.target.value;
                          setFormStake(newStake);
                          // Auto-calc profit if odds exist
                          const o = parseFloat(formOdds);
                          if (o > 1 && newStake) {
                            const s = parseFloat(newStake);
                            setManualProfit(((s * o) - s).toFixed(2));
                          }
                        }} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white font-mono text-lg focus:border-emerald-500" />
                      </div>
                    </div>

                    {/* 2. DESCRIPTION & TAGS */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">DescripciÃ³n General</label>
                        <input type="text" value={formDesc} onChange={e => setFormDesc(e.target.value)} placeholder="Ej: Real Madrid vs Barcelona" className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:border-emerald-500" />
                      </div>
                      <div>
                        <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Etiquetas (Autocompletar)</label>
                        <div className="relative group">
                          <input type="text" value={formTags} onChange={e => setFormTags(e.target.value)} placeholder="Escribe para buscar..." className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white text-sm focus:border-blue-500" />
                          <div className="absolute top-0 right-0 h-full flex items-center pr-3 pointer-events-none text-slate-600"><Tag size={14} /></div>
                          {/* Simple suggestion dropdown could be added here if needed, leveraging availableTags */}
                          {formTags && (
                            <div className="absolute top-full left-0 w-full bg-slate-900 border border-slate-700 rounded-lg mt-1 shadow-xl z-50 hidden group-focus-within:block">
                              <div className="p-2 text-xs text-slate-500 uppercase font-bold">Sugerencias:</div>
                              {availableTags.filter(t => t.toLowerCase().includes(formTags.toLowerCase()) && !formTags.includes(t)).slice(0, 5).map(t => (
                                <div key={t} className="p-2 hover:bg-slate-800 text-slate-300 cursor-pointer text-sm" onMouseDown={(e) => { e.preventDefault(); setFormTags(prev => prev ? prev + ', ' + t : t); }}>{t}</div>
                              ))}
                            </div>
                          )}
                        </div>
                      </div>
                    </div>

                    {/* 3. MULTI-LINE BUILDER (Always On) */}
                    <div className="bg-slate-800/30 p-4 rounded-xl border border-slate-700/50 space-y-3">
                      <div className="flex justify-between items-center">
                        <div className="text-xs font-bold text-indigo-400 uppercase flex items-center gap-2"><Layers size={14} /> LÃ­neas de Apuesta (Multi/Mezcla)</div>
                        <button type="button" onClick={() => setIsMultiLine(!isMultiLine)} className="text-[10px] text-slate-500 hover:text-white underline">{isMultiLine ? 'Ocultar Constructor' : 'Mostrar Constructor'}</button>
                      </div>

                      {(isMultiLine || betLines.length > 0) && (
                        <div className="space-y-2 animate-fade-in">
                          {betLines.map((line, idx) => (
                            <div key={idx} className="flex flex-col md:flex-row gap-2 items-start md:items-center bg-slate-900/50 p-3 rounded border border-slate-700">
                              <div className="flex-1 w-full md:w-auto">
                                <div className="flex gap-1 mb-1">
                                  {/* MULTI TIPSTER LOGIC */}
                                  <div className="flex items-center gap-1 flex-wrap">
                                    <span className="text-[10px] text-slate-500 uppercase font-bold mr-1">Tipsters:</span>
                                    {line.tipster && line.tipster.split(' + ').map((tName, tIdx) => (
                                      <span key={tIdx} className="bg-indigo-900/30 text-indigo-200 border border-indigo-500/30 px-1.5 py-0.5 rounded text-[10px]">{tName}</span>
                                    ))}
                                    <button type="button" onClick={() => {
                                      const current = line.tipster ? line.tipster.split(' + ') : [];
                                      const nextTipster = prompt("AÃ±adir Co-Tipster (Nombre):");
                                      /* A better UI would be a mini dropdown, but prompt is fast for now as fallback */
                                      if (nextTipster) updateLine(idx, 'tipster', [...current, nextTipster].join(' + '));
                                    }} className="text-emerald-400 hover:text-white bg-emerald-900/20 p-0.5 rounded border border-emerald-500/30"><Plus size={10} /></button>
                                  </div>
                                </div>
                                <input type="text" placeholder="DescripciÃ³n selecciÃ³n..." value={line.description} onChange={e => updateLine(idx, 'description', e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white focus:border-indigo-500" />
                              </div>
                              <div className="flex gap-2 w-full md:w-auto">
                                <input type="number" placeholder="@" step="0.01" value={line.odds} onChange={e => updateLine(idx, 'odds', e.target.value)} className="w-20 bg-slate-950 border border-slate-700 rounded p-2 text-sm text-center font-bold text-white focus:border-indigo-500" />
                                <button type="button" onClick={() => removeLine(idx)} className="p-2 text-slate-500 hover:text-red-400 hover:bg-red-900/10 rounded"><Trash2 size={16} /></button>
                              </div>
                            </div>
                          ))}
                          <button type="button" onClick={addLine} className="w-full py-2 border border-dashed border-slate-700 text-slate-400 text-xs rounded hover:bg-slate-800 hover:text-indigo-400 transition-colors flex justify-center items-center gap-2">
                            <Plus size={14} /> AÃ‘ADIR LÃNEA
                          </button>
                        </div>
                      )}
                      {/* Auto-enable if empty */}
                      {betLines.length === 0 && <div className="text-center text-xs text-slate-500 italic py-2 cursor-pointer hover:text-indigo-400" onClick={addLine}>Haga clic para aÃ±adir lÃ­neas detalladas</div>}
                    </div>

                    {/* 4. ODDS & PROFIT CALCULATOR */}
                    <div className="grid grid-cols-2 gap-4 bg-slate-800/30 p-4 rounded-xl border border-slate-700/50">
                      <div>
                        <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Cuota Final (@)</label>
                        <input type="number" step="0.01" value={formOdds} onChange={e => {
                          const val = e.target.value;
                          setFormOdds(val);
                          // Auto-calc profit
                          const s = parseFloat(formStake);
                          const o = parseFloat(val);
                          if (s > 0 && o > 1) {
                            setManualProfit(((s * o) - s).toFixed(2));
                          } else {
                            if (!val) setManualProfit('');
                          }
                        }} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white text-xl font-bold font-mono focus:border-emerald-500" placeholder="1.00" />
                      </div>
                      <div>
                        <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">O Ganancia Neta (â‚¬)</label>
                        <div className="relative">
                          <input type="number" step="0.01" value={manualProfit} onChange={e => {
                            const val = e.target.value;
                            setManualProfit(val);

                            const s = parseFloat(formStake);
                            const p = parseFloat(val);

                            if (s > 0 && p > 0) {
                              const targetTotalOdds = (p + s) / s;

                              // 1. Update Global Odds Display
                              setFormOdds(targetTotalOdds.toFixed(2));

                              // 2. Prop-Odds Scaling for Multi-Line
                              if (isMultiLine && betLines.length > 0) {
                                const currentTotalProduct = betLines.reduce((acc, line) => acc * (parseFloat(line.odds) || 1), 1);
                                if (currentTotalProduct > 0) {
                                  // Math: NewLine = OldLine * (TargetTotal / CurrentTotal)^(1/n)
                                  const ratio = targetTotalOdds / currentTotalProduct;
                                  const n = betLines.length;
                                  const multiplier = Math.pow(ratio, 1 / n);

                                  const newLines = betLines.map(line => ({
                                    ...line,
                                    odds: ((parseFloat(line.odds) || 1) * multiplier).toFixed(2)
                                  }));
                                  setBetLines(newLines);
                                }
                              }
                            } else {
                              if (!val) setFormOdds(''); // Optional: clear odds if profit cleared? Or keep last.
                            }
                          }} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-emerald-400 font-bold font-mono text-xl focus:border-emerald-500" placeholder="0.00" />
                          <span className="absolute right-3 top-4 text-xs text-slate-600">AUTO-CALC</span>
                        </div>
                      </div>
                    </div>

                    <button type="submit" className="w-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 py-4 rounded-xl font-bold text-white shadow-lg shadow-emerald-900/20 text-lg transition-all transform active:scale-95 flex items-center justify-center gap-3">
                      <Save size={20} /> REGISTRAR APUESTA
                    </button>
                  </form>
                </div>
              </div>
            </div>
          )}

          {/* TIPSTER MANAGER MODAL (V30) */}
          {showTipsterManager && (
            <div className="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4 animate-fade-in backdrop-blur-md" onClick={() => setShowTipsterManager(false)}>
              <div className="bg-slate-900 w-full max-w-2xl rounded-xl border border-slate-700 shadow-2xl overflow-hidden animate-scale-in" onClick={e => e.stopPropagation()}>
                <div className="p-6 bg-slate-950 border-b border-slate-800 flex justify-between items-center">
                  <h3 className="text-xl font-bold text-white flex items-center gap-2"><Users className="text-blue-500" /> GestiÃ³n de Tipsters</h3>
                  <button onClick={() => setShowTipsterManager(false)} className="text-slate-500 hover:text-white"><X size={20} /></button>
                </div>
                <div className="p-6 max-h-[60vh] overflow-y-auto">
                  <div className="flex gap-2 mb-6">
                    <input type="text" id="newTipsterName" placeholder="Nombre del Tipster..." className="flex-1 bg-slate-800 border border-slate-700 rounded p-3 text-white focus:border-blue-500" />
                    <input type="number" id="newTipsterStake" placeholder="Stake Def (â‚¬)..." className="w-32 bg-slate-800 border border-slate-700 rounded p-3 text-white focus:border-blue-500" />
                    <button onClick={() => {
                      const nameEl = document.getElementById('newTipsterName');
                      const stakeEl = document.getElementById('newTipsterStake');
                      if (nameEl.value) {
                        handleAddTipster(nameEl.value, stakeEl.value);
                        nameEl.value = '';
                        stakeEl.value = '';
                      }
                    }} className="bg-blue-600 hover:bg-blue-500 text-white font-bold px-4 rounded flex items-center gap-2"><Plus size={18} /> AÃ±adir</button>
                  </div>

                  <div className="space-y-2">
                    {tipsters.map(t => (
                      <div key={t.id} className="flex items-center justify-between bg-slate-800/50 p-3 rounded border border-slate-700 hover:border-slate-500 transition-colors">
                        <div className="flex items-center gap-4">
                          <div className="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center font-bold text-slate-300">{t.name.charAt(0)}</div>
                          <div>
                            <div className="font-bold text-white">{t.name}</div>
                            <div className="text-xs text-slate-500">Stake Base: {t.defaultStake}â‚¬</div>
                          </div>
                        </div>
                        <div className="flex items-center gap-2">
                          <button onClick={() => {
                            const original = DEFAULT_TIPSTERS.find(dt => dt.id === t.id);
                            const label = original
                              ? `Editar Nombre (Original: ${original.name}):`
                              : "Editar Nombre del Tipster:";

                            const newName = prompt(label, t.name);
                            if (newName !== null) {
                              const newStake = prompt("Editar Stake Base (â‚¬):", t.defaultStake);
                              if (newStake !== null) {
                                handleEditTipster(t.id, newName || t.name, newStake || t.defaultStake);
                              }
                            }
                          }} className="p-2 text-slate-400 hover:text-white bg-slate-900 rounded border border-slate-700 hover:border-emerald-500 transition-colors"><Edit size={14} /></button>
                          <button onClick={() => handleDeleteTipster(t.id)} className="p-2 text-red-400 hover:text-red-300 bg-red-900/20 rounded"><Trash2 size={14} /></button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* CHALLENGE BET MODAL - BUGFIX V30 */}
          {activeChallengeId && (
            <div className="fixed inset-0 bg-black/90 z-[95] flex items-center justify-center p-4 animate-fade-in backdrop-blur-md" onClick={() => setActiveChallengeId(null)}>
              <div className="bg-slate-900 w-full max-w-lg rounded-xl border border-slate-700 shadow-2xl overflow-hidden animate-scale-in" onClick={e => e.stopPropagation()}>
                <div className="p-4 bg-slate-950 border-b border-slate-800 flex justify-between items-center">
                  <h3 className="text-lg font-bold text-white flex items-center gap-2"><Trophy className="text-yellow-500" /> Nuevo Paso del Reto</h3>
                  <button onClick={() => setActiveChallengeId(null)} className="text-slate-500 hover:text-white"><X size={20} /></button>
                </div>
                <form onSubmit={(e) => { addChallengeBet(e, activeChallengeId); setActiveChallengeId(null); }} className="p-6 space-y-4">
                  <div>
                    <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">DescripciÃ³n</label>
                    <input type="text" value={challengeForm.desc} onChange={e => setChallengeForm({ ...challengeForm, desc: e.target.value })} className="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white focus:border-yellow-500" required placeholder="Ej: Paso 1" />
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Stake (â‚¬)</label>
                      <input type="number" step="0.01" value={challengeForm.stake} onChange={e => setChallengeForm({ ...challengeForm, stake: e.target.value })} className="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white font-mono focus:border-yellow-500" required />
                    </div>
                    <div>
                      <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Cuota (@)</label>
                      <input type="number" step="0.01" value={challengeForm.odds} onChange={e => setChallengeForm({ ...challengeForm, odds: e.target.value })} className="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white font-mono focus:border-yellow-500" required />
                    </div>
                  </div>
                  <button type="submit" className="w-full bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-3 rounded-lg shadow-lg">REGISTRAR PASO</button>
                </form>
              </div>
            </div>
          )}
        </div>
      );
    }

    // --- RENDERIZADO ---
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<PortfolioManager />);

    // Inicializar iconos Lucide (por si acaso se usan fuera de React, aunque aquÃ­ no deberÃ­a hacer falta si se usan como componentes)
    lucide.createIcons();
  </script>
</body>

</html>